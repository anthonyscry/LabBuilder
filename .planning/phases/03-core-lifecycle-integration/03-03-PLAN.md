---
phase: 03-core-lifecycle-integration
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - Public/Test-LabNetwork.ps1
  - Public/Test-LabNetworkHealth.ps1
  - Scripts/Test-OpenCodeLabHealth.ps1
  - Tests/NetworkHealth.Tests.ps1
autonomous: true
requirements:
  - NET-01
  - NET-02
  - NET-03
  - NET-04
  - NET-05
  - CLI-06

must_haves:
  truths:
    - "Test-LabNetwork reads switch name from $GlobalLabConfig instead of hardcoding 'SimpleLab'"
    - "Test-LabNetworkHealth reads VM names and config from $GlobalLabConfig instead of hardcoding defaults"
    - "Test-OpenCodeLabHealth.ps1 checks vSwitch, NAT, DNS resolution, and domain join status in addition to VM state and AD DS"
    - "Health check returns actionable diagnostics: what is wrong and what command to run to fix it"
  artifacts:
    - path: "Public/Test-LabNetwork.ps1"
      provides: "Config-aware vSwitch check"
      contains: "GlobalLabConfig"
    - path: "Scripts/Test-OpenCodeLabHealth.ps1"
      provides: "Comprehensive health check covering network, DNS, domain join"
      contains: "vSwitch|NAT|DNS|DomainJoin"
    - path: "Tests/NetworkHealth.Tests.ps1"
      provides: "Tests for network check functions"
      contains: "Describe.*Network"
  key_links:
    - from: "Scripts/Test-OpenCodeLabHealth.ps1"
      to: "Public/Test-LabNetwork.ps1"
      via: "Calls Test-LabNetwork for vSwitch validation"
      pattern: "Test-LabNetwork"
---

<objective>
Fix hardcoded values in network test functions and enhance the health check to cover full infrastructure status.

Purpose: Test-LabNetwork hardcodes "SimpleLab" as the switch name, which breaks if the user configured a different name. Test-OpenCodeLabHealth.ps1 only checks VM state and AD DS status but doesn't validate vSwitch, NAT, DNS resolution, or member server domain join — leaving infrastructure issues undiagnosed.

Output: Network test functions read from $GlobalLabConfig. Health check covers vSwitch, NAT, DNS, domain join, and VM-to-VM connectivity with actionable diagnostics.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-lifecycle-integration/03-RESEARCH.md
@.planning/phases/03-core-lifecycle-integration/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hardcoded values in network test functions</name>
  <files>Public/Test-LabNetwork.ps1, Public/Test-LabNetworkHealth.ps1</files>
  <action>
1. **Public/Test-LabNetwork.ps1:**
   - Add `-SwitchName` parameter (default from `$GlobalLabConfig.Network.SwitchName` if available, else "SimpleLab")
   - Replace all hardcoded "SimpleLab" references with `$SwitchName`
   - Update result object's SwitchName field to use the parameter value
   - Maintain backward compatibility: function works without parameters using config values

2. **Public/Test-LabNetworkHealth.ps1:**
   - Add `-SwitchName` parameter defaulting from `$GlobalLabConfig.Network.SwitchName`
   - Update default `$VMNames` parameter to read from `$GlobalLabConfig.Lab.CoreVMNames` if available
   - Pass `-SwitchName` to `Test-LabNetwork` call
   - Pass config-aware values to `Get-LabNetworkConfig` calls
  </action>
  <verify>
- `Select-String -Path Public/Test-LabNetwork.ps1 -Pattern '"SimpleLab"'` returns no hits in function body (only in default parameter value as fallback)
- Test-LabNetwork accepts -SwitchName parameter
- Test-LabNetworkHealth passes SwitchName to Test-LabNetwork
  </verify>
  <done>Network test functions read switch name and VM names from $GlobalLabConfig instead of hardcoded values.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance health check and add network tests</name>
  <files>Scripts/Test-OpenCodeLabHealth.ps1, Tests/NetworkHealth.Tests.ps1</files>
  <action>
1. **Scripts/Test-OpenCodeLabHealth.ps1 — Add infrastructure checks:**

   After the VM existence checks (line ~96), add:

   a. **vSwitch check:**
   ```powershell
   $sw = Get-VMSwitch -Name $GlobalLabConfig.Network.SwitchName -ErrorAction SilentlyContinue
   if ($sw) { Add-Ok "vSwitch '$($GlobalLabConfig.Network.SwitchName)' exists" }
   else { Add-Issue "vSwitch '$($GlobalLabConfig.Network.SwitchName)' missing. Run: New-LabSwitch -SwitchName '$($GlobalLabConfig.Network.SwitchName)'" }
   ```

   b. **NAT check:**
   ```powershell
   $nat = Get-NetNat -Name $GlobalLabConfig.Network.NatName -ErrorAction SilentlyContinue
   if ($nat) { Add-Ok "NAT '$($GlobalLabConfig.Network.NatName)' exists" }
   else { Add-Issue "NAT '$($GlobalLabConfig.Network.NatName)' missing. Run: New-LabNAT" }
   ```

   c. **Host gateway IP check:**
   ```powershell
   $ifAlias = "vEthernet ($($GlobalLabConfig.Network.SwitchName))"
   $gwIp = Get-NetIPAddress -InterfaceAlias $ifAlias -AddressFamily IPv4 -ErrorAction SilentlyContinue |
           Where-Object { $_.IPAddress -eq $GlobalLabConfig.Network.GatewayIp }
   if ($gwIp) { Add-Ok "Host gateway IP $($GlobalLabConfig.Network.GatewayIp) on $ifAlias" }
   else { Add-Issue "Host gateway IP $($GlobalLabConfig.Network.GatewayIp) missing on $ifAlias" }
   ```

   d. **DNS resolution check** (on DC1, if AD DS is healthy):
   ```powershell
   # Test that DC1 can resolve external DNS (forwarders working)
   $dnsResult = Invoke-LabCommand -ComputerName 'DC1' -PassThru -ScriptBlock {
       $resolved = Resolve-DnsName -Name 'google.com' -QuickTimeout -ErrorAction SilentlyContinue
       [bool]$resolved
   } -ErrorAction SilentlyContinue
   if ($dnsResult) { Add-Ok "DC1 DNS external resolution working" }
   else { Add-Issue "DC1 cannot resolve external DNS. Check forwarders: Get-DnsServerForwarder on DC1" }
   ```

   e. **Member server domain join check** (for svr1, ws1):
   ```powershell
   foreach ($memberVM in @($ExpectedVMs | Where-Object { $_ -notin @('DC1', 'LIN1') })) {
       $joinCheck = Invoke-LabStructuredCheck -ComputerName $memberVM -RequiredProperty 'Domain' -ScriptBlock {
           $cs = Get-CimInstance Win32_ComputerSystem
           [pscustomobject]@{ Domain = $cs.Domain; PartOfDomain = $cs.PartOfDomain }
       } -ErrorAction SilentlyContinue
       if ($joinCheck -and $joinCheck.PartOfDomain) {
           Add-Ok "$memberVM joined to domain '$($joinCheck.Domain)'"
       } else {
           Add-Issue "$memberVM not joined to domain. Expected: '$($GlobalLabConfig.Lab.DomainName)'"
       }
   }
   ```

2. **Create Tests/NetworkHealth.Tests.ps1:**
   - Test: Test-LabNetwork accepts -SwitchName parameter
   - Test: Test-LabNetwork returns structured object with Exists, SwitchType, Status properties
   - Test: Test-LabNetworkHealth returns structured object with OverallStatus, ConnectivityTests
   - Mock Get-VMSwitch, Get-NetNat for isolated testing
  </action>
  <verify>
- Test-OpenCodeLabHealth.ps1 contains checks for vSwitch, NAT, gateway IP, DNS, and domain join
- Each infrastructure issue includes an actionable remediation command
- Pester tests pass: `Invoke-Pester Tests/NetworkHealth.Tests.ps1 -PassThru`
  </verify>
  <done>Health check covers full infrastructure. Network test functions are config-aware. Tests validate the check functions.</done>
</task>

</tasks>

<verification>
- Test-LabNetwork uses $GlobalLabConfig.Network.SwitchName instead of hardcoded "SimpleLab"
- Test-OpenCodeLabHealth checks: VM state, AD DS, vSwitch, NAT, gateway IP, DNS resolution, domain join
- Each health issue includes actionable remediation
- Network tests pass in isolation with mocked Hyper-V cmdlets
</verification>

<success_criteria>
1. Test-LabNetwork reads switch name from config
2. Health check covers vSwitch, NAT, DNS, domain join in addition to VM state
3. All diagnostics are actionable (tell operator what to run)
4. Tests validate network check functions
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-lifecycle-integration/03-03-SUMMARY.md`
</output>
