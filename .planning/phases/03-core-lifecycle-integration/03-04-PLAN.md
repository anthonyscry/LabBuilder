---
phase: 03-core-lifecycle-integration
plan: 04
type: execute
wave: 2
depends_on:
  - 03-01
  - 03-02
files_modified:
  - OpenCodeLab-App.ps1
  - Bootstrap.ps1
  - Private/Clear-LabSSHKnownHosts.ps1
  - Tests/TeardownIdempotency.Tests.ps1
autonomous: true
requirements:
  - LIFE-04
  - LIFE-05
  - CLI-07
  - CLI-03

must_haves:
  truths:
    - "Invoke-BlowAway calls Clear-LabSSHKnownHosts during teardown to remove stale host keys"
    - "All destructive actions (blow-away, one-button-reset, teardown full) require scoped confirmation tokens or typed confirmation"
    - "Bootstrap.ps1 is idempotent: skips already-installed prerequisites, re-creates only missing resources"
    - "Re-deploy after teardown succeeds: Invoke-BlowAway + full deploy produces working lab"
  artifacts:
    - path: "OpenCodeLab-App.ps1"
      provides: "SSH known_hosts cleanup in teardown, confirmation gates on all destructive actions"
      contains: "Clear-LabSSHKnownHosts"
    - path: "Bootstrap.ps1"
      provides: "Idempotent prerequisite installation"
      contains: "already installed|already exists"
    - path: "Tests/TeardownIdempotency.Tests.ps1"
      provides: "Tests for teardown completeness and bootstrap idempotency"
      contains: "Describe.*Teardown"
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Clear-LabSSHKnownHosts.ps1"
      via: "Called in Invoke-BlowAway teardown flow"
      pattern: "Clear-LabSSHKnownHosts"
---

<objective>
Harden teardown to clean all resources (including SSH known_hosts), wire confirmation tokens to all destructive actions, and make Bootstrap.ps1 idempotent.

Purpose: Teardown currently leaves stale SSH known_hosts entries that cause "REMOTE HOST IDENTIFICATION HAS CHANGED" errors on redeploy. Bootstrap.ps1 reinstalls prerequisites on every run even if already present. Destructive actions lack consistent confirmation gates.

Output: Teardown cleans SSH known_hosts. All destructive actions have confirmation gates. Bootstrap skips already-installed items. Re-deploy after teardown succeeds cleanly.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-lifecycle-integration/03-RESEARCH.md
@.planning/phases/03-core-lifecycle-integration/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden teardown and add confirmation gates</name>
  <files>OpenCodeLab-App.ps1</files>
  <action>
1. **Add SSH known_hosts cleanup to Invoke-BlowAway:**
   After step 4 (removing lab files) and before step 5 (network cleanup), add:
   ```powershell
   Write-Host "  [4b/5] Clearing SSH known hosts..." -ForegroundColor Cyan
   if (Get-Command Clear-LabSSHKnownHosts -ErrorAction SilentlyContinue) {
       try {
           Clear-LabSSHKnownHosts
           Write-Host "    SSH known_hosts cleared" -ForegroundColor Gray
       } catch {
           Write-LabStatus -Status WARN -Message "SSH known_hosts cleanup failed: $($_.Exception.Message)"
       }
   }
   ```

2. **Add NAT cleanup verification** in step 5:
   After `Remove-NetNat`, verify it's actually gone:
   ```powershell
   $natCheck = Get-NetNat -Name $GlobalLabConfig.Network.NatName -ErrorAction SilentlyContinue
   if ($natCheck) {
       Write-LabStatus -Status WARN -Message "NAT '$($GlobalLabConfig.Network.NatName)' still present after removal attempt"
   }
   ```

3. **Add confirmation consistency to Invoke-OneButtonReset:**
   Currently Invoke-OneButtonReset bypasses prompt. Add a confirmation check when not in NonInteractive mode:
   - In the interactive menu handler for 'R', the "REBUILD" typed confirmation already exists — ensure it's consistent
   - For direct `-Action one-button-reset`, check if `-Force` or `-NonInteractive` is set; if not, require typed confirmation

4. **Ensure Invoke-BlowAway Simulate mode reports all steps** including the new SSH cleanup step.
  </action>
  <verify>
- `Select-String -Path OpenCodeLab-App.ps1 -Pattern 'Clear-LabSSHKnownHosts'` returns at least one hit in Invoke-BlowAway
- Invoke-BlowAway Simulate mode output includes SSH known_hosts step
- NAT removal verification exists after Remove-NetNat
  </verify>
  <done>Teardown cleans SSH known_hosts, verifies NAT removal, and all destructive actions have confirmation gates.</done>
</task>

<task type="auto">
  <name>Task 2: Make Bootstrap.ps1 idempotent and add tests</name>
  <files>Bootstrap.ps1, Tests/TeardownIdempotency.Tests.ps1</files>
  <action>
1. **Bootstrap.ps1 idempotency improvements:**
   - Step 1 (NuGet): Already idempotent (checks version) — no change needed
   - Step 2 (Pester fix): Check if Pester module conflict exists before attempting fix
   - Step 3 (PSFramework): Add `Get-Module -ListAvailable -Name PSFramework` check; skip if installed
   - Step 4 (SHiPS): Add `Get-Module -ListAvailable -Name SHiPS` check; skip if installed
   - Step 5 (AutomatedLab): Already has check (`Get-Module -ListAvailable`) — verify logic is correct
   - Step 6 (LabSources): Already creates only if missing (`New-Item -Force`) — no change needed
   - Step 7 (Hyper-V): Already a read-only check — no change needed
   - Step 8 (vSwitch+NAT): Check if switch/NAT already exist before creating — use idempotent pattern
   - Step 9 (ISOs): Already a read-only check — no change needed

   For each skipped step, output Write-Skip "X already installed" message.

2. **Create Tests/TeardownIdempotency.Tests.ps1:**
   - Test: Invoke-BlowAway function definition contains Clear-LabSSHKnownHosts call
   - Test: Invoke-BlowAway Simulate path includes SSH cleanup step text
   - Test: Bootstrap.ps1 contains idempotency checks for PSFramework, SHiPS (Get-Module -ListAvailable)
   - Test: Bootstrap.ps1 vSwitch creation checks for existing switch before creating
  </action>
  <verify>
- Bootstrap.ps1 contains `Get-Module -ListAvailable -Name PSFramework` check
- Bootstrap.ps1 vSwitch section checks for existing switch
- Tests pass: `Invoke-Pester Tests/TeardownIdempotency.Tests.ps1 -PassThru`
  </verify>
  <done>Bootstrap.ps1 is idempotent. Teardown tests validate completeness. Re-deploy after teardown flow is verified.</done>
</task>

</tasks>

<verification>
- Teardown cleans SSH known_hosts entries
- NAT removal is verified after removal attempt
- Bootstrap.ps1 skips already-installed prerequisites
- All destructive actions have confirmation checks
- Tests verify teardown completeness and bootstrap idempotency
</verification>

<success_criteria>
1. Invoke-BlowAway cleans SSH known_hosts
2. NAT removal is verified
3. Bootstrap.ps1 is idempotent (skip already-installed)
4. All destructive actions have confirmation gates
5. Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-lifecycle-integration/03-04-SUMMARY.md`
</output>
