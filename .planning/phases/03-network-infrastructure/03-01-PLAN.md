---
phase: 03-network-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - SimpleLab/Public/Test-LabNetwork.ps1
  - SimpleLab/Public/New-LabSwitch.ps1
  - SimpleLab/SimpleLab.psm1
autonomous: true

must_haves:
  truths:
    - Tool creates dedicated Internal vSwitch named "SimpleLab" when it does not exist
    - Tool reports vSwitch status (exists/created) with clear messaging
    - Tool skips creation if vSwitch already exists (idempotent)
    - Tool handles Hyper-V module availability errors gracefully
  artifacts:
    - path: SimpleLab/Public/Test-LabNetwork.ps1
      provides: vSwitch existence detection function
      min_lines: 30
      exports: [Test-LabNetwork]
    - path: SimpleLab/Public/New-LabSwitch.ps1
      provides: vSwitch creation function
      min_lines: 40
      exports: [New-LabSwitch]
  key_links:
    - from: Test-LabNetwork.ps1
      to: Hyper-V module
      via: Get-VMSwitch cmdlet
      pattern: Get-VMSwitch.*-Name.*SimpleLab
    - from: New-LabSwitch.ps1
      to: Hyper-V module
      via: New-VMSwitch cmdlet
      pattern: New-VMSwitch.*-SwitchType.*Internal
---

<objective>
Create Internal vSwitch for isolated lab network

Purpose: Establish network foundation for lab VMs with a dedicated Internal virtual switch named "SimpleLab" that provides VM-to-VM communication while isolating from the host's production network.

Output: Test-LabNetwork and New-LabSwitch functions for detecting and creating the lab vSwitch
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern reference from prior phases
@SimpleLab/Public/Test-HyperVEnabled.ps1
@SimpleLab/Public/Test-LabPrereqs.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test-LabNetwork function for vSwitch detection</name>
  <files>SimpleLab/Public/Test-LabNetwork.ps1</files>
  <action>
    Create Test-LabNetwork function in Public/ that:
    - Accepts no parameters (defaults to checking for "SimpleLab" vSwitch)
    - Returns PSCustomObject with properties: SwitchName, Exists, SwitchType, Status, Message
    - Uses Get-VMSwitch -Name "SimpleLab" -ErrorAction SilentlyContinue to check existence
    - Handles Hyper-V module not available scenario (return Exists=$false with error message)
    - Returns Status = "OK" if switch exists, "NotFound" if not found
    - Include descriptive Message: "SimpleLab vSwitch exists" or "SimpleLab vSwitch not found"

    Pattern reference: Follow Test-HyperVEnabled.ps1 error handling pattern with try/catch
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Test-LabNetwork
    3. Verify output contains SwitchName, Exists, SwitchType, Status, Message properties
    4. Verify function returns without error when Hyper-V module is available
  </verify>
  <done>
    Test-LabNetwork function returns PSCustomObject indicating whether "SimpleLab" vSwitch exists with all required properties
  </done>
</task>

<task type="auto">
  <name>Task 2: Create New-LabSwitch function for vSwitch creation</name>
  <files>SimpleLab/Public/New-LabSwitch.ps1</files>
  <action>
    Create New-LabSwitch function in Public/ that:
    - Accepts optional parameters: SwitchName (default "SimpleLab"), Force (switch parameter)
    - Idempotent: Checks if switch exists first using Test-LabNetwork, skips creation if Exists=$true unless Force specified
    - Creates Internal vSwitch using: New-VMSwitch -Name $SwitchName -SwitchType Internal
    - Returns PSCustomObject with properties: SwitchName, Created, Status, Message, SwitchType
    - Status values: "OK" (created or already exists), "Failed" (creation error)
    - Message provides clear feedback: "SimpleLab vSwitch created", "SimpleLab vSwitch already exists", or creation error details
    - Uses try/catch with structured error handling
    - Validates Hyper-V availability before attempting creation

    Pattern reference: Follow orchestrator pattern from Test-LabPrereqs.ps1 (return structured result)
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: New-LabSwitch
    3. Verify output has SwitchName, Created, Status, Message, SwitchType properties
    4. Verify running again without Force returns "already exists" Status
    5. Verify running with -Force recreates the switch
  </verify>
  <done>
    New-LabSwitch function creates "SimpleLab" Internal vSwitch idempotently and returns structured result with creation status
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SimpleLab.psm1 to export new functions</name>
  <files>SimpleLab/SimpleLab.psm1</files>
  <action>
    Update SimpleLab.psm1 Export-ModuleMember to include:
    - Add 'Test-LabNetwork' to exported function list
    - Add 'New-LabSwitch' to exported function list

    Maintain existing alphabetical ordering in the Export-ModuleMember array
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Test-LabNetwork and New-LabSwitch appear in output
  </verify>
  <done>
    Test-LabNetwork and New-LabSwitch functions are exported from SimpleLab module and available for use
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Test-LabNetwork returns correct status when SimpleLab vSwitch does not exist
2. New-LabSwitch creates the vSwitch and returns Status="OK", Created=$true
3. Running New-LabSwitch again returns Status="OK", Created=$false (already exists)
4. vSwitch appears in Get-VMSwitch output with SwitchType="Internal"
</verification>

<success_criteria>
1. Tool creates Internal vSwitch named "SimpleLab" with single command
2. Tool reports clear status indicating switch creation or existing state
3. Function handles missing Hyper-V module gracefully with error message
4. vSwitch persists after creation (visible in Get-VMSwitch output)
</success_criteria>

<output>
After completion, create `.planning/phases/03-network-infrastructure/03-01-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Any deviations from plan
</output>
