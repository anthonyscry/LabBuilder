---
phase: 03-network-infrastructure
plan: 03
type: execute
wave: 3
depends_on: [03-01, 03-02]
files_modified:
  - SimpleLab/Private/Test-VMNetworkConnectivity.ps1
  - SimpleLab/Public/Test-LabNetworkHealth.ps1
  - SimpleLab/SimpleLab.psm1
autonomous: false

must_haves:
  truths:
    - Tool verifies VMs can communicate with each other after network setup
    - Tool provides clear pass/fail status for network connectivity
    - Tool identifies which VMs are reachable/unreachable
    - User can run single command to validate entire lab network
  artifacts:
    - path: SimpleLab/Private/Test-VMNetworkConnectivity.ps1
      provides: Individual VM-to-VM connectivity test via PowerShell Direct
      min_lines: 40
    - path: SimpleLab/Public/Test-LabNetworkHealth.ps1
      provides: Network health orchestrator for full lab validation
      min_lines: 50
      exports: [Test-LabNetworkHealth]
  key_links:
    - from: Test-LabNetworkHealth.ps1
      to: Test-LabNetwork.ps1 (from 03-01)
      via: Function call to verify vSwitch exists
      pattern: Test-LabNetwork
    - from: Test-LabNetworkHealth.ps1
      to: Get-LabNetworkConfig.ps1 (from 03-02)
      via: Function call to get VM list and IP assignments
      pattern: Get-LabNetworkConfig
    - from: Test-LabNetworkHealth.ps1
      to: Test-VMNetworkConnectivity.ps1
      via: Function call per VM pair
      pattern: Test-VMNetworkConnectivity
    - from: Test-VMNetworkConnectivity.ps1
      to: Target VMs
      via: PowerShell Direct (Invoke-Command -VMName) with Test-Connection
      pattern: Invoke-Command.*Test-Connection
---

<objective>
Validate network connectivity between lab VMs

Purpose: Provide verification that lab VMs can communicate with each other after network setup, ensuring the isolated lab network is functioning correctly before proceeding to domain configuration.

Output: Network health validation system with clear pass/fail reporting
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern reference from prior phases
@SimpleLab/Public/Test-LabPrereqs.ps1
@SimpleLab/Private/Write-ValidationReport.ps1

# Network infrastructure from prior plans in this phase
@SimpleLab/Public/Test-LabNetwork.ps1
@SimpleLab/Public/New-LabSwitch.ps1
@SimpleLab/Private/Get-LabNetworkConfig.ps1
@SimpleLab/Private/Set-VMStaticIP.ps1
@SimpleLab/Public/Initialize-LabNetwork.ps1
@.planning/phases/03-network-infrastructure/03-01-SUMMARY.md
@.planning/phases/03-network-infrastructure/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test-VMNetworkConnectivity for VM-to-VM ping test</name>
  <files>SimpleLab/Private/Test-VMNetworkConnectivity.ps1</files>
  <action>
    Create Test-VMNetworkConnectivity function in Private/ that:
    - Parameters: SourceVM (string, mandatory), TargetIP (string, mandatory), Count (int, default 4)
    - Uses PowerShell Direct to execute Test-Connection inside SourceVM
    - Invoke-Command -VMName $SourceVM -ScriptBlock { param($ip, $count) Test-Connection -ComputerName $ip -Count $count -Quiet }
    - Returns PSCustomObject with: SourceVM, TargetIP, Reachable, Status, Message
    - Reachable: $true if all pings succeed, $false otherwise
    - Status values: "OK" (reachable), "Failed" (unreachable), "VMNotFound" (source VM not running), "Error" (exception)
    - Message provides details: "Reachable from {SourceVM} to {TargetIP}", "Unreachable", or error details
    - Handles VM not running and PowerShell Direct errors gracefully
    - Internal function only (not exported)

    Pattern reference: Follow Test-LabPrereqs.ps1 error handling pattern
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Test-VMNetworkConnectivity -SourceVM "NonExistentVM" -TargetIP "10.0.0.1"
    3. Verify output contains SourceVM, TargetIP, Reachable, Status, Message properties
    4. Verify Status="VMNotFound" for non-existent VM
  </verify>
  <done>
    Test-VMNetworkConnectivity function tests connectivity from source VM to target IP and returns structured result
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Test-LabNetworkHealth orchestrator</name>
  <files>SimpleLab/Public/Test-LabNetworkHealth.ps1</files>
  <action>
    Create Test-LabNetworkHealth function in Public/ that:
    - Parameters: VMNames (string array, optional - defaults to "SimpleDC", "SimpleServer", "SimpleWin11")
    - Orchestrates full network health validation:
      1. Check vSwitch exists using Test-LabNetwork
      2. Get network config using Get-LabNetworkConfig
      3. Test VM-to-VM connectivity for all pairs (skip self-pairs)
      4. Each VM pings all other VMs' assigned IPs
    - Returns PSCustomObject with: OverallStatus, ConnectivityTests (array), FailedTests (array), Duration
    - OverallStatus values: "OK" (all tests pass), "Partial" (some fail), "Failed" (vSwitch missing or all tests fail), "Warning" (VMs not running)
    - ConnectivityTests array contains Test-VMNetworkConnectivity results
    - FailedTests array contains only failed test results
    - Tests array format: SourceVM, TargetIP, TargetVM (resolved from IP), Reachable, Status
    - Measures execution duration using New-TimeSpan
    - Provides summary Message with count of passed/failed tests
    - Special handling: If vSwitch doesn't exist, return OverallStatus="Failed" with message to run New-LabSwitch first

    Pattern reference: Follow Test-LabPrereqs orchestrator pattern (structured result with checks array)
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Test-LabNetworkHealth (without running VMs)
    3. Verify output contains OverallStatus, ConnectivityTests, FailedTests, Duration properties
    4. Verify OverallStatus reflects network state (likely "Warning" if VMs not running)
  </verify>
  <done>
    Test-LabNetworkHealth function orchestrates full network health validation and returns structured result
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SimpleLab.psm1 to export Test-LabNetworkHealth</name>
  <files>SimpleLab/SimpleLab.psm1</files>
  <action>
    Update SimpleLab.psm1 Export-ModuleMember to include:
    - Add 'Test-LabNetworkHealth' to exported function list

    Maintain existing alphabetical ordering in the Export-ModuleMember array
    Note: Test-VMNetworkConnectivity remains internal (Private/)
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Test-LabNetworkHealth appears in output
    4. Verify Test-VMNetworkConnectivity does NOT appear (internal function)
  </verify>
  <done>
    Test-LabNetworkHealth function is exported from SimpleLab module and available for use
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify complete network infrastructure</name>
  <files>SimpleLab/Public/Test-LabNetwork.ps1, SimpleLab/Public/New-LabSwitch.ps1, SimpleLab/Public/Initialize-LabNetwork.ps1, SimpleLab/Public/Test-LabNetworkHealth.ps1</files>
  <action>
    Verify the complete Phase 3 network infrastructure by testing all network functions.

    No code changes - verification checkpoint only.
  </action>
  <verify>
    1. Check vSwitch exists:
       ```powershell
       Import-Module ./SimpleLab/SimpleLab.psd1
       Test-LabNetwork
       ```
       Expected: Output shows "SimpleLab" vSwitch exists

    2. Verify IP configuration is stored:
       ```powershell
       Get-LabNetworkConfig
       ```
       Expected: Output shows IP assignments (SimpleDC: 10.0.0.1, SimpleServer: 10.0.0.2, SimpleWin11: 10.0.0.3)

    3. Run network health check:
       ```powershell
       Test-LabNetworkHealth
       ```
       Expected: Returns structured result with OverallStatus (may be "Warning" if VMs not running yet)

    4. Verify all network functions are exported:
       ```powershell
       Get-Command -Module SimpleLab | Where-Object {$_.Name -like "*Network*"}
       ```
       Expected: Shows Test-LabNetwork, New-LabSwitch, Initialize-LabNetwork, Test-LabNetworkHealth
  </verify>
  <done>
    All network infrastructure functions are working correctly and Phase 3 success criteria are met
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Test-VMNetworkConnectivity tests connectivity from source VM to target IP
2. Test-LabNetworkHealth orchestrates full network validation with vSwitch check
3. Test-LabNetworkHealth handles missing vSwitch with clear error message
4. Test-LabNetworkHealth returns structured result with OverallStatus, ConnectivityTests, FailedTests, Duration
5. All public network functions are exported from module
</verification>

<success_criteria>
1. Tool provides single command to validate lab network health
2. Tool reports clear pass/fail status for VM-to-VM connectivity
3. Tool identifies which specific connections are failing
4. User can verify network setup before proceeding to domain configuration
</success_criteria>

<output>
After completion, create `.planning/phases/03-network-infrastructure/03-03-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Verification checkpoint results
- Any deviations from plan

Phase 3 completion: Update STATE.md and ROADMAP.md with Phase 3 completion status
</output>
