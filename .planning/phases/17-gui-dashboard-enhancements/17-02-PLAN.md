---
phase: 17-gui-dashboard-enhancements
plan: 02
type: execute
wave: 2
depends_on:
  - 17-01
files_modified:
  - Tests/DashboardEnhancements.Tests.ps1
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03

must_haves:
  truths:
    - "Get-LabHealthState returns correct state for all VM status combinations"
    - "Health banner color mapping covers all four states"
    - "Bulk action handlers call correct Hyper-V cmdlets for each VM"
  artifacts:
    - path: "Tests/DashboardEnhancements.Tests.ps1"
      provides: "Pester 5.x tests covering health state logic, resource summary formatting, and bulk action wiring"
      contains: "Describe 'Dashboard Enhancements'"
  key_links:
    - from: "Tests/DashboardEnhancements.Tests.ps1"
      to: "GUI/Start-OpenCodeLabGUI.ps1"
      via: "dot-source and invoke Get-LabHealthState"
      pattern: "Get-LabHealthState"
---

<objective>
Create Pester tests for the three dashboard enhancement features: health banner logic, resource summary formatting, and bulk action command coverage.

Purpose: Verify correctness of health state derivation and resource display without requiring a live GUI or Hyper-V host.
Output: Comprehensive test file covering all DASH requirements.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/17-gui-dashboard-enhancements/17-01-SUMMARY.md
@GUI/Start-OpenCodeLabGUI.ps1
@Private/Get-LabHostResourceInfo.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pester tests for health state logic and resource formatting</name>
  <files>Tests/DashboardEnhancements.Tests.ps1</files>
  <action>
Create a Pester 5.x test file `Tests/DashboardEnhancements.Tests.ps1`. The file must test the `Get-LabHealthState` function which was added to `GUI/Start-OpenCodeLabGUI.ps1` in Plan 01.

**BeforeAll block:**
- Set `$repoRoot = Split-Path -Parent $PSScriptRoot`
- The `Get-LabHealthState` function is defined in `GUI/Start-OpenCodeLabGUI.ps1`, but that file loads WPF assemblies and the whole GUI. To avoid loading the full GUI, extract and dot-source ONLY the function. Use this pattern:
  ```powershell
  $guiScript = Get-Content (Join-Path $repoRoot 'GUI/Start-OpenCodeLabGUI.ps1') -Raw
  # Extract Get-LabHealthState function using IndexOf-based extraction
  $funcStart = $guiScript.IndexOf('function Get-LabHealthState')
  # Find matching closing brace by counting braces from funcStart
  ```
  Alternatively, since the function is pure logic with no WPF dependencies, use a simpler approach: write a small script block that recreates the function definition by extracting it from the source file. The IndexOf + brace-counting approach was used successfully in Phase 16-02 tests.

  Actually, the cleanest pattern given prior phases: mock everything WPF-related and use Select-String to verify code structure. But for Get-LabHealthState being pure logic, extraction is better.

  **Best approach:** Use `Select-String` to verify structural properties of the source file AND define a local copy of Get-LabHealthState logic for unit testing. This avoids loading WPF assemblies entirely.

**Describe 'Dashboard Enhancements':**

**Context 'Get-LabHealthState logic' (DASH-01):**
- Define a local function matching Get-LabHealthState's logic for testing
- Test: No VMs (null input) returns State='No Lab', Detail contains 'No VMs'
- Test: No VMs (empty array) returns State='No Lab'
- Test: All VMs running returns State='Healthy', Detail matches "X of X VMs running"
- Test: Some VMs running, some off returns State='Degraded'
- Test: No VMs running returns State='Offline', Detail matches "0 of X VMs running"
- Test: Mixed states (Running, Paused, Saved) - only 'Running' counts as running, so Paused/Saved = Degraded

Each test creates mock VM status objects like:
```powershell
$mockVMs = @(
    [PSCustomObject]@{ VMName = 'dc1'; State = 'Running' },
    [PSCustomObject]@{ VMName = 'svr1'; State = 'Off' }
)
```

**Context 'Health banner source structure' (DASH-01):**
- Use Select-String on GUI/Start-OpenCodeLabGUI.ps1 to verify:
  - File contains 'healthBanner' element resolution (FindName)
  - File contains health state color mapping for all 4 states
  - Health banner background is set based on state

**Context 'Resource summary source structure' (DASH-02):**
- Use Select-String on GUI/Start-OpenCodeLabGUI.ps1 to verify:
  - File contains 'txtRAMUsage' element resolution
  - File contains 'txtCPUUsage' element resolution
  - File references Get-LabHostResourceInfo

**Context 'DashboardView.xaml structure' (DASH-01, DASH-02, DASH-03):**
- Load DashboardView.xaml as XML
- Verify x:Name="healthBanner" exists
- Verify x:Name="txtHealthState" exists
- Verify x:Name="txtHealthDetail" exists
- Verify x:Name="txtRAMUsage" exists
- Verify x:Name="txtCPUUsage" exists
- Verify x:Name="btnStartAll" exists
- Verify x:Name="btnStopAll" exists
- Verify x:Name="btnSaveCheckpoint" exists

**Context 'Bulk action source structure' (DASH-03):**
- Use Select-String on GUI/Start-OpenCodeLabGUI.ps1 to verify:
  - File contains 'btnStartAll' click handler wiring (Add_Click)
  - File contains 'btnStopAll' click handler wiring
  - File contains 'btnSaveCheckpoint' click handler wiring
  - File contains Start-VM call within a bulk handler context
  - File contains Stop-VM call
  - File contains Checkpoint-VM call

Use `[System.IO.File]::ReadAllText()` or `Get-Content -Raw` for source analysis. Use `Select-String -Pattern` for structural checks. Use `[xml]` cast for XAML validation.

Follow the established test pattern from Phase 16-02: IndexOf-based block extraction for source analysis, structural assertions via Select-String, and mock objects for unit logic.

Each test should have descriptive names like:
- 'returns Healthy when all VMs are running'
- 'returns Degraded when some VMs are off'
- 'DashboardView.xaml contains healthBanner element'
  </action>
  <verify>
Run: `pwsh -Command "Invoke-Pester -Path 'Tests/DashboardEnhancements.Tests.ps1' -Output Detailed -PassThru | Select-Object -Property Result,TotalCount,PassedCount,FailedCount"`

All tests pass. Expect 15+ tests covering health state logic (6+), XAML structure (8+), and source structure (6+).
  </verify>
  <done>
DashboardEnhancements.Tests.ps1 exists with passing Pester tests covering:
- Get-LabHealthState logic for all 4 states (Healthy, Degraded, Offline, No Lab)
- DashboardView.xaml element names for all DASH requirements
- Source structure verification for health banner, resource summary, and bulk action wiring
  </done>
</task>

</tasks>

<verification>
1. `Invoke-Pester -Path Tests/DashboardEnhancements.Tests.ps1` passes all tests
2. Tests cover all 4 health states with mock VM data
3. Tests verify XAML element names match what Initialize-DashboardView resolves
4. Tests verify bulk action button handlers reference correct Hyper-V cmdlets
5. No WPF assembly loading required in test execution
</verification>

<success_criteria>
- All Pester tests pass on Linux (no Hyper-V dependency in tests)
- Health state logic tests cover null, empty, all-running, partial, none-running scenarios
- XAML structure tests confirm all 8 named elements exist
- Source structure tests confirm wiring for all 3 features
- Test count: 15+ tests minimum
</success_criteria>

<output>
After completion, create `.planning/phases/17-gui-dashboard-enhancements/17-02-SUMMARY.md`
</output>
