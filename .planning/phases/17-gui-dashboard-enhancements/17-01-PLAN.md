---
phase: 17-gui-dashboard-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GUI/Views/DashboardView.xaml
  - GUI/Start-OpenCodeLabGUI.ps1
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03

must_haves:
  truths:
    - "Dashboard shows a health banner with overall lab state (Healthy / Degraded / Offline / No Lab) that updates on each 5-second poll"
    - "Dashboard shows total RAM and CPU allocated across running VMs compared to host availability"
    - "Dashboard has Start All, Stop All, and Save Checkpoint buttons that apply to all lab VMs"
  artifacts:
    - path: "GUI/Views/DashboardView.xaml"
      provides: "Health banner, resource summary panel, and bulk action buttons layout"
      contains: "healthBanner"
    - path: "GUI/Start-OpenCodeLabGUI.ps1"
      provides: "Initialize-DashboardView with health banner logic, resource probe, and bulk action handlers"
      contains: "Get-LabHostResourceInfo"
  key_links:
    - from: "GUI/Start-OpenCodeLabGUI.ps1"
      to: "Private/Get-LabHostResourceInfo.ps1"
      via: "function call in polling timer"
      pattern: "Get-LabHostResourceInfo"
    - from: "GUI/Start-OpenCodeLabGUI.ps1"
      to: "Private/Get-LabSnapshotInventory.ps1"
      via: "function call for checkpoint save"
      pattern: "Checkpoint-VM"
---

<objective>
Add health banner, resource usage summary, and bulk quick-action buttons to the GUI dashboard.

Purpose: Operators see lab health and resource state at a glance and can perform common bulk operations without switching to CLI.
Output: Updated DashboardView.xaml with three new UI sections and fully wired Initialize-DashboardView function.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@GUI/Views/DashboardView.xaml
@GUI/Start-OpenCodeLabGUI.ps1
@GUI/Components/VMCard.xaml
@GUI/Themes/Dark.xaml
@Private/Get-LabHostResourceInfo.ps1
@Private/Get-LabSnapshotInventory.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add health banner, resource summary, and bulk buttons to DashboardView.xaml</name>
  <files>GUI/Views/DashboardView.xaml</files>
  <action>
Restructure DashboardView.xaml to add three new sections above the existing VM cards + topology layout. The current Grid has two columns (VM cards left, topology right). Wrap the existing content in a new outer Grid with row definitions to stack the new sections on top.

**New layout (top to bottom):**

1. **Health Banner (Row 0):** A full-width Border with x:Name="healthBanner" containing a StackPanel with:
   - TextBlock x:Name="txtHealthState" for the state label (e.g. "Healthy", "Degraded", "Offline", "No Lab"), FontSize 16, FontWeight SemiBold
   - TextBlock x:Name="txtHealthDetail" for a secondary detail line (e.g. "3 of 3 VMs running"), FontSize 12, using TextSecondaryBrush
   - Use DynamicResource for all brushes (BackgroundBrush, TextPrimaryBrush, etc.)
   - The banner background will be set dynamically in code (green=Healthy, yellow=Degraded, red=Offline, gray=No Lab) so give it a default CardBackgroundBrush via DynamicResource
   - Style the border with CornerRadius 8, Padding 12, Margin 0,0,0,12

2. **Resource Summary + Bulk Actions row (Row 1):** A horizontal Grid with two columns:
   - Left column: Resource summary panel with x:Name="pnlResourceSummary", a Border with CardBorder style containing:
     - TextBlock header "Resource Usage" using HeaderLabel style, Margin 0,0,0,8
     - TextBlock x:Name="txtRAMUsage" for RAM info (e.g. "RAM: 12.0 / 32.0 GB"), FontSize 13
     - TextBlock x:Name="txtCPUUsage" for CPU info (e.g. "CPU: 8 / 16 cores allocated"), FontSize 13
     - Both use TextSecondaryBrush foreground
   - Right column: Bulk actions panel, a Border with CardBorder style containing:
     - TextBlock header "Quick Actions" using HeaderLabel style, Margin 0,0,0,8
     - StackPanel Orientation="Horizontal" with three Buttons using ModernButton style:
       - x:Name="btnStartAll" Content="Start All" Padding 12,6 Margin 0,0,8,0
       - x:Name="btnStopAll" Content="Stop All" Padding 12,6 Margin 0,0,8,0
       - x:Name="btnSaveCheckpoint" Content="Save Checkpoint" Padding 12,6
   - Give the row Margin 0,0,0,12

3. **Existing content (Row 2):** Move the current two-column Grid (VM cards + topology) into Row 2, unchanged.

Use DynamicResource for ALL brush references (TextPrimaryBrush, TextSecondaryBrush, CardBackgroundBrush, etc.) to support theme switching. Do NOT use StaticResource in view XAML.
  </action>
  <verify>
Open the XAML file and confirm:
- All x:Name attributes are present: healthBanner, txtHealthState, txtHealthDetail, txtRAMUsage, txtCPUUsage, btnStartAll, btnStopAll, btnSaveCheckpoint
- All brush references use DynamicResource
- The existing vmCardContainer and topologyCanvas names are preserved
- XML is well-formed (no unclosed tags)

Run: `pwsh -Command "[xml](Get-Content 'GUI/Views/DashboardView.xaml' -Raw)"` to validate XML parsing.
  </verify>
  <done>DashboardView.xaml contains health banner, resource summary, bulk action buttons, and existing VM card/topology sections in a 3-row layout with all required named elements.</done>
</task>

<task type="auto">
  <name>Task 2: Wire health banner, resource probe, and bulk actions in Initialize-DashboardView</name>
  <files>GUI/Start-OpenCodeLabGUI.ps1</files>
  <action>
Modify the `Initialize-DashboardView` function in `GUI/Start-OpenCodeLabGUI.ps1` to wire up the three new dashboard features. Also add a helper function `Get-LabHealthState` above `Initialize-DashboardView`.

**New helper function `Get-LabHealthState`:**
```
function Get-LabHealthState {
    [CmdletBinding()]
    param(
        [Parameter()]
        $VMStatuses
    )
    # Returns PSCustomObject with State (string) and Detail (string)
    # Logic:
    # - If $VMStatuses is null/empty: State='No Lab', Detail='No VMs configured'
    # - Count running VMs vs total VMs
    # - All running: State='Healthy', Detail="$total of $total VMs running"
    # - Some running: State='Degraded', Detail="$running of $total VMs running"
    # - None running: State='Offline', Detail="0 of $total VMs running"
}
```

**Modifications to Initialize-DashboardView:**

After resolving vmContainer and other existing elements, also resolve the new named elements:
```
$healthBanner = $viewElement.FindName('healthBanner')
$txtHealthState = $viewElement.FindName('txtHealthState')
$txtHealthDetail = $viewElement.FindName('txtHealthDetail')
$txtRAMUsage = $viewElement.FindName('txtRAMUsage')
$txtCPUUsage = $viewElement.FindName('txtCPUUsage')
$btnStartAll = $viewElement.FindName('btnStartAll')
$btnStopAll = $viewElement.FindName('btnStopAll')
$btnSaveCheckpoint = $viewElement.FindName('btnSaveCheckpoint')
```

**Add a new helper function `Update-DashboardBanner`** (can be defined inside Initialize-DashboardView scope or as a script block):
- Takes $VMStatuses parameter
- Calls `Get-LabHealthState -VMStatuses $VMStatuses`
- Sets txtHealthState.Text to the State
- Sets txtHealthDetail.Text to the Detail
- Sets healthBanner.Background based on State:
  - 'Healthy': New SolidColorBrush with Color #1B5E20 (dark green) for dark theme / #C8E6C9 for light, or simpler: use a semi-transparent green. Best approach: create a SolidColorBrush from hex. Use `[System.Windows.Media.SolidColorBrush]::new([System.Windows.Media.Color]::FromRgb(27,94,32))` for Healthy (dark green), `FromRgb(183,149,38)` for Degraded (dark yellow), `FromRgb(183,28,28)` for Offline (dark red), and use the CardBackgroundBrush from resources for No Lab.

**Add a new helper function `Update-ResourceSummary`** (script block inside Initialize-DashboardView):
- Calls `Get-LabHostResourceInfo` to get host resources (FreeRAMGB, FreeDiskGB, LogicalProcessors)
- Calculates total allocated RAM from VMStatuses: sum of MemoryGB properties where value is not 'N/A'
- Calculates total allocated CPUs from VMStatuses: count of running VMs * assumed processors (or if available from Get-VM ProcessorCount)
- Actually, for CPU: count running VMs and show "X VMs running / Y logical cores on host"
- For RAM: Calculate totalAssignedGB from running VMs. Get-LabStatus returns MemoryGB (e.g. "4 GB"). Parse numeric value. Show "RAM: {totalAssigned} GB assigned / {totalHost} GB total ({freeRAM} GB free)"
- Sets txtRAMUsage.Text and txtCPUUsage.Text
- Wrap in try/catch: on failure, set text to "RAM: unavailable" / "CPU: unavailable"

**Important for RAM calculation:** Get-LabHostResourceInfo returns FreeRAMGB. To get total RAM, use `Get-CimInstance Win32_ComputerSystem` and `.TotalPhysicalMemory / 1GB`. Or simpler: calculate totalRAM = freeRAM + allocatedRAM (approximation). Best approach: add total RAM to the resource info. Actually, keep it simple - use the existing Get-LabHostResourceInfo FreeRAMGB and compute total assigned from VM statuses. Display as: "RAM: X.X GB used by VMs | Y.Y GB free on host"

**Wire the polling timer update** to also call Update-DashboardBanner and Update-ResourceSummary after each poll. Add these calls to both the initial poll block and the timer Tick handler, right after the existing `Update-TopologyCanvas` call.

**Wire bulk action buttons:**

```powershell
$btnStartAll.Add_Click({
    foreach ($vmName in $vmNames) {
        try { Start-VM -Name $vmName -ErrorAction SilentlyContinue } catch {}
    }
    if (Get-Command -Name Add-LogEntry -ErrorAction SilentlyContinue) {
        Add-LogEntry -Message "Started all lab VMs" -Level 'Info'
    }
}.GetNewClosure())

$btnStopAll.Add_Click({
    foreach ($vmName in $vmNames) {
        try { Stop-VM -Name $vmName -Force -ErrorAction SilentlyContinue } catch {}
    }
    if (Get-Command -Name Add-LogEntry -ErrorAction SilentlyContinue) {
        Add-LogEntry -Message "Stopped all lab VMs" -Level 'Info'
    }
}.GetNewClosure())

$btnSaveCheckpoint.Add_Click({
    $timestamp = (Get-Date).ToString('yyyyMMdd-HHmmss')
    foreach ($vmName in $vmNames) {
        try {
            Checkpoint-VM -Name $vmName -SnapshotName "GUI-$timestamp" -ErrorAction SilentlyContinue
        } catch {}
    }
    if (Get-Command -Name Add-LogEntry -ErrorAction SilentlyContinue) {
        Add-LogEntry -Message "Saved checkpoint for all lab VMs (GUI-$timestamp)" -Level 'Success'
    }
}.GetNewClosure())
```

**PowerShell 5.1 compatibility notes:**
- Use `[System.Windows.Media.Color]::FromRgb()` not `[Color]::FromRgb()`
- Use nested `Join-Path` for any path construction
- Use `.GetNewClosure()` on all script blocks that capture outer variables
- Do NOT use ternary operator `? :` (PS 7+ only)
  </action>
  <verify>
1. Validate PowerShell syntax: `pwsh -Command "& { $null = [scriptblock]::Create((Get-Content 'GUI/Start-OpenCodeLabGUI.ps1' -Raw)) }"`
2. Grep for all new named element references: healthBanner, txtHealthState, txtHealthDetail, txtRAMUsage, txtCPUUsage, btnStartAll, btnStopAll, btnSaveCheckpoint
3. Grep for Get-LabHostResourceInfo call within Initialize-DashboardView
4. Grep for Get-LabHealthState function definition
5. Verify .GetNewClosure() is used on all button click handlers
  </verify>
  <done>
Initialize-DashboardView resolves all new named elements, updates health banner and resource summary on each 5-second poll, and wires Start All / Stop All / Save Checkpoint button handlers. Get-LabHealthState helper maps VM statuses to Healthy/Degraded/Offline/No Lab states.
  </done>
</task>

</tasks>

<verification>
1. DashboardView.xaml parses as valid XML
2. Start-OpenCodeLabGUI.ps1 parses as valid PowerShell
3. All DASH-01/02/03 named elements exist in XAML and are resolved in PS1
4. Health banner updates in both initial poll and timer tick
5. Resource summary calls Get-LabHostResourceInfo
6. Bulk buttons iterate over vmNames with error handling
7. All DynamicResource brush references match Dark.xaml/Light.xaml keys
</verification>

<success_criteria>
- DashboardView.xaml has 3-row layout: health banner, resource+actions row, existing VM cards+topology
- Initialize-DashboardView wires health state, resource summary, and bulk actions
- Health banner maps to 4 states with distinct background colors
- Resource summary shows RAM and CPU from Get-LabHostResourceInfo
- All three bulk action buttons have functional click handlers
- No PowerShell 5.1 incompatibilities (no ternary, no 3-arg Join-Path)
</success_criteria>

<output>
After completion, create `.planning/phases/17-gui-dashboard-enhancements/17-01-SUMMARY.md`
</output>
