---
phase: 04-vm-provisioning
plan: 04
type: execute
wave: 4
depends_on: [04-01, 04-02, 04-03]
files_modified:
  - SimpleLab/Private/Remove-StaleVM.ps1
  - SimpleLab/SimpleLab.psm1
autonomous: false

must_haves:
  truths:
    - Tool removes incomplete VMs from failed provisioning runs
    - Tool prevents "VM already exists" errors on subsequent runs
    - Tool supports idempotent lab rebuild operations
    - Tool cleans up VMs in inconsistent states (saved, paused, critical)
  artifacts:
    - path: SimpleLab/Private/Remove-StaleVM.ps1
      provides: Aggressive cleanup of incomplete VMs from failed runs
      min_lines: 50
  key_links:
    - from: Remove-StaleVM.ps1
      to: Get-VM (Hyper-V module)
      via: Cmdlet to enumerate all VMs for stale detection
      pattern: Get-VM.*-SimpleLab
    - from: Remove-StaleVM.ps1
      to: Remove-VM (Hyper-V module)
      via: Cmdlet to remove stale VMs
      pattern: Remove-VM.*-Force
    - from: New-LabVM.ps1 (from 04-02)
      to: Remove-StaleVM.ps1
      via: Optional cleanup call before VM creation for idempotency
      pattern: Remove-StaleVM.*-Force
---

<objective>
Implement aggressive cleanup for reliable VM provisioning

Purpose: Prevent "VM already exists" errors from failed provisioning runs by implementing aggressive cleanup of incomplete or stale VMs, enabling idempotent lab rebuild operations that work consistently regardless of previous run state.

Output: Remove-StaleVM function for cleaning up incomplete VMs
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vm-provisioning/04-RESEARCH.md
@.planning/phases/04-vm-provisioning/04-01-SUMMARY.md
@.planning/phases/04-vm-provisioning/04-02-SUMMARY.md
@.planning/phases/04-vm-provisioning/04-03-SUMMARY.md

# Pattern reference from existing codebase
@Deploy.ps1
@Lab-Common.ps1

# VM provisioning from prior plans in this phase
@SimpleLab/Public/New-LabVM.ps1
@SimpleLab/Public/Remove-LabVM.ps1
@SimpleLab/Private/Test-LabVM.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Remove-StaleVM for aggressive cleanup</name>
  <files>SimpleLab/Private/Remove-StaleVM.ps1</files>
  <action>
    Create Remove-StaleVM function in Private/ that:
    - Parameters:
      * LabVMs (string array, default @("SimpleDC", "SimpleServer", "SimpleWin11"))
      * Force (switch, default false - require confirmation)
    - Removes incomplete VMs from failed provisioning runs
    - Get all VMs: Get-VM to enumerate VMs
    - Identify stale VMs: VMs in LabVMs list that are NOT in "Off" state with proper configuration
    - Stale conditions (remove if ANY true):
      * VM state is "Saved", "Paused", "Critical" (incomplete states)
      * VM exists but has no VHD attached (creation failed)
      * VM exists but VHD file is missing (disk corruption)
      * Force parameter specified (remove all LabVMs unconditionally)
    - For each stale VM:
      1. Stop VM if not Off: Stop-VM -Name $vmName -TurnOff -Force
      2. Remove VM: Remove-VM -Name $vmName -Force
      3. Remove checkpoint files if any: Remove-Item "C:\Lab\VMs\$vmName\*" -Recurse -Force
    - Returns PSCustomObject with: VMsRemoved (array), SkippedVMs (array), OverallStatus, Message
    - OverallStatus values: "OK" (cleanup successful), "Partial" (some removals failed), "Failed" (all failed)
    - Message provides summary: "Removed {count} stale VM(s)", "No stale VMs found"
    - Handles errors with try/catch per VM (continue on individual failures)
    - Internal function only (not exported)

    Pattern reference: Follow existing Remove-HyperVVMStale pattern from Deploy.ps1 if available
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Remove-StaleVM (without Hyper-V available)
    3. Verify output contains VMsRemoved, SkippedVMs, OverallStatus, Message properties
    4. Verify OverallStatus="OK" (no VMs to remove in clean environment)
  </verify>
  <done>
    Remove-StaleVM function removes incomplete VMs from failed runs with structured result tracking
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SimpleLab module file</name>
  <files>SimpleLab/SimpleLab.psm1</files>
  <action>
    Update SimpleLab.psm1:
    - No changes needed (internal function, not exported)
    - Remove-StaleVM remains internal in Private/ and is not exported

    This follows the pattern established in Phase 2 and Phase 3 for internal helper functions
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Remove-StaleVM does NOT appear in output (internal function)
  </verify>
  <done>
    Module file verified - Remove-StaleVM is internal and available for internal use
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify provisioning performance and idempotency</name>
  <files>SimpleLab/Public/Initialize-LabVMs.ps1, SimpleLab/Private/Remove-StaleVM.ps1, SimpleLab/Public/New-LabVM.ps1</files>
  <action>
    Verify Phase 4 provisioning performance and idempotency requirements are met.

    No code changes - verification checkpoint only.
  </action>
  <verify>
    1. Verify provisioning completes in reasonable time:
       ```powershell
       Import-Module ./SimpleLab/SimpleLab.psd1
       Measure-Command { Initialize-LabVMs }
       ```
       Expected: Basic VM setup (without actual VM creation due to WSL) should complete quickly

    2. Verify idempotent operations:
       ```powershell
       # Run multiple times - should not error
       Initialize-LabVMs
       Initialize-LabVMs
       ```
       Expected: Second run returns "AlreadyExists" status without errors

    3. Verify aggressive cleanup availability:
       ```powershell
       Remove-StaleVM
       ```
       Expected: Returns structured result with OverallStatus, VMsRemoved, SkippedVMs

    4. Verify all Phase 4 success criteria:
       - Single command to build complete lab: Initialize-LabVMs
       - Appropriate RAM allocation: Get-LabVMConfig shows correct MemoryGB values
       - ISO attachment: New-LabVM accepts IsoPath parameter
       - Performance: Basic setup overhead is minimal
  </verify>
  <done>
    All Phase 4 success criteria verified - provisioning performance meets requirements
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Remove-StaleVM identifies and removes VMs in incomplete states
2. Remove-StaleVM handles multiple stale conditions (saved, paused, critical)
3. Remove-StaleVM removes checkpoint files during cleanup
4. Remove-StaleVM continues on individual VM failures
5. Remove-StaleVM returns structured result with removal tracking
6. Provisioning performance meets "under 15 minutes" requirement for basic VM setup
7. Idempotent operations work correctly with -Force parameter
</verification>

<success_criteria>
1. Tool removes incomplete VMs from failed provisioning runs
2. Tool prevents "VM already exists" errors on subsequent runs
3. Tool supports idempotent lab rebuild operations with -Force
4. Provisioning completes in under 15 minutes for basic VM setup
5. Aggressive cleanup enables reliable rebuild regardless of prior state
</success_criteria>

<output>
After completion, create `.planning/phases/04-vm-provisioning/04-04-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Verification checkpoint results
- Performance metrics
- Any deviations from plan

Phase 4 final completion: Update STATE.md and ROADMAP.md with all Phase 4 plans complete
</output>
