---
phase: 04-vm-provisioning
plan: 03
type: execute
wave: 3
depends_on: [04-01, 04-02]
files_modified:
  - SimpleLab/Public/Initialize-LabVMs.ps1
  - SimpleLab/SimpleLab.psm1
  - SimpleLab/SimpleLab.psd1
autonomous: false

must_haves:
  truths:
    - User can run single command to create complete Windows domain lab (DC, Server 2019, Win 11)
    - Tool creates all 3 VMs with appropriate RAM allocation (DC: 2GB, Server: 2GB, Win11: 4GB)
    - Tool orchestrates multi-VM creation with error aggregation
    - Tool returns structured result showing per-VM creation status
    - Tool integrates with existing vSwitch from Phase 3
  artifacts:
    - path: SimpleLab/Public/Initialize-LabVMs.ps1
      provides: Multi-VM creation orchestrator for complete lab setup
      min_lines: 70
      exports: [Initialize-LabVMs]
  key_links:
    - from: Initialize-LabVMs.ps1
      to: Get-LabVMConfig.ps1 (from 04-01)
      via: Function call to get VM hardware specifications
      pattern: Get-LabVMConfig
    - from: Initialize-LabVMs.ps1
      to: New-LabVM.ps1 (from 04-02)
      via: Function call per VM to create each lab VM
      pattern: New-LabVM.*-VMName
    - from: Initialize-LabVMs.ps1
      to: Get-LabConfig.ps1 (from Phase 2)
      via: Function call to get ISO paths from config
      pattern: Get-LabConfig
    - from: Initialize-LabVMs.ps1
      to: "SimpleLab" vSwitch (from Phase 3)
      via: SwitchName parameter passed to New-LabVM
      pattern: -SwitchName.*SimpleLab
---

<objective>
Create multi-VM orchestrator for complete lab provisioning

Purpose: Enable single-command creation of the complete Windows domain lab by orchestrating the creation of all three VMs (Domain Controller, Server 2019, Windows 11) with appropriate hardware configurations, ISO attachments, and error aggregation for reliable deployment.

Output: Initialize-LabVMs orchestrator function for complete lab VM creation
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vm-provisioning/04-RESEARCH.md
@.planning/phases/04-vm-provisioning/04-01-SUMMARY.md
@.planning/phases/04-vm-provisioning/04-02-SUMMARY.md

# Pattern reference from prior phases
@SimpleLab/Public/Initialize-LabNetwork.ps1
@SimpleLab/Public/New-LabSwitch.ps1
@SimpleLab/Private/Get-LabConfig.ps1

# VM provisioning from Plan 04-02
@SimpleLab/Public/New-LabVM.ps1
@SimpleLab/Public/Remove-LabVM.ps1

# VM configuration from Plan 04-01
@SimpleLab/Private/Get-LabVMConfig.ps1
@SimpleLab/Private/Test-LabVM.ps1

# Network infrastructure from Phase 3
@SimpleLab/Public/Test-LabNetwork.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Initialize-LabVMs orchestrator</name>
  <files>SimpleLab/Public/Initialize-LabVMs.ps1</files>
  <action>
    Create Initialize-LabVMs function in Public/ that:
    - Parameters:
      * SwitchName (string, default "SimpleLab")
      * VHDBasePath (string, default "C:\Lab\VMs")
      * Force (switch, default false - recreate existing VMs)
    - Orchestrates creation of all 3 lab VMs: SimpleDC, SimpleServer, SimpleWin11
    - Start timing: $startTime = Get-Date
    - Initialize result object with: VMsCreated (hashtable), FailedVMs (array), OverallStatus, Duration, Message
    - Get VM configurations using Get-LabVMConfig (for hardware specs)
    - Get ISO paths using Get-LabConfig (reads IsoPaths from config.json)
    - Ensure VHDBasePath exists: if (-not (Test-Path $VHDBasePath)) { New-Item -Path $VHDBasePath -ItemType Directory -Force | Out-Null }
    - Loop through each VM in order:
      1. Get VM config from Get-LabVMConfig -VMName $vmName
      2. Build VHD path: Join-Path $VHDBasePath "$vmName.vhdx"
      3. Get ISO path from config.IsoPaths[$vmConfig.ISO]
      4. Call New-LabVM with parameters from VM config
      5. Store result in $results hashtable keyed by VMName
      6. Track success/failure counts
    - Calculate duration: New-TimeSpan -Start $startTime -End (Get-Date)
    - Determine OverallStatus:
      * "OK" if all VMs created successfully
      * "Partial" if some VMs created, some failed
      * "Failed" if no VMs created
    - Build summary Message with counts
    - Returns PSCustomObject with: OverallStatus, VMsCreated (hashtable), FailedVMs (array), Duration, Message
    - Public function (exported)

    Pattern reference: Follow Initialize-LabNetwork.ps1 orchestrator pattern
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
    Use New-TimeSpan for duration measurement
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Initialize-LabVMs (without Hyper-V available)
    3. Verify output contains OverallStatus, VMsCreated, FailedVMs, Duration, Message properties
    4. Verify OverallStatus reflects creation attempts (likely "Failed" in WSL)
  </verify>
  <done>
    Initialize-LabVMs function orchestrates multi-VM creation with structured result tracking
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SimpleLab module files to export orchestrator</name>
  <files>SimpleLab/SimpleLab.psm1, SimpleLab/SimpleLab.psd1</files>
  <action>
    Update both SimpleLab module files to export orchestrator:
    - SimpleLab.psm1: Add 'Initialize-LabVMs' to Export-ModuleMember array
    - SimpleLab.psd1: Add 'Initialize-LabVMs' to FunctionsToExport array

    Maintain alphabetical ordering in both export arrays
    This follows the pattern established in Phase 3 for proper module exports
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Initialize-LabVMs appears in output
  </verify>
  <done>
    Initialize-LabVMs function is exported from SimpleLab module and available for use
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete VM provisioning infrastructure</name>
  <files>SimpleLab/Public/New-LabVM.ps1, SimpleLab/Public/Remove-LabVM.ps1, SimpleLab/Public/Initialize-LabVMs.ps1, SimpleLab/Private/Get-LabVMConfig.ps1, SimpleLab/Private/Test-LabVM.ps1</files>
  <action>
    Verify the complete Phase 4 VM provisioning infrastructure by testing all VM functions.

    No code changes - verification checkpoint only.
  </action>
  <verify>
    1. Verify VM configuration retrieval:
       ```powershell
       Import-Module ./SimpleLab/SimpleLab.psd1
       Get-LabVMConfig
       ```
       Expected: Returns hashtable with all 3 VM configurations

    2. Verify VM detection:
       ```powershell
       Test-LabVM -VMName "SimpleDC"
       ```
       Expected: Returns structured result with Exists, Status, Message properties

    3. Verify all VM provisioning functions are exported:
       ```powershell
       Get-Command -Module SimpleLab | Where-Object {$_.Name -like "*LabVM*"}
       ```
       Expected: Shows New-LabVM, Remove-LabVM, Initialize-LabVMs

    4. Verify orchestrator returns correct structure:
       ```powershell
       Initialize-LabVMs
       ```
       Expected: Returns structured result with OverallStatus, VMsCreated, FailedVMs, Duration
  </verify>
  <done>
    All VM provisioning infrastructure functions are working correctly and Phase 4 success criteria are met
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Initialize-LabVMs orchestrates creation of all 3 lab VMs
2. Initialize-LabVMs uses Get-LabVMConfig for hardware specifications
3. Initialize-LabVMs calls New-LabVM for each VM with correct parameters
4. Initialize-LabVMs returns structured result with per-VM status
5. Initialize-LabVMs handles VM path creation automatically
6. Initialize-LabVMs is properly exported from the module
</verification>

<success_criteria>
1. User can run single command to build complete Windows domain lab
2. Tool creates 3 VMs with appropriate RAM allocation (DC: 2GB, Server: 2GB, Win11: 4GB)
3. Tool attaches ISOs for bootable configuration
4. Tool returns structured result showing per-VM creation status
5. Tool integrates with existing "SimpleLab" vSwitch from Phase 3
</success_criteria>

<output>
After completion, create `.planning/phases/04-vm-provisioning/04-03-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Verification checkpoint results
- Any deviations from plan

Phase 4 completion: Update STATE.md and ROADMAP.md with Phase 4 completion status
</output>
