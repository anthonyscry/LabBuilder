---
phase: 08-orchestrator-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - OpenCodeLab-App.ps1
  - Private/Convert-LabArgumentArrayToSplat.ps1
  - Private/Resolve-LabScriptPath.ps1
  - Private/Invoke-LabRepoScript.ps1
  - Private/Get-LabExpectedVMs.ps1
  - Private/Get-LabPreflightArgs.ps1
  - Private/Get-LabBootstrapArgs.ps1
  - Private/Get-LabDeployArgs.ps1
  - Private/Get-LabHealthArgs.ps1
  - Private/Import-LabModule.ps1
  - Private/Add-LabRunEvent.ps1
  - Private/Invoke-LabLogRetention.ps1
  - Tests/OrchestratorExtraction-Batch1.Tests.ps1
autonomous: true
requirements:
  - EXT-01
  - EXT-03
  - EXT-04

must_haves:
  truths:
    - "11 pure utility functions extracted from OpenCodeLab-App.ps1 to Private/ with [CmdletBinding()] and explicit parameters"
    - "Script-scope variable dependencies replaced with explicit parameters on all 11 functions"
    - "OpenCodeLab-App.ps1 calls extracted helpers with parameters instead of relying on closure state"
    - "All existing Pester tests pass after extraction (no behavior regression)"
  artifacts:
    - path: "Private/Convert-LabArgumentArrayToSplat.ps1"
      provides: "Extracted Convert-ArgumentArrayToSplat with Lab prefix"
    - path: "Private/Invoke-LabRepoScript.ps1"
      provides: "Extracted Invoke-RepoScript with explicit ScriptDir and RunEvents params"
    - path: "Private/Add-LabRunEvent.ps1"
      provides: "Extracted Add-RunEvent with RunEvents list as parameter"
    - path: "Tests/OrchestratorExtraction-Batch1.Tests.ps1"
      provides: "Unit tests for all 11 extracted functions"
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Add-LabRunEvent.ps1"
      via: "calls Add-LabRunEvent with -RunEvents $RunEvents"
      pattern: "Add-LabRunEvent"
---

<objective>
Extract 11 pure utility functions from OpenCodeLab-App.ps1 to Private/ helpers (Batch 1 of 4).

Purpose: These are leaf-level functions with no or minimal script-scope dependencies. They are extracted first because other inline functions depend on them. Each gets [CmdletBinding()], explicit parameters, and unit tests.

Output: 11 new Private/*.ps1 files, updated OpenCodeLab-App.ps1 with inline definitions removed and replaced by calls to extracted helpers, plus OrchestratorExtraction-Batch1.Tests.ps1.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-orchestrator-extraction/08-RESEARCH.md
@OpenCodeLab-App.ps1
@Lab-Common.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Convert-ArgumentArrayToSplat (pure function, no deps)</name>
  <files>Private/Convert-LabArgumentArrayToSplat.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Convert-LabArgumentArrayToSplat.ps1` containing the function renamed to `Convert-LabArgumentArrayToSplat` with:
    - `[CmdletBinding()]` attribute
    - Same `param([string[]]$ArgumentList)` parameter
    - Same body logic (no changes needed -- this function has no script-scope deps)

    In OpenCodeLab-App.ps1:
    - Remove the inline `function Convert-ArgumentArrayToSplat { ... }` definition (lines 311-336)
    - Replace all calls to `Convert-ArgumentArrayToSplat` with `Convert-LabArgumentArrayToSplat`
    - The only call is inside Invoke-RepoScript (which will be extracted in a later task in this plan)
  </action>
  <verify>Dot-source the new file and call `Convert-LabArgumentArrayToSplat -ArgumentList @('-Mode', 'full', '-NonInteractive')` -- returns hashtable with Mode='full' and NonInteractive=$true.</verify>
  <done>Convert-LabArgumentArrayToSplat.ps1 exists in Private/ with [CmdletBinding()]. Inline definition removed from App.ps1.</done>
</task>

<task type="auto">
  <name>Task 2: Extract Resolve-ScriptPath -> Resolve-LabScriptPath</name>
  <files>Private/Resolve-LabScriptPath.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Resolve-LabScriptPath.ps1` with function `Resolve-LabScriptPath`:
    - `[CmdletBinding()]` attribute
    - Parameters: `[Parameter(Mandatory)][string]$BaseName`, `[Parameter(Mandatory)][string]$ScriptDir`
    - Body: same logic but uses the `$ScriptDir` parameter instead of closure variable

    In OpenCodeLab-App.ps1:
    - Remove inline `function Resolve-ScriptPath { ... }` (lines 301-309)
    - Update all calls: `Resolve-ScriptPath -BaseName X` -> `Resolve-LabScriptPath -BaseName X -ScriptDir $ScriptDir`
  </action>
  <verify>Call `Resolve-LabScriptPath -BaseName 'Deploy' -ScriptDir $ScriptDir` and verify it finds Deploy.ps1.</verify>
  <done>Resolve-LabScriptPath.ps1 exists with explicit $ScriptDir parameter. No closure dependency.</done>
</task>

<task type="auto">
  <name>Task 3: Extract Add-RunEvent -> Add-LabRunEvent</name>
  <files>Private/Add-LabRunEvent.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Add-LabRunEvent.ps1` with function `Add-LabRunEvent`:
    - `[CmdletBinding()]` attribute
    - Parameters: `[Parameter(Mandatory)][string]$Step`, `[Parameter(Mandatory)][string]$Status`, `[string]$Message = ''`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: same .Add() logic but uses the `$RunEvents` parameter

    In OpenCodeLab-App.ps1:
    - Remove inline `function Add-RunEvent { ... }` (lines 152-165)
    - Replace ALL calls to `Add-RunEvent -Step X -Status Y -Message Z` with `Add-LabRunEvent -Step X -Status Y -Message Z -RunEvents $RunEvents`
    - There are many call sites throughout the file -- update every one
  </action>
  <verify>Create a List[object], call Add-LabRunEvent, verify the list has 1 item with correct Step/Status/Message properties.</verify>
  <done>Add-LabRunEvent.ps1 exists with explicit $RunEvents parameter. All call sites updated.</done>
</task>

<task type="auto">
  <name>Task 4: Extract Invoke-RepoScript -> Invoke-LabRepoScript</name>
  <files>Private/Invoke-LabRepoScript.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabRepoScript.ps1` with function `Invoke-LabRepoScript`:
    - `[CmdletBinding()]` attribute
    - Parameters: `[Parameter(Mandatory)][string]$BaseName`, `[string[]]$Arguments`, `[Parameter(Mandatory)][string]$ScriptDir`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: calls `Resolve-LabScriptPath` (with -ScriptDir) and `Add-LabRunEvent` (with -RunEvents) and `Convert-LabArgumentArrayToSplat`
    - Updates internal references to use the new Lab-prefixed function names

    In OpenCodeLab-App.ps1:
    - Remove inline `function Invoke-RepoScript { ... }` (lines 338-360)
    - Replace ALL calls to `Invoke-RepoScript -BaseName X` with `Invoke-LabRepoScript -BaseName X -ScriptDir $ScriptDir -RunEvents $RunEvents`
    - Include `-Arguments` when applicable
  </action>
  <verify>Mock the downstream script and verify Invoke-LabRepoScript calls it and adds run events.</verify>
  <done>Invoke-LabRepoScript.ps1 exists with explicit ScriptDir and RunEvents params. All call sites updated.</done>
</task>

<task type="auto">
  <name>Task 5: Extract Get-ExpectedVMs -> Get-LabExpectedVMs</name>
  <files>Private/Get-LabExpectedVMs.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Get-LabExpectedVMs.ps1` with function `Get-LabExpectedVMs`:
    - `[CmdletBinding()]` attribute
    - Parameters: `[Parameter(Mandatory)][hashtable]$LabConfig`
    - Body: `return @(@($LabConfig.Lab.CoreVMNames))`

    In OpenCodeLab-App.ps1:
    - Remove inline `function Get-ExpectedVMs { ... }` (lines 362-364)
    - Replace all calls: `Get-ExpectedVMs` -> `Get-LabExpectedVMs -LabConfig $GlobalLabConfig`
  </action>
  <verify>Call with a test config hashtable, verify returns array of CoreVMNames.</verify>
  <done>Get-LabExpectedVMs.ps1 exists with explicit $LabConfig parameter.</done>
</task>

<task type="auto">
  <name>Task 6: Extract arg-builder helpers (PreflightArgs, BootstrapArgs, DeployArgs, HealthArgs)</name>
  <files>Private/Get-LabPreflightArgs.ps1, Private/Get-LabBootstrapArgs.ps1, Private/Get-LabDeployArgs.ps1, Private/Get-LabHealthArgs.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create 4 files:

    **Private/Get-LabPreflightArgs.ps1** - `Get-LabPreflightArgs`:
    - `[CmdletBinding()]`, no params needed
    - Body: `return @()`

    **Private/Get-LabBootstrapArgs.ps1** - `Get-LabBootstrapArgs`:
    - `[CmdletBinding()]`
    - Parameters: `[ValidateSet('quick', 'full')][string]$Mode = 'full'`, `[switch]$NonInteractive`, `[switch]$AutoFixSubnetConflict`
    - Body: builds $scriptArgs array from parameters (same logic, but uses params instead of script-scope vars)

    **Private/Get-LabDeployArgs.ps1** - `Get-LabDeployArgs`:
    - `[CmdletBinding()]`
    - Parameters: `[ValidateSet('quick', 'full')][string]$Mode = 'full'`, `[switch]$NonInteractive`, `[switch]$AutoFixSubnetConflict`
    - Body: same pattern as bootstrap args

    **Private/Get-LabHealthArgs.ps1** - `Get-LabHealthArgs`:
    - `[CmdletBinding()]`, no params needed
    - Body: `return @()`

    In OpenCodeLab-App.ps1:
    - Remove all 4 inline function definitions
    - Update calls:
      - `Get-PreflightArgs` -> `Get-LabPreflightArgs`
      - `Get-BootstrapArgs -Mode X` -> `Get-LabBootstrapArgs -Mode X -NonInteractive:$NonInteractive -AutoFixSubnetConflict:$AutoFixSubnetConflict`
      - `Get-DeployArgs -Mode X` -> `Get-LabDeployArgs -Mode X -NonInteractive:$NonInteractive -AutoFixSubnetConflict:$AutoFixSubnetConflict`
      - `Get-HealthArgs` -> `Get-LabHealthArgs`
  </action>
  <verify>Call each function with test parameters and verify returned argument arrays.</verify>
  <done>4 arg-builder helpers extracted with explicit parameters. No script-scope dependencies.</done>
</task>

<task type="auto">
  <name>Task 7: Extract Ensure-LabImported -> Import-LabModule</name>
  <files>Private/Import-LabModule.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Import-LabModule.ps1` with function `Import-LabModule`:
    - `[CmdletBinding()]` attribute
    - Parameters: `[Parameter(Mandatory)][string]$LabName`
    - Body: same logic but uses $LabName parameter instead of $GlobalLabConfig.Lab.Name

    Note: The existing Private/ already has Import-OpenCodeLab.ps1, which is a different helper. This function specifically imports the AutomatedLab module and lab definition.

    In OpenCodeLab-App.ps1:
    - Remove inline `function Ensure-LabImported { ... }` (lines 532-554)
    - Replace all calls: `Ensure-LabImported` -> `Import-LabModule -LabName $GlobalLabConfig.Lab.Name`
  </action>
  <verify>Verify the function exists with [CmdletBinding()] and $LabName parameter.</verify>
  <done>Import-LabModule.ps1 exists. Ensure-LabImported inline removed. All call sites pass $LabName explicitly.</done>
</task>

<task type="auto">
  <name>Task 8: Extract Invoke-LogRetention -> Invoke-LabLogRetention</name>
  <files>Private/Invoke-LabLogRetention.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabLogRetention.ps1` with function `Invoke-LabLogRetention`:
    - `[CmdletBinding()]` attribute
    - Parameters: `[int]$RetentionDays = 14`, `[string]$LogRoot`
    - Body: same logic but uses $RetentionDays and $LogRoot params instead of script-scope vars

    In OpenCodeLab-App.ps1:
    - Remove inline `function Invoke-LogRetention { ... }` (lines 252-260)
    - Replace call: `Invoke-LogRetention` -> `Invoke-LabLogRetention -RetentionDays $LogRetentionDays -LogRoot $RunLogRoot`
  </action>
  <verify>Create a temp dir with old files, call Invoke-LabLogRetention, verify old files deleted.</verify>
  <done>Invoke-LabLogRetention.ps1 exists with explicit params. Script-scope vars eliminated.</done>
</task>

<task type="auto">
  <name>Task 9: Create unit tests for all 11 extracted functions</name>
  <files>Tests/OrchestratorExtraction-Batch1.Tests.ps1</files>
  <action>
    Create Pester 5.x test file with Describe blocks for each extracted function:

    1. **Convert-LabArgumentArrayToSplat**: Test switch args, key-value args, mixed, empty, error on bare values
    2. **Resolve-LabScriptPath**: Test root path found, Scripts/ subfolder found, not found throws
    3. **Add-LabRunEvent**: Test event added to list with correct Time/Step/Status/Message properties
    4. **Invoke-LabRepoScript**: Mock downstream script, verify it is called and events logged
    5. **Get-LabExpectedVMs**: Test returns CoreVMNames array from config
    6. **Get-LabPreflightArgs**: Test returns empty array
    7. **Get-LabBootstrapArgs**: Test mode and switch params
    8. **Get-LabDeployArgs**: Test mode and switch params
    9. **Get-LabHealthArgs**: Test returns empty array
    10. **Import-LabModule**: Mock Import-Module/Import-Lab, verify calls
    11. **Invoke-LabLogRetention**: Test retention cleanup with temp files

    Use `Set-StrictMode -Version Latest` in BeforeAll. Follow project test patterns.
  </action>
  <verify>Run `Invoke-Pester Tests/OrchestratorExtraction-Batch1.Tests.ps1 -Output Detailed` -- all tests pass.</verify>
  <done>Unit tests exist for all 11 functions. All pass. No regressions in existing test suite.</done>
</task>

<task type="auto">
  <name>Task 10: Run full test suite to verify no regressions</name>
  <files>(none -- verification only)</files>
  <action>
    Run the full Pester test suite to verify no regressions:
    ```powershell
    Invoke-Pester Tests/ -Output Detailed
    ```
    All 566+ existing tests must still pass. Fix any failures caused by the extraction.
  </action>
  <verify>Full test suite passes. Zero regressions.</verify>
  <done>All existing tests pass. Batch 1 extraction is complete with no behavior changes.</done>
</task>

</tasks>

<verification>
1. All 11 Private/*.ps1 files exist with [CmdletBinding()] and explicit parameters
2. OpenCodeLab-App.ps1 no longer contains the 11 inline function definitions
3. OpenCodeLab-App.ps1 calls the extracted functions with explicit parameters
4. `Invoke-Pester Tests/OrchestratorExtraction-Batch1.Tests.ps1 -Output Detailed` -- all pass
5. `Invoke-Pester Tests/ -Output Detailed` -- full suite passes, no regressions
</verification>

<success_criteria>
- 11 functions extracted to Private/ with [CmdletBinding()] and explicit parameters
- No script-scope variable dependencies in extracted functions
- OpenCodeLab-App.ps1 reduced by ~250 lines
- All extracted functions have unit tests
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-orchestrator-extraction/08-01-SUMMARY.md`
</output>
