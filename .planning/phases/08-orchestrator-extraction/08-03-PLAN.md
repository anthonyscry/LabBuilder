---
phase: 08-orchestrator-extraction
plan: 03
type: execute
wave: 3
depends_on: [08-02]
files_modified:
  - OpenCodeLab-App.ps1
  - Private/Invoke-LabOrchestrationActionCore.ps1
  - Private/Invoke-LabOneButtonSetup.ps1
  - Private/Invoke-LabOneButtonReset.ps1
  - Private/Invoke-LabSetup.ps1
  - Private/Invoke-LabBulkVMProvision.ps1
  - Private/Invoke-LabSetupMenu.ps1
  - Tests/OrchestratorExtraction-Batch3.Tests.ps1
autonomous: true
requirements:
  - EXT-01
  - EXT-03
  - EXT-04

must_haves:
  truths:
    - "6 lifecycle orchestration functions extracted with explicit parameters"
    - "Invoke-OrchestrationActionCore -> Invoke-LabOrchestrationActionCore with explicit mode, config, and switch params"
    - "Invoke-OneButtonSetup/Reset chain extracted with all dependency params explicit"
    - "All existing Pester tests pass after extraction"
  artifacts:
    - path: "Private/Invoke-LabOrchestrationActionCore.ps1"
      provides: "Central deploy/teardown dispatch with explicit params"
    - path: "Private/Invoke-LabOneButtonSetup.ps1"
      provides: "Full setup sequence with explicit params"
    - path: "Tests/OrchestratorExtraction-Batch3.Tests.ps1"
      provides: "Unit tests for all 6 extracted functions"
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Invoke-LabOrchestrationActionCore.ps1"
      via: "calls Invoke-LabOrchestrationActionCore in deploy/teardown switch"
      pattern: "Invoke-LabOrchestrationActionCore"
---

<objective>
Extract 6 lifecycle orchestration functions from OpenCodeLab-App.ps1 (Batch 3 of 4).

Purpose: These functions orchestrate the setup, deploy, reset, and teardown sequences. They call the Batch 1 and Batch 2 helpers, so they must be extracted after those. Each has moderate-to-high script-scope dependencies that are converted to explicit parameters.

Output: 6 new Private/*.ps1 files, updated App.ps1, unit tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-orchestrator-extraction/08-RESEARCH.md
@OpenCodeLab-App.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Invoke-OrchestrationActionCore -> Invoke-LabOrchestrationActionCore</name>
  <files>Private/Invoke-LabOrchestrationActionCore.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabOrchestrationActionCore.ps1` with function `Invoke-LabOrchestrationActionCore`:
    - `[CmdletBinding()]`
    - Parameters:
      - `[Parameter(Mandatory)][ValidateSet('deploy', 'teardown')][string]$OrchestrationAction`
      - `[Parameter(Mandatory)][ValidateSet('quick', 'full')][string]$Mode`
      - `[Parameter(Mandatory)][object]$Intent`
      - `[Parameter(Mandatory)][hashtable]$LabConfig`
      - `[Parameter(Mandatory)][string]$ScriptDir`
      - `[Parameter(Mandatory)][string]$SwitchName`
      - `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
      - `[switch]$Force`
      - `[switch]$NonInteractive`
      - `[switch]$RemoveNetwork`
      - `[switch]$DryRun`
      - `[switch]$AutoFixSubnetConflict`
    - Body: same switch logic but calls extracted helpers with explicit params:
      - `Invoke-LabQuickDeploy` with -ScriptDir -RunEvents -DryRun
      - `Get-LabDeployArgs` with -NonInteractive -AutoFixSubnetConflict
      - `Invoke-LabRepoScript` with -ScriptDir -RunEvents
      - `Invoke-LabQuickTeardown` with explicit params
      - `Invoke-LabBlowAway` with explicit params

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 400-433)
    - Update calls with all explicit params
  </action>
  <verify>Mock downstream functions, call with deploy/quick, verify correct helper called.</verify>
  <done>Invoke-LabOrchestrationActionCore.ps1 extracted with explicit params.</done>
</task>

<task type="auto">
  <name>Task 2: Extract Invoke-OneButtonSetup -> Invoke-LabOneButtonSetup</name>
  <files>Private/Invoke-LabOneButtonSetup.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabOneButtonSetup.ps1` with function `Invoke-LabOneButtonSetup`:
    - `[CmdletBinding()]`
    - Parameters:
      - `[Parameter(Mandatory)][ValidateSet('quick', 'full')][string]$EffectiveMode`
      - `[Parameter(Mandatory)][hashtable]$LabConfig`
      - `[Parameter(Mandatory)][string]$ScriptDir`
      - `[Parameter(Mandatory)][string]$LabName`
      - `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
      - `[switch]$NonInteractive`
      - `[switch]$AutoFixSubnetConflict`
    - Body: calls Get-LabPreflightArgs, Get-LabBootstrapArgs, Invoke-LabRepoScript, Get-LabExpectedVMs, Get-LabHealthArgs, Import-LabModule, Test-LabReadySnapshot, Add-LabRunEvent -- all with explicit params

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 701-751)
    - Update calls with explicit params
  </action>
  <verify>Mock all downstream helpers. Verify the sequence executes in correct order.</verify>
  <done>Invoke-LabOneButtonSetup.ps1 extracted with explicit params.</done>
</task>

<task type="auto">
  <name>Task 3: Extract Invoke-OneButtonReset -> Invoke-LabOneButtonReset</name>
  <files>Private/Invoke-LabOneButtonReset.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabOneButtonReset.ps1` with function `Invoke-LabOneButtonReset`:
    - `[CmdletBinding()]`
    - Parameters:
      - `[switch]$DropNetwork`
      - `[switch]$DryRun`
      - `[switch]$Force`
      - `[switch]$NonInteractive`
      - `[switch]$AutoFixSubnetConflict`
      - `[Parameter(Mandatory)][hashtable]$LabConfig`
      - `[Parameter(Mandatory)][string]$ScriptDir`
      - `[Parameter(Mandatory)][string]$SwitchName`
      - `[Parameter(Mandatory)][string]$LabName`
      - `[Parameter(Mandatory)][ValidateSet('quick', 'full')][string]$EffectiveMode`
      - `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: calls Invoke-LabBlowAway and Invoke-LabOneButtonSetup with explicit params

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 753-768)
    - Update calls
  </action>
  <verify>Mock Invoke-LabBlowAway and Invoke-LabOneButtonSetup. Verify both called in sequence.</verify>
  <done>Invoke-LabOneButtonReset.ps1 extracted with explicit params.</done>
</task>

<task type="auto">
  <name>Task 4: Extract Invoke-Setup -> Invoke-LabSetup</name>
  <files>Private/Invoke-LabSetup.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabSetup.ps1` with function `Invoke-LabSetup`:
    - `[CmdletBinding()]`
    - Parameters:
      - `[Parameter(Mandatory)][ValidateSet('quick', 'full')][string]$EffectiveMode`
      - `[Parameter(Mandatory)][string]$ScriptDir`
      - `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
      - `[switch]$NonInteractive`
      - `[switch]$AutoFixSubnetConflict`
    - Body: calls Get-LabPreflightArgs, Get-LabBootstrapArgs, Invoke-LabRepoScript

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 770-776)
    - Update call: `Invoke-Setup` -> `Invoke-LabSetup -EffectiveMode $EffectiveMode -ScriptDir $ScriptDir -RunEvents $RunEvents -NonInteractive:$NonInteractive -AutoFixSubnetConflict:$AutoFixSubnetConflict`
  </action>
  <verify>Mock Invoke-LabRepoScript, verify preflight and bootstrap called.</verify>
  <done>Invoke-LabSetup.ps1 extracted.</done>
</task>

<task type="auto">
  <name>Task 5: Extract Invoke-BulkAdditionalVMProvision -> Invoke-LabBulkVMProvision</name>
  <files>Private/Invoke-LabBulkVMProvision.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabBulkVMProvision.ps1` with function `Invoke-LabBulkVMProvision`:
    - `[CmdletBinding()]`
    - Parameters:
      - `[Parameter(Mandatory)][ValidateRange(0, 100)][int]$ServerCount`
      - `[Parameter(Mandatory)][ValidateRange(0, 100)][int]$WorkstationCount`
      - `[string]$ServerIsoPath`
      - `[string]$WorkstationIsoPath`
      - `[Parameter(Mandatory)][hashtable]$LabConfig`
      - `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: same logic but reads VMSizing, Paths, Network from $LabConfig param
    - Calls Add-LabRunEvent with -RunEvents

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 1077-1153)
    - Update call in Invoke-SetupLabMenu (or its extracted equivalent)
  </action>
  <verify>Mock New-LabVM, verify correct VM names generated and provisioned.</verify>
  <done>Invoke-LabBulkVMProvision.ps1 extracted with explicit LabConfig param.</done>
</task>

<task type="auto">
  <name>Task 6: Extract Invoke-SetupLabMenu -> Invoke-LabSetupMenu</name>
  <files>Private/Invoke-LabSetupMenu.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabSetupMenu.ps1` with function `Invoke-LabSetupMenu`:
    - `[CmdletBinding()]`
    - Parameters:
      - `[Parameter(Mandatory)][hashtable]$LabConfig`
      - `[Parameter(Mandatory)][string]$ScriptDir`
      - `[Parameter(Mandatory)][string]$LabName`
      - `[Parameter(Mandatory)][ValidateSet('quick', 'full')][string]$EffectiveMode`
      - `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
      - `[switch]$NonInteractive`
      - `[switch]$AutoFixSubnetConflict`
    - Body: calls Read-LabMenuCount, Invoke-LabOneButtonSetup, Invoke-LabBulkVMProvision, Add-LabRunEvent with explicit params

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 1155-1181)
    - Update call in Invoke-InteractiveMenu
  </action>
  <verify>Mock Read-Host and downstream helpers. Verify setup + bulk provision sequence.</verify>
  <done>Invoke-LabSetupMenu.ps1 extracted.</done>
</task>

<task type="auto">
  <name>Task 7: Create unit tests for all 6 extracted functions</name>
  <files>Tests/OrchestratorExtraction-Batch3.Tests.ps1</files>
  <action>
    Create Pester 5.x test file with Describe blocks:

    1. **Invoke-LabOrchestrationActionCore**: Mock deploy/teardown helpers, verify correct dispatch
    2. **Invoke-LabOneButtonSetup**: Mock sequence helpers, verify execution order
    3. **Invoke-LabOneButtonReset**: Mock blow-away and setup, verify both called
    4. **Invoke-LabSetup**: Mock preflight and bootstrap calls
    5. **Invoke-LabBulkVMProvision**: Mock New-LabVM, test server/workstation naming sequence
    6. **Invoke-LabSetupMenu**: Mock Read-Host and downstream, verify setup flow

    Follow project test patterns. Set-StrictMode, dot-source, mock.
  </action>
  <verify>All tests pass.</verify>
  <done>Unit tests for all 6 lifecycle functions. All pass.</done>
</task>

<task type="auto">
  <name>Task 8: Run full test suite for regression check</name>
  <files>(none)</files>
  <action>Run `Invoke-Pester Tests/ -Output Detailed` -- fix any regressions.</action>
  <verify>Full suite passes.</verify>
  <done>All tests pass after Batch 3 extraction.</done>
</task>

</tasks>

<verification>
1. All 6 Private/*.ps1 files exist with [CmdletBinding()] and explicit parameters
2. OpenCodeLab-App.ps1 no longer contains the 6 inline definitions
3. All inter-function calls use extracted Lab-prefixed names with explicit params
4. `Invoke-Pester Tests/OrchestratorExtraction-Batch3.Tests.ps1` -- all pass
5. `Invoke-Pester Tests/` -- full suite passes
</verification>

<success_criteria>
- 6 lifecycle functions extracted with no script-scope dependencies
- Function call chains work correctly through explicit parameters
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-orchestrator-extraction/08-03-SUMMARY.md`
</output>
