---
phase: 04-role-provisioning
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - LabBuilder/Build-LabFromSelection.ps1
  - LabBuilder/Invoke-LabBuilder.ps1
  - Tests/LabBuilderOrchestration.Tests.ps1
autonomous: true
requirements:
  - ROLE-11

must_haves:
  truths:
    - "Build-LabFromSelection reports per-role success/failure with role-specific context"
    - "Missing roleScriptMap entries for Linux variants don't crash validation"
    - "Post-install summary shows which roles succeeded and which failed with reasons"
    - "Build continues when non-critical roles fail (only DC failure is fatal)"
  artifacts:
    - path: "LabBuilder/Build-LabFromSelection.ps1"
      provides: "Enhanced post-install reporting, DC-failure-is-fatal logic, Linux role map entries"
    - path: "LabBuilder/Invoke-LabBuilder.ps1"
      provides: "Updated valid tags list"
    - path: "Tests/LabBuilderOrchestration.Tests.ps1"
      provides: "Pester tests for orchestration error handling"
  key_links:
    - from: "LabBuilder/Build-LabFromSelection.ps1"
      to: "LabBuilder/Roles/*.ps1"
      via: "roleScriptMap dispatch"
      pattern: "roleScriptMap"
---

<objective>
Harden the Build-LabFromSelection.ps1 orchestrator with enhanced error reporting, DC-failure-is-fatal logic, and add missing Linux role entries to the role script map.

Purpose: The orchestrator currently gives generic "Post-install failed" messages. Role failures should report which role failed and why. DC failure should abort the build (other roles depend on AD), while non-critical role failures should continue. The roleScriptMap is also missing 4 Linux role entries that exist as files.

Output: Hardened orchestrator with clear per-role reporting and comprehensive test coverage.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-role-provisioning/04-RESEARCH.md
@.planning/phases/04-role-provisioning/04-01-SUMMARY.md
@LabBuilder/Build-LabFromSelection.ps1
@LabBuilder/Invoke-LabBuilder.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Build-LabFromSelection orchestrator error handling and role map</name>
  <files>
    LabBuilder/Build-LabFromSelection.ps1
    LabBuilder/Invoke-LabBuilder.ps1
  </files>
  <action>
**Build-LabFromSelection.ps1 — Phase 7 (roleScriptMap):** Add missing Linux role entries:
```powershell
WebServerUbuntu = @{ File = 'WebServer.Ubuntu.ps1'; Function = 'Get-LabRole_WebServerUbuntu' }
DatabaseUbuntu  = @{ File = 'Database.Ubuntu.ps1';  Function = 'Get-LabRole_DatabaseUbuntu' }
DockerUbuntu    = @{ File = 'Docker.Ubuntu.ps1';    Function = 'Get-LabRole_DockerUbuntu' }
K8sUbuntu       = @{ File = 'K8s.Ubuntu.ps1';       Function = 'Get-LabRole_K8sUbuntu' }
```

**Build-LabFromSelection.ps1 — Phase 11 (DC PostInstall):** Wrap DC PostInstall invocation in try-catch. If DC PostInstall fails, throw a fatal error that stops the entire build:
```powershell
if ($dcRole -and $dcRole.PostInstall) {
    Write-Host "    Running post-install: $($dcRole.VMName) [CRITICAL - AD services]..." -ForegroundColor Yellow
    try {
        & $dcRole.PostInstall $Config
        Write-Host "    [OK] DC post-install complete: $($dcRole.VMName)" -ForegroundColor Green
    }
    catch {
        throw "FATAL: DC role post-install failed. AD services are required for all other roles. Error: $($_.Exception.Message). Aborting build."
    }
}
```

**Build-LabFromSelection.ps1 — Phase 11 (parallel post-install reporting):** After all parallel post-install jobs complete, add a summary section:
- Track results in an array: `$postInstallResults = @()`
- For each completed job, add to results: `@{ VMName = ...; Tag = ...; Success = ...; Error = ... }`
- After all jobs processed, print a summary table:
```
  Post-Install Summary:
  VM Name      Role         Status
  -------      ----         ------
  SQL1         SQL          OK
  IIS1         IIS          OK
  WSUS1        WSUS         WARN: WsusService not running
  FILE1        FileServer   FAIL: SMB share creation failed
```
- Use Green for OK, Yellow for WARN, Red for FAIL
- If any roles failed, Write-Warning with count: "N of M role post-installs failed. Lab may be partially configured."
- Do NOT throw — non-DC failures should not abort the build

**Build-LabFromSelection.ps1 — Phase 13 (summary):** Add `PostInstallResults` to the JSON summary output so build reports include per-role status.

**Invoke-LabBuilder.ps1:** The `$validTags` list on line 116 is already complete with all Linux variants. Verify this is correct and matches the updated roleScriptMap.
  </action>
  <verify>Parse both files with PowerShell parser. Grep for 'FATAL.*DC' to confirm DC failure handling. Grep for 'Post-Install Summary' to confirm reporting exists.</verify>
  <done>DC failure aborts build. Non-DC failures continue with warnings. Post-install summary table prints status of each role. roleScriptMap has all role entries including Linux variants. JSON summary includes per-role results.</done>
</task>

<task type="auto">
  <name>Task 2: Create Pester tests for orchestration error handling</name>
  <files>Tests/LabBuilderOrchestration.Tests.ps1</files>
  <action>
Create `Tests/LabBuilderOrchestration.Tests.ps1` with Pester 5 tests. Follow project test conventions (Set-StrictMode -Version Latest, dot-source in BeforeAll, mock in BeforeEach).

**Test groups:**

1. **roleScriptMap completeness:** Read `Build-LabFromSelection.ps1`, extract roleScriptMap keys, verify all 15 role tags are present: DC, DSC, IIS, SQL, WSUS, DHCP, FileServer, PrintServer, Jumpbox, Client, Ubuntu, WebServerUbuntu, DatabaseUbuntu, DockerUbuntu, K8sUbuntu.

2. **roleScriptMap file references:** For each entry in roleScriptMap, verify the referenced .ps1 file exists in `LabBuilder/Roles/`.

3. **Invoke-LabBuilder valid tags list:** Extract `$validTags` from Invoke-LabBuilder.ps1, verify it matches the roleScriptMap keys exactly (no orphans in either direction).

4. **Role script function naming convention:** For each role in roleScriptMap, verify the Function name follows the pattern `Get-LabRole_{Tag}` (with underscore separator).

Since Build-LabFromSelection.ps1 requires AutomatedLab module and admin privileges to actually run, these tests should be structural (parsing file content) rather than execution-based.

Use `Get-Content` + regex to extract the roleScriptMap and validTags from the source files rather than trying to execute them.
  </action>
  <verify>Run `pwsh -Command "Invoke-Pester Tests/LabBuilderOrchestration.Tests.ps1 -Output Detailed"` — all tests pass.</verify>
  <done>Tests validate roleScriptMap completeness, file references, validTags alignment, and function naming convention.</done>
</task>

</tasks>

<verification>
1. Both modified files parse without syntax errors
2. roleScriptMap has 15 entries (10 Windows + 5 Linux)
3. DC failure handling uses throw (fatal)
4. Non-DC post-install failures use Write-Warning (non-fatal)
5. Post-install summary table is printed after all jobs complete
6. All Pester tests pass
</verification>

<success_criteria>
- DC PostInstall failure aborts the entire build with clear error
- Non-DC PostInstall failures continue with warnings
- Post-install summary shows per-role status with color coding
- roleScriptMap complete with all 15 role entries
- JSON summary includes PostInstallResults
- Pester tests validate structural correctness
</success_criteria>

<output>
After completion, create `.planning/phases/04-role-provisioning/04-03-SUMMARY.md`
</output>
