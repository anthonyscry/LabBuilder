---
phase: 01-cleanup-config-foundation
plan: 04
type: execute
wave: 2
depends_on:
  - 01-02
files_modified:
  - Private/Save-LabTemplate.ps1
  - Private/Get-ActiveTemplateConfig.ps1
  - Tests/Save-LabTemplate.Tests.ps1
autonomous: true
requirements:
  - CFG-04

must_haves:
  truths:
    - "Templates with invalid IP addresses are rejected with clear error messages"
    - "Templates with unknown roles are rejected with clear error messages"
    - "Templates with invalid VM names (>15 chars, special chars) are rejected"
    - "Templates with out-of-range memory/processor values are rejected"
    - "Get-ActiveTemplateConfig validates loaded JSON structure before returning"
  artifacts:
    - path: "Private/Save-LabTemplate.ps1"
      provides: "Template write validation with field-level checks"
      contains: "throw"
    - path: "Private/Get-ActiveTemplateConfig.ps1"
      provides: "Template read validation"
      contains: "throw"
  key_links:
    - from: "Private/Save-LabTemplate.ps1"
      to: ".planning/templates/*.json"
      via: "ConvertTo-Json + Set-Content"
      pattern: "ConvertTo-Json"
    - from: "Private/Get-ActiveTemplateConfig.ps1"
      to: ".planning/templates/*.json"
      via: "Get-Content + ConvertFrom-Json"
      pattern: "ConvertFrom-Json"
---

<objective>
Ensure the template system validates JSON data on both read and write with field-level checks that reject invalid data.

Purpose: Per user decision: "Reject templates with invalid data (bad IP format, unknown role) -- won't load until fixed. Don't auto-correct; force the user to fix the source of truth." Templates are the source of truth for VM deployment definitions. Invalid data here cascades into failed deployments.

Output: Save-LabTemplate validates strictly on write (throw on invalid). Get-ActiveTemplateConfig validates on read (throw on invalid). Both use PowerShell 5.1 compatible field-level validation (no Test-Json).
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cleanup-config-foundation/01-RESEARCH.md
@Private/Save-LabTemplate.ps1
@Private/Get-ActiveTemplateConfig.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strengthen Save-LabTemplate validation to throw on invalid data</name>
  <files>Private/Save-LabTemplate.ps1</files>
  <action>
1. Read Private/Save-LabTemplate.ps1 fully to understand current validation.

2. Research shows Save-LabTemplate already has some validation (IP regex check returns PSCustomObject with Success=$false). The current pattern returns error objects instead of throwing. Per user decision, change to **throw** on invalid data instead of returning error objects.

3. Create or enhance a private validation helper function `Test-LabTemplateVM` inside Save-LabTemplate.ps1 (or as a separate helper if one exists). The function should validate each VM entry with these checks:

   **VM Name validation:**
   - NetBIOS compatible: 1-15 chars, alphanumeric + hyphens only
   - Pattern: `'^[a-zA-Z0-9-]{1,15}$'`
   - Unique within template (no duplicate names)

   **IP Address validation:**
   - Valid IPv4 format: `'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$'`
   - Each octet 0-255 (basic regex catches format; octet range check is bonus)
   - Unique within template (no duplicate IPs)

   **Role validation:**
   - Must be from known role list: DC, SQL, IIS, WSUS, DHCP, FileServer, PrintServer, DSC, Jumpbox, Client, Ubuntu, WebServerUbuntu, DatabaseUbuntu, DockerUbuntu, K8sUbuntu
   - Empty/null role is acceptable (generic VM)

   **Memory validation:**
   - Must be numeric, 1-64 GB range
   - Type: integer or convertible to integer

   **Processor validation:**
   - Must be numeric, 1-16 range
   - Type: integer or convertible to integer

4. The validation function should throw with specific, actionable error messages:
   ```powershell
   throw "Template validation failed: VM name 'this-is-way-too-long-name' exceeds 15 characters."
   throw "Template validation failed: Invalid IP '999.1.2.3' for VM 'DC1'. Expected IPv4 format."
   throw "Template validation failed: Unknown role 'WebServer' for VM 'IIS1'. Valid roles: DC, SQL, IIS, ..."
   ```

5. Call the validation for each VM entry in the template before writing to disk. If ANY VM fails validation, throw immediately (don't write partial data).

6. Also validate the template structure itself:
   - Must have a `vms` array (or equivalent top-level structure)
   - `vms` array must not be empty
   - Template description should be a non-empty string (warn, don't throw)

7. Preserve the existing return pattern (`[pscustomobject]@{ Success = $true; ... }`) for successful operations. Only change error handling from returning `Success=$false` to throwing.
  </action>
  <verify>
- `grep 'throw.*Template validation failed' Private/Save-LabTemplate.ps1` shows throw-based validation
- `grep -c 'Success = \$false' Private/Save-LabTemplate.ps1` returns 0 (no soft error returns for validation)
- The file parses without syntax errors
  </verify>
  <done>Save-LabTemplate throws on invalid VM data (name, IP, role, memory, processors) instead of returning soft error objects. Validation covers NetBIOS names, IPv4 format, known roles, memory/processor ranges, and uniqueness.</done>
</task>

<task type="auto">
  <name>Task 2: Add read-time validation to Get-ActiveTemplateConfig</name>
  <files>Private/Get-ActiveTemplateConfig.ps1, Tests/Save-LabTemplate.Tests.ps1</files>
  <action>
1. Read Private/Get-ActiveTemplateConfig.ps1 fully. This function reads template JSON files and returns the active configuration.

2. Add validation after JSON deserialization but before returning data. When a template is loaded from disk, validate:

   **JSON parse validation:**
   - ConvertFrom-Json should succeed (already would throw on malformed JSON)
   - Wrap in try-catch with descriptive error:
     ```powershell
     try {
         $template = Get-Content $templatePath -Raw | ConvertFrom-Json
     }
     catch {
         throw "Template file '$templatePath' contains invalid JSON: $($_.Exception.Message)"
     }
     ```

   **Structure validation:**
   - Template must contain a VMs array (or the appropriate top-level property)
   - VMs array must not be empty
   - Each VM must have required fields: name, ip, role (at minimum)

   **Field validation (reuse same checks as Save-LabTemplate):**
   - Extract the VM validation logic into a shared helper function or duplicate the checks
   - Apply same name/IP/role/memory/processor validation as write-time
   - Throw on any invalid entry with: `"Template '$templatePath' contains invalid data: [specific error]"`

3. Per user decision: "Don't auto-correct; force the user to fix the source of truth." Do NOT attempt to repair invalid data. Throw and stop.

4. If a shared validation function makes sense (to avoid duplication between Save-LabTemplate and Get-ActiveTemplateConfig), create it as a separate private helper file `Private/Test-LabTemplateData.ps1`. This function should:
   - Accept a template object (deserialized JSON)
   - Validate all VM entries
   - Throw on first invalid entry
   - Be dot-sourced by both Save-LabTemplate and Get-ActiveTemplateConfig via Lab-Common.ps1 auto-discovery

5. Update or create Tests/Save-LabTemplate.Tests.ps1 to cover validation:
   - Test that invalid IP throws
   - Test that unknown role throws
   - Test that duplicate VM name throws
   - Test that valid template succeeds
   - Test that Get-ActiveTemplateConfig rejects invalid JSON on disk

NOTE: If Tests/Save-LabTemplate.Tests.ps1 already exists, add tests. If not, create it following existing test patterns (Pester 5.x, dot-source helpers in BeforeAll, mock in BeforeEach).
  </action>
  <verify>
- `grep 'throw.*invalid' Private/Get-ActiveTemplateConfig.ps1` shows validation errors
- If shared helper created: `Test-Path Private/Test-LabTemplateData.ps1` returns true
- Pester tests pass: `Invoke-Pester Tests/Save-LabTemplate.Tests.ps1 -PassThru` (or validate test file parses)
- Both files parse without syntax errors
  </verify>
  <done>Get-ActiveTemplateConfig validates loaded JSON structure and field values before returning. Shared validation helper extracts common checks. Pester tests cover invalid IP, unknown role, duplicate name, and valid template scenarios.</done>
</task>

</tasks>

<verification>
- Save-LabTemplate rejects invalid VMs with throw (not soft error returns)
- Get-ActiveTemplateConfig validates JSON on read
- Validation covers: VM name (NetBIOS), IP (IPv4), role (known list), memory (1-64), processors (1-16)
- No auto-correction of invalid data
- Pester tests confirm validation behavior
- All modified files parse without syntax errors
</verification>

<success_criteria>
1. Templates with invalid IP addresses, unknown roles, bad names, or out-of-range specs are rejected with clear error messages
2. Validation happens on both write (Save-LabTemplate) and read (Get-ActiveTemplateConfig)
3. Invalid templates cause immediate failure (throw), not soft error returns
4. Validation is PowerShell 5.1 compatible (field-level regex, no Test-Json)
5. Pester tests verify rejection of invalid data
</success_criteria>

<output>
After completion, create `.planning/phases/01-cleanup-config-foundation/01-04-SUMMARY.md`
</output>
