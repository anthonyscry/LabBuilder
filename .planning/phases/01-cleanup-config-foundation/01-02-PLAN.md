---
phase: 01-cleanup-config-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - OpenCodeLab-App.ps1
  - GUI/Start-OpenCodeLabGUI.ps1
autonomous: true
requirements:
  - CFG-02

must_haves:
  truths:
    - "OpenCodeLab-App.ps1 sources helpers via Lab-Common.ps1 dynamic discovery instead of manual $OrchestrationHelperPaths array"
    - "GUI entry point wraps each helper dot-source in try-catch with fail-fast error handling"
    - "A broken helper file causes immediate failure with clear error message in all entry points"
  artifacts:
    - path: "OpenCodeLab-App.ps1"
      provides: "CLI orchestrator with standardized helper sourcing"
      contains: "Lab-Common.ps1"
    - path: "GUI/Start-OpenCodeLabGUI.ps1"
      provides: "GUI entry point with fail-fast helper sourcing"
      contains: "catch"
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Lab-Common.ps1"
      via: "dot-source at startup"
      pattern: "\\. .*Lab-Common\\.ps1"
    - from: "GUI/Start-OpenCodeLabGUI.ps1"
      to: "Private/*.ps1"
      via: "try-catch wrapped dot-source"
      pattern: "try.*\\. \\$_\\.FullName.*catch"
---

<objective>
Standardize all entry points to use consistent helper sourcing with fail-fast error handling.

Purpose: Replace the 3 different helper sourcing patterns (explicit array in OpenCodeLab-App.ps1, bare Get-ChildItem in GUI, dynamic discovery in Lab-Common.ps1) with a single consistent pattern. Per user decision: "broken helper = broken app, surface it immediately."

Output: OpenCodeLab-App.ps1 uses Lab-Common.ps1 sourcing (removing $OrchestrationHelperPaths). GUI wraps dot-sourcing in try-catch. Both fail immediately on helper load errors.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cleanup-config-foundation/01-RESEARCH.md
@Lab-Common.ps1
@OpenCodeLab-App.ps1
@GUI/Start-OpenCodeLabGUI.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace $OrchestrationHelperPaths with Lab-Common.ps1 sourcing in OpenCodeLab-App.ps1</name>
  <files>OpenCodeLab-App.ps1</files>
  <action>
1. Read OpenCodeLab-App.ps1 lines 66-94 (current helper sourcing block).

2. The file currently does TWO things:
   - Line 66-67: Dot-sources Lab-Common.ps1 (which loads ALL Private + Public helpers via dynamic discovery)
   - Lines 69-94: ALSO manually loads 18 specific helpers via $OrchestrationHelperPaths array

   This is redundant. Lab-Common.ps1 already loads all Private/ and Public/ files including every file in $OrchestrationHelperPaths.

3. Remove the entire $OrchestrationHelperPaths block (lines 69-94):
   - Delete the `$OrchestrationHelperPaths = @(...)` array declaration
   - Delete the `foreach ($helperPath in $OrchestrationHelperPaths)` loop
   - Keep the Lab-Common.ps1 sourcing (lines 66-67)

4. IMPORTANT: The current Lab-Common.ps1 sourcing on line 67 has a silent skip pattern:
   ```powershell
   if ((-not $NoExecute) -and (-not $SkipRuntimeBootstrap) -and (Test-Path $CommonPath)) { . $CommonPath }
   ```
   This silently skips if Lab-Common.ps1 is missing. Per user decision (fail fast), change to:
   ```powershell
   if ((-not $NoExecute) -and (-not $SkipRuntimeBootstrap)) {
       if (-not (Test-Path $CommonPath)) {
           throw "Required helper loader not found: $CommonPath"
       }
       . $CommonPath
   }
   ```

5. Apply the same fail-fast pattern to the Lab-Config.ps1 sourcing on line 64:
   ```powershell
   if ((-not $NoExecute) -and (-not $SkipRuntimeBootstrap)) {
       if (-not (Test-Path $ConfigPath)) {
           throw "Required configuration not found: $ConfigPath"
       }
       . $ConfigPath
   }
   ```

6. Lines 99-100 define fallback variables:
   ```powershell
   if (-not (Get-Variable -Name LabName -ErrorAction SilentlyContinue)) { $LabName = 'AutomatedLab' }
   if (-not (Get-Variable -Name LabVMs -ErrorAction SilentlyContinue)) { $LabVMs = @('dc1', 'svr1', 'dsc', 'ws1') }
   ```
   Leave these for now -- they will be removed in Plan 03 (CFG-01 legacy variable removal). Do NOT remove them in this plan.
  </action>
  <verify>
- `grep -c 'OrchestrationHelperPaths' OpenCodeLab-App.ps1` returns 0
- `grep 'Lab-Common.ps1' OpenCodeLab-App.ps1` shows the fail-fast sourcing pattern
- `grep 'throw.*Required.*not found' OpenCodeLab-App.ps1` shows fail-fast for both config and common
- The script still parses: `pwsh -c "& { [System.Management.Automation.Language.Parser]::ParseFile('OpenCodeLab-App.ps1', [ref]\$null, [ref]\$null) }"` returns no parse errors (or use powershell.exe)
  </verify>
  <done>$OrchestrationHelperPaths array and its foreach loop removed. Lab-Common.ps1 and Lab-Config.ps1 sourcing uses fail-fast pattern (throws on missing file instead of silent skip).</done>
</task>

<task type="auto">
  <name>Task 2: Add fail-fast error handling to GUI helper sourcing</name>
  <files>GUI/Start-OpenCodeLabGUI.ps1</files>
  <action>
1. Read GUI/Start-OpenCodeLabGUI.ps1 lines 24-31 (current helper sourcing block).

2. Current pattern has no error handling on individual file loads:
   ```powershell
   foreach ($subDir in @('Private', 'Public')) {
       $dirPath = Join-Path $script:RepoRoot $subDir
       if (Test-Path $dirPath) {
           Get-ChildItem -Path $dirPath -Filter '*.ps1' -Recurse |
               ForEach-Object { . $_.FullName }
       }
   }
   ```

3. Replace with try-catch per file (matching Lab-Common.ps1 pattern). Per user decision: broken helper = broken app:
   ```powershell
   foreach ($subDir in @('Private', 'Public')) {
       $dirPath = Join-Path $script:RepoRoot $subDir
       if (Test-Path $dirPath) {
           $helperFiles = Get-ChildItem -Path $dirPath -Filter '*.ps1' -Recurse
           foreach ($file in $helperFiles) {
               try {
                   . $file.FullName
               }
               catch {
                   throw "Failed to load $subDir helper '$($file.FullName)': $($_.Exception.Message)"
               }
           }
       }
   }
   ```

4. Also check the Lab-Config.ps1 sourcing block (lines 33-40). Current code:
   ```powershell
   try { . $script:LabConfigPath } catch {
       if (-not (Test-Path variable:GlobalLabConfig)) { throw $_ }
   }
   ```
   This is acceptable -- it re-throws if GlobalLabConfig wasn't populated. Leave this as-is (the error swallowing is intentional for cross-platform path resolution).

5. Do NOT change the GUI to use Lab-Common.ps1 sourcing. The GUI sources files with `$script:RepoRoot` scope which is different from Lab-Common.ps1's `$ScriptRoot`. Keep the Get-ChildItem pattern but add error handling. This avoids introducing scoping bugs in the WPF GUI.
  </action>
  <verify>
- `grep -A3 'catch' GUI/Start-OpenCodeLabGUI.ps1` shows the fail-fast pattern with descriptive error message
- `grep 'ForEach-Object.*\\. \\$_\\.FullName' GUI/Start-OpenCodeLabGUI.ps1` returns 0 lines (old pattern gone)
- The script still parses without errors
  </verify>
  <done>GUI helper sourcing wraps each dot-source in try-catch with descriptive error message. Broken helper files now cause immediate failure with clear error instead of silent skip.</done>
</task>

</tasks>

<verification>
- No entry point silently skips failed helper loads
- OpenCodeLab-App.ps1 relies on Lab-Common.ps1 for all helper sourcing (no manual array)
- GUI uses try-catch per file with throw on failure
- Both scripts parse without syntax errors
- Existing Pester tests in Tests/ still pass (run subset that doesn't require Hyper-V)
</verification>

<success_criteria>
1. $OrchestrationHelperPaths array completely removed from OpenCodeLab-App.ps1
2. OpenCodeLab-App.ps1 sources helpers exclusively via Lab-Common.ps1 with fail-fast on missing
3. GUI wraps every dot-source in try-catch with descriptive throw
4. No silent helper load failures in any entry point
</success_criteria>

<output>
After completion, create `.planning/phases/01-cleanup-config-foundation/01-02-SUMMARY.md`
</output>
