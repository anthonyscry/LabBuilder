---
phase: 01-cleanup-config-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 01-02
files_modified:
  - Lab-Config.ps1
  - OpenCodeLab-App.ps1
  - Deploy.ps1
  - Bootstrap.ps1
  - Scripts/Test-OpenCodeLabHealth.ps1
  - Scripts/Test-OpenCodeLabPreflight.ps1
  - Scripts/Asset-Report.ps1
  - Scripts/Lab-Status.ps1
  - Scripts/Add-LIN1.ps1
  - Scripts/Start-LabDay.ps1
  - Scripts/Configure-LIN1.ps1
  - Scripts/Test-OnWS1.ps1
  - Scripts/Save-LabWork.ps1
  - Scripts/Push-ToWS1.ps1
  - Scripts/New-LabProject.ps1
  - Private/Get-LabStateProbe.ps1
  - Private/Get-LabFleetStateProbe.ps1
  - Private/Resolve-LabPassword.ps1
  - Private/New-LabDeploymentReport.ps1
  - LabBuilder/Build-LabFromSelection.ps1
  - Public/Linux/New-LinuxGoldenVhdx.ps1
  - Public/Linux/New-LinuxVM.ps1
  - Public/Linux/Join-LinuxToDomain.ps1
autonomous: true
requirements:
  - CFG-01
  - CFG-03

must_haves:
  truths:
    - "No script outside Lab-Config.ps1 references legacy variables ($LabName, $LabSwitch, $AdminPassword, etc.)"
    - "All consumers use $GlobalLabConfig hashtable exclusively for configuration access"
    - "Lab-Config.ps1 validates required fields on load and throws immediately on missing/invalid values"
    - "$LabBuilderConfig alias is preserved for LabBuilder scripts (intentional coupling)"
  artifacts:
    - path: "Lab-Config.ps1"
      provides: "Single source of truth config with validation"
      contains: "Test-LabConfigRequired"
    - path: "Private/Resolve-LabPassword.ps1"
      provides: "Password resolution using GlobalLabConfig"
      contains: "GlobalLabConfig"
  key_links:
    - from: "Lab-Config.ps1"
      to: "All consumer scripts"
      via: "$GlobalLabConfig hashtable"
      pattern: "\\$GlobalLabConfig\\."
    - from: "Lab-Config.ps1"
      to: "LabBuilder/Build-LabFromSelection.ps1"
      via: "$LabBuilderConfig alias"
      pattern: "\\$LabBuilderConfig"
---

<objective>
Unify configuration to use $GlobalLabConfig exclusively, remove all legacy variable exports, and add validation that fails loudly on missing/invalid required fields.

Purpose: Per user decision: "Kill legacy variables immediately -- no deprecation period. Config validation fails loudly -- missing required fields = script stops with clear error message." This eliminates the dual config system (hashtable + legacy variables) that causes confusion and config drift.

Output: Lab-Config.ps1 is the single source of truth with validation. All 20+ consumer files updated to use $GlobalLabConfig. Legacy variable block deleted.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cleanup-config-foundation/01-RESEARCH.md
@.planning/phases/01-cleanup-config-foundation/01-02-SUMMARY.md
@Lab-Config.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configuration validation to Lab-Config.ps1 and delete legacy variable exports</name>
  <files>Lab-Config.ps1</files>
  <action>
1. Read Lab-Config.ps1 fully. The file has two sections:
   - Lines 1-398: `$GlobalLabConfig` hashtable definition (KEEP)
   - Lines 400-516: Legacy variable exports (DELETE entirely)

2. Delete the entire legacy variable export block (lines 400-516). This includes:
   - All `$LabName = $GlobalLabConfig.Lab.Name` style assignments
   - All `$DC_Memory`, `$LabSwitch`, `$AdminPassword`, etc. variables
   - The `$LabBuilderConfig = $GlobalLabConfig.Builder` alias
   - The `$GitPackageConfig = $GlobalLabConfig.SoftwarePackages.Git` alias

3. EXCEPTION: Preserve `$LabBuilderConfig` as an intentional alias. Research confirms LabBuilder scripts need this. Add it back as a single line after the hashtable:
   ```powershell
   # Expose Builder config for LabBuilder scripts (intentional coupling -- see 01-RESEARCH.md)
   $LabBuilderConfig = $GlobalLabConfig.Builder
   ```

4. Add a validation function at the end of Lab-Config.ps1, AFTER the $GlobalLabConfig hashtable definition. Use the pattern from research (Test-LabConfigRequired):

   ```powershell
   # ── Configuration Validation ──────────────────────────────────────────────
   # Validates required fields exist and have valid values.
   # Fails loudly per design: missing required fields = script stops.

   function Test-LabConfigRequired {
       [CmdletBinding()]
       param([hashtable]$Config)

       $requiredFields = @{
           'Lab.Name'              = { param($v) $v -match '^[a-zA-Z0-9_-]+$' }
           'Lab.DomainName'        = { param($v) $v -match '^[a-z0-9.-]+$' }
           'Network.SwitchName'    = { param($v) $v -match '^[a-zA-Z0-9_ -]+$' }
           'Network.AddressSpace'  = { param($v) $v -match '^\d{1,3}(\.\d{1,3}){3}/\d{1,2}$' }
           'Network.GatewayIp'     = { param($v) $v -match '^\d{1,3}(\.\d{1,3}){3}$' }
           'Network.DnsIp'         = { param($v) $v -match '^\d{1,3}(\.\d{1,3}){3}$' }
           'Credentials.InstallUser' = { param($v) -not [string]::IsNullOrWhiteSpace($v) }
           'Credentials.AdminPassword' = { param($v) -not [string]::IsNullOrWhiteSpace($v) }
           'Paths.LabRoot'         = { param($v) -not [string]::IsNullOrWhiteSpace($v) }
           'Paths.LabSourcesRoot'  = { param($v) -not [string]::IsNullOrWhiteSpace($v) }
       }

       foreach ($keyPath in $requiredFields.Keys) {
           $parts = $keyPath -split '\.'
           $value = $Config
           foreach ($part in $parts) {
               if (-not ($value -is [hashtable]) -or -not $value.ContainsKey($part)) {
                   throw "Lab-Config validation failed: Required field '$keyPath' is missing from `$GlobalLabConfig."
               }
               $value = $value[$part]
           }
           if (-not (& $requiredFields[$keyPath] $value)) {
               throw "Lab-Config validation failed: Invalid value for '$keyPath': '$value'"
           }
       }
   }

   Test-LabConfigRequired -Config $GlobalLabConfig
   ```

5. The AdminPassword warning that was in the legacy block (lines 458-460) should be preserved. Add it after validation:
   ```powershell
   if ($GlobalLabConfig.Credentials.AdminPassword -eq 'SimpleLab123!') {
       Write-Warning "[Lab-Config] AdminPassword is set to the default value. Set the '$($GlobalLabConfig.Credentials.PasswordEnvVar)' environment variable or update Lab-Config.ps1 for production use."
   }
   ```
  </action>
  <verify>
- `grep -c '^\$LabName\|^\$LabSwitch\|^\$AdminPassword\|^\$DomainName\|^\$LabPath\|^\$AddressSpace\|^\$DC_Memory\|^\$Server_Memory' Lab-Config.ps1` returns 0 (no legacy exports)
- `grep 'LabBuilderConfig' Lab-Config.ps1` shows exactly one line (the intentional alias)
- `grep 'Test-LabConfigRequired' Lab-Config.ps1` shows the function definition and call
- The file ends with validation call and admin password warning
  </verify>
  <done>Legacy variable export block (lines 400-516) deleted. $LabBuilderConfig alias preserved. Test-LabConfigRequired function added and called at end of Lab-Config.ps1. Config now fails loudly on missing/invalid required fields.</done>
</task>

<task type="auto">
  <name>Task 2: Update all consumer scripts to use $GlobalLabConfig instead of legacy variables</name>
  <files>OpenCodeLab-App.ps1, Deploy.ps1, Bootstrap.ps1, Scripts/Test-OpenCodeLabHealth.ps1, Scripts/Test-OpenCodeLabPreflight.ps1, Scripts/Asset-Report.ps1, Scripts/Lab-Status.ps1, Scripts/Add-LIN1.ps1, Scripts/Start-LabDay.ps1, Scripts/Configure-LIN1.ps1, Scripts/Test-OnWS1.ps1, Scripts/Save-LabWork.ps1, Scripts/Push-ToWS1.ps1, Scripts/New-LabProject.ps1, Private/Get-LabStateProbe.ps1, Private/Get-LabFleetStateProbe.ps1, Private/Resolve-LabPassword.ps1, Private/New-LabDeploymentReport.ps1, LabBuilder/Build-LabFromSelection.ps1, Public/Linux/New-LinuxGoldenVhdx.ps1, Public/Linux/New-LinuxVM.ps1, Public/Linux/Join-LinuxToDomain.ps1</files>
  <action>
For each of the ~23 files that reference legacy variables (identified by grep), replace every legacy variable reference with its $GlobalLabConfig equivalent. Use this mapping:

**Lab identity:**
- `$LabName` -> `$GlobalLabConfig.Lab.Name`
- `$LabVMs` -> `@($GlobalLabConfig.Lab.CoreVMNames)`
- `$DomainName` -> `$GlobalLabConfig.Lab.DomainName`

**Paths:**
- `$LabPath` -> `Join-Path $GlobalLabConfig.Paths.LabRoot $GlobalLabConfig.Lab.Name`
- `$LabSourcesRoot` -> `$GlobalLabConfig.Paths.LabSourcesRoot`
- `$ScriptsRoot` -> `Join-Path $GlobalLabConfig.Paths.LabSourcesRoot 'Scripts'`
- `$ShareName` -> `$GlobalLabConfig.Paths.ShareName`
- `$SharePath` -> `$GlobalLabConfig.Paths.SharePath`
- `$GitRepoPath` -> `$GlobalLabConfig.Paths.GitRepoPath`
- `$LinuxLabShareMount` -> `$GlobalLabConfig.Paths.LinuxLabShareMount`
- `$LinuxProjectsRoot` -> `$GlobalLabConfig.Paths.LinuxProjectsRoot`

**Networking:**
- `$LabSwitch` -> `$GlobalLabConfig.Network.SwitchName`
- `$AddressSpace` -> `$GlobalLabConfig.Network.AddressSpace`
- `$GatewayIp` -> `$GlobalLabConfig.Network.GatewayIp`
- `$NatName` -> `$GlobalLabConfig.Network.NatName`
- `$DnsIp` -> `$GlobalLabConfig.Network.DnsIp`

**IPs:**
- `$dc1_Ip` / `$DC1_Ip` -> `$GlobalLabConfig.IPPlan.DC1`
- `$svr1_Ip` / `$Server1_Ip` -> `$GlobalLabConfig.IPPlan.SVR1`
- `$ws1_Ip` / `$Win11_Ip` -> `$GlobalLabConfig.IPPlan.WS1`
- `$dsc_Ip` -> `$GlobalLabConfig.IPPlan.DSC1`
- `$lin1_Ip` / `$LIN1_Ip` -> `$GlobalLabConfig.IPPlan.LIN1`

**VM sizing:**
- `$DC_Memory` -> `$GlobalLabConfig.VMSizing.DC.Memory` (and Min/Max/Processors patterns)
- `$Server_Memory` -> `$GlobalLabConfig.VMSizing.Server.Memory`
- `$Client_Memory` -> `$GlobalLabConfig.VMSizing.Client.Memory`
- `$DSC_Memory` -> `$GlobalLabConfig.VMSizing.DSC.Memory`
- `$UBU_Memory` -> `$GlobalLabConfig.VMSizing.Ubuntu.Memory`

**Credentials:**
- `$AdminPassword` -> `$GlobalLabConfig.Credentials.AdminPassword`
- `$SqlSaPassword` -> `$GlobalLabConfig.Credentials.SqlSaPassword`
- `$LabInstallUser` -> `$GlobalLabConfig.Credentials.InstallUser`
- `$LinuxUser` -> `$GlobalLabConfig.Credentials.LinuxUser`
- `$GitName` -> `$GlobalLabConfig.Credentials.GitName`
- `$GitEmail` -> `$GlobalLabConfig.Credentials.GitEmail`

**Timeouts:**
- `$AL_Timeout_*` -> `$GlobalLabConfig.Timeouts.AutomatedLab.*`
- `$LIN1_WaitMinutes` -> `$GlobalLabConfig.Timeouts.Linux.LIN1WaitMinutes`
- `$SSH_ConnectTimeout` -> `$GlobalLabConfig.Timeouts.Linux.SSHConnectTimeout`
- `$SSH_PollInitialSec` -> `$GlobalLabConfig.Timeouts.Linux.SSHPollInitialSec`
- `$SSH_PollMaxSec` -> `$GlobalLabConfig.Timeouts.Linux.SSHPollMaxSec`

**Other:**
- `$RequiredISOs` -> `@($GlobalLabConfig.RequiredISOs)`
- `$LabTimeZone` -> `$GlobalLabConfig.Lab.TimeZone`
- `$DhcpScopeId` -> `$GlobalLabConfig.DHCP.ScopeId` (and Start/End/Mask)
- `$SSHKeyDir` -> `Join-Path $GlobalLabConfig.Paths.LabSourcesRoot 'SSHKeys'`
- `$SSHPublicKey` -> computed from SSHKeyDir
- `$SSHPrivateKey` -> computed from SSHKeyDir
- `$GitPackageConfig` -> `$GlobalLabConfig.SoftwarePackages.Git`

**IMPORTANT for OpenCodeLab-App.ps1:** Remove the fallback variable definitions (lines 99-100):
```powershell
if (-not (Get-Variable -Name LabName ...)) { $LabName = 'AutomatedLab' }
if (-not (Get-Variable -Name LabVMs ...)) { $LabVMs = @('dc1', 'svr1', 'dsc', 'ws1') }
```
These are no longer needed -- $GlobalLabConfig is loaded by Lab-Config.ps1 and validated.

**IMPORTANT for LabBuilder/Build-LabFromSelection.ps1:** This file uses `$LabBuilderConfig` which is intentionally preserved as an alias. Leave `$LabBuilderConfig` references as-is. Only replace non-Builder legacy variables (like `$AdminPassword`, `$LabName`).

**IMPORTANT for Resolve-LabPassword.ps1:** This is the credential resolution function. Update it to read from `$GlobalLabConfig.Credentials.AdminPassword` instead of `$AdminPassword`.

**PowerShell 5.1 note:** Use nested `Join-Path` for computed paths (only 2 args per call).

Process each file methodically. For each file:
1. Read the file
2. Identify all legacy variable references (grep output provides locations)
3. Replace each with the $GlobalLabConfig equivalent
4. Verify the file still parses
  </action>
  <verify>
- `grep -r '\$LabName\b\|\$LabSwitch\b\|\$AdminPassword\b\|\$DomainName\b\|\$LabPath\b\|\$AddressSpace\b\|\$DC_Memory\b' --include="*.ps1" | grep -v Lab-Config.ps1 | grep -v Tests/ | grep -v .archive/` returns 0 lines
- `grep -r '\$GatewayIp\b\|\$NatName\b\|\$dc1_Ip\b\|\$svr1_Ip\b\|\$LabSourcesRoot\b\|\$ScriptsRoot\b' --include="*.ps1" | grep -v Lab-Config.ps1 | grep -v Tests/ | grep -v .archive/` returns 0 lines
- All modified scripts parse without errors
- `grep 'LabBuilderConfig' LabBuilder/Build-LabFromSelection.ps1` still shows usage (intentional)
  </verify>
  <done>All 20+ consumer scripts updated to use $GlobalLabConfig exclusively. No legacy variable references remain outside Lab-Config.ps1 and Tests/. $LabBuilderConfig alias preserved for LabBuilder. Fallback variable definitions removed from OpenCodeLab-App.ps1.</done>
</task>

</tasks>

<verification>
- `grep -rn '\$LabName\b' --include="*.ps1" | grep -v 'Lab-Config.ps1\|Tests/\|\.archive/' | wc -l` returns 0
- `grep -rn '\$LabSwitch\b\|\$AdminPassword\b\|\$DomainName\b' --include="*.ps1" | grep -v 'Lab-Config.ps1\|Tests/\|\.archive/' | wc -l` returns 0
- `grep 'Test-LabConfigRequired' Lab-Config.ps1` returns hits (validation exists)
- Lab-Config.ps1 legacy export block (lines 400-516) is gone
- All modified .ps1 files parse without syntax errors
</verification>

<success_criteria>
1. Zero legacy variable references outside Lab-Config.ps1 and Tests/
2. Lab-Config.ps1 validates all required fields on load with clear error messages
3. All 20+ consumer scripts use $GlobalLabConfig exclusively
4. $LabBuilderConfig alias preserved for LabBuilder scripts
5. Config validation throws immediately on missing/invalid required fields (no silent defaults)
</success_criteria>

<output>
After completion, create `.planning/phases/01-cleanup-config-foundation/01-03-SUMMARY.md`
</output>
