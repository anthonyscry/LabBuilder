---
phase: 21-lab-export-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Export-LabPackage.ps1
  - Private/Import-LabPackage.ps1
autonomous: true
requirements: [XFER-01, XFER-02, XFER-03]

must_haves:
  truths:
    - "Export-LabPackage reads a saved profile and bundles config + metadata into a self-contained JSON package file"
    - "Import-LabPackage reads a package JSON and saves the config as a usable profile without manual editing"
    - "Import-LabPackage rejects malformed packages before applying, listing which fields failed validation"
  artifacts:
    - path: "Private/Export-LabPackage.ps1"
      provides: "Export-LabPackage cmdlet"
      exports: ["Export-LabPackage"]
    - path: "Private/Import-LabPackage.ps1"
      provides: "Import-LabPackage cmdlet with validation"
      exports: ["Import-LabPackage"]
  key_links:
    - from: "Private/Export-LabPackage.ps1"
      to: "Private/Load-LabProfile.ps1"
      via: "Reads profile JSON from .planning/profiles/"
      pattern: "Get-Content.*profiles.*json"
    - from: "Private/Import-LabPackage.ps1"
      to: "Private/Save-LabProfile.ps1"
      via: "Saves imported config as a profile"
      pattern: "Save-LabProfile"
---

<objective>
Create Export-LabPackage and Import-LabPackage Private cmdlets that bundle lab configurations into portable JSON packages and restore them on any compatible host.

Purpose: Enables operators to transfer or back up lab definitions as self-contained files that can be redeployed without manual file editing.
Output: Two Private/ cmdlets following established profile cmdlet patterns.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-configuration-profiles/18-01-SUMMARY.md
@.planning/phases/18-configuration-profiles/18-02-SUMMARY.md
@Private/Save-LabProfile.ps1
@Private/Load-LabProfile.ps1
@Private/Get-LabProfile.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Export-LabPackage cmdlet</name>
  <files>Private/Export-LabPackage.ps1</files>
  <action>
Create Private/Export-LabPackage.ps1 with a single function Export-LabPackage following the exact same patterns as Save-LabProfile.ps1 (CmdletBinding, PSCustomObject output, throw on validation, try/catch on I/O).

Parameters:
- [Parameter(Mandatory)][string]$Name — profile name to export (validated with ^[a-zA-Z0-9_-]+$ regex, same as Save-LabProfile)
- [Parameter(Mandatory)][string]$Path — output directory where the package JSON will be written
- [Parameter(Mandatory)][string]$RepoRoot — repo root for locating profiles (same pattern as profile cmdlets)

Logic:
1. Validate $Name with the same regex as profile cmdlets. Throw on invalid name.
2. Build profile path: Join-Path (Join-Path (Join-Path $RepoRoot '.planning') 'profiles') "$Name.json" (nested Join-Path for PS 5.1).
3. If profile does not exist at that path, throw "Profile '$Name' not found."
4. Read and parse the profile JSON with Get-Content -Raw -Encoding UTF8 | ConvertFrom-Json.
5. Build the package object as [ordered]@{}:
   - packageVersion = '1.0'
   - exportedAt = Get-Date -Format 'o'
   - sourceName = the profile's .name field
   - sourceDescription = the profile's .description field (or '' if missing)
   - config = the profile's .config object (the full lab configuration)
6. Validate $Path directory exists. If not, create it with New-Item -ItemType Directory -Force.
7. Write the package to Join-Path $Path "$Name.json" using ConvertTo-Json -Depth 10 | Set-Content -Encoding UTF8.
8. Return [pscustomobject]@{ Success = $true; Message = "Package '$Name' exported to '$packagePath'." ; Path = $packagePath }.

Include full comment-based help (.SYNOPSIS, .PARAMETER, .OUTPUTS, .EXAMPLE) matching the style of Save-LabProfile.ps1.
  </action>
  <verify>Confirm file exists and contains function Export-LabPackage with CmdletBinding, parameter validation, profile reading, package JSON writing, and PSCustomObject return.</verify>
  <done>Export-LabPackage reads a saved profile from .planning/profiles/, bundles it into a self-contained JSON package with version and metadata, and writes it to the specified output path.</done>
</task>

<task type="auto">
  <name>Task 2: Create Import-LabPackage cmdlet</name>
  <files>Private/Import-LabPackage.ps1</files>
  <action>
Create Private/Import-LabPackage.ps1 with a single function Import-LabPackage following Load-LabProfile.ps1 patterns.

Parameters:
- [Parameter(Mandatory)][string]$Path — full path to the package JSON file to import
- [Parameter(Mandatory)][string]$RepoRoot — repo root for saving the imported profile
- [Parameter()][string]$Name — optional override name for the imported profile. If not provided, uses sourceName from the package.

Logic:
1. Validate $Path exists. If not, throw "Package file not found: '$Path'".
2. Read the package JSON: Get-Content -Raw -Path $Path -Encoding UTF8 | ConvertFrom-Json. Wrap in try/catch, throw on parse failure: "Failed to read package '$Path': $($_.Exception.Message)".
3. **Validate package integrity (XFER-03)** — check ALL required fields before applying anything:
   - Build a $validationErrors = @() list
   - Check $data has 'packageVersion' NoteProperty. If missing, add "Missing required field: 'packageVersion'" to $validationErrors.
   - Check $data has 'sourceName' NoteProperty. If missing, add "Missing required field: 'sourceName'" to $validationErrors.
   - Check $data has 'config' NoteProperty. If missing, add "Missing required field: 'config'" to $validationErrors.
   - If 'config' exists, check it has a 'Lab' NoteProperty. If missing, add "Package config missing required section: 'Lab'" to $validationErrors.
   - If $validationErrors.Count -gt 0, throw "Package validation failed:`n$($validationErrors -join "`n")" — this displays ALL failed fields at once, not just the first one.
4. Determine the profile name: use $Name if provided and non-empty, else use $data.sourceName. Validate the resolved name with the ^[a-zA-Z0-9_-]+$ regex. Throw on invalid.
5. Convert $data.config from PSCustomObject to hashtable using the ConvertTo-Hashtable function. NOTE: Dot-source Load-LabProfile.ps1 is NOT needed — instead, include a local copy of ConvertTo-Hashtable in this file (same pattern as Load-LabProfile.ps1 has its own copy). This avoids cross-file coupling.
6. Call Save-LabProfile -Name $resolvedName -Config $configHashtable -RepoRoot $RepoRoot -Description "Imported from package: $($data.sourceName)".
7. Return [pscustomobject]@{ Success = $true; Message = "Package imported as profile '$resolvedName'." ; ProfileName = $resolvedName }.

Include full comment-based help matching Load-LabProfile.ps1 style. The .SYNOPSIS should mention that validation occurs before any configuration is applied.

IMPORTANT: The ConvertTo-Hashtable function in this file should be named ConvertTo-PackageHashtable to avoid conflicts with the one in Load-LabProfile.ps1. Same implementation, different name.
  </action>
  <verify>Confirm file exists and contains function Import-LabPackage with CmdletBinding, package reading, multi-field validation that collects all errors before throwing, ConvertTo-PackageHashtable helper, Save-LabProfile call, and PSCustomObject return.</verify>
  <done>Import-LabPackage reads a package JSON, validates all required fields (packageVersion, sourceName, config, config.Lab) collecting errors before throwing, converts config to hashtable, and saves as a named profile via Save-LabProfile.</done>
</task>

</tasks>

<verification>
- Both files exist in Private/ with proper CmdletBinding and comment-based help
- Export-LabPackage writes a JSON package containing packageVersion, exportedAt, sourceName, config
- Import-LabPackage validates packageVersion, sourceName, config, config.Lab before applying
- Import-LabPackage collects ALL validation errors and displays them together (not fail-fast on first)
- Both functions use nested Join-Path for PS 5.1 compatibility
- Both functions use [pscustomobject] return type with Success/Message properties
</verification>

<success_criteria>
- Export-LabPackage can read any saved profile and produce a self-contained JSON package
- Import-LabPackage can read a valid package and save it as a profile via Save-LabProfile
- Import-LabPackage rejects packages missing packageVersion, sourceName, or config with all errors listed
- No global state modification — both functions are side-effect-free except for file I/O
</success_criteria>

<output>
After completion, create `.planning/phases/21-lab-export-import/21-01-SUMMARY.md`
</output>
