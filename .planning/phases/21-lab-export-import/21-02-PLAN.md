---
phase: 21-lab-export-import
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - Tests/LabExportImport.Tests.ps1
  - SimpleLab.psd1
autonomous: true
requirements: [XFER-01, XFER-02, XFER-03]

must_haves:
  truths:
    - "Pester tests prove Export-LabPackage creates valid package JSON from a saved profile"
    - "Pester tests prove Import-LabPackage saves a profile from a valid package"
    - "Pester tests prove Import-LabPackage rejects malformed packages listing all validation errors"
    - "Export-LabPackage and Import-LabPackage are exported from the module manifest"
  artifacts:
    - path: "Tests/LabExportImport.Tests.ps1"
      provides: "Comprehensive Pester tests for export/import"
      min_lines: 80
    - path: "SimpleLab.psd1"
      provides: "Module manifest with Export-LabPackage and Import-LabPackage in FunctionsToExport"
      contains: "Export-LabPackage"
  key_links:
    - from: "Tests/LabExportImport.Tests.ps1"
      to: "Private/Export-LabPackage.ps1"
      via: "dot-source in BeforeAll"
      pattern: "\\. .*Export-LabPackage"
    - from: "Tests/LabExportImport.Tests.ps1"
      to: "Private/Import-LabPackage.ps1"
      via: "dot-source in BeforeAll"
      pattern: "\\. .*Import-LabPackage"
    - from: "SimpleLab.psd1"
      to: "Private/Export-LabPackage.ps1"
      via: "FunctionsToExport entry"
      pattern: "Export-LabPackage"
---

<objective>
Create comprehensive Pester tests for Export-LabPackage and Import-LabPackage, and register both functions in the module manifest.

Purpose: Proves all three XFER requirements work correctly and makes the cmdlets available to module consumers.
Output: Test file with full coverage + updated module manifest.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-lab-export-import/21-01-SUMMARY.md
@Tests/LabProfile.Tests.ps1
@Private/Export-LabPackage.ps1
@Private/Import-LabPackage.ps1
@SimpleLab.psd1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive Pester tests for Export-LabPackage and Import-LabPackage</name>
  <files>Tests/LabExportImport.Tests.ps1</files>
  <action>
Create Tests/LabExportImport.Tests.ps1 following the EXACT pattern of Tests/LabProfile.Tests.ps1:
- BeforeAll dot-sources the cmdlets: Export-LabPackage.ps1, Import-LabPackage.ps1, Save-LabProfile.ps1 (dependency), and Load-LabProfile.ps1 (for ConvertTo-Hashtable used in round-trip verification)
- New-TestRepoRoot, Remove-TestRepoRoot, New-TestConfig helper functions (same as LabProfile.Tests.ps1)
- Every test uses try/finally with Remove-TestRepoRoot for guaranteed cleanup

Test structure (Describe blocks):

**Describe 'Export-LabPackage'** (XFER-01):
1. "exports a saved profile as a package JSON file" — Save a profile first via Save-LabProfile, then Export-LabPackage. Verify output file exists, parse the JSON, check packageVersion eq '1.0', sourceName eq the profile name, config is present, exportedAt is non-empty.
2. "throws on non-existent profile" — Call Export-LabPackage with a name that has no saved profile. Verify it throws "not found".
3. "throws on invalid profile name" — Call Export-LabPackage -Name "bad/name". Verify it throws "invalid characters".
4. "creates output directory if it does not exist" — Call Export-LabPackage with a $Path that does not exist yet. Verify the directory is created and the package file is written.
5. "returns Success object with Path" — Verify the return object has Success = $true and Path pointing to the written file.

**Describe 'Import-LabPackage'** (XFER-02):
6. "imports a valid package as a profile" — Export a profile, then Import-LabPackage from the exported file. Verify a profile now exists with the source name (use Get-Content on the .planning/profiles/{name}.json to confirm).
7. "imports with custom name override" — Export, then Import-LabPackage -Name "custom-name". Verify the profile is saved under "custom-name".
8. "throws on non-existent package file" — Call Import-LabPackage with a path that does not exist. Verify it throws "not found".
9. "round-trip preserves config data" — Save profile, export, import (with different name), then load the imported profile JSON and compare key config values (Lab.Name, Lab.CoreVMNames count) to originals.

**Describe 'Import-LabPackage Validation'** (XFER-03):
10. "rejects package missing packageVersion" — Write a JSON file with config and sourceName but no packageVersion. Import-LabPackage should throw containing "packageVersion".
11. "rejects package missing config" — Write a JSON file with packageVersion and sourceName but no config. Import-LabPackage should throw containing "config".
12. "rejects package missing sourceName" — Write a JSON file with packageVersion and config but no sourceName. Import-LabPackage should throw containing "sourceName".
13. "rejects package with config missing Lab section" — Write a JSON file with packageVersion, sourceName, and config = {} (no Lab key). Import-LabPackage should throw containing "Lab".
14. "lists ALL validation errors at once" — Write a JSON file with only exportedAt (missing packageVersion, sourceName, config). Import-LabPackage should throw and the error message should contain ALL THREE missing field names.
15. "rejects unparseable JSON" — Write a file with invalid JSON content. Import-LabPackage should throw containing "Failed to read".

That is 15 tests total across 3 Describe blocks.
  </action>
  <verify>Run `pwsh -Command "Invoke-Pester Tests/LabExportImport.Tests.ps1 -Output Detailed"` and confirm all 15 tests pass.</verify>
  <done>15 Pester tests pass covering export (5 tests), import (4 tests), and validation (6 tests) proving all three XFER requirements.</done>
</task>

<task type="auto">
  <name>Task 2: Register Export-LabPackage and Import-LabPackage in module manifest</name>
  <files>SimpleLab.psd1</files>
  <action>
Edit SimpleLab.psd1 FunctionsToExport array. Add 'Export-LabPackage' and 'Import-LabPackage' to the list.

Place them in a new comment group after the "# Run history" section:
```
    # Lab export/import
    'Export-LabPackage', 'Import-LabPackage',
```

This follows the existing pattern where functions are grouped by feature with a comment header (e.g., "# VM management", "# Run history").
  </action>
  <verify>Run `pwsh -Command "(Import-PowerShellDataFile SimpleLab.psd1).FunctionsToExport"` and confirm Export-LabPackage and Import-LabPackage appear in the output.</verify>
  <done>Export-LabPackage and Import-LabPackage are registered in SimpleLab.psd1 FunctionsToExport and will be available when the module is imported.</done>
</task>

</tasks>

<verification>
- All 15 Pester tests pass with zero failures
- SimpleLab.psd1 FunctionsToExport includes Export-LabPackage and Import-LabPackage
- Tests cover: successful export, successful import, name override, round-trip data fidelity, validation of all required fields, multi-error reporting, invalid JSON handling
</verification>

<success_criteria>
- 15 Pester tests pass proving export creates valid packages, import restores profiles, and validation catches all malformed packages
- Module manifest updated so both commands are exported
- Test patterns match existing LabProfile.Tests.ps1 conventions (BeforeAll dot-source, try/finally cleanup, New-TestConfig helper)
</success_criteria>

<output>
After completion, create `.planning/phases/21-lab-export-import/21-02-SUMMARY.md`
</output>
