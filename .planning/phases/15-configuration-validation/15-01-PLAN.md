---
phase: 15-configuration-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Get-LabHostResourceInfo.ps1
  - Private/Test-LabConfigValidation.ps1
  - Tests/ConfigValidation.Tests.ps1
autonomous: true
requirements: [CONF-01, CONF-02, CONF-03]

must_haves:
  truths:
    - "Operator can run Test-LabConfigValidation and see a consolidated pass/fail report"
    - "Report compares host free RAM, disk, CPUs against scenario template requirements"
    - "Every failed check includes a diagnostic message explaining the problem and a remediation step"
  artifacts:
    - path: "Private/Get-LabHostResourceInfo.ps1"
      provides: "Host resource probe returning free RAM GB, free disk GB, logical CPU count"
      min_lines: 40
    - path: "Private/Test-LabConfigValidation.ps1"
      provides: "Unified validation runner combining host resource checks with guided diagnostics"
      min_lines: 80
    - path: "Tests/ConfigValidation.Tests.ps1"
      provides: "Pester tests for host resource probe and validation runner"
      min_lines: 100
  key_links:
    - from: "Private/Test-LabConfigValidation.ps1"
      to: "Private/Get-LabHostResourceInfo.ps1"
      via: "calls Get-LabHostResourceInfo for host stats"
      pattern: "Get-LabHostResourceInfo"
    - from: "Private/Test-LabConfigValidation.ps1"
      to: "Private/Get-LabScenarioResourceEstimate.ps1"
      via: "calls Get-LabScenarioResourceEstimate for template requirements"
      pattern: "Get-LabScenarioResourceEstimate"
---

<objective>
Create the host resource probe and unified configuration validation engine that compares host availability against scenario requirements, producing a consolidated pass/fail report with guided diagnostics.

Purpose: Operators need pre-deployment validation that catches resource shortfalls before wasting time on doomed deployments. Each failure must explain what is wrong and how to fix it.
Output: Get-LabHostResourceInfo helper, Test-LabConfigValidation runner, and Pester test suite.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@Private/Get-LabScenarioResourceEstimate.ps1
@Private/Get-LabScenarioTemplate.ps1
@Private/Test-DiskSpace.ps1
@Private/Get-HostInfo.ps1
@Lab-Config.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Get-LabHostResourceInfo and Test-LabConfigValidation functions</name>
  <files>
    Private/Get-LabHostResourceInfo.ps1
    Private/Test-LabConfigValidation.ps1
  </files>
  <action>
Create two Private/ helper functions following existing codebase patterns ([CmdletBinding()], [OutputType([PSCustomObject])], try/catch with prefixed error messages, Set-StrictMode -Version Latest not needed inside functions since it's set at caller level).

**Get-LabHostResourceInfo.ps1:**
- Returns [pscustomobject] with: FreeRAMGB (decimal, rounded to 2), FreeDiskGB (decimal, rounded to 2), LogicalProcessors (int), DiskPath (string showing which path was checked)
- On Windows: Use Get-CimInstance Win32_OperatingSystem for FreePhysicalMemory (convert KB to GB), Get-PSDrive for disk free (same approach as Test-DiskSpace.ps1), [Environment]::ProcessorCount for logical CPUs
- On Linux/macOS: Use /proc/meminfo or `free -b` for RAM, `df -k` for disk, [Environment]::ProcessorCount for CPUs
- Accept optional -DiskPath parameter (default "C:\" on Windows, "/" on Linux) following the platform detection pattern from Get-HostInfo.ps1 (Get-Variable -Name 'IsWindows' -ErrorAction SilentlyContinue)
- Error handling: wrap in try/catch, throw "Get-LabHostResourceInfo: {message}"

**Test-LabConfigValidation.ps1:**
- Accept parameters: -Scenario (optional string), -TemplatesRoot (optional, defaults same as Get-LabScenarioTemplate), -DiskPath (optional, passed to Get-LabHostResourceInfo)
- Returns [pscustomobject] with: OverallStatus (Pass/Fail), Checks (array of check results), Summary (string)
- Each check result is [pscustomobject] with: Name (string), Status (Pass/Fail/Warn), Message (string), Remediation (string or $null)

Run these validation checks in order:
1. **HyperV**: Check Hyper-V enabled via Get-WindowsOptionalFeature (wrap in try/catch, on non-Windows skip with status Warn "Hyper-V check only available on Windows"). Remediation: "Run 'Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All' as Administrator and reboot"
2. **RAM**: Call Get-LabHostResourceInfo, compare FreeRAMGB against scenario requirements (if -Scenario provided, call Get-LabScenarioResourceEstimate; otherwise use $GlobalLabConfig.VMSizing defaults or skip with Pass "No scenario specified for RAM comparison"). Fail if free RAM < required. Remediation: "Close applications to free memory. Need {required}GB but only {free}GB available. Consider reducing VM memory in scenario template."
3. **Disk**: Compare FreeDiskGB from Get-LabHostResourceInfo against scenario TotalDiskGB. Same skip logic as RAM. Remediation: "Free disk space on {path}. Need {required}GB but only {free}GB available. Remove unused VMs/checkpoints with Hyper-V Manager."
4. **CPU**: Compare LogicalProcessors against scenario TotalProcessors. Warn (not fail) if host CPUs < scenario total (VMs can share CPUs). Message: "Host has {available} logical processors, scenario requests {required}. VMs will share CPU time."
5. **Config**: Check $GlobalLabConfig exists and has required keys (Lab, Network, Credentials, VMSizing). Remediation: "Verify Lab-Config.ps1 is present and dot-sourced. Required sections: Lab, Network, Credentials, VMSizing."

OverallStatus = 'Fail' if ANY check has Status 'Fail', else 'Pass'.
Summary = "{PassCount} passed, {FailCount} failed, {WarnCount} warnings"

When -Scenario is provided but Get-LabScenarioResourceEstimate is not available (command not found), set RAM/Disk/CPU checks to Warn with message "Scenario resource estimation not available (Get-LabScenarioResourceEstimate not loaded)".
  </action>
  <verify>
    Both files parse without errors: `pwsh -NoProfile -Command "& { $tokens = $null; $errors = $null; [System.Management.Automation.Language.Parser]::ParseFile('Private/Get-LabHostResourceInfo.ps1', [ref]$tokens, [ref]$errors); $errors.Count }"` returns 0. Same for Test-LabConfigValidation.ps1.
  </verify>
  <done>
    Get-LabHostResourceInfo returns host resource PSCustomObject with FreeRAMGB, FreeDiskGB, LogicalProcessors. Test-LabConfigValidation returns consolidated validation report with OverallStatus, Checks array (each with Name/Status/Message/Remediation), and Summary string.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Pester test suite for validation functions</name>
  <files>
    Tests/ConfigValidation.Tests.ps1
  </files>
  <action>
Create Pester 5.x test suite following existing test patterns (BeforeAll dot-sources helpers, BeforeEach sets up mocks, $script: scope for shared variables).

In BeforeAll:
- Dot-source Private/Get-LabHostResourceInfo.ps1
- Dot-source Private/Test-LabConfigValidation.ps1
- Dot-source Private/Get-LabScenarioResourceEstimate.ps1
- Dot-source Private/Get-LabScenarioTemplate.ps1
- Dot-source Private/Test-LabTemplateData.ps1

**Get-LabHostResourceInfo tests (Describe block):**
1. Returns PSCustomObject with expected properties (FreeRAMGB, FreeDiskGB, LogicalProcessors, DiskPath)
2. FreeRAMGB is a positive number
3. FreeDiskGB is a positive number
4. LogicalProcessors is a positive integer
5. Accepts -DiskPath parameter without error
6. Throws with prefix on invalid disk path (mock Get-PSDrive to return $null)

**Test-LabConfigValidation tests (Describe block):**
Mock Get-LabHostResourceInfo to return consistent values: @{ FreeRAMGB = 32.0; FreeDiskGB = 500.0; LogicalProcessors = 8; DiskPath = 'C:\' }
Mock Get-LabScenarioResourceEstimate to return: @{ Scenario = 'TestScenario'; VMCount = 2; TotalRAMGB = 8; TotalDiskGB = 160; TotalProcessors = 4; VMs = @() }
Mock Get-WindowsOptionalFeature to return @{ State = 'Enabled' }
Set $GlobalLabConfig in test scope with Lab, Network, Credentials, VMSizing keys.

Tests:
1. Returns PSCustomObject with OverallStatus, Checks, Summary properties
2. OverallStatus is 'Pass' when all checks pass (sufficient resources, Hyper-V enabled, config valid)
3. Each check has Name, Status, Message, Remediation properties
4. RAM check fails when free RAM < scenario requirement (mock FreeRAMGB = 2.0, scenario needs 8GB)
5. RAM failure includes remediation message mentioning required and available amounts
6. Disk check fails when free disk < scenario requirement (mock FreeDiskGB = 50.0, scenario needs 160GB)
7. Disk failure includes remediation mentioning disk space
8. CPU check warns (not fails) when host CPUs < scenario total (mock LogicalProcessors = 2, scenario needs 4)
9. Config check fails when GlobalLabConfig is missing required sections (set $GlobalLabConfig to @{} or remove Lab key)
10. Config failure remediation mentions Lab-Config.ps1
11. Without -Scenario parameter, RAM/Disk/CPU resource comparison checks pass with "No scenario specified" message
12. Summary string contains pass/fail/warn counts
13. OverallStatus is 'Fail' if any single check fails
14. Hyper-V check handles non-Windows (mock Get-WindowsOptionalFeature to throw, expect Warn not Fail)

Target: 25-30 tests covering both functions.
  </action>
  <verify>
    Run tests: `pwsh -NoProfile -Command "Invoke-Pester -Path 'Tests/ConfigValidation.Tests.ps1' -Output Detailed -PassThru | Select-Object -ExpandProperty Result"` shows all tests passing.
  </verify>
  <done>
    All Pester tests pass. Test suite covers: host resource probe properties, validation pass/fail/warn logic, remediation messages, scenario vs no-scenario modes, and edge cases.
  </done>
</task>

</tasks>

<verification>
1. Both new Private/ files parse without syntax errors
2. All Pester tests in Tests/ConfigValidation.Tests.ps1 pass
3. Get-LabHostResourceInfo returns real host resource data when called interactively
4. Test-LabConfigValidation returns consolidated report with pass/fail per check
5. Failed checks include non-null Remediation strings with actionable guidance
</verification>

<success_criteria>
- Get-LabHostResourceInfo returns host free RAM, disk, and CPU count as PSCustomObject
- Test-LabConfigValidation produces a consolidated validation report comparing host resources against scenario requirements
- Every failed check includes a Remediation string explaining the problem and fix
- 25+ Pester tests pass covering both functions
</success_criteria>

<output>
After completion, create `.planning/phases/15-configuration-validation/15-01-SUMMARY.md`
</output>
