---
phase: 15-configuration-validation
plan: 02
type: execute
wave: 2
depends_on: [15-01]
files_modified:
  - OpenCodeLab-App.ps1
  - Deploy.ps1
  - Tests/ConfigValidationIntegration.Tests.ps1
autonomous: true
requirements: [CONF-01, CONF-02, CONF-03]

must_haves:
  truths:
    - "Operator can run the app with -Action validate and see a consolidated preflight report"
    - "Deploy flow runs validation automatically before VM creation when a scenario is specified"
    - "Validation output shows pass/fail per check with remediation for failures"
  artifacts:
    - path: "OpenCodeLab-App.ps1"
      provides: "validate action routing to Test-LabConfigValidation"
      contains: "validate"
    - path: "Deploy.ps1"
      provides: "Pre-deploy validation call with scenario resource comparison"
      contains: "Test-LabConfigValidation"
    - path: "Tests/ConfigValidationIntegration.Tests.ps1"
      provides: "Integration tests for validate action and deploy validation wiring"
      min_lines: 60
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Test-LabConfigValidation.ps1"
      via: "action routing calls Test-LabConfigValidation"
      pattern: "Test-LabConfigValidation"
    - from: "Deploy.ps1"
      to: "Private/Test-LabConfigValidation.ps1"
      via: "pre-deploy validation before VM creation"
      pattern: "Test-LabConfigValidation"
---

<objective>
Wire the validation engine into the CLI app as a standalone -Action validate and as an automatic pre-deploy check in Deploy.ps1, with console output formatting and integration tests.

Purpose: Operators need a single command to validate their environment and automatic validation before deployment to prevent wasted time.
Output: Updated OpenCodeLab-App.ps1 with validate action, updated Deploy.ps1 with pre-deploy validation, integration test suite.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/15-configuration-validation/15-01-SUMMARY.md
@OpenCodeLab-App.ps1
@Deploy.ps1
@Private/Test-LabConfigValidation.ps1
@Private/Get-LabHostResourceInfo.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire validate action into OpenCodeLab-App.ps1 and pre-deploy check into Deploy.ps1</name>
  <files>
    OpenCodeLab-App.ps1
    Deploy.ps1
  </files>
  <action>
**OpenCodeLab-App.ps1 changes:**

1. Add 'validate' to the ValidateSet of the -Action parameter (find the existing ValidateSet attribute on $Action and add 'validate' to the list).

2. Add a 'validate' case in the action switch block (find the switch ($Action) block). The validate action should:
   - Build a splat hashtable for Test-LabConfigValidation
   - If $PSBoundParameters.ContainsKey('Scenario'), add -Scenario $Scenario to the splat (same conditional passthrough pattern used for deploy action per Phase 14-02 decision)
   - Call Test-LabConfigValidation with the splat
   - Format and print the results to console:
     ```
     ===== Configuration Validation Report =====
     [PASS] HyperV: Hyper-V is enabled
     [FAIL] RAM: Need 10GB but only 4GB free
            Fix: Close applications to free memory...
     [PASS] Disk: 500GB free, 180GB required
     [WARN] CPU: Host has 4 logical processors, scenario requests 8
     [PASS] Config: All required configuration sections present

     Result: 3 passed, 1 failed, 1 warning
     ```
   - Use Write-Host with colors: Green for PASS, Red for FAIL, Yellow for WARN
   - If any check has Remediation and Status is 'Fail', print the remediation indented below with "Fix: " prefix
   - Set exit code 1 if OverallStatus is 'Fail'

**Deploy.ps1 changes:**

1. After the existing scenario resource estimate output block (around line 290-296 where it prints "===== Scenario Resource Requirements"), add a validation block:
   - Only run when -Scenario is provided (inside the existing `if (-not [string]::IsNullOrWhiteSpace($Scenario))` block, after the resource estimate output)
   - Call Test-LabConfigValidation -Scenario $Scenario
   - Print a compact validation summary:
     ```
     ===== Pre-Deploy Validation =====
     [PASS] HyperV  [PASS] RAM  [FAIL] Disk  [PASS] Config
     ```
   - If OverallStatus is 'Fail', print each failed check's Message and Remediation, then throw "Pre-deploy validation failed. Fix the issues above before deploying." to halt deployment
   - If OverallStatus is 'Pass', print "Pre-deploy validation passed." in Green and continue

2. The validation functions are already available because OpenCodeLab-App.ps1 dot-sources all Private/ helpers via Import-LabScriptTree, and Deploy.ps1 is called from the app. However, Deploy.ps1 also dot-sources specific helpers directly for standalone use. Add dot-source lines for the two new helpers alongside the existing scenario helper dot-sources (near line 28-31):
   ```powershell
   $validationHelperPath = Join-Path $ScriptDir 'Private\Test-LabConfigValidation.ps1'
   $hostResourceHelperPath = Join-Path $ScriptDir 'Private\Get-LabHostResourceInfo.ps1'
   if (Test-Path $validationHelperPath) { . $validationHelperPath }
   if (Test-Path $hostResourceHelperPath) { . $hostResourceHelperPath }
   ```
  </action>
  <verify>
    Both files parse without syntax errors. grep -c 'validate' OpenCodeLab-App.ps1 shows the new action exists. grep -c 'Test-LabConfigValidation' Deploy.ps1 shows the validation call exists.
  </verify>
  <done>
    OpenCodeLab-App.ps1 has a 'validate' action that calls Test-LabConfigValidation and prints a formatted report. Deploy.ps1 runs pre-deploy validation when a scenario is specified and halts on failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for validate action and deploy validation wiring</name>
  <files>
    Tests/ConfigValidationIntegration.Tests.ps1
  </files>
  <action>
Create Pester 5.x integration test suite using static analysis patterns (Select-String on source files) following the pattern established in Tests/ScenarioDeployIntegration.Tests.ps1.

In BeforeAll:
- Set $repoRoot to the repository root
- Read OpenCodeLab-App.ps1 content
- Read Deploy.ps1 content

**OpenCodeLab-App.ps1 validate action tests (Describe block):**
1. -Action parameter ValidateSet includes 'validate' (Select-String for 'validate' in the ValidateSet)
2. Action switch block contains 'validate' case
3. Validate action calls Test-LabConfigValidation
4. Validate action conditionally passes -Scenario parameter (look for PSBoundParameters.ContainsKey('Scenario') pattern)
5. Validate action formats output with colored status indicators (look for Write-Host with ForegroundColor)

**Deploy.ps1 pre-deploy validation tests (Describe block):**
1. Deploy.ps1 dot-sources Test-LabConfigValidation.ps1 (Select-String for the dot-source path)
2. Deploy.ps1 dot-sources Get-LabHostResourceInfo.ps1
3. Deploy.ps1 calls Test-LabConfigValidation when scenario is specified
4. Deploy.ps1 halts on validation failure (look for throw pattern after OverallStatus/Fail check)
5. Deploy.ps1 prints "Pre-deploy validation passed" on success

**Function wiring tests (Describe block):**
1. Private/Test-LabConfigValidation.ps1 exists and parses without error
2. Private/Get-LabHostResourceInfo.ps1 exists and parses without error
3. Test-LabConfigValidation function is defined with -Scenario parameter
4. Test-LabConfigValidation function is defined with -TemplatesRoot parameter
5. Get-LabHostResourceInfo function is defined with -DiskPath parameter
6. Test-LabConfigValidation calls Get-LabHostResourceInfo (static analysis)
7. Test-LabConfigValidation produces checks with Remediation field (static analysis for 'Remediation')

Target: 17-20 integration tests.
  </action>
  <verify>
    Run tests: `pwsh -NoProfile -Command "Invoke-Pester -Path 'Tests/ConfigValidationIntegration.Tests.ps1' -Output Detailed -PassThru | Select-Object -ExpandProperty Result"` shows all tests passing.
  </verify>
  <done>
    All integration tests pass. Tests verify validate action exists in app, Deploy.ps1 runs pre-deploy validation, and all function wiring is correct via static analysis.
  </done>
</task>

</tasks>

<verification>
1. OpenCodeLab-App.ps1 has 'validate' in its action ValidateSet
2. Deploy.ps1 calls Test-LabConfigValidation before VM creation when -Scenario is specified
3. All integration tests pass
4. Validation output is color-coded and includes remediation for failures
</verification>

<success_criteria>
- Operator can run `OpenCodeLab-App.ps1 -Action validate` and see a consolidated validation report
- Operator can run `OpenCodeLab-App.ps1 -Action validate -Scenario SecurityLab` and see host resources compared against scenario requirements
- Deploy.ps1 automatically validates before deployment when -Scenario is specified and halts on failure
- 17+ integration tests pass covering CLI wiring and deploy validation
</success_criteria>

<output>
After completion, create `.planning/phases/15-configuration-validation/15-02-SUMMARY.md`
</output>
