---
phase: 05-gui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GUI/Start-OpenCodeLabGUI.ps1
  - Tests/WpfGui.Tests.ps1
autonomous: true
requirements:
  - GUI-02
  - GUI-08

must_haves:
  truths:
    - "Actions view dropdown contains all 23 CLI actions matching OpenCodeLab-App.ps1 ValidateSet"
    - "Actions view populates action descriptions for all 23 actions"
    - "Actions view mode descriptions cover quick and full modes"
    - "Dashboard polling timer stops when navigating away from Dashboard view"
    - "Dashboard polling timer restarts when navigating back to Dashboard view"
    - "Window Closing event disposes all active timers"
    - "Switch-View stops VMPollTimer before clearing content area children"
    - "View switching handles null/missing XAML elements defensively with try/catch"
    - "Start-OpenCodeLabGUI.ps1 has no parse errors"
  artifacts:
    - path: "GUI/Start-OpenCodeLabGUI.ps1"
      provides: "Full 23-action list matching CLI, timer lifecycle management, defensive view switching"
      contains: "preflight"
      contains: "add-lin1"
      contains: "ansible"
      contains: "terminal"
    - path: "Tests/WpfGui.Tests.ps1"
      provides: "Tests validating action list parity with CLI and XAML structure"
  key_links:
    - from: "GUI/Start-OpenCodeLabGUI.ps1"
      to: "OpenCodeLab-App.ps1"
      via: "Action list must match ValidateSet in OpenCodeLab-App.ps1 param block"
      pattern: "ValidateSet.*menu.*setup.*deploy"
---

<objective>
Close the CLI-to-GUI action parity gap and fix timer lifecycle/view switching reliability.

Purpose: The Actions dropdown currently lists only 8 of 23 CLI actions. Users cannot access preflight, bootstrap, add-lin1, lin1-config, ansible, start, asset-report, offline-bundle, terminal, new-project, push, test, save, stop, or rollback from the GUI. Additionally, the Dashboard polling timer runs indefinitely even when the user navigates away, wasting resources and risking WPF dispatcher errors on stale element references. View switching lacks defensive error handling, meaning a single XAML load failure crashes the entire GUI.

Output: Updated Start-OpenCodeLabGUI.ps1 with full action list, timer lifecycle management, defensive view switching. Updated tests validating parity.
</objective>

<execution_context>
- GUI/Start-OpenCodeLabGUI.ps1 is the single monolithic GUI file (~1540 lines)
- Actions populated at line 1119: only 8 of 23 actions listed
- Action descriptions at line 1129: only 8 entries
- Dashboard timer created at line 588: never stopped
- Switch-View function at line 180: no try/catch, no timer management
- VMPollTimer stored in $script:VMPollTimer
- OpenCodeLab-App.ps1 ValidateSet (line 9-34) is the canonical action list
</execution_context>

<changes>

## Change 1: Expand Actions dropdown to match CLI's full 23-action list

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Initialize-ActionsView` function, around line 1119

Replace the 8-action list with the full 23-action list from OpenCodeLab-App.ps1's ValidateSet:

```
$actions = @('deploy', 'teardown', 'status', 'health', 'setup',
             'one-button-setup', 'one-button-reset', 'blow-away',
             'preflight', 'bootstrap', 'add-lin1', 'lin1-config',
             'ansible', 'start', 'stop', 'asset-report',
             'offline-bundle', 'terminal', 'new-project',
             'push', 'test', 'save', 'rollback')
```

## Change 2: Add descriptions for all 23 actions

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Initialize-ActionsView`, the `$actionDescriptions` hashtable around line 1129

Add descriptions for the 15 missing actions:

```
'preflight'      = 'Run pre-deployment validation checks. Verifies Hyper-V, disk space, ISO availability, and network prerequisites.'
'bootstrap'      = 'Bootstrap the lab host environment. Installs required PowerShell modules, creates directory structure, and prepares configuration.'
'add-lin1'       = 'Add the Ubuntu Linux VM (lin1) to the lab. Creates and configures the Linux VM with cloud-init.'
'lin1-config'    = 'Configure the Linux VM (lin1). Applies post-install settings, network configuration, and domain integration.'
'ansible'        = 'Install and configure Ansible on the Linux VM. Sets up Ansible for lab automation and configuration management.'
'start'          = 'Start all lab VMs. Powers on all virtual machines in the correct boot order.'
'stop'           = 'Stop all lab VMs gracefully. Sends shutdown commands and waits for clean power-off.'
'asset-report'   = 'Generate a lab asset report. Lists all VMs, disks, network adapters, and resource usage.'
'offline-bundle' = 'Build an offline deployment bundle. Packages all required files for air-gapped lab deployment.'
'terminal'       = 'Open interactive terminals to lab VMs. Launches PowerShell remoting or SSH sessions.'
'new-project'    = 'Create a new lab project workspace. Scaffolds directory structure and configuration files for a new project.'
'push'           = 'Push files to the WS1 workstation VM. Copies project files to the Windows 11 client for testing.'
'test'           = 'Run tests on the WS1 workstation VM. Executes the test suite remotely on the client VM.'
'save'           = 'Save current lab work. Creates checkpoints and backs up current state for later restoration.'
'rollback'       = 'Rollback to the last saved checkpoint. Restores all VMs to their most recent saved state.'
```

## Change 3: Stop Dashboard timer when navigating away

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Switch-View` function, around line 209 (the stale-ref cleanup section)

Add timer stop logic when leaving Dashboard:

```powershell
if ($script:CurrentView -eq 'Dashboard') {
    if ($null -ne $script:VMPollTimer) {
        $script:VMPollTimer.Stop()
    }
}
```

## Change 4: Restart timer when returning to Dashboard

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Initialize-DashboardView` function, around line 588

Wrap timer creation in an idempotency guard:

```powershell
if ($null -ne $script:VMPollTimer) {
    $script:VMPollTimer.Start()
} else {
    # create new timer (existing code)
}
```

Also do an initial poll immediately on view load (before waiting 5 seconds):

```powershell
try {
    $statuses = Get-LabStatus
    # update cards and topology...
} catch { }
```

## Change 5: Add Window Closing handler to dispose timers

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** After line 268 (after wiring navigation buttons), before the default view load

```powershell
$mainWindow.Add_Closing({
    if ($null -ne $script:VMPollTimer) {
        $script:VMPollTimer.Stop()
        $script:VMPollTimer = $null
    }
})
```

## Change 6: Wrap Switch-View content loading in try/catch

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Switch-View` function, around line 197

Wrap the XAML loading and initialization in a try/catch so a single view failure doesn't crash the app:

```powershell
try {
    $script:contentArea.Children.Clear()

    if (Test-Path $viewPath) {
        $viewElement = Import-XamlFile -Path $viewPath
        $script:contentArea.Children.Add($viewElement) | Out-Null
    }
    else {
        $script:txtPlaceholder.Text = "$ViewName view coming soon..."
        $script:contentArea.Children.Add($script:txtPlaceholder) | Out-Null
    }
}
catch {
    $script:contentArea.Children.Clear()
    $errBlock = New-Object System.Windows.Controls.TextBlock
    $errBlock.Text = "Failed to load $ViewName view: $_"
    $errBlock.Foreground = [System.Windows.Media.Brushes]::Red
    $errBlock.TextWrapping = 'Wrap'
    $errBlock.FontSize = 14
    $script:contentArea.Children.Add($errBlock) | Out-Null
    return
}
```

## Change 7: Add parity test to WpfGui.Tests.ps1

**File:** `Tests/WpfGui.Tests.ps1`

Add a test that extracts the action list from Start-OpenCodeLabGUI.ps1 and compares it to OpenCodeLab-App.ps1's ValidateSet to ensure they stay in sync:

```powershell
Describe 'GUI-CLI Action Parity' {
    It 'WPF GUI actions list matches CLI ValidateSet (excluding menu)' {
        $guiScript = Join-Path $guiRoot 'Start-OpenCodeLabGUI.ps1'
        $cliScript = Join-Path (Split-Path -Parent $guiRoot) 'OpenCodeLab-App.ps1'

        # Extract CLI actions from ValidateSet
        $cliContent = Get-Content -Raw -Path $cliScript
        $cliActions = @()
        if ($cliContent -match "ValidateSet\(([\s\S]*?)\)") {
            $cliActions = @([regex]::Matches($matches[1], "'([^']+)'") | ForEach-Object { $_.Groups[1].Value }) |
                Where-Object { $_ -ne 'menu' } | Sort-Object
        }

        # Extract GUI actions from Initialize-ActionsView
        $guiContent = Get-Content -Raw -Path $guiScript
        $guiActions = @()
        if ($guiContent -match '\$actions\s*=\s*@\(([\s\S]*?)\)') {
            $guiActions = @([regex]::Matches($matches[1], "'([^']+)'") | ForEach-Object { $_.Groups[1].Value }) |
                Sort-Object
        }

        $cliActions.Count | Should -BeGreaterThan 0
        $guiActions | Should -Be $cliActions
    }
}
```

Also add CustomizeView.xaml to the XAML file existence tests (currently missing from the list).

</changes>

<validation>
- `Tests/WpfGui.Tests.ps1` GUI-CLI parity test passes
- PowerShell parser validates Start-OpenCodeLabGUI.ps1 has no syntax errors
- The action list in the GUI matches the CLI's 23 actions (excluding 'menu')
- All XAML files pass validity checks including CustomizeView.xaml
</validation>
