---
phase: 05-gui-integration
plan: 03
type: execute
wave: 2
depends_on:
  - 05-01
  - 05-02
files_modified:
  - GUI/Start-OpenCodeLabGUI.ps1
  - GUI/Views/ActionsView.xaml
autonomous: true
requirements:
  - GUI-03
  - GUI-06
  - GUI-07
  - GUI-08

must_haves:
  truths:
    - "Customize view template operations wrapped in try/catch with MessageBox error display"
    - "Template load handles missing/corrupt JSON gracefully with user-visible error message"
    - "Template save validates VM names are non-empty before writing"
    - "Script-scoped closure captures in Customize view use .GetNewClosure() consistently"
    - "NavigateToActions function exists to switch view and pre-select an action"
    - "Actions view handles unrecognized actions in description lookup without crashing"
    - "btnRunAction handler validates required fields before launching process"
    - "Actions run handler catches Start-Process failure and shows error instead of crashing"
  artifacts:
    - path: "GUI/Start-OpenCodeLabGUI.ps1"
      provides: "Hardened Customize view, action pre-selection support, run validation"
    - path: "GUI/Views/ActionsView.xaml"
      provides: "No structural changes needed, but verify element names are stable"
  key_links:
    - from: "GUI/Start-OpenCodeLabGUI.ps1 Initialize-CustomizeView"
      to: "Private/Save-LabTemplate.ps1"
      via: "$fnSaveTemplate closure capture"
      pattern: "Save-LabTemplate"
    - from: "GUI/Start-OpenCodeLabGUI.ps1 Initialize-ActionsView"
      to: "Private/Get-LabGuiDestructiveGuard.ps1"
      via: "$fnDestructiveGuard closure capture"
      pattern: "Get-LabGuiDestructiveGuard"
---

<objective>
Harden Customize view template operations and Actions view execution pipeline for crash-free operation.

Purpose: The Customize view's template load/save/apply operations have several unguarded paths that can crash the GUI. Template JSON parsing lacks defensive error handling -- a single corrupt file crashes the entire view init. The Actions view run handler catches Start-Process failures but does not validate required fields (e.g., blow-away without confirmation token). VM name validation is missing from the save flow. This plan adds the defensive layers needed for both views to operate reliably.

Output: Hardened Customize view with validated template operations, hardened Actions run pipeline with field validation.
</objective>

<execution_context>
- Initialize-CustomizeView starts at line 609 (~475 lines of closure-heavy code)
- $loadTemplate closure at line 772 catches parse errors but returns silently with no user feedback
- $btnSaveTemplate click handler at line 946 calls Save-LabTemplate which validates, but GUI shows raw error text
- VM name validation: getVMsFromEditor at line 736 reads whatever text is in the fields, including blanks
- Actions run handler at line 1229 has try/catch for Start-Process but no pre-validation
- blow-away action requires ConfirmationToken but the GUI does not validate its presence
- Closures use .GetNewClosure() throughout, which is correct, but some nested closures ($newVMEditorRow at line 647) have deep capture chains that need verification
</execution_context>

<changes>

## Change 1: Add user-visible error feedback in template load

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `$loadTemplate` closure, around line 772

Replace the silent `catch { return }` with a user-visible error:

```powershell
catch {
    $txtTemplateDescription.Text = "Error loading template: $_"
    return
}
```

## Change 2: Validate VM names before save

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `$btnSaveTemplate.Add_Click` handler, around line 946, after `$vms = & $getVMsFromEditor`

Add validation:

```powershell
$emptyNames = @($vms | Where-Object { [string]::IsNullOrWhiteSpace($_.name) })
if ($emptyNames.Count -gt 0) {
    [System.Windows.MessageBox]::Show(
        "All VMs must have a name. Please fill in empty name fields.",
        'Validation Error',
        [System.Windows.MessageBoxButton]::OK,
        [System.Windows.MessageBoxImage]::Warning
    ) | Out-Null
    return
}
```

Apply the same validation in the `$btnApplyTemplate.Add_Click` handler at line 986.

## Change 3: Wrap Customize view initialization in try/catch

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Initialize-CustomizeView` function body

Wrap the entire function body in a try/catch that displays a fallback error message:

```powershell
function Initialize-CustomizeView {
    [CmdletBinding()]
    param()

    try {
        # ... existing body ...
    }
    catch {
        try {
            $viewElement = $script:contentArea.Children[0]
            if ($viewElement) {
                $errBlock = New-Object System.Windows.Controls.TextBlock
                $errBlock.Text = "Customize view failed to initialize: $_"
                $errBlock.Foreground = [System.Windows.Media.Brushes]::Red
                $errBlock.TextWrapping = 'Wrap'
                $errBlock.Margin = New-Object System.Windows.Thickness(0, 16, 0, 0)
                if ($viewElement -is [System.Windows.Controls.Panel]) {
                    $viewElement.Children.Add($errBlock) | Out-Null
                }
            }
        }
        catch { }
    }
}
```

## Change 4: Add Actions run pre-validation for blow-away confirmation token

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `$btnRunAction.Add_Click` handler, around line 1229, after `$opts = & $getOptions`

Add required-field validation:

```powershell
# Validate blow-away requires a confirmation token
if ($opts.Action -eq 'blow-away' -and [string]::IsNullOrWhiteSpace($opts.ConfirmationToken)) {
    [System.Windows.MessageBox]::Show(
        "The blow-away action requires a Confirmation Token. Expand Advanced Options and provide one.",
        'Missing Confirmation Token',
        [System.Windows.MessageBoxButton]::OK,
        [System.Windows.MessageBoxImage]::Warning
    ) | Out-Null
    return
}
```

## Change 5: Add fallback description for unrecognized actions

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `$updateDescription` closure in Initialize-ActionsView, around line 1151

After the existing `if ($action -and $actionDescriptions.ContainsKey($action))` block, add:

```powershell
if ($action -and -not $actionDescriptions.ContainsKey($action)) {
    $parts += "Run the '$action' action."
}
```

## Change 6: Harden Actions view OpenCodeLab.ps1 path resolution

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `$btnRunAction.Add_Click` handler, the `$scriptPath` assignment

The handler currently sets `$scriptPath = Join-Path $script:RepoRoot 'OpenCodeLab.ps1'` but the actual CLI entry point is `OpenCodeLab-App.ps1`. Verify and fix if wrong:

```powershell
$scriptPath = Join-Path $script:RepoRoot 'OpenCodeLab-App.ps1'
```

Note: The command preview at line 1189 uses `'OpenCodeLab.ps1'` while the actual run handler should use `'OpenCodeLab-App.ps1'`. This is a potential mismatch that needs to be unified.

</changes>

<validation>
- PowerShell parser validates Start-OpenCodeLabGUI.ps1 has no syntax errors
- Corrupt template JSON shows error message in description area instead of crashing
- Empty VM names blocked from save with validation message
- blow-away action without confirmation token shows validation message
- Unrecognized action in description lookup does not crash
- Run handler targets correct script path (OpenCodeLab-App.ps1)
</validation>
