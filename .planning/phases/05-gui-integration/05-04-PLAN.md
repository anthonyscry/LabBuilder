---
phase: 05-gui-integration
plan: 04
type: test
wave: 3
depends_on:
  - 05-01
  - 05-02
  - 05-03
files_modified:
  - Tests/WpfGui.Tests.ps1
  - Tests/OpenCodeLabGuiHelpers.Tests.ps1
autonomous: true
requirements:
  - GUI-01
  - GUI-02
  - GUI-03
  - GUI-04
  - GUI-05
  - GUI-06
  - GUI-07
  - GUI-08

must_haves:
  truths:
    - "CustomizeView.xaml included in XAML existence/validity test list"
    - "GUI-CLI action parity test validates all 23 CLI actions present in GUI"
    - "Action description coverage test validates every action has a description entry"
    - "Theme resource parity test validates both themes define identical key sets"
    - "Start-OpenCodeLabGUI.ps1 parse test passes with no errors"
    - "Log cap constant is defined and positive"
    - "Timer lifecycle test validates VMPollTimer stop on view exit pattern exists in source"
    - "Window Closing handler registration test validates cleanup code exists"
  artifacts:
    - path: "Tests/WpfGui.Tests.ps1"
      provides: "Comprehensive Pester tests covering XAML validity, action parity, theme parity, timer lifecycle, log cap"
    - path: "Tests/OpenCodeLabGuiHelpers.Tests.ps1"
      provides: "Updated helper tests if any new helpers were added"
  key_links:
    - from: "Tests/WpfGui.Tests.ps1"
      to: "GUI/Start-OpenCodeLabGUI.ps1"
      via: "AST parsing and regex extraction for structural validation"
      pattern: "ParseFile.*Start-OpenCodeLabGUI"
    - from: "Tests/WpfGui.Tests.ps1"
      to: "OpenCodeLab-App.ps1"
      via: "ValidateSet extraction for parity comparison"
      pattern: "ValidateSet"
---

<objective>
Create comprehensive Pester tests validating all Phase 5 success criteria without requiring a running WPF Application instance.

Purpose: WPF GUI code cannot be easily unit-tested through instantiation in a headless CI environment. Instead, we validate structural correctness through AST parsing, regex extraction, XAML validity checks, and source-code pattern matching. This ensures that the action list stays in sync with CLI, themes remain consistent, timer lifecycle code exists, log caps are enforced, and all XAML files parse without errors -- all without needing a display server.

Output: Extended WpfGui.Tests.ps1 with structural validation tests. No changes to production code.
</objective>

<execution_context>
- Tests/WpfGui.Tests.ps1 currently has 3 Describe blocks: XAML files, Theme Dictionaries, GUI Entry Point Syntax
- Tests/OpenCodeLabGuiHelpers.Tests.ps1 has tests for command preview, argument list, artifact summary, destructive guard, layout state
- WPF tests must NOT load PresentationFramework or create Application instances -- pure file/string/AST analysis only
- PowerShell AST via [System.Management.Automation.Language.Parser]::ParseFile is available in all PS 5.1+ environments
</execution_context>

<changes>

## Change 1: Add CustomizeView.xaml to XAML existence tests

**File:** `Tests/WpfGui.Tests.ps1`
**Location:** `$xamlFiles` array in the 'WPF GUI XAML Files' Describe block

Add `'Views/CustomizeView.xaml'` to the list.

## Change 2: Add GUI-CLI action parity test

**File:** `Tests/WpfGui.Tests.ps1`

Add a new Describe block:

```powershell
Describe 'GUI-CLI Action Parity' {

    BeforeAll {
        $guiScriptPath = Join-Path $guiRoot 'Start-OpenCodeLabGUI.ps1'
        $cliScriptPath = Join-Path (Split-Path -Parent $guiRoot) 'OpenCodeLab-App.ps1'
        $guiContent = Get-Content -Raw -Path $guiScriptPath
        $cliContent = Get-Content -Raw -Path $cliScriptPath
    }

    It 'GUI actions list matches CLI ValidateSet (excluding menu)' {
        # Extract CLI actions from ValidateSet
        $cliActions = @()
        if ($cliContent -match "(?s)ValidateSet\((.*?)\)") {
            $cliActions = @([regex]::Matches($matches[1], "'([^']+)'") |
                ForEach-Object { $_.Groups[1].Value }) |
                Where-Object { $_ -ne 'menu' } | Sort-Object
        }

        # Extract GUI actions array
        $guiActions = @()
        if ($guiContent -match "(?s)\`$actions\s*=\s*@\((.*?)\)") {
            $guiActions = @([regex]::Matches($matches[1], "'([^']+)'") |
                ForEach-Object { $_.Groups[1].Value }) | Sort-Object
        }

        $cliActions.Count | Should -BeGreaterThan 0
        $guiActions.Count | Should -BeGreaterThan 0
        $guiActions | Should -Be $cliActions
    }

    It 'every GUI action has a description entry' {
        # Extract action description keys
        $descKeys = @()
        $descPattern = "'([a-z][a-z0-9-]*)'\s*="
        $inDescBlock = $false
        foreach ($line in ($guiContent -split "`n")) {
            if ($line -match '\$actionDescriptions\s*=\s*@\{') { $inDescBlock = $true; continue }
            if ($inDescBlock -and $line -match '^\s*\}') { $inDescBlock = $false; continue }
            if ($inDescBlock -and $line -match $descPattern) {
                $descKeys += $matches[1]
            }
        }

        # Extract GUI actions
        $guiActions = @()
        if ($guiContent -match "(?s)\`$actions\s*=\s*@\((.*?)\)") {
            $guiActions = @([regex]::Matches($matches[1], "'([^']+)'") |
                ForEach-Object { $_.Groups[1].Value })
        }

        foreach ($action in $guiActions) {
            $descKeys | Should -Contain $action -Because "action '$action' needs a description"
        }
    }
}
```

## Change 3: Add timer lifecycle structural tests

**File:** `Tests/WpfGui.Tests.ps1`

```powershell
Describe 'Timer Lifecycle' {

    BeforeAll {
        $guiContent = Get-Content -Raw -Path (Join-Path $guiRoot 'Start-OpenCodeLabGUI.ps1')
    }

    It 'VMPollTimer is stopped when leaving Dashboard view' {
        $guiContent | Should -Match 'VMPollTimer.*Stop'
    }

    It 'Window Closing handler is registered' {
        $guiContent | Should -Match 'Add_Closing'
    }
}
```

## Change 4: Add log cap structural test

**File:** `Tests/WpfGui.Tests.ps1`

```powershell
Describe 'Log Management' {

    BeforeAll {
        $guiContent = Get-Content -Raw -Path (Join-Path $guiRoot 'Start-OpenCodeLabGUI.ps1')
    }

    It 'defines a log entries maximum count' {
        $guiContent | Should -Match 'LogEntriesMaxCount'
    }

    It 'trims log entries when exceeding cap' {
        $guiContent | Should -Match 'RemoveAt\(0\)'
    }

    It 'uses Application.Current for resource lookup in Render-LogEntries' {
        $guiContent | Should -Match 'Application\]::Current\.FindResource'
    }
}
```

## Change 5: Add settings persistence structural test

**File:** `Tests/WpfGui.Tests.ps1`

```powershell
Describe 'Settings Persistence' {

    BeforeAll {
        $guiContent = Get-Content -Raw -Path (Join-Path $guiRoot 'Start-OpenCodeLabGUI.ps1')
    }

    It 'Settings save handler writes network settings to config.json' {
        $guiContent | Should -Match 'SwitchName'
        $guiContent | Should -Match 'Subnet'
        $guiContent | Should -Match 'GatewayIP'
    }

    It 'Settings save handler validates gateway IP format' {
        $guiContent | Should -Match 'Invalid Gateway IP format'
    }

    It 'Settings save handler validates subnet format' {
        $guiContent | Should -Match 'Invalid subnet format'
    }
}
```

## Change 6: Add Customize view structural test

**File:** `Tests/WpfGui.Tests.ps1`

```powershell
Describe 'Customize View Hardening' {

    BeforeAll {
        $guiContent = Get-Content -Raw -Path (Join-Path $guiRoot 'Start-OpenCodeLabGUI.ps1')
    }

    It 'validates VM names are non-empty before template save' {
        $guiContent | Should -Match 'All VMs must have a name'
    }

    It 'Initialize-CustomizeView has error handling' {
        $guiContent | Should -Match 'Customize view failed to initialize'
    }
}
```

</changes>

<validation>
- All new tests in Tests/WpfGui.Tests.ps1 pass against the code produced by plans 05-01 through 05-03
- No tests require WPF runtime or display server
- Tests validate structural properties through string/regex analysis
- CustomizeView.xaml passes XML validity check
- Action parity test confirms all 23 actions present
- All description keys cover all actions
</validation>
