---
phase: 26-lab-ttl-lifecycle-monitoring
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - Lab-Config.ps1
  - Private/Get-LabTTLConfig.ps1
  - Tests/LabTTLConfig.Tests.ps1
autonomous: true
requirements: [TTL-01]
must_haves:
  truths:
    - "Operator sees TTL block in Lab-Config.ps1 with Enabled, IdleMinutes, WallClockHours, Action keys"
    - "Loading config with missing TTL keys does not throw under Set-StrictMode -Version Latest"
    - "Get-LabTTLConfig returns correct defaults when TTL block is absent"
    - "Get-LabTTLConfig returns operator values when TTL block is present"
  artifacts:
    - path: "Lab-Config.ps1"
      provides: "TTL config block in GlobalLabConfig"
      contains: "TTL = @{"
    - path: "Private/Get-LabTTLConfig.ps1"
      provides: "Safe TTL config reader with ContainsKey guards"
      exports: ["Get-LabTTLConfig"]
    - path: "Tests/LabTTLConfig.Tests.ps1"
      provides: "Unit tests for TTL config reading"
      min_lines: 60
  key_links:
    - from: "Private/Get-LabTTLConfig.ps1"
      to: "Lab-Config.ps1"
      via: "Reads $GlobalLabConfig.TTL with ContainsKey guards"
      pattern: "ContainsKey.*TTL"
---

<objective>
Add TTL configuration block to Lab-Config.ps1 and create a safe config reader function.

Purpose: Enables operators to configure lab TTL duration with safe defaults. The config reader uses ContainsKey guards to prevent StrictMode failures when keys are absent, following the same pattern used by AutoHeal config.
Output: Lab-Config.ps1 updated, Get-LabTTLConfig.ps1 created and tested.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/26-lab-ttl-lifecycle-monitoring/26-RESEARCH.md
@Lab-Config.ps1
@Private/Invoke-LabQuickModeHeal.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TTL config block to Lab-Config.ps1</name>
  <files>Lab-Config.ps1</files>
  <action>
Add a `TTL = @{...}` block to `$GlobalLabConfig` in Lab-Config.ps1, positioned immediately after the existing `AutoHeal` block (after line 206, before the `SSH` block).

Keys with inline comments (matching existing Lab-Config.ps1 style):
```powershell
TTL = @{
    # Changing Enabled toggles whether lab TTL monitoring is active.
    Enabled = $false
    # Changing IdleMinutes sets how long all VMs must be idle before TTL fires (0 = disabled).
    IdleMinutes = 0
    # Changing WallClockHours sets maximum lab runtime before TTL fires.
    WallClockHours = 8
    # Changing Action sets what happens when TTL expires: 'Suspend' (Save-VM) or 'Off' (Stop-VM).
    Action = 'Suspend'
}
```

Feature is disabled by default. Every key has a comment explaining what it controls.
  </action>
  <verify>Open Lab-Config.ps1 and confirm TTL block exists after AutoHeal block with all 4 keys and inline comments. Verify the file parses without syntax error: `powershell -NoProfile -Command "& { . ./Lab-Config.ps1 }"` (or equivalent syntax check).</verify>
  <done>Lab-Config.ps1 contains TTL = @{ Enabled = $false; IdleMinutes = 0; WallClockHours = 8; Action = 'Suspend' } with inline comments matching project style.</done>
</task>

<task type="auto">
  <name>Task 2: Create Get-LabTTLConfig with TDD</name>
  <files>Private/Get-LabTTLConfig.ps1, Tests/LabTTLConfig.Tests.ps1</files>
  <action>
**RED phase — write tests first** in Tests/LabTTLConfig.Tests.ps1:

Test file structure (follow QuickModeHeal.Tests.ps1 pattern):
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Get-LabTTLConfig.ps1')
}
```

Test cases (use `$script:` scope for BeforeEach variables per project pattern):
1. Returns defaults when GlobalLabConfig variable does not exist (Enabled=$false, IdleMinutes=0, WallClockHours=8, Action='Suspend')
2. Returns defaults when GlobalLabConfig exists but has no TTL key
3. Returns defaults when TTL block exists but is empty hashtable
4. Returns operator values when all TTL keys are present
5. Returns partial defaults when only some TTL keys are present (e.g., Enabled=$true but no IdleMinutes)
6. Casts types correctly: Enabled as [bool], IdleMinutes as [int], WallClockHours as [int], Action as [string]
7. Does not throw under Set-StrictMode -Version Latest with missing keys

For tests that set $GlobalLabConfig, use `$script:GlobalLabConfig = @{...}` in test scope and clean up in AfterEach.

**GREEN phase — create Private/Get-LabTTLConfig.ps1:**
```powershell
function Get-LabTTLConfig {
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param()

    $ttlBlock = if (Test-Path variable:GlobalLabConfig) {
        if ($GlobalLabConfig.ContainsKey('TTL')) { $GlobalLabConfig.TTL } else { @{} }
    } else { @{} }

    [pscustomobject]@{
        Enabled        = if ($ttlBlock.ContainsKey('Enabled'))        { [bool]$ttlBlock.Enabled }        else { $false }
        IdleMinutes    = if ($ttlBlock.ContainsKey('IdleMinutes'))    { [int]$ttlBlock.IdleMinutes }      else { 0 }
        WallClockHours = if ($ttlBlock.ContainsKey('WallClockHours')) { [int]$ttlBlock.WallClockHours }   else { 8 }
        Action         = if ($ttlBlock.ContainsKey('Action'))         { [string]$ttlBlock.Action }        else { 'Suspend' }
    }
}
```

Uses [CmdletBinding()], returns [pscustomobject], ContainsKey guards on every read. No ternary operators (PS 5.1 compat). Function is auto-discovered by Lab-Common.ps1 — no registration needed.

**REFACTOR:** Ensure all tests pass, clean up any duplication.
  </action>
  <verify>Run `pwsh -NoProfile -Command "Invoke-Pester Tests/LabTTLConfig.Tests.ps1 -Output Detailed"` — all tests pass. Confirm function file exists at Private/Get-LabTTLConfig.ps1 and follows [CmdletBinding()] pattern.</verify>
  <done>Get-LabTTLConfig returns correct PSCustomObject with all 4 fields, uses ContainsKey guards, handles missing config gracefully, 7+ tests passing.</done>
</task>

</tasks>

<verification>
- [ ] Lab-Config.ps1 parses without error after adding TTL block
- [ ] TTL block positioned after AutoHeal, before SSH
- [ ] All 4 keys have inline comments matching project style
- [ ] Get-LabTTLConfig returns [pscustomobject] with Enabled, IdleMinutes, WallClockHours, Action
- [ ] No StrictMode failures when TTL keys are absent
- [ ] All Pester tests pass
</verification>

<success_criteria>
Operator can set TTL values in Lab-Config.ps1. Get-LabTTLConfig reads them safely with defaults. No breakage of existing config loading. All tests green.
</success_criteria>

<output>
After completion, create `.planning/phases/26-lab-ttl-lifecycle-monitoring/26-01-SUMMARY.md`
</output>
