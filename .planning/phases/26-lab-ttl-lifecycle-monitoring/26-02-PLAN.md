---
phase: 26-lab-ttl-lifecycle-monitoring
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - Private/Register-LabTTLTask.ps1
  - Private/Unregister-LabTTLTask.ps1
  - Tests/LabTTLTask.Tests.ps1
autonomous: true
requirements: [TTL-02]
must_haves:
  truths:
    - "Register-LabTTLTask creates a Windows Scheduled Task named OpenCodeLab-TTLMonitor"
    - "Re-running Register-LabTTLTask does not produce duplicate task errors (idempotent)"
    - "Scheduled task runs under SYSTEM context with 5-minute repetition interval"
    - "Unregister-LabTTLTask removes the task cleanly with no orphans"
    - "Unregister-LabTTLTask is idempotent — no error when task does not exist"
  artifacts:
    - path: "Private/Register-LabTTLTask.ps1"
      provides: "Idempotent scheduled task registration"
      exports: ["Register-LabTTLTask"]
    - path: "Private/Unregister-LabTTLTask.ps1"
      provides: "Idempotent scheduled task removal"
      exports: ["Unregister-LabTTLTask"]
    - path: "Tests/LabTTLTask.Tests.ps1"
      provides: "Unit tests for task registration/unregistration"
      min_lines: 80
  key_links:
    - from: "Private/Register-LabTTLTask.ps1"
      to: "Windows Task Scheduler"
      via: "Register-ScheduledTask cmdlet"
      pattern: "Register-ScheduledTask"
    - from: "Private/Unregister-LabTTLTask.ps1"
      to: "Windows Task Scheduler"
      via: "Unregister-ScheduledTask cmdlet"
      pattern: "Unregister-ScheduledTask"
---

<objective>
Create idempotent scheduled task registration and unregistration for TTL monitoring.

Purpose: Provides the persistent background mechanism that will invoke TTL monitoring. The scheduled task survives PowerShell session termination and host reboots, running under SYSTEM context every 5 minutes.
Output: Register-LabTTLTask.ps1, Unregister-LabTTLTask.ps1, and comprehensive tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/26-lab-ttl-lifecycle-monitoring/26-RESEARCH.md
@Private/Invoke-LabQuickModeHeal.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Register-LabTTLTask and Unregister-LabTTLTask with TDD</name>
  <files>Private/Register-LabTTLTask.ps1, Private/Unregister-LabTTLTask.ps1, Tests/LabTTLTask.Tests.ps1</files>
  <action>
**RED phase — write tests first** in Tests/LabTTLTask.Tests.ps1:

Test file structure:
```powershell
BeforeAll {
    $repoRoot = Split-Path -Parent $PSScriptRoot
    . (Join-Path $repoRoot 'Private/Register-LabTTLTask.ps1')
    . (Join-Path $repoRoot 'Private/Unregister-LabTTLTask.ps1')
}
```

Mock strategy: Mock all ScheduledTasks cmdlets (Get-ScheduledTask, Register-ScheduledTask, Unregister-ScheduledTask, New-ScheduledTaskTrigger, New-ScheduledTaskAction, New-ScheduledTaskPrincipal). These are Windows-only cmdlets that won't exist in test environments. Use function stubs in BeforeEach (matching QuickModeHeal test pattern — define mock functions, not Pester Mock).

**Register-LabTTLTask tests:**
1. Creates scheduled task with correct name 'OpenCodeLab-TTLMonitor'
2. Calls Unregister-ScheduledTask then Register-ScheduledTask when task already exists (idempotent)
3. Calls only Register-ScheduledTask when task does not exist (first-time setup)
4. Returns PSCustomObject with TaskRegistered=$true, TaskName='OpenCodeLab-TTLMonitor'
5. Passes -Confirm:$false to Unregister-ScheduledTask (suppresses prompt)
6. Uses SYSTEM principal (captures UserId param)
7. Sets 5-minute RepetitionInterval (captures trigger creation)
8. Handles Register-ScheduledTask failure gracefully — returns TaskRegistered=$false with error message

**Unregister-LabTTLTask tests:**
1. Removes task when it exists — calls Unregister-ScheduledTask
2. Returns PSCustomObject with TaskRemoved=$true when task existed and was removed
3. Returns TaskRemoved=$false gracefully when task does not exist (no error)
4. Passes -Confirm:$false to Unregister-ScheduledTask

**GREEN phase — create functions:**

**Private/Register-LabTTLTask.ps1:**
```powershell
function Register-LabTTLTask {
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param(
        [string]$ProjectRoot = (Split-Path -Parent $PSScriptRoot)
    )

    $taskName = 'OpenCodeLab-TTLMonitor'

    try {
        # Idempotent: remove existing first
        $existing = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
        if ($existing) {
            Unregister-ScheduledTask -TaskName $taskName -Confirm:$false
        }

        # Build the monitor invocation command
        # Bake absolute path at registration time so SYSTEM context finds it
        $labCommonPath = Join-Path $ProjectRoot 'Lab-Common.ps1'
        $command = ". '$labCommonPath'; Invoke-LabTTLMonitor"

        $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) `
            -RepetitionInterval (New-TimeSpan -Minutes 5) `
            -RepetitionDuration ([TimeSpan]::MaxValue)

        $action = New-ScheduledTaskAction -Execute 'powershell.exe' `
            -Argument "-NoProfile -NonInteractive -ExecutionPolicy Bypass -Command `"$command`""

        $principal = New-ScheduledTaskPrincipal -UserId 'NT AUTHORITY\SYSTEM' `
            -LogonType ServiceAccount -RunLevel Highest

        Register-ScheduledTask -TaskName $taskName -Trigger $trigger `
            -Action $action -Principal $principal `
            -Description 'OpenCodeLab TTL Monitor — auto-suspends lab VMs when TTL expires'

        return [pscustomobject]@{
            TaskRegistered = $true
            TaskName       = $taskName
            Message        = "Scheduled task '$taskName' registered successfully"
        }
    }
    catch {
        Write-Warning "[TTLTask] Registration failed: $($_.Exception.Message)"
        return [pscustomobject]@{
            TaskRegistered = $false
            TaskName       = $taskName
            Message        = "Registration failed: $($_.Exception.Message)"
        }
    }
}
```

**Private/Unregister-LabTTLTask.ps1:**
```powershell
function Unregister-LabTTLTask {
    [CmdletBinding()]
    [OutputType([pscustomobject])]
    param()

    $taskName = 'OpenCodeLab-TTLMonitor'

    try {
        $existing = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
        if ($existing) {
            Unregister-ScheduledTask -TaskName $taskName -Confirm:$false
            return [pscustomobject]@{
                TaskRemoved = $true
                TaskName    = $taskName
                Message     = "Scheduled task '$taskName' removed"
            }
        }
        else {
            return [pscustomobject]@{
                TaskRemoved = $false
                TaskName    = $taskName
                Message     = "Scheduled task '$taskName' not found (already clean)"
            }
        }
    }
    catch {
        Write-Warning "[TTLTask] Unregister failed: $($_.Exception.Message)"
        return [pscustomobject]@{
            TaskRemoved = $false
            TaskName    = $taskName
            Message     = "Unregister failed: $($_.Exception.Message)"
        }
    }
}
```

Both use [CmdletBinding()], return [pscustomobject], handle errors with try-catch. No ternary operators. Functions auto-discovered by Lab-Common.ps1.

**REFACTOR:** Verify all tests pass, ensure consistent return object shape.
  </action>
  <verify>Run `pwsh -NoProfile -Command "Invoke-Pester Tests/LabTTLTask.Tests.ps1 -Output Detailed"` — all tests pass. Confirm both function files exist in Private/ with [CmdletBinding()] and [OutputType([pscustomobject])].</verify>
  <done>Register-LabTTLTask creates idempotent scheduled task with SYSTEM context and 5-minute interval. Unregister-LabTTLTask removes it cleanly. Both handle errors gracefully. 12+ tests passing.</done>
</task>

</tasks>

<verification>
- [ ] Register-LabTTLTask creates task named OpenCodeLab-TTLMonitor
- [ ] Re-running Register-LabTTLTask is idempotent (unregister-then-register)
- [ ] Task configured with SYSTEM principal and 5-minute RepetitionInterval
- [ ] Unregister-LabTTLTask removes task or is no-op if absent
- [ ] Both functions return structured PSCustomObject
- [ ] All Pester tests pass
</verification>

<success_criteria>
Scheduled task registration and unregistration functions are complete, idempotent, and tested. SYSTEM context and 5-minute interval are configured. Error handling follows project patterns.
</success_criteria>

<output>
After completion, create `.planning/phases/26-lab-ttl-lifecycle-monitoring/26-02-SUMMARY.md`
</output>
