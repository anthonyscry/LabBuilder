---
phase: 18-configuration-profiles
plan: 02
type: execute
wave: 2
depends_on:
  - 18-01
files_modified:
  - Private/Load-LabProfile.ps1
  - Tests/LabProfile.Tests.ps1
autonomous: true
requirements:
  - PROF-02

must_haves:
  truths:
    - "Load-LabProfile -Name 'x' reads the profile JSON and returns the config hashtable ready for assignment to GlobalLabConfig"
    - "Load-LabProfile throws a clear error when the named profile does not exist"
    - "Load-LabProfile validates the profile JSON contains a 'config' key before returning"
    - "Full CRUD cycle works: save a profile, list it, load it, remove it, confirm it is gone"
  artifacts:
    - path: "Private/Load-LabProfile.ps1"
      provides: "Profile load function restoring config from JSON"
      exports: ["Load-LabProfile"]
    - path: "Tests/LabProfile.Tests.ps1"
      provides: "Pester 5 tests covering all four profile cmdlets"
      min_lines: 100
  key_links:
    - from: "Private/Load-LabProfile.ps1"
      to: ".planning/profiles/*.json"
      via: "Get-Content + ConvertFrom-Json on profile path"
      pattern: "ConvertFrom-Json"
    - from: "Tests/LabProfile.Tests.ps1"
      to: "Private/Save-LabProfile.ps1"
      via: "dot-source in BeforeAll"
      pattern: "\\. .*Save-LabProfile"
    - from: "Tests/LabProfile.Tests.ps1"
      to: "Private/Load-LabProfile.ps1"
      via: "dot-source in BeforeAll"
      pattern: "\\. .*Load-LabProfile"
---

<objective>
Create the Load-LabProfile cmdlet and comprehensive Pester tests for all four profile management functions.

Purpose: Completes the profile CRUD surface by adding the load operation (restoring saved config) and proves all four cmdlets work correctly through automated tests.
Output: Load-LabProfile Private/ helper and LabProfile.Tests.ps1 test file.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/18-configuration-profiles/18-01-SUMMARY.md
@Lab-Config.ps1
@Private/Save-LabTemplate.ps1
@Tests/Save-LabTemplate.Tests.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Load-LabProfile cmdlet</name>
  <files>Private/Load-LabProfile.ps1</files>
  <action>
Create `Private/Load-LabProfile.ps1` implementing:

```powershell
function Load-LabProfile {
    [CmdletBinding()]
    [OutputType([hashtable])]
    param(
        [Parameter(Mandatory)]
        [string]$Name,

        [Parameter(Mandatory)]
        [string]$RepoRoot
    )
```

Implementation:
- Validate `$Name` matches `^[a-zA-Z0-9_-]+$` (same as other profile cmdlets).
- Build profile path: `Join-Path (Join-Path (Join-Path $RepoRoot '.planning') 'profiles') "$Name.json"`. Use nested Join-Path (PS 5.1 compat -- only 2 args per call).
- If file does not exist, throw: "Profile '$Name' not found."
- Read JSON with `Get-Content -Raw | ConvertFrom-Json -ErrorAction Stop`.
- Validate the parsed object has a `config` property. If missing, throw: "Profile '$Name' is malformed: missing 'config' key."
- Convert the `config` PSCustomObject back to a nested hashtable. Write a local helper `ConvertTo-Hashtable` that recursively converts PSCustomObject properties to hashtable entries. This is necessary because `ConvertFrom-Json` returns PSCustomObject, but `$GlobalLabConfig` is a hashtable.
- The `ConvertTo-Hashtable` helper should handle: nested PSCustomObjects (recurse), arrays (iterate and recurse elements), and leaf values (pass through).
- Return the resulting hashtable. The caller is responsible for assigning it to `$GlobalLabConfig` -- Load-LabProfile does NOT modify global state directly (keeps it testable and side-effect-free).
- Wrap file I/O in try/catch, re-throw with context: "Failed to load profile '$Name': $($_.Exception.Message)".
  </action>
  <verify>
Dot-source and confirm function loads:
`pwsh -NoProfile -Command ". ./Private/Load-LabProfile.ps1; Get-Command Load-LabProfile"`
  </verify>
  <done>Load-LabProfile reads a saved profile JSON, validates it has a config key, converts PSCustomObject back to hashtable, and returns the config hashtable ready for assignment to GlobalLabConfig.</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive Pester tests for all profile cmdlets</name>
  <files>Tests/LabProfile.Tests.ps1</files>
  <action>
Create `Tests/LabProfile.Tests.ps1` following the pattern in `Tests/Save-LabTemplate.Tests.ps1`:

**BeforeAll block:**
- Dot-source all four cmdlets: `Save-LabProfile.ps1`, `Get-LabProfile.ps1`, `Remove-LabProfile.ps1`, `Load-LabProfile.ps1` from `$PSScriptRoot/../Private/`.
- Create `New-TestRepoRoot` and `Remove-TestRepoRoot` helper functions (same as Save-LabTemplate.Tests.ps1).
- Create a `New-TestConfig` helper that returns a sample `$GlobalLabConfig`-shaped hashtable with Lab.Name, Lab.CoreVMNames (3 VMs), Network.SwitchName, Paths.LabRoot, and Credentials.InstallUser keys. This provides realistic test data.

**Describe 'Save-LabProfile':**
- It 'throws on invalid profile name with special characters' -- test `Save-LabProfile -Name 'bad@name!'`
- It 'saves a profile successfully with correct metadata' -- save, verify file exists, parse JSON, check `name`, `createdAt`, `vmCount` (should be 3 from CoreVMNames), `config` key exists
- It 'overwrites existing profile without error' -- save twice with same name, verify file contains second save's data
- It 'creates profiles directory if it does not exist' -- use fresh RepoRoot, verify directory creation

**Describe 'Get-LabProfile':**
- It 'returns empty array when no profiles exist' -- fresh RepoRoot
- It 'returns summary for saved profiles' -- save 2 profiles, call Get-LabProfile, verify count is 2, each has Name/VMCount/CreatedAt
- It 'retrieves a single profile by name' -- save profile, call `Get-LabProfile -Name` with that name, verify full config is returned
- It 'throws when named profile does not exist' -- `Get-LabProfile -Name 'nonexistent'`

**Describe 'Remove-LabProfile':**
- It 'removes an existing profile' -- save then remove, verify file is gone
- It 'throws when profile does not exist' -- try removing nonexistent
- It 'throws on invalid name characters' -- `Remove-LabProfile -Name '../escape'`

**Describe 'Load-LabProfile':**
- It 'loads a saved profile and returns a hashtable' -- save config, load it, verify result is [hashtable], verify nested keys survived round-trip (e.g., `$result.Lab.Name` matches original)
- It 'throws when profile does not exist' -- load nonexistent name
- It 'throws on malformed profile missing config key' -- manually write JSON without config property, attempt load
- It 'preserves array values through round-trip' -- save config with CoreVMNames array, load, verify array length and values match

**Describe 'Profile CRUD Integration':**
- It 'completes full save-list-load-remove lifecycle' -- save 'test-profile', list (verify 1 result), load (verify config round-trips), remove, list (verify 0 results)

Use try/finally with `Remove-TestRepoRoot` in every test (same pattern as Save-LabTemplate.Tests.ps1) to ensure cleanup.
  </action>
  <verify>
Run the test file with Pester:
`pwsh -NoProfile -Command "Invoke-Pester ./Tests/LabProfile.Tests.ps1 -Output Detailed"`
All tests must pass.
  </verify>
  <done>LabProfile.Tests.ps1 exists with 15+ tests covering all four cmdlets (save, get, remove, load) including validation, error cases, round-trip data fidelity, and a full CRUD lifecycle integration test. All tests pass.</done>
</task>

</tasks>

<verification>
- Load-LabProfile parses profile JSON and returns a hashtable
- Nested PSCustomObject-to-hashtable conversion preserves all config keys
- All Pester tests pass: `Invoke-Pester ./Tests/LabProfile.Tests.ps1 -Output Detailed`
- Full lifecycle works: save -> list -> load -> remove -> verify gone
</verification>

<success_criteria>
Load-LabProfile cmdlet exists implementing PROF-02 (load saved profile). LabProfile.Tests.ps1 covers all four PROF requirements with 15+ passing tests including round-trip data fidelity and full CRUD lifecycle validation.
</success_criteria>

<output>
After completion, create `.planning/phases/18-configuration-profiles/18-02-SUMMARY.md`
</output>
