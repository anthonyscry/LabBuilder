---
phase: 18-configuration-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Save-LabProfile.ps1
  - Private/Get-LabProfile.ps1
  - Private/Remove-LabProfile.ps1
autonomous: true
requirements:
  - PROF-01
  - PROF-03
  - PROF-04

must_haves:
  truths:
    - "Save-LabProfile -Name 'x' writes a JSON file containing all GlobalLabConfig keys to .planning/profiles/x.json"
    - "Get-LabProfile with no arguments returns a table of all saved profiles with Name, VMCount, and CreatedAt"
    - "Remove-LabProfile -Name 'x' deletes the profile JSON file and confirms removal"
    - "Save-LabProfile validates the profile name is filesystem-safe (alphanumeric, hyphens, underscores only)"
    - "Remove-LabProfile throws a clear error when the named profile does not exist"
  artifacts:
    - path: "Private/Save-LabProfile.ps1"
      provides: "Profile save function capturing GlobalLabConfig snapshot"
      exports: ["Save-LabProfile"]
    - path: "Private/Get-LabProfile.ps1"
      provides: "Profile listing with summary metadata"
      exports: ["Get-LabProfile"]
    - path: "Private/Remove-LabProfile.ps1"
      provides: "Profile deletion by name"
      exports: ["Remove-LabProfile"]
  key_links:
    - from: "Private/Save-LabProfile.ps1"
      to: "Lab-Config.ps1"
      via: "reads $GlobalLabConfig hashtable"
      pattern: "GlobalLabConfig"
    - from: "Private/Get-LabProfile.ps1"
      to: ".planning/profiles/*.json"
      via: "Get-ChildItem enumerating profile directory"
      pattern: "Get-ChildItem.*profiles.*\\.json"
    - from: "Private/Remove-LabProfile.ps1"
      to: ".planning/profiles/*.json"
      via: "Remove-Item on profile path"
      pattern: "Remove-Item.*profiles"
---

<objective>
Create the three profile management cmdlets that persist, list, and delete named lab configuration profiles.

Purpose: Operators need to save their lab configuration for reuse without manual file management. This plan implements the save/list/delete operations that store $GlobalLabConfig snapshots as named JSON profiles.
Output: Three Private/ helper functions (Save-LabProfile, Get-LabProfile, Remove-LabProfile) following established project patterns.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@Lab-Config.ps1
@Private/Save-LabTemplate.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Save-LabProfile cmdlet</name>
  <files>Private/Save-LabProfile.ps1</files>
  <action>
Create `Private/Save-LabProfile.ps1` implementing:

```powershell
function Save-LabProfile {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [string]$Name,

        [Parameter(Mandatory)]
        [hashtable]$Config,

        [Parameter(Mandatory)]
        [string]$RepoRoot,

        [Parameter()]
        [string]$Description = ''
    )
```

Implementation details:
- Validate `$Name` matches `^[a-zA-Z0-9_-]+$` (same pattern as Save-LabTemplate). Throw clear error on invalid names.
- Build a profile object as `[ordered]@{}` containing: `name`, `description`, `createdAt` (ISO 8601 via `Get-Date -Format 'o'`), `config` (deep copy of `$Config` hashtable).
- Count VMs from `$Config.Lab.CoreVMNames` array and store as `vmCount` in the profile object for summary display.
- Store profiles in `.planning/profiles/` directory under `$RepoRoot`. Create directory if it does not exist (same pattern as Save-LabTemplate line 64-68).
- Write profile to `$Name.json` using `ConvertTo-Json -Depth 10 | Set-Content -Encoding UTF8`.
- If a profile with the same name already exists, overwrite it silently (update use case).
- Return `[pscustomobject]@{ Success = $true; Message = "Profile '$Name' saved successfully." }` on success.
- Use `[CmdletBinding()]` and `[OutputType([PSCustomObject])]`. Follow Save-LabTemplate error handling pattern (throw on validation, try/catch on I/O).
- Accept `$Config` as parameter (NOT reading `$GlobalLabConfig` directly) -- keeps function testable and decoupled.
  </action>
  <verify>
Dot-source the file in PowerShell and confirm the function loads without parse errors:
`pwsh -NoProfile -Command ". ./Private/Save-LabProfile.ps1; Get-Command Save-LabProfile"`
  </verify>
  <done>Save-LabProfile function exists, accepts Name/Config/RepoRoot/Description parameters, validates name, writes JSON profile to .planning/profiles/{Name}.json with createdAt and vmCount metadata, returns success PSCustomObject.</done>
</task>

<task type="auto">
  <name>Task 2: Create Get-LabProfile and Remove-LabProfile cmdlets</name>
  <files>Private/Get-LabProfile.ps1, Private/Remove-LabProfile.ps1</files>
  <action>
**Get-LabProfile** (`Private/Get-LabProfile.ps1`):

```powershell
function Get-LabProfile {
    [CmdletBinding()]
    [OutputType([PSCustomObject[]])]
    param(
        [Parameter(Mandatory)]
        [string]$RepoRoot,

        [Parameter()]
        [string]$Name
    )
```

Implementation:
- Profile directory: `Join-Path (Join-Path $RepoRoot '.planning') 'profiles'`.
- If `$Name` is provided: load and return that single profile's JSON as a PSCustomObject. Throw if not found: "Profile '$Name' not found."
- If `$Name` is NOT provided: enumerate all `*.json` files in the profiles directory using `Get-ChildItem -Filter '*.json'`.
- For each file, parse JSON and return a summary PSCustomObject with properties: `Name`, `Description`, `VMCount`, `CreatedAt`, `Path`.
- If the profiles directory does not exist or is empty, return an empty array `@()`.
- Sort results by `CreatedAt` descending (newest first).
- Use try/catch for JSON parse errors -- skip corrupt files with `Write-Warning` rather than failing the entire listing.

**Remove-LabProfile** (`Private/Remove-LabProfile.ps1`):

```powershell
function Remove-LabProfile {
    [CmdletBinding()]
    [OutputType([PSCustomObject])]
    param(
        [Parameter(Mandatory)]
        [string]$Name,

        [Parameter(Mandatory)]
        [string]$RepoRoot
    )
```

Implementation:
- Validate `$Name` matches `^[a-zA-Z0-9_-]+$` (prevent path traversal).
- Build profile path: `Join-Path (Join-Path (Join-Path $RepoRoot '.planning') 'profiles') "$Name.json"`.
- If file does not exist, throw: "Profile '$Name' not found."
- Remove the file with `Remove-Item -Path $profilePath -Force`.
- Return `[pscustomobject]@{ Success = $true; Message = "Profile '$Name' removed successfully." }`.
  </action>
  <verify>
Dot-source both files and confirm functions load:
`pwsh -NoProfile -Command ". ./Private/Get-LabProfile.ps1; . ./Private/Remove-LabProfile.ps1; Get-Command Get-LabProfile, Remove-LabProfile"`
  </verify>
  <done>Get-LabProfile lists all profiles with Name/Description/VMCount/CreatedAt/Path or retrieves a single profile by name. Remove-LabProfile deletes a named profile or throws if not found. Both follow CmdletBinding pattern with PSCustomObject output.</done>
</task>

</tasks>

<verification>
- All three functions parse without errors when dot-sourced
- `Save-LabProfile` creates `.planning/profiles/{name}.json` with config snapshot
- `Get-LabProfile` returns profile summaries from the profiles directory
- `Remove-LabProfile` deletes a profile file and throws on missing profiles
- Name validation rejects special characters in all functions that accept Name
</verification>

<success_criteria>
Three Private/ cmdlets exist implementing PROF-01 (save), PROF-03 (list), and PROF-04 (delete) with consistent error handling, JSON storage in .planning/profiles/, and testable function signatures accepting RepoRoot parameter.
</success_criteria>

<output>
After completion, create `.planning/phases/18-configuration-profiles/18-01-SUMMARY.md`
</output>
