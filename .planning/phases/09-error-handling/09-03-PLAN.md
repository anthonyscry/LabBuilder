---
phase: 09-error-handling
plan: 03
type: execute
wave: 1
depends_on: ["09-02"]
files_modified:
  - Private/Resolve-LabActionRequest.ps1
  - Private/Resolve-LabCoordinatorPolicy.ps1
  - Private/Resolve-LabDispatchMode.ps1
  - Private/Resolve-LabDispatchPlan.ps1
  - Private/Resolve-LabModeDecision.ps1
  - Private/Resolve-LabNoExecuteStateOverride.ps1
  - Private/Resolve-LabOperationIntent.ps1
  - Private/Resolve-LabOrchestrationIntent.ps1
  - Private/Show-LabMenu.ps1
  - Private/Invoke-LabInteractiveMenu.ps1
  - Private/Invoke-LabAddVMMenu.ps1
  - Private/Invoke-LabAddVMWizard.ps1
  - Private/Invoke-LabConfigureRoleMenu.ps1
  - Private/Invoke-LabSetupMenu.ps1
  - Tests/ErrorHandling-Batch3.Tests.ps1
autonomous: true
requirements:
  - ERR-01
  - ERR-03

must_haves:
  truths:
    - "All 14 resolution, policy, and menu Private functions have outer try-catch blocks"
    - "Error messages include the function name as a prefix for grep-ability"
    - "Resolution functions use throw (incorrect resolution = wrong operation executed)"
    - "Menu functions use $PSCmdlet.WriteError (menu errors should not crash the app)"
    - "All existing Pester tests pass after changes (no behavior regression)"
  artifacts:
    - path: "Private/Resolve-LabCoordinatorPolicy.ps1"
      provides: "try-catch wrapping complex policy evaluation"
    - path: "Private/Resolve-LabModeDecision.ps1"
      provides: "try-catch wrapping mode decision tree"
    - path: "Tests/ErrorHandling-Batch3.Tests.ps1"
      provides: "Tests verifying error handling pattern for all 14 functions"
  key_links:
    - from: "Private/Resolve-LabModeDecision.ps1"
      to: "Private/Resolve-LabOperationIntent.ps1"
      via: "mode decision depends on operation intent"
      pattern: "try.*catch"
---

<objective>
Add try-catch error handling to 14 Private resolution, policy, and menu functions (Batch 3 of 4).

Purpose: Resolution functions determine what operation to execute and how. Menu functions handle interactive user input. Both need error handling to prevent cryptic failures: resolution errors should halt (wrong resolution = wrong operation), menu errors should be caught and displayed gracefully.

Output: 14 updated Private/*.ps1 files with try-catch, plus ErrorHandling-Batch3.Tests.ps1 verifying the pattern.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-error-handling/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add try-catch to resolution functions (8 files)</name>
  <files>Private/Resolve-LabActionRequest.ps1, Private/Resolve-LabCoordinatorPolicy.ps1, Private/Resolve-LabDispatchMode.ps1, Private/Resolve-LabDispatchPlan.ps1, Private/Resolve-LabModeDecision.ps1, Private/Resolve-LabNoExecuteStateOverride.ps1, Private/Resolve-LabOperationIntent.ps1, Private/Resolve-LabOrchestrationIntent.ps1</files>
  <action>
    Wrap the function body (everything after param block) in a try-catch block for each file.

    **Pattern -- terminating errors (resolution failures = wrong operation gets executed):**
    ```powershell
    try {
        # existing function body
    }
    catch {
        throw "FunctionName: <context> - $_"
    }
    ```

    Context messages:
    - Resolve-LabActionRequest: "failed to resolve action request"
    - Resolve-LabCoordinatorPolicy: "failed to evaluate coordinator policy"
    - Resolve-LabDispatchMode: "failed to resolve dispatch mode"
    - Resolve-LabDispatchPlan: "failed to resolve dispatch plan"
    - Resolve-LabModeDecision: "failed to determine execution mode"
    - Resolve-LabNoExecuteStateOverride: "failed to resolve no-execute state override"
    - Resolve-LabOperationIntent: "failed to resolve operation intent"
    - Resolve-LabOrchestrationIntent: "failed to resolve orchestration intent"

    IMPORTANT: Resolve-LabNoExecuteStateOverride does file I/O (reads/writes state JSON). The try-catch should wrap the entire body so file I/O errors are caught.
  </action>
  <verify>
    Verify try-catch and function name in error messages for each file.
  </verify>
  <done>8 resolution functions have try-catch with function-name-prefixed error messages.</done>
</task>

<task type="auto">
  <name>Task 2: Add try-catch to menu functions (6 files)</name>
  <files>Private/Show-LabMenu.ps1, Private/Invoke-LabInteractiveMenu.ps1, Private/Invoke-LabAddVMMenu.ps1, Private/Invoke-LabAddVMWizard.ps1, Private/Invoke-LabConfigureRoleMenu.ps1, Private/Invoke-LabSetupMenu.ps1</files>
  <action>
    Wrap the function body in try-catch for each file.

    **Pattern -- non-terminating errors (menu errors should display gracefully, not crash the app):**
    ```powershell
    try {
        # existing function body
    }
    catch {
        Write-Warning "FunctionName: <context> - $_"
    }
    ```

    Note: Menu functions use Write-Warning instead of $PSCmdlet.WriteError because menu errors are displayed to interactive users who need readable messages, not ErrorRecord objects.

    Context messages:
    - Show-LabMenu: "failed to display menu"
    - Invoke-LabInteractiveMenu: "interactive menu error"
    - Invoke-LabAddVMMenu: "add VM menu error"
    - Invoke-LabAddVMWizard: "VM creation wizard error"
    - Invoke-LabConfigureRoleMenu: "role configuration menu error"
    - Invoke-LabSetupMenu: "setup menu error"
  </action>
  <verify>
    Check each file contains try-catch with function name in error/warning message.
  </verify>
  <done>6 menu functions have try-catch with function-name-prefixed warning messages.</done>
</task>

<task type="auto">
  <name>Task 3: Create ErrorHandling-Batch3.Tests.ps1</name>
  <files>Tests/ErrorHandling-Batch3.Tests.ps1</files>
  <action>
    Create a Pester 5.x test file that verifies all 14 functions have try-catch with proper error message patterns.

    Same structure as Batch 1/2 tests: iterate over file list, verify try-catch presence and function-name-in-error-message pattern.

    The function name regex match should check for either `throw "FuncName:` or `Write-Warning "FuncName:` or `WriteError.*FuncName:` patterns.

    Use `Set-StrictMode -Version Latest` in BeforeAll. Follow project test patterns.
  </action>
  <verify>
    ```powershell
    Invoke-Pester Tests/ErrorHandling-Batch3.Tests.ps1 -Output Detailed
    ```
    All tests pass.
  </verify>
  <done>ErrorHandling-Batch3.Tests.ps1 exists with tests for all 14 functions. All tests pass.</done>
</task>

</tasks>

<verification>
1. `Invoke-Pester Tests/ErrorHandling-Batch3.Tests.ps1 -Output Detailed` -- all tests pass
2. All 14 files have try-catch with function name in error messages
3. Full test suite: `Invoke-Pester Tests/ -Output Detailed` -- no regressions
</verification>

<success_criteria>
- All 14 resolution, policy, and menu Private functions have try-catch error handling
- Error messages include function name prefix (ERR-03)
- Resolution functions use throw, menu functions use Write-Warning
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-error-handling/09-03-SUMMARY.md`
</output>
