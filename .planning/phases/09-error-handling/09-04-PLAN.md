---
phase: 09-error-handling
plan: 04
type: execute
wave: 1
depends_on: ["09-03"]
files_modified:
  - Public/Initialize-LabNetwork.ps1
  - Public/New-LabNAT.ps1
  - Public/New-LabSSHKey.ps1
  - Public/Show-LabStatus.ps1
  - Public/Test-LabNetworkHealth.ps1
  - Public/Write-LabStatus.ps1
  - Tests/ErrorHandling-Batch4.Tests.ps1
  - Tests/ErrorHandling-Audit.Tests.ps1
autonomous: true
requirements:
  - ERR-01
  - ERR-02
  - ERR-03
  - ERR-04

must_haves:
  truths:
    - "All 6 Public functions without try-catch get explicit error handling"
    - "Error messages include the function name as a prefix for grep-ability"
    - "Infrastructure functions (Initialize-LabNetwork, New-LabNAT, New-LabSSHKey) use try-catch with throw"
    - "Display functions (Show-LabStatus, Write-LabStatus) use try-catch with Write-Warning"
    - "No function in Private/ or Public/ uses 'exit' to terminate (ERR-04 audit)"
    - "All existing Pester tests pass after changes (no behavior regression)"
  artifacts:
    - path: "Public/New-LabNAT.ps1"
      provides: "try-catch wrapping NAT creation with IP validation"
    - path: "Public/Initialize-LabNetwork.ps1"
      provides: "try-catch wrapping static IP configuration"
    - path: "Tests/ErrorHandling-Batch4.Tests.ps1"
      provides: "Tests verifying error handling for all 6 public functions"
    - path: "Tests/ErrorHandling-Audit.Tests.ps1"
      provides: "Comprehensive audit: all functions have try-catch, no exit usage"
  key_links:
    - from: "Public/Initialize-LabNetwork.ps1"
      to: "Private/Set-VMStaticIP.ps1"
      via: "configures VMs using Private helper"
      pattern: "try.*catch"
---

<objective>
Add try-catch error handling to 6 Public functions and create a comprehensive audit test (Batch 4 of 4).

Purpose: Public functions are the user-facing API. Adding try-catch ensures that infrastructure operations (NAT, network, SSH) surface actionable errors when Hyper-V commands fail, and that display functions degrade gracefully. The audit test provides a regression guard ensuring no future functions ship without error handling.

Output: 6 updated Public/*.ps1 files with try-catch, ErrorHandling-Batch4.Tests.ps1, and ErrorHandling-Audit.Tests.ps1 (full codebase audit).
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-error-handling/09-RESEARCH.md
@Public/Initialize-LabNetwork.ps1
@Public/New-LabNAT.ps1
@Public/New-LabSSHKey.ps1
@Public/Show-LabStatus.ps1
@Public/Test-LabNetworkHealth.ps1
@Public/Write-LabStatus.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add try-catch to infrastructure Public functions (3 files)</name>
  <files>Public/Initialize-LabNetwork.ps1, Public/New-LabNAT.ps1, Public/New-LabSSHKey.ps1</files>
  <action>
    Wrap the function body (everything after param block) in a try-catch block for each file.

    **Pattern -- terminating errors (infrastructure failures should halt):**
    ```powershell
    try {
        # existing function body
    }
    catch {
        throw "FunctionName: <context> - $_"
    }
    ```

    Context messages:
    - Initialize-LabNetwork: "failed to configure lab network"
    - New-LabNAT: "failed to create NAT configuration"
    - New-LabSSHKey: "failed to generate SSH key pair"

    IMPORTANT: These functions have complex bodies with multiple early returns. The try-catch should wrap the ENTIRE body after the param block so that any unexpected exception at any point is caught.
  </action>
  <verify>
    Verify try-catch and function name in error messages for each file.
  </verify>
  <done>3 infrastructure Public functions have try-catch with function-name-prefixed error messages.</done>
</task>

<task type="auto">
  <name>Task 2: Add try-catch to display Public functions (3 files)</name>
  <files>Public/Show-LabStatus.ps1, Public/Test-LabNetworkHealth.ps1, Public/Write-LabStatus.ps1</files>
  <action>
    Wrap the function body in try-catch for each file.

    **Show-LabStatus and Test-LabNetworkHealth -- terminating (users expect these to either work or explain why not):**
    ```powershell
    try {
        # existing function body
    }
    catch {
        throw "FunctionName: <context> - $_"
    }
    ```

    **Write-LabStatus -- non-terminating (console output helper should not crash callers):**
    ```powershell
    try {
        # existing function body
    }
    catch {
        Write-Warning "Write-LabStatus: failed to write status message - $_"
    }
    ```

    Context messages:
    - Show-LabStatus: "failed to display lab status"
    - Test-LabNetworkHealth: "failed to run network health check"
    - Write-LabStatus: "failed to write status message"
  </action>
  <verify>
    Check each file contains try-catch with function name in error/warning message.
  </verify>
  <done>3 display Public functions have try-catch with function-name-prefixed error messages.</done>
</task>

<task type="auto">
  <name>Task 3: Create ErrorHandling-Batch4.Tests.ps1</name>
  <files>Tests/ErrorHandling-Batch4.Tests.ps1</files>
  <action>
    Create a Pester 5.x test file that verifies all 6 Public functions have try-catch with proper error message patterns.

    Same structure as previous batch tests: iterate over file list, verify try-catch presence and function-name-in-error-message pattern.

    Use `Set-StrictMode -Version Latest` in BeforeAll. Follow project test patterns.
  </action>
  <verify>
    ```powershell
    Invoke-Pester Tests/ErrorHandling-Batch4.Tests.ps1 -Output Detailed
    ```
    All tests pass.
  </verify>
  <done>ErrorHandling-Batch4.Tests.ps1 exists with tests for all 6 Public functions. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 4: Create ErrorHandling-Audit.Tests.ps1 -- comprehensive codebase audit</name>
  <files>Tests/ErrorHandling-Audit.Tests.ps1</files>
  <action>
    Create a comprehensive Pester 5.x audit test that serves as a regression guard for error handling across the entire codebase.

    **Test 1: All Private/ functions with >10 lines have try-catch**
    - Get all Private/*.ps1 files
    - Exclude the exempt list (trivial functions from 09-RESEARCH.md): Get-LabHealthArgs, Get-LabPreflightArgs, Suspend-LabMenuPrompt, Get-LabExpectedVMs, Get-LabBootstrapArgs, Get-LabDeployArgs, Register-LabAliases, Convert-LabArgumentArrayToSplat, Resolve-LabScriptPath, ConvertTo-LabTargetHostList, Get-LabGuiLayoutState, Read-LabMenuCount, Test-LabTransientTransportFailure, Protect-LabLogString, Add-LabRunEvent
    - Verify each non-exempt file contains `try` and `catch`

    **Test 2: All Public/ functions have try-catch**
    - Get all Public/*.ps1 files (top-level only, not Linux/)
    - Verify each contains `try` and `catch`

    **Test 3: No function uses exit to terminate (ERR-04)**
    - Scan all Private/*.ps1 and Public/*.ps1 files
    - Use regex `^\s*exit\b` (exit at start of line, not inside strings)
    - Should find 0 matches
    - Exclude comment lines (starting with #)

    **Test 4: Error messages include function name (ERR-03 sampling)**
    - For a representative sample (10 files), verify the catch block contains the function name

    Use `Set-StrictMode -Version Latest` in BeforeAll. Follow project test patterns.
  </action>
  <verify>
    ```powershell
    Invoke-Pester Tests/ErrorHandling-Audit.Tests.ps1 -Output Detailed
    ```
    All tests pass.
  </verify>
  <done>ErrorHandling-Audit.Tests.ps1 provides comprehensive regression guard. All tests pass. ERR-01, ERR-02, ERR-03, ERR-04 verified.</done>
</task>

</tasks>

<verification>
1. `Invoke-Pester Tests/ErrorHandling-Batch4.Tests.ps1 -Output Detailed` -- all tests pass
2. `Invoke-Pester Tests/ErrorHandling-Audit.Tests.ps1 -Output Detailed` -- all tests pass
3. All 6 Public files have try-catch with function name in error messages
4. No `exit` usage anywhere in Private/ or Public/
5. Full test suite: `Invoke-Pester Tests/ -Output Detailed` -- no regressions
</verification>

<success_criteria>
- All 6 Public functions have try-catch error handling (ERR-02)
- Error messages include function name prefix (ERR-03)
- No function uses exit to terminate (ERR-04)
- Comprehensive audit test provides regression guard
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-error-handling/09-04-SUMMARY.md`
</output>
