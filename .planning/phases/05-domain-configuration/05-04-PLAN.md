---
phase: 05-domain-configuration
plan: 04
type: execute
wave: 1
depends_on: [05-01, 05-02, 05-03]
files_modified:
  - SimpleLab/Public/Test-LabDomainHealth.ps1
  - SimpleLab/SimpleLab.psm1
  - SimpleLab/SimpleLab.psd1
autonomous: false

must_haves:
  truths:
    - Tool validates all domain components are healthy
    - Tool checks DC is accessible and functional
    - Tool verifies DNS is resolving
    - Tool checks member servers are joined and reachable
    - Tool provides overall domain health status
  artifacts:
    - path: SimpleLab/Public/Test-LabDomainHealth.ps1
      provides: Comprehensive domain health validation
      min_lines: 150
  key_links:
    - from: Test-LabDomainHealth.ps1
      to: Get-ADDomain (ActiveDirectory module)
      via: PowerShell Direct cmdlet to query domain
      pattern: Get-ADDomain.*-Identity
    - from: Test-LabDomainHealth.ps1
      to: Get-ADComputer (ActiveDirectory module)
      via: PowerShell Direct for computer account checks
      pattern: Get-ADComputer.*-Filter
---

<objective>
Validate domain health across all lab components

Purpose: Provide comprehensive health validation for the SimpleLab domain including domain controller status, DNS functionality, and member server connectivity. Returns clear status reporting for troubleshooting.

Output: Test-LabDomainHealth function for complete domain health validation
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-configuration/05-RESEARCH.md
@.planning/phases/05-domain-configuration/05-01-SUMMARY.md
@.planning/phases/05-domain-configuration/05-02-SUMMARY.md
@.planning/phases/05-domain-configuration/05-03-SUMMARY.md

# Domain functions from 05-01, 05-02, 05-03
@SimpleLab/Public/Initialize-LabDomain.ps1
@SimpleLab/Public/Initialize-LabDNS.ps1
@SimpleLab/Public/Join-LabDomain.ps1
@SimpleLab/Private/Test-LabDNS.ps1
@SimpleLab/Private/Test-LabDomainJoin.ps1
@SimpleLab/Private/Get-LabDomainConfig.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test-LabDomainHealth for comprehensive validation</name>
  <files>SimpleLab/Public/Test-LabDomainHealth.ps1</files>
  <action>
    Create Test-LabDomainHealth function in Public/ that:
    - Parameters:
      * DomainName (string, optional - from config or "simplelab.local")
      * Credential (pscredential, optional - from config or prompts)
      * IncludeMemberServers (switch, default true - check joined VMs)
    - Performs comprehensive domain health validation:
      1. Domain Controller Health:
         * DC VM is running and accessible
         * AD DS service is running
         * Domain is reachable and responding
         * FSMO roles are available (optional check)
      2. DNS Health:
         * DNS service is running on DC
         * DNS is responding to queries
         * Forwarders are configured (if applicable)
         * Can resolve domain names
      3. Member Server Health:
         * Each member VM is running
         * Each member is joined to domain
         * Domain trust is established
         * Can ping DC by name
      4. Overall Assessment:
         * All checks passed
         * Partial failures (warnings)
         * Critical failures
    - Returns PSCustomObject with:
      * DomainName (string)
      * OverallStatus (string: "Healthy", "Warning", "Failed", "NoDomain")
      * Message (string)
      * Checks (array of all check results)
      * DCHealth (PSCustomObject with DC-specific checks)
      * DNSHealth (PSCustomObject with DNS-specific checks)
      * MemberHealth (array of PSCustomObject per member server)
      * Duration (timespan)
    - Uses PowerShell Direct for in-VM checks
    - Uses ActiveDirectory module for domain queries
    - Handles case where domain doesn't exist yet gracefully
    - Provides clear pass/fail/warning status for each check
    - Uses [CmdletBinding()] and [OutputType([PSCustomObject])]
    - Public function (exported from module)

    Pattern: Follow Test-LabPrereqs pattern for structured multi-check validation
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Test-LabDomainHealth
    3. Verify output contains OverallStatus, DCHealth, DNSHealth, MemberHealth properties
    4. Verify OverallStatus is one of: Healthy, Warning, Failed, NoDomain
  </verify>
  <done>
    Test-LabDomainHealth function provides comprehensive domain health validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update module files for exports</name>
  <files>SimpleLab/SimpleLab.psm1, SimpleLab/SimpleLab.psd1</files>
  <action>
    Update SimpleLab module files:
    - SimpleLab.psm1: Add Test-LabDomainHealth to exported functions
    - SimpleLab.psd1: Add Test-LabDomainHealth to FunctionsToExport array

    Update module version to 0.6.0
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Test-LabDomainHealth appears in output
  </verify>
  <done>
    Module files updated - Test-LabDomainHealth exported
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <name>Task 3: Verify domain health validation on running domain</name>
  <files>SimpleLab/Public/Test-LabDomainHealth.ps1</files>
  <action>
    Optional verification of domain health validation on actual Hyper-V host.

    Skip on WSL/Linux (no domain available). On Windows with running domain:
    1. Run: Test-LabDomainHealth
    2. Verify DC health checks pass
    3. Verify DNS health checks pass
    4. Verify member server health checks pass
  </action>
  <verify>
    Manual verification only - automated tests run on WSL
  </verify>
  <done>
    Verification skipped on WSL - function code follows established patterns
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Test-LabDomainHealth validates domain controller is running and accessible
2. Test-LabDomainHealth checks AD DS service status
3. Test-LabDomainHealth validates DNS functionality
4. Test-LabDomainHealth checks member server domain membership
5. Test-LabDomainHealth provides clear overall status (Healthy/Warning/Failed/NoDomain)
6. Function handles non-existent domain gracefully (returns "NoDomain" status)
7. All health checks provide clear pass/fail/warning messages
</verification>

<success_criteria>
1. Tool validates all domain components are healthy
2. Tool checks DC is accessible and functional
3. Tool verifies DNS is resolving correctly
4. Tool checks member servers are joined and reachable
5. Single command (Test-LabDomainHealth) performs complete domain health validation
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-configuration/05-04-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Any deviations from plan
- Phase 5 completion summary

Update STATE.md:
- Mark Phase 5 as complete (all 4 plans done)
- Increment current phase position to Phase 6
- Add Phase 5 implementation decisions for health validation
- Update progress bar to 68%

Update ROADMAP.md:
- Mark Phase 5 as complete
- Update progress table
</output>
