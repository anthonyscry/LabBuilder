---
phase: 05-domain-configuration
plan: 02
type: execute
wave: 1
depends_on: [05-01]
files_modified:
  - SimpleLab/Private/Test-LabDNS.ps1
  - SimpleLab/Public/Initialize-LabDNS.ps1
  - SimpleLab/SimpleLab.psm1
  - SimpleLab/SimpleLab.psd1
autonomous: false

must_haves:
  truths:
    - Tool configures DNS forwarders for Internet resolution
    - Tool validates DNS is resolving queries
    - Tool tests DNS server health
    - Tool provides clear DNS diagnostic information
  artifacts:
    - path: SimpleLab/Private/Test-LabDNS.ps1
      provides: DNS health validation
      min_lines: 80
    - path: SimpleLab/Public/Initialize-LabDNS.ps1
      provides: DNS configuration orchestrator
      min_lines: 60
  key_links:
    from: Initialize-LabDNS.ps1
      to: Add-DnsServerForwarder (DnsServer module)
      via: PowerShell Direct cmdlet to configure forwarders
      pattern: Add-DnsServerForwarder.*-IPAddress
    - from: Test-LabDNS.ps1
      to: Test-DnsServerDnsServer (DnsServer module)
      via: PowerShell Direct for DNS health checks
      pattern: Test-DnsServerDnsServer.*-ComputerName
---

<objective>
Configure DNS forwarders and validate DNS functionality

Purpose: Configure the domain controller DNS with forwarders for Internet resolution and validate DNS server health to ensure name resolution works correctly for the lab.

Output: Initialize-LabDNS function for DNS configuration and Test-LabDNS for health validation
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-configuration/05-RESEARCH.md
@.planning/phases/05-domain-configuration/05-01-SUMMARY.md

# DC promotion from 05-01
@SimpleLab/Public/Initialize-LabDomain.ps1
@SimpleLab/Private/Get-LabDomainConfig.ps1
@SimpleLab/Private/Test-DCPromotionPrereqs.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test-LabDNS for DNS health validation</name>
  <files>SimpleLab/Private/Test-LabDNS.ps1</files>
  <action>
    Create Test-LabDNS function in Private/ that:
    - Parameters:
      * VMName (string, default: "SimpleDC")
      * TestInternetResolution (switch, default false)
    - Validates DNS server health via PowerShell Direct:
      * DNS service is running
      * DNS server is responding to queries
      * Forwarders are configured (if TestInternetResolution)
      * Can resolve internal names (if applicable)
      * Can resolve Internet names (if TestInternetResolution)
    - Returns PSCustomObject with:
      * VMName (string)
      * DNSRunning (bool)
      * DNSResponding (bool)
      * ForwardersConfigured (bool)
      * InternalResolution (bool)
      * InternetResolution (bool)
      * OverallStatus (string: "Healthy", "Warning", "Failed")
      * Message (string)
      * Checks (array of individual check results)
    - Uses Invoke-Command -VMName for in-VM DNS checks
    - Uses DnsServer module commands (Get-DnsServerSetting, Test-DnsServerDnsServer)
    - Handles case where VM doesn't exist or isn't a DC yet
    - Uses [CmdletBinding()] and [OutputType([PSCustomObject])]
    - Internal function only (not exported)

    Pattern: Follow Test-LabNetworkHealth pattern for structured validation
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Test-LabDNS
    3. Verify output contains DNSRunning, OverallStatus, Message properties
    4. Verify OverallStatus is one of: Healthy, Warning, Failed
  </verify>
  <done>
    Test-LabDNS function validates DNS health with structured results
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Initialize-LabDNS for DNS configuration</name>
  <files>SimpleLab/Public/Initialize-LabDNS.ps1</files>
  <action>
    Create Initialize-LabDNS function in Public/ that:
    - Parameters:
      * VMName (string, default: "SimpleDC")
      * Forwarder (string array, common public DNS: 8.8.8.8, 8.8.4.4, 1.1.1.1)
      * Force (switch, default false - reconfigure if forwarders exist)
    - Orchestrates DNS configuration workflow:
      1. Verify VM is running and is a domain controller
      2. Configure DNS forwarders for Internet resolution:
         * Add-DnsServerForwarder via PowerShell Direct
         * Use default forwarders if not specified (8.8.8.8, 8.8.4.4)
      3. Configure root hints if needed (optional, for redundancy)
      4. Verify DNS is responding to queries
      5. Test Internet resolution if forwarders configured
    - Returns PSCustomObject with:
      * VMName (string)
      * Configured (bool)
      * Status (string: "OK", "AlreadyConfigured", "Failed", "NotADC")
      * Message (string with details)
      * ForwardersConfigured (string array)
      * Duration (timespan)
    - Handles "already configured" case gracefully
    - Force parameter reconfigures existing forwarders
    - Validates forwarder reachability before adding
    - Uses [CmdletBinding()] and [OutputType([PSCustomObject])]
    - Public function (exported from module)

    Pattern: Follow Initialize-LabDomain orchestrator pattern
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Initialize-LabDNS
    3. Verify output contains Configured, Status, ForwardersConfigured properties
    4. Verify Status is one of: OK, AlreadyConfigured, Failed, NotADC
  </verify>
  <done>
    Initialize-LabDNS function configures DNS forwarders with validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Update module files for exports</name>
  <files>SimpleLab/SimpleLab.psm1, SimpleLab/SimpleLab.psd1</files>
  <action>
    Update SimpleLab module files:
    - SimpleLab.psm1: Add Initialize-LabDNS to exported functions
    - SimpleLab.psd1: Add Initialize-LabDNS to FunctionsToExport array
    - Ensure Test-LabDNS remains internal

    Update module version to 0.4.0
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Initialize-LabDNS appears in output
    4. Verify Test-LabDNS does NOT appear (internal)
  </verify>
  <done>
    Module files updated - Initialize-LabDNS exported, Test-LabDNS remains internal
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <name>Task 4: Verify DNS configuration and resolution</name>
  <files>SimpleLab/Public/Initialize-LabDNS.ps1, SimpleLab/Private/Test-LabDNS.ps1</files>
  <action>
    Optional verification of DNS configuration on actual Hyper-V host.

    Skip on WSL/Linux (no DC available). On Windows with running DC:
    1. Run: Initialize-LabDNS
    2. Verify forwarders are added
    3. Run: Test-LabDNS -TestInternetResolution
    4. Verify Internet name resolution works
  </action>
  <verify>
    Manual verification only - automated tests run on WSL
  </verify>
  <done>
    Verification skipped on WSL - function code follows established patterns
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Test-LabDNS validates DNS service is running
2. Test-LabDNS validates DNS is responding to queries
3. Test-LabDNS tests forwarder configuration
4. Initialize-LabDNS configures DNS forwarders via PowerShell Direct
5. Initialize-LabDNS uses default forwarders (8.8.8.8, 8.8.4.4) if not specified
6. Initialize-LabDNS validates forwarder reachability before adding
7. Error handling provides clear messages for each failure mode
</verification>

<success_criteria>
1. Tool configures DNS forwarders for Internet resolution
2. Tool validates DNS is resolving queries
3. Tool tests DNS server health with Test-LabDNS
4. Tool provides clear DNS diagnostic information
5. Single command (Initialize-LabDNS) performs complete DNS configuration
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-configuration/05-02-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Any deviations from plan
- Next steps for 05-03 (Domain Join Automation)

Update STATE.md:
- Increment current phase position to Phase 5, Plan 2
- Add Phase 5 implementation decisions for DNS
- Update progress bar to 60%
</output>
