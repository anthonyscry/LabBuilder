---
phase: 05-domain-configuration
plan: 01
type: execute
wave: 1
depends_on: [04-01, 04-02, 04-03, 04-04]
files_modified:
  - SimpleLab/Private/Get-LabDomainConfig.ps1
  - SimpleLab/Private/Test-DCPromotionPrereqs.ps1
  - SimpleLab/Public/Initialize-LabDomain.ps1
  - SimpleLab/SimpleLab.psm1
  - SimpleLab/SimpleLab.psd1
autonomous: false

must_haves:
  truths:
    - Tool promotes SimpleDC VM to domain controller
    - Tool installs DNS Server role during promotion
    - Tool reboots VM after promotion automatically
    - Tool waits for VM to return online after reboot
    - Tool verifies domain controller is functional
  artifacts:
    - path: SimpleLab/Private/Get-LabDomainConfig.ps1
      provides: Domain configuration retrieval
      min_lines: 30
    - path: SimpleLab/Private/Test-DCPromotionPrereqs.ps1
      provides: DC promotion prerequisite validation
      min_lines: 40
    - path: SimpleLab/Public/Initialize-LabDomain.ps1
      provides: DC promotion orchestrator
      min_lines: 80
  key_links:
    - from: Initialize-LabDomain.ps1
      to: Install-ADDSForest (ADDSDeployment module)
      via: PowerShell Direct cmdlet to promote DC
      pattern: Install-ADDSForest.*-DomainName
    - from: Initialize-LabDomain.ps1
      to: Invoke-Command (PowerShell core)
      via: PowerShell Direct for in-VM execution
      pattern: Invoke-Command.*-VMName.*SimpleDC
---

<objective>
Automate domain controller promotion and Active Directory deployment

Purpose: Promote the SimpleDC VM to a domain controller with DNS services, creating the "simplelab.local" forest and establishing the foundation for domain member operations.

Output: Initialize-LabDomain function for complete DC promotion automation
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-configuration/05-RESEARCH.md

# VM provisioning from Phase 4
@SimpleLab/Public/Initialize-LabVMs.ps1
@SimpleLab/Private/Get-LabVMConfig.ps1
@SimpleLab/Private/Test-LabVM.ps1

# PowerShell Direct patterns from Phase 3
@SimpleLab/Private/Set-VMStaticIP.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Get-LabDomainConfig for domain settings</name>
  <files>SimpleLab/Private/Get-LabDomainConfig.ps1</files>
  <action>
    Create Get-LabDomainConfig function in Private/ that:
    - No parameters (reads from config.json)
    - Returns PSCustomObject with domain configuration:
      * DomainName (default: "simplelab.local")
      * NetBIOSName (default: "SIMPLELAB")
      * SafeModePassword (from config or default)
      * DnsServerAddress (default: DC IP from network config)
    - Reads DomainConfiguration section from config.json if exists
    - Falls back to sensible defaults if no configuration
    - Returns structured result for use by promotion functions
    - Uses [CmdletBinding()] and [OutputType([PSCustomObject])]
    - Internal function only (not exported)

    Pattern: Follow Get-LabNetworkConfig pattern for defaults + override
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Get-LabDomainConfig
    3. Verify output contains DomainName, NetBIOSName, SafeModePassword properties
    4. Verify DomainName defaults to "simplelab.local"
  </verify>
  <done>
    Get-LabDomainConfig function provides domain configuration with defaults and override support
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Test-DCPromotionPrereqs for validation</name>
  <files>SimpleLab/Private/Test-DCPromotionPrereqs.ps1</files>
  <action>
    Create Test-DCPromotionPrereqs function in Private/ that:
    - Parameters:
      * VMName (string, default: "SimpleDC")
    - Validates DC promotion prerequisites via PowerShell Direct:
      * VM is running (Heartbeat = "Ok")
      * ADDSDeployment module is available inside VM
      * Network connectivity is functional
    - Returns PSCustomObject with:
      * VMName (string)
      * CanPromote (bool)
      * Status (string: "Ready", "NotRunning", "MissingModule", "NoNetwork")
      * Message (string with details)
      * Checks (array of individual check results)
    - Uses Invoke-Command -VMName for in-VM validation
    - Handles case where VM doesn't exist gracefully
    - Provides clear error messages for each failure condition
    - Uses [CmdletBinding()] and [OutputType([PSCustomObject])]
    - Internal function only (not exported)

    Pattern: Follow Test-LabPrereqs pattern for structured validation
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Test-DCPromotionPrereqs -VMName "SimpleDC"
    3. Verify output contains CanPromote, Status, Message properties
    4. Verify Status is one of: Ready, NotRunning, MissingModule, NoNetwork
  </verify>
  <done>
    Test-DCPromotionPrereqs function validates DC promotion readiness with structured results
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Initialize-LabDomain for DC promotion</name>
  <files>SimpleLab/Public/Initialize-LabDomain.ps1</files>
  <action>
    Create Initialize-LabDomain function in Public/ that:
    - Parameters:
      * VMName (string, default: "SimpleDC")
      * SafeModePassword (securestring, optional - from config if not specified)
      * DomainName (string, optional - from config if not specified)
      * Force (switch, default false - skip confirmation)
      * WaitTimeoutMinutes (int, default: 15)
    - Orchestrates complete DC promotion workflow:
      1. Get domain config: Get-LabDomainConfig
      2. Test prerequisites: Test-DCPromotionPrereqs
      3. If prereqs fail, return error with clear message
      4. Execute promotion via PowerShell Direct:
         * Invoke-Command -VMName $VMName -ScriptBlock {
             Install-ADDSForest @domainParams -Force:$true
         }
      5. Wait for reboot:
         * Poll VM state until Off (reboot starts)
         * Wait for VM to come back (Heartbeat = "Ok")
         * Timeout based on WaitTimeoutMinutes
      6. Verify DC is functional:
         * Test AD services availability
         * Test DNS is resolving
    - Returns PSCustomObject with:
      * VMName (string)
      * Promoted (bool)
      * Status (string: "OK", "AlreadyDC", "Failed", "Timeout")
      * Message (string with details)
      * Duration (timespan)
    - Handles "already a DC" case gracefully (return "AlreadyDC" status)
    - Handles timeout waiting for VM to return online
    - Force parameter suppresses confirmation prompts
    - Uses [CmdletBinding()] and [OutputType([PSCustomObject])]
    - Public function (exported from module)

    Pattern: Follow Initialize-LabVMs orchestrator pattern
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Initialize-LabDomain
    3. Verify output contains Promoted, Status, Duration properties
    4. Verify Status is one of: OK, AlreadyDC, Failed, Timeout
  </verify>
  <done>
    Initialize-LabDomain function orchestrates DC promotion with reboot handling and verification
  </done>
</task>

<task type="auto">
  <name>Task 4: Update module files for exports</name>
  <files>SimpleLab/SimpleLab.psm1, SimpleLab/SimpleLab.psd1</files>
  <action>
    Update SimpleLab module files:
    - SimpleLab.psm1: Add Initialize-LabDomain to exported functions
    - SimpleLab.psd1: Add Initialize-LabDomain to FunctionsToExport array
    - Ensure Get-LabDomainConfig and Test-DCPromotionPrereqs remain internal

    Update module version to 0.3.0
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Initialize-LabDomain appears in output
    4. Verify Get-LabDomainConfig does NOT appear (internal)
    5. Verify Test-DCPromotionPrereqs does NOT appear (internal)
  </verify>
  <done>
    Module files updated - Initialize-LabDomain exported, helper functions remain internal
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <name>Task 5: Verify domain promotion prerequisites</name>
  <files>SimpleLab/Public/Initialize-LabDomain.ps1, SimpleLab/Private/Test-DCPromotionPrereqs.ps1</files>
  <action>
    Optional verification of DC promotion readiness on actual Hyper-V host.

    Skip on WSL/Linux (cannot create VMs). On Windows with Hyper-V:
    1. Create test VM with Windows Server 2019
    2. Run Initialize-LabDomain with test VM
    3. Verify promotion succeeds
    4. Verify DNS is installed and functional
    5. Verify VM reboots and returns online
  </action>
  <verify>
    Manual verification only - automated tests run on WSL
  </verify>
  <done>
    Verification skipped on WSL - function code follows established patterns
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Get-LabDomainConfig returns domain configuration with proper defaults
2. Test-DCPromotionPrereqs validates VM state and module availability
3. Initialize-LabDomain orchestrates complete promotion workflow
4. DC promotion uses Install-ADDSForest via PowerShell Direct
5. Function handles VM reboot and waits for return online
6. Function verifies DC functionality after promotion
7. Error handling provides clear messages for each failure mode
</verification>

<success_criteria>
1. Tool promotes SimpleDC VM to domain controller with "simplelab.local" domain
2. Tool installs DNS Server role during promotion automatically
3. Tool reboots VM after promotion and waits for return online
4. Tool verifies domain controller is functional after promotion completes
5. Single command (Initialize-LabDomain) performs complete DC promotion
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-configuration/05-01-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Any deviations from plan
- Next steps for 05-02 (DNS configuration)

Update STATE.md:
- Increment current phase position to Phase 5, Plan 1
- Add Phase 5 implementation decisions
- Update progress bar to 56%
</output>
