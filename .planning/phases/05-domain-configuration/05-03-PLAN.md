---
phase: 05-domain-configuration
plan: 03
type: execute
wave: 1
depends_on: [05-01, 05-02]
files_modified:
  - SimpleLab/Private/Test-LabDomainJoin.ps1
  - SimpleLab/Public/Join-LabDomain.ps1
  - SimpleLab/SimpleLab.psm1
  - SimpleLab/SimpleLab.psd1
autonomous: false

must_haves:
  truths:
    - Tool joins member VMs to the simplelab.local domain
    - Tool handles domain join credentials securely
    - Tool reboots VMs after joining
    - Tool verifies domain membership
    - Tool provides clear join status for each VM
  artifacts:
    - path: SimpleLab/Private/Test-LabDomainJoin.ps1
      provides: Domain membership validation
      min_lines: 60
    - path: SimpleLab/Public/Join-LabDomain.ps1
      provides: Domain join orchestrator for multiple VMs
      min_lines: 100
  key_links:
    - from: Join-LabDomain.ps1
      to: Add-Computer (Microsoft.PowerShell.Management)
      via: PowerShell Direct cmdlet to join domain
      pattern: Add-Computer.*-DomainName.*-Credential
    - from: Join-LabDomain.ps1
      to: Test-ComputerSecureChannel (ActiveDirectory module)
      via: PowerShell Direct for domain membership verification
      pattern: Test-ComputerSecureChannel.*-Credential
---

<objective>
Automate domain join for member servers

Purpose: Join the SimpleServer and SimpleWin11 VMs to the simplelab.local domain using PowerShell Direct, handling credentials, reboots, and verification.

Output: Join-LabDomain function for domain join automation and Test-LabDomainJoin for validation
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-configuration/05-RESEARCH.md
@.planning/phases/05-domain-configuration/05-01-SUMMARY.md
@.planning/phases/05-domain-configuration/05-02-SUMMARY.md

# DC promotion and DNS from 05-01, 05-02
@SimpleLab/Public/Initialize-LabDomain.ps1
@SimpleLab/Public/Initialize-LabDNS.ps1
@SimpleLab/Private/Get-LabDomainConfig.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test-LabDomainJoin for domain membership validation</name>
  <files>SimpleLab/Private/Test-LabDomainJoin.ps1</files>
  <action>
    Create Test-LabDomainJoin function in Private/ that:
    - Parameters:
      * VMName (string, required)
      * DomainName (string, optional - from config or default)
      * Credential (pscredential, optional - default domain admin)
    - Validates domain membership via PowerShell Direct:
      * VM is running
      * VM is joined to the specified domain
      * Domain trust is established (Test-ComputerSecureChannel)
      * Domain controller is reachable from VM
    - Returns PSCustomObject with:
      * VMName (string)
      * IsJoined (bool)
      * DomainName (string - actual domain joined)
      * TrustStatus (string: "OK", "Failed", "NotJoined")
      * Status (string: "Joined", "NotJoined", "NotRunning", "NoTrust")
      * Message (string)
      * Checks (array of individual check results)
    - Handles case where VM doesn't exist
    - Uses Invoke-Command -VMName for in-VM validation
    - Uses ActiveDirectory module (Test-ComputerSecureChannel, Get-ADComputer)
    - Uses [CmdletBinding()] and [OutputType([PSCustomObject])]
    - Internal function only (not exported)

    Pattern: Follow Test-DCPromotionPrereqs pattern for structured validation
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Test-LabDomainJoin -VMName "SimpleServer"
    3. Verify output contains IsJoined, Status, Message properties
    4. Verify Status is one of: Joined, NotJoined, NotRunning, NoTrust
  </verify>
  <done>
    Test-LabDomainJoin function validates domain membership with structured results
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Join-LabDomain for domain join automation</name>
  <files>SimpleLab/Public/Join-LabDomain.ps1</files>
  <action>
    Create Join-LabDomain function in Public/ that:
    - Parameters:
      * VMNames (string array, default: @("SimpleServer", "SimpleWin11"))
      * DomainName (string, optional - from config or "simplelab.local")
      * Credential (pscredential, optional - prompts if not provided)
      * OUPath (string, optional - Organizational Unit for computer accounts)
      * Force (switch, default false - rejoin if already joined)
      * WaitTimeoutMinutes (int, default: 10)
    - Orchestrates domain join for multiple VMs:
      1. Get domain configuration
      2. Prompt for domain admin credentials if not provided
      3. Process each VM in dependency order (servers before clients)
      4. For each VM:
         * Test if already joined (skip if joined and not Force)
         * Verify DC is reachable from VM
         * Execute domain join via Add-Computer with -Restart
         * Wait for VM to reboot and return online
         * Verify domain membership
      5. Returns PSCustomObject with:
         * VMsJoined (hashtable of results per VM)
         * FailedVMs (array)
         * SkippedVMs (array)
         * OverallStatus (string: "OK", "Partial", "Failed")
         * Message (string)
         * Duration (timespan)
    - Handles credential prompting securely (using Credential attribute)
    - Reboots VMs after joining automatically
    - Waits for VMs to return online with timeout
    - Force parameter allows rejoining if already in domain
    - Uses [CmdletBinding()] and [OutputType([PSCustomObject])]
    - Public function (exported from module)

    Pattern: Follow Initialize-LabVMs orchestrator pattern with per-VM result tracking
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Join-LabDomain
    3. Verify output contains VMsJoined, OverallStatus, Message properties
    4. Verify OverallStatus is one of: OK, Partial, Failed
  </verify>
  <done>
    Join-LabDomain function orchestrates domain join with credential handling and verification
  </done>
</task>

<task type="auto">
  <name>Task 3: Update module files for exports</name>
  <files>SimpleLab/SimpleLab.psm1, SimpleLab/SimpleLab.psd1</files>
  <action>
    Update SimpleLab module files:
    - SimpleLab.psm1: Add Join-LabDomain to exported functions
    - SimpleLab.psd1: Add Join-LabDomain to FunctionsToExport array
    - Ensure Test-LabDomainJoin remains internal

    Update module version to 0.5.0
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Join-LabDomain appears in output
    4. Verify Test-LabDomainJoin does NOT appear (internal)
  </verify>
  <done>
    Module files updated - Join-LabDomain exported, Test-LabDomainJoin remains internal
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <name>Task 4: Verify domain join functionality</name>
  <files>SimpleLab/Public/Join-LabDomain.ps1, SimpleLab/Private/Test-LabDomainJoin.ps1</files>
  <action>
    Optional verification of domain join on actual Hyper-V host.

    Skip on WSL/Linux (no VMs available). On Windows with running DC:
    1. Ensure member VMs are running
    2. Run: Join-LabDomain
    3. Verify VMs are joined to domain
    4. Verify VMs rebooted and returned online
  </action>
  <verify>
    Manual verification only - automated tests run on WSL
  </verify>
  <done>
    Verification skipped on WSL - function code follows established patterns
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Test-LabDomainJoin validates VM domain membership status
2. Test-LabDomainJoin verifies domain trust channel
3. Join-LabDomain joins multiple VMs to domain in correct order
4. Join-LabDomain handles credential prompting securely
5. Join-LabDomain reboots VMs after joining and waits for return online
6. Join-LabDomain verifies domain membership after join
7. Force parameter allows rejoining already-joined VMs
</verification>

<success_criteria>
1. Tool joins member VMs to the simplelab.local domain
2. Tool handles domain join credentials securely with prompting
3. Tool reboots VMs after joining automatically
4. Tool verifies domain membership after reboot
5. Single command (Join-LabDomain) joins all member servers
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-configuration/05-03-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Any deviations from plan
- Next steps for 05-04 (Domain Health Validation)

Update STATE.md:
- Increment current phase position to Phase 5, Plan 3
- Add Phase 5 implementation decisions for domain join
- Update progress bar to 64%
</output>
