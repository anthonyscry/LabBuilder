---
phase: 24-linux-vm-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Get-LabSnapshotInventory.ps1
  - Private/Save-LabProfile.ps1
  - Private/Load-LabProfile.ps1
  - Private/Get-LabStateProbe.ps1
  - Tests/LinuxSnapshotParity.Tests.ps1
  - Tests/LinuxProfileParity.Tests.ps1
autonomous: true
requirements:
  - LNX-01
  - LNX-03
  - LNX-04

must_haves:
  truths:
    - "Get-LabSnapshotInventory discovers all Linux VMs (LIN1, LINWEB1, LINDB1, LINDOCK1, LINK8S1) not just LIN1"
    - "Remove-LabStaleSnapshots prunes Linux VM snapshots identically to Windows VM snapshots"
    - "Checkpoint-VM and Restore-VMCheckpoint work for Linux VMs via existing helpers (Hyper-V treats them identically)"
    - "Save-LabProfile preserves Linux section, LinuxVM sizing, and Linux IP plan entries"
    - "Load-LabProfile restores Linux configuration including nested hashtables"
    - "Get-LabStateProbe includes Linux VMs in fleet status"
  artifacts:
    - path: "Private/Get-LabSnapshotInventory.ps1"
      provides: "All-Linux-VM auto-detection in snapshot inventory"
      contains: "LinuxVM"
    - path: "Private/Save-LabProfile.ps1"
      provides: "Linux VM count in profile metadata"
      contains: "LinuxVM"
    - path: "Tests/LinuxSnapshotParity.Tests.ps1"
      provides: "Pester tests for Linux snapshot parity"
      contains: "Describe"
    - path: "Tests/LinuxProfileParity.Tests.ps1"
      provides: "Pester tests for Linux profile round-trip"
      contains: "Describe"
  key_links:
    - from: "Private/Get-LabSnapshotInventory.ps1"
      to: "Lab-Config.ps1"
      via: "GlobalLabConfig.Builder.VMNames for Linux VM name resolution"
      pattern: "VMNames"
    - from: "Private/Save-LabProfile.ps1"
      to: "Private/Load-LabProfile.ps1"
      via: "JSON round-trip of Linux config sections"
      pattern: "LinuxVM|Linux"
---

<objective>
Linux VM snapshot and profile parity — extend existing snapshot inventory, pruning, and profile save/load to treat Linux VMs as first-class citizens alongside Windows VMs.

Purpose: Linux VMs currently have partial lifecycle support (create/start). Snapshot management (inventory, prune, restore) and configuration profiles must include all Linux VMs for full parity with Windows VMs.

Output: Updated Get-LabSnapshotInventory with all-Linux-VM discovery, enhanced Save-LabProfile with Linux VM metadata, and comprehensive Pester tests proving parity.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Private/Get-LabSnapshotInventory.ps1
@Private/Remove-LabStaleSnapshots.ps1
@Private/Save-LabProfile.ps1
@Private/Load-LabProfile.ps1
@Private/Get-LabStateProbe.ps1
@Lab-Config.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend snapshot inventory and state probe to discover all Linux VMs</name>
  <files>
    Private/Get-LabSnapshotInventory.ps1
    Private/Get-LabStateProbe.ps1
    Tests/LinuxSnapshotParity.Tests.ps1
  </files>
  <action>
    1. In `Get-LabSnapshotInventory.ps1`, update the auto-detection block (lines 41-54) that currently only auto-detects 'LIN1'. Replace the single LIN1 detection with a loop over all Linux VM names from `$GlobalLabConfig.Builder.VMNames` where the key contains 'Ubuntu' (i.e., Ubuntu, WebServerUbuntu, DatabaseUbuntu, DockerUbuntu, K8sUbuntu). Use pattern:
    ```powershell
    # Auto-detect Linux VMs from Builder config
    if (Test-Path variable:GlobalLabConfig) {
        $linuxKeys = @('Ubuntu', 'WebServerUbuntu', 'DatabaseUbuntu', 'DockerUbuntu', 'K8sUbuntu')
        foreach ($key in $linuxKeys) {
            if ($GlobalLabConfig.Builder.VMNames.ContainsKey($key)) {
                $linName = $GlobalLabConfig.Builder.VMNames[$key]
                if ($linName -and $linName -notin $targetVMs) {
                    $linVM = Get-VM -Name $linName -ErrorAction SilentlyContinue
                    if ($linVM) { $targetVMs += $linName }
                }
            }
        }
    }
    ```
    Also keep the fallback LIN1 detection for backward compat when GlobalLabConfig is not loaded.

    2. In `Get-LabStateProbe.ps1`, verify Linux VMs are included in fleet status. If the probe only checks CoreVMNames, add Linux VM detection using the same pattern. Only modify if Linux VMs are currently excluded.

    3. Create `Tests/LinuxSnapshotParity.Tests.ps1` with Pester 5 tests:
    - Test that Get-LabSnapshotInventory discovers Linux VMs when present (mock Get-VM to return Linux VM objects)
    - Test that Get-LabSnapshotInventory includes Linux VMs in output alongside Windows VMs
    - Test that Remove-LabStaleSnapshots processes Linux VM snapshots (mock Get-LabSnapshotInventory to return Linux VM snapshots, mock Remove-VMCheckpoint)
    - Test backward compat: LIN1 still auto-detected when GlobalLabConfig not loaded
    - Use `$script:` scope for BeforeAll variables per project convention
    - Dot-source the helpers in BeforeAll, mock Hyper-V cmdlets (Get-VM, Get-VMCheckpoint, Remove-VMCheckpoint)
    - Set StrictMode Latest
  </action>
  <verify>
    Run: `pwsh -Command "Invoke-Pester ./Tests/LinuxSnapshotParity.Tests.ps1 -Output Detailed"` — all tests pass.
    Verify Get-LabSnapshotInventory source contains the multi-Linux-VM detection loop.
  </verify>
  <done>
    Get-LabSnapshotInventory discovers all 5 Linux VM names (not just LIN1). Remove-LabStaleSnapshots processes Linux VM snapshots. Tests prove parity. Backward compat preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend profile save/load to preserve Linux VM settings with round-trip tests</name>
  <files>
    Private/Save-LabProfile.ps1
    Tests/LinuxProfileParity.Tests.ps1
  </files>
  <action>
    1. In `Save-LabProfile.ps1`, enhance the vmCount calculation (lines 39-41) to also count Linux VMs. Add a `linuxVmCount` field to the profile metadata:
    ```powershell
    $linuxVmCount = 0
    if ($Config.ContainsKey('Builder') -and $Config.Builder -is [hashtable]) {
        if ($Config.Builder.ContainsKey('LinuxVM') -and $Config.Builder.LinuxVM -is [hashtable]) {
            $linuxVmCount = 1  # LinuxVM config present
        }
        if ($Config.Builder.ContainsKey('VMNames') -and $Config.Builder.VMNames -is [hashtable]) {
            $linuxKeys = @('Ubuntu', 'WebServerUbuntu', 'DatabaseUbuntu', 'DockerUbuntu', 'K8sUbuntu')
            $linuxVmCount = @($linuxKeys | Where-Object { $Config.Builder.VMNames.ContainsKey($_) }).Count
        }
    }
    ```
    Add `linuxVmCount = $linuxVmCount` to the $profile ordered hashtable.

    2. The actual config round-trip already works because Save-LabProfile serializes the entire $Config hashtable to JSON and Load-LabProfile deserializes with ConvertTo-Hashtable. No changes needed to Load-LabProfile — the Linux sections (Linux, LinuxVM, SupportedDistros) are already preserved. But verify this in tests.

    3. Create `Tests/LinuxProfileParity.Tests.ps1` with Pester 5 tests:
    - Test that Save-LabProfile includes linuxVmCount in profile metadata
    - Test round-trip: save a config with Linux section, load it back, verify Linux.User, Linux.SSHPublicKey, LinuxVM.Memory, LinuxVM.Processors are preserved
    - Test round-trip: verify SupportedDistros entries survive serialization (nested hashtable-in-hashtable)
    - Test round-trip: verify Builder.VMNames Linux entries (Ubuntu, WebServerUbuntu, etc.) survive
    - Test that linuxVmCount = 0 when no Linux VM keys present
    - Use temp directory for profile files, clean up in AfterAll
    - Dot-source Save-LabProfile.ps1 and Load-LabProfile.ps1 in BeforeAll
    - Set StrictMode Latest
  </action>
  <verify>
    Run: `pwsh -Command "Invoke-Pester ./Tests/LinuxProfileParity.Tests.ps1 -Output Detailed"` — all tests pass.
    Verify Save-LabProfile.ps1 contains linuxVmCount in profile object.
  </verify>
  <done>
    Save-LabProfile includes Linux VM count metadata. Load-LabProfile correctly round-trips all Linux configuration sections (Linux, LinuxVM, SupportedDistros, VMNames). Tests prove full round-trip fidelity.
  </done>
</task>

</tasks>

<verification>
1. `pwsh -Command "Invoke-Pester ./Tests/LinuxSnapshotParity.Tests.ps1, ./Tests/LinuxProfileParity.Tests.ps1 -Output Detailed"` — all tests pass
2. `Select-String 'LinuxVM|Ubuntu.*WebServer.*Database.*Docker.*K8s' Private/Get-LabSnapshotInventory.ps1` — confirms multi-VM detection
3. `Select-String 'linuxVmCount' Private/Save-LabProfile.ps1` — confirms metadata field
</verification>

<success_criteria>
- All Linux VMs auto-discovered in snapshot inventory (not just LIN1)
- Snapshot pruning works identically for Linux and Windows VMs
- Profile save/load round-trips Linux config sections without data loss
- All new Pester tests pass
- Backward compatibility with LIN1-only detection preserved
</success_criteria>

<output>
After completion, create `.planning/phases/24-linux-vm-parity/24-01-SUMMARY.md`
</output>
