---
phase: 24-linux-vm-parity
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - LabBuilder/Roles/LinuxRoleBase.ps1
  - LabBuilder/Roles/CentOS.ps1
  - Lab-Config.ps1
  - Tests/LinuxSSHRetry.Tests.ps1
  - Tests/CentOSRole.Tests.ps1
autonomous: true
requirements:
  - LNX-02
  - LNX-06

must_haves:
  truths:
    - "Invoke-LinuxRolePostInstall retries SSH failures up to a configurable count with backoff"
    - "SSH retry count and timeout are configurable via LabConfig.Timeouts or function parameters"
    - "CentOS/RHEL VMs can be provisioned using cloud-init NoCloud datasource"
    - "Get-LabRole_CentOS returns a role definition matching the Ubuntu role structure"
    - "Existing Ubuntu roles are unaffected by CentOS additions"
    - "Lab-Config.ps1 has CentOS VM name, IP plan, and role menu entries"
  artifacts:
    - path: "LabBuilder/Roles/LinuxRoleBase.ps1"
      provides: "SSH retry with configurable count and backoff in Invoke-LinuxRolePostInstall"
      contains: "RetryCount"
    - path: "LabBuilder/Roles/CentOS.ps1"
      provides: "CentOS role definition with cloud-init NoCloud provisioning"
      contains: "Get-LabRole_CentOS"
    - path: "Lab-Config.ps1"
      provides: "CentOS VM entries in VMNames, IPPlan, RoleMenu, SupportedDistros"
      contains: "CentOS"
    - path: "Tests/LinuxSSHRetry.Tests.ps1"
      provides: "Pester tests for SSH retry behavior"
      contains: "Describe"
    - path: "Tests/CentOSRole.Tests.ps1"
      provides: "Pester tests for CentOS role definition"
      contains: "Describe"
  key_links:
    - from: "LabBuilder/Roles/CentOS.ps1"
      to: "LabBuilder/Roles/LinuxRoleBase.ps1"
      via: "Invoke-LinuxRoleCreateVM and Invoke-LinuxRolePostInstall"
      pattern: "Invoke-LinuxRole"
    - from: "LabBuilder/Roles/LinuxRoleBase.ps1"
      to: "Lab-Config.ps1"
      via: "LabConfig.Timeouts for SSH retry settings"
      pattern: "SSHRetryCount|SSHRetryDelay"
---

<objective>
SSH retry with configurable count/timeout and CentOS role support — add resilient SSH-based role application and a new CentOS/RHEL VM role using cloud-init NoCloud.

Purpose: SSH connections to freshly provisioned Linux VMs are unreliable during early boot. Role application needs retry logic. CentOS/RHEL support broadens the Linux ecosystem beyond Ubuntu-only.

Output: Updated LinuxRoleBase.ps1 with retry, new CentOS.ps1 role, updated Lab-Config.ps1, and comprehensive Pester tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@LabBuilder/Roles/LinuxRoleBase.ps1
@LabBuilder/Roles/Ubuntu.ps1
@LabBuilder/Roles/Database.Ubuntu.ps1
@Lab-Config.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configurable SSH retry to Invoke-LinuxRolePostInstall and Invoke-LinuxRoleCreateVM</name>
  <files>
    LabBuilder/Roles/LinuxRoleBase.ps1
    Lab-Config.ps1
    Tests/LinuxSSHRetry.Tests.ps1
  </files>
  <action>
    1. In `Lab-Config.ps1`, add SSH retry settings to the `Builder.Timeouts` section (around line 347):
    ```powershell
    SSHRetryCount = 3
    SSHRetryDelaySeconds = 10
    ```

    2. In `LinuxRoleBase.ps1`, modify `Invoke-LinuxRolePostInstall` to add retry logic around the SSH execution block (the try/catch at lines 159-168). Add parameters:
    ```powershell
    [int]$RetryCount = 3,
    [int]$RetryDelaySeconds = 10
    ```
    Read defaults from LabConfig if not explicitly provided:
    ```powershell
    if (-not $PSBoundParameters.ContainsKey('RetryCount') -and $LabConfig.ContainsKey('Timeouts') -and $LabConfig.Timeouts.ContainsKey('SSHRetryCount')) {
        $RetryCount = $LabConfig.Timeouts.SSHRetryCount
    }
    if (-not $PSBoundParameters.ContainsKey('RetryDelaySeconds') -and $LabConfig.ContainsKey('Timeouts') -and $LabConfig.Timeouts.ContainsKey('SSHRetryDelaySeconds')) {
        $RetryDelaySeconds = $LabConfig.Timeouts.SSHRetryDelaySeconds
    }
    ```
    Wrap the SCP+SSH execution in a retry loop:
    ```powershell
    $attempt = 0
    $succeeded = $false
    while ($attempt -lt $RetryCount -and -not $succeeded) {
        $attempt++
        try {
            # existing SCP + SSH execution
            $succeeded = $true
            Write-Host "    [OK] $SuccessMessage on $vmName" -ForegroundColor Green
        }
        catch {
            if ($attempt -lt $RetryCount) {
                Write-Warning "SSH attempt $attempt/$RetryCount failed on ${vmName}: $($_.Exception.Message). Retrying in ${RetryDelaySeconds}s..."
                Start-Sleep -Seconds $RetryDelaySeconds
            }
            else {
                Write-Warning "Post-install SSH execution failed on ${vmName} after $RetryCount attempts: $($_.Exception.Message)"
            }
        }
    }
    ```
    Remove the old single-attempt try/catch and replace with this loop.

    3. In `Invoke-LinuxRoleCreateVM`, the SSH wait loop already has retry-like behavior (polling). No changes needed there — it already retries SSH connectivity checks until a deadline.

    4. Create `Tests/LinuxSSHRetry.Tests.ps1` with Pester 5 tests:
    - Test that Invoke-LinuxRolePostInstall retries on SSH failure up to RetryCount
    - Test that Invoke-LinuxRolePostInstall succeeds on second attempt when first fails
    - Test that RetryCount defaults from LabConfig.Timeouts.SSHRetryCount when not explicitly set
    - Test that RetryDelaySeconds defaults from LabConfig.Timeouts.SSHRetryDelaySeconds
    - Test that final failure after all retries exhausted produces warning with attempt count
    - Mock: ssh.exe, scp.exe, Test-Path, Get-VMNetworkAdapter, Start-Sleep (verify delay called)
    - Dot-source LinuxRoleBase.ps1 in BeforeAll
    - Set StrictMode Latest
    - Use `$script:` scope for BeforeAll variables
    - IMPORTANT: The function references `$GlobalLabConfig.SSH.KnownHostsPath` — mock or set this variable in test setup
  </action>
  <verify>
    Run: `pwsh -Command "Invoke-Pester ./Tests/LinuxSSHRetry.Tests.ps1 -Output Detailed"` — all tests pass.
    Verify LinuxRoleBase.ps1 contains RetryCount parameter and retry loop.
    Verify Lab-Config.ps1 contains SSHRetryCount and SSHRetryDelaySeconds.
  </verify>
  <done>
    Invoke-LinuxRolePostInstall retries SSH failures up to configurable count with delay between attempts. Defaults read from LabConfig.Timeouts. Tests prove retry behavior, config defaults, and exhaustion reporting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CentOS role with cloud-init NoCloud provisioning and config entries</name>
  <files>
    LabBuilder/Roles/CentOS.ps1
    LabBuilder/Roles/LinuxRoleBase.ps1
    Lab-Config.ps1
    Tests/CentOSRole.Tests.ps1
  </files>
  <action>
    1. Create `LabBuilder/Roles/CentOS.ps1` following the exact pattern of `Ubuntu.ps1`:
    ```powershell
    function Get-LabRole_CentOS {
        [CmdletBinding()]
        param(
            [Parameter(Mandatory)]
            [hashtable]$Config
        )

        # Null-guard: LinuxVM config required
        if (-not $Config.ContainsKey('LinuxVM') -or -not $Config.LinuxVM) {
            Write-Warning "Linux VM configuration not found. Skipping role definition for CentOS."
            return @{ Tag = 'CentOS'; VMName = ''; SkipInstallLab = $true; IsLinux = $true; Roles = @(); OS = ''; IP = ''; Gateway = ''; DnsServer1 = ''; PostInstall = $null; CreateVM = $null }
        }

        $labCommonPath = Join-Path (Split-Path $PSScriptRoot -Parent) 'Lab-Common.ps1'
        if (Test-Path $labCommonPath) { . $labCommonPath }

        $linuxRoleBasePath = Join-Path $PSScriptRoot 'LinuxRoleBase.ps1'
        if (Test-Path $linuxRoleBasePath) { . $linuxRoleBasePath }

        return @{
            Tag            = 'CentOS'
            VMName         = $Config.VMNames.CentOS
            IsLinux        = $true
            SkipInstallLab = $true
            OS             = 'CentOS Stream 9'
            Memory         = $Config.LinuxVM.Memory
            MinMemory      = $Config.LinuxVM.MinMemory
            MaxMemory      = $Config.LinuxVM.MaxMemory
            Processors     = $Config.LinuxVM.Processors
            IP             = $Config.IPPlan.CentOS
            Gateway        = $Config.Network.Gateway
            DnsServer1     = $Config.IPPlan.DC
            Network        = $Config.Network.SwitchName
            DomainName     = $Config.DomainName
            Roles          = @()

            CreateVM = {
                param([hashtable]$LabConfig)
                Invoke-LinuxRoleCreateVM -LabConfig $LabConfig -VMNameKey 'CentOS' -ISOPattern 'CentOS-Stream-9*.iso'
            }

            PostInstall = {
                param([hashtable]$LabConfig)
                $script = @"
#!/bin/bash
set -e
SUDO=""
if [ "`$(id -u)" -ne 0 ]; then SUDO="sudo -n"; fi

echo "[POST] Updating packages..."
`$SUDO dnf update -y -q || true
`$SUDO dnf install -y -q openssh-server cifs-utils net-tools curl wget git jq gcc make || true

echo "[POST] Configuring SSH..."
`$SUDO systemctl enable --now sshd || true

echo "[POST] Installing dev tools..."
`$SUDO dnf install -y -q python3 python3-pip nodejs npm 2>/dev/null || true

echo "[POST] Post-install complete."
"@
                Invoke-LinuxRolePostInstall -LabConfig $LabConfig -VMNameKey 'CentOS' -BashScript $script
            }
        }
    }
    ```

    2. In `LinuxRoleBase.ps1`, update `Invoke-LinuxRoleCreateVM` to support CentOS cloud-init. The existing function uses `New-CidataVhdx` which creates an autoinstall cloud-init disk. For CentOS, cloud-init uses the NoCloud datasource with `user-data` and `meta-data` files (same VHDX approach). The `New-CidataVhdx` function should already handle both — verify it creates `/user-data` and `/meta-data` files. If `New-CidataVhdx` is tightly coupled to Ubuntu autoinstall format, add an optional `-CloudInitType` parameter ('autoinstall' or 'nocloud') and handle both. Check `Lab-Common.ps1` for the `New-CidataVhdx` implementation before deciding.

    IMPORTANT: Read `LabBuilder/Lab-Common.ps1` to check `New-CidataVhdx` before modifying. If it already supports generic cloud-init user-data format (not Ubuntu-specific autoinstall), no changes needed. If it's Ubuntu-autoinstall-specific, add a `-CloudInitType` parameter that defaults to 'autoinstall' for backward compat and supports 'nocloud' for CentOS.

    3. In `Lab-Config.ps1`, add CentOS entries:
    - `Builder.VMNames`: Add `CentOS = 'LINCENT1'`
    - `Builder.IPPlan`: Add `CentOS = '10.0.10.115'`
    - `Builder.RoleMenu`: Add `@{ Tag = 'CentOS'; Label = 'CentOS Stream (LINCENT1)'; Locked = $false }` after the Ubuntu entry
    - `Builder.SupportedDistros`: Already has Rocky9 entry — verify CentOS Stream 9 pattern works. Add if missing:
    ```powershell
    CentOS9 = @{
        DisplayName = 'CentOS Stream 9'
        ISOPattern  = 'CentOS-Stream-9*.iso'
        CloudInit   = 'nocloud'
    }
    ```

    4. Create `Tests/CentOSRole.Tests.ps1` with Pester 5 tests:
    - Test that Get-LabRole_CentOS returns role with correct Tag='CentOS', IsLinux=$true, SkipInstallLab=$true
    - Test that Get-LabRole_CentOS returns correct VMName from Config.VMNames.CentOS
    - Test that Get-LabRole_CentOS CreateVM scriptblock calls Invoke-LinuxRoleCreateVM with -ISOPattern 'CentOS-Stream-9*.iso'
    - Test that Get-LabRole_CentOS PostInstall scriptblock uses dnf (not apt-get)
    - Test null-guard: missing LinuxVM config returns empty role with Warning
    - Test that CentOS role has same structure as Ubuntu role (same property names)
    - Dot-source CentOS.ps1 (and LinuxRoleBase.ps1 if needed) in BeforeAll
    - Set StrictMode Latest
    - Mock Hyper-V cmdlets and SSH tooling
  </action>
  <verify>
    Run: `pwsh -Command "Invoke-Pester ./Tests/CentOSRole.Tests.ps1 -Output Detailed"` — all tests pass.
    Verify CentOS.ps1 exists with Get-LabRole_CentOS function.
    Verify Lab-Config.ps1 contains CentOS entries in VMNames, IPPlan, RoleMenu.
    `Select-String 'CentOS' Lab-Config.ps1` shows config entries.
  </verify>
  <done>
    CentOS role defined with cloud-init NoCloud provisioning, dnf-based post-install. Lab-Config.ps1 includes CentOS VM name, IP, menu entry, and supported distro. Role follows exact same structure as Ubuntu role. Tests prove role definition correctness and null-guard behavior.
  </done>
</task>

</tasks>

<verification>
1. `pwsh -Command "Invoke-Pester ./Tests/LinuxSSHRetry.Tests.ps1, ./Tests/CentOSRole.Tests.ps1 -Output Detailed"` — all tests pass
2. `Select-String 'RetryCount' LabBuilder/Roles/LinuxRoleBase.ps1` — confirms retry parameter
3. `Select-String 'Get-LabRole_CentOS' LabBuilder/Roles/CentOS.ps1` — confirms role function
4. `Select-String 'CentOS' Lab-Config.ps1` — confirms config entries
5. Existing Ubuntu role tests still pass (no regression)
</verification>

<success_criteria>
- SSH post-install retries configurable via LabConfig.Timeouts.SSHRetryCount (default 3)
- Retry includes delay between attempts (SSHRetryDelaySeconds, default 10)
- CentOS role defined with same structure as Ubuntu role
- CentOS uses dnf package manager (not apt-get)
- CentOS ISO pattern matches CentOS-Stream-9*.iso
- Lab-Config.ps1 has CentOS in VMNames, IPPlan, RoleMenu, SupportedDistros
- All new Pester tests pass
- No regression in existing Ubuntu roles
</success_criteria>

<output>
After completion, create `.planning/phases/24-linux-vm-parity/24-02-SUMMARY.md`
</output>
