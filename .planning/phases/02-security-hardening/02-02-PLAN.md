---
phase: 02-security-hardening
plan: 02
type: execute
wave: 2
depends_on: []
files_modified:
  - Lab-Config.ps1
  - Private/Linux/Invoke-LinuxSSH.ps1
  - Private/Linux/Copy-LinuxFile.ps1
  - Scripts/Test-OpenCodeLabHealth.ps1
  - Scripts/Install-Ansible.ps1
  - LabBuilder/Roles/LinuxRoleBase.ps1
  - Private/Clear-LabSSHKnownHosts.ps1
  - Tests/SSHKnownHosts.Tests.ps1
autonomous: true
requirements:
  - SEC-02

must_haves:
  truths:
    - "No file in the codebase contains 'UserKnownHostsFile=NUL' — all SSH/SCP operations use a lab-specific known_hosts path"
    - "$GlobalLabConfig.SSH.KnownHostsPath defines the lab-specific known_hosts file location"
    - "Clear-LabSSHKnownHosts helper exists and removes the lab known_hosts file for clean redeploy"
    - "All SSH operations use StrictHostKeyChecking=accept-new (already true, verify preserved)"
  artifacts:
    - path: "Private/Clear-LabSSHKnownHosts.ps1"
      provides: "Helper to clear lab-specific known_hosts for teardown/redeploy"
      contains: "function Clear-LabSSHKnownHosts"
    - path: "Tests/SSHKnownHosts.Tests.ps1"
      provides: "Tests for SSH known_hosts configuration"
      contains: "Describe.*SSH"
  key_links:
    - from: "Lab-Config.ps1"
      to: "Private/Linux/Invoke-LinuxSSH.ps1"
      via: "$GlobalLabConfig.SSH.KnownHostsPath"
      pattern: "KnownHostsPath"
---

<objective>
Replace all UserKnownHostsFile=NUL with a lab-specific known_hosts file path, making accept-new actually functional.

Purpose: When UserKnownHostsFile=NUL, SSH discards host keys after every session, making StrictHostKeyChecking=accept-new meaningless (every connection looks "new"). Using a persistent lab-specific known_hosts file means SSH will detect key changes on reconnection — a real security improvement for the lab environment.

Output: All SSH/SCP operations use $GlobalLabConfig.SSH.KnownHostsPath. Clear-LabSSHKnownHosts helper created for teardown. Tests verify configuration.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-hardening/02-RESEARCH.md
@.planning/phases/02-security-hardening/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSH config to GlobalLabConfig and create Clear-LabSSHKnownHosts helper</name>
  <files>Lab-Config.ps1, Private/Clear-LabSSHKnownHosts.ps1</files>
  <action>
1. Add SSH configuration block to `$GlobalLabConfig` in Lab-Config.ps1, after the `AutoHeal` block:
   ```powershell
   SSH = @{
       # Changing KnownHostsPath moves where lab SSH host keys are stored.
       # This file is cleared on teardown so redeploy gets fresh keys.
       KnownHostsPath = Join-Path (Join-Path $GlobalLabConfig.Paths.LabSourcesRoot 'SSHKeys') 'lab_known_hosts'
   }
   ```
   Note: Since `$GlobalLabConfig` is being built, use the variable reference. If `Paths.LabSourcesRoot` isn't available at that point in the hashtable construction, use the literal path 'C:\LabSources\SSHKeys\lab_known_hosts' or compute it after the hashtable is built. Check the structure.

   Actually, since the hashtable is built in one block, self-reference won't work. Add the SSH block as a post-construction assignment:
   ```powershell
   $GlobalLabConfig.SSH = @{
       KnownHostsPath = Join-Path (Join-Path $GlobalLabConfig.Paths.LabSourcesRoot 'SSHKeys') 'lab_known_hosts'
   }
   ```

2. Create `Private/Clear-LabSSHKnownHosts.ps1`:
   ```powershell
   function Clear-LabSSHKnownHosts {
       <#
       .SYNOPSIS
           Removes the lab-specific SSH known_hosts file.
       .DESCRIPTION
           Called during teardown to clear stale host keys so redeploy
           can accept fresh keys without host key mismatch errors.
       #>
       [CmdletBinding()]
       param()

       $knownHostsPath = $GlobalLabConfig.SSH.KnownHostsPath
       if ([string]::IsNullOrWhiteSpace($knownHostsPath)) {
           Write-Warning '[Clear-LabSSHKnownHosts] SSH.KnownHostsPath not configured.'
           return
       }

       if (Test-Path $knownHostsPath) {
           Remove-Item -Path $knownHostsPath -Force
           Write-Host "  [OK] Cleared lab SSH known_hosts: $knownHostsPath" -ForegroundColor Green
       } else {
           Write-Verbose "Lab SSH known_hosts not found (already clean): $knownHostsPath"
       }
   }
   ```
  </action>
  <verify>
- `grep 'SSH' Lab-Config.ps1` shows SSH config block with KnownHostsPath
- `Test-Path Private/Clear-LabSSHKnownHosts.ps1` is true
- `grep 'lab_known_hosts' Lab-Config.ps1` confirms the filename
  </verify>
  <done>SSH configuration added to GlobalLabConfig with lab-specific known_hosts path. Clear-LabSSHKnownHosts helper created for teardown use.</done>
</task>

<task type="auto">
  <name>Task 2: Replace all UserKnownHostsFile=NUL with lab-specific known_hosts path</name>
  <files>Private/Linux/Invoke-LinuxSSH.ps1, Private/Linux/Copy-LinuxFile.ps1, Scripts/Test-OpenCodeLabHealth.ps1, Scripts/Install-Ansible.ps1, LabBuilder/Roles/LinuxRoleBase.ps1, Tests/SSHKnownHosts.Tests.ps1</files>
  <action>
1. **Private/Linux/Invoke-LinuxSSH.ps1** (line 24):
   Change `'-o', 'UserKnownHostsFile=NUL'` to:
   ```powershell
   '-o', "UserKnownHostsFile=$($GlobalLabConfig.SSH.KnownHostsPath)"
   ```
   Ensure the SSHKeys directory exists by adding before the ssh call:
   ```powershell
   $knownHostsDir = Split-Path -Parent $GlobalLabConfig.SSH.KnownHostsPath
   if (-not (Test-Path $knownHostsDir)) {
       New-Item -ItemType Directory -Path $knownHostsDir -Force | Out-Null
   }
   ```

2. **Private/Linux/Copy-LinuxFile.ps1** (line 21):
   Same replacement — change `UserKnownHostsFile=NUL` to use `$GlobalLabConfig.SSH.KnownHostsPath`.
   Add the same directory creation guard.

3. **Scripts/Test-OpenCodeLabHealth.ps1** (line 220):
   Replace `UserKnownHostsFile=NUL` with lab-specific path.

4. **Scripts/Install-Ansible.ps1** (lines 36, 74, 101, 111):
   Replace all 4 instances of `UserKnownHostsFile=NUL` with lab-specific path.
   These are inline ssh/scp calls, so use `$GlobalLabConfig.SSH.KnownHostsPath`.

5. **LabBuilder/Roles/LinuxRoleBase.ps1** (lines 119, 131):
   Replace both `UserKnownHostsFile=NUL` instances with lab-specific path.

6. **Create Tests/SSHKnownHosts.Tests.ps1**:
   - Test: No .ps1 file in the repo contains 'UserKnownHostsFile=NUL' (grep-based verification test)
   - Test: Clear-LabSSHKnownHosts removes the file when it exists
   - Test: Clear-LabSSHKnownHosts is a no-op when file doesn't exist (no error)
   - Test: $GlobalLabConfig.SSH.KnownHostsPath is set and points to SSHKeys directory
  </action>
  <verify>
- `grep -r 'UserKnownHostsFile=NUL' --include='*.ps1'` returns zero results
- `grep -r 'UserKnownHostsFile=' --include='*.ps1'` shows only lab_known_hosts references
- All SSH operations still use StrictHostKeyChecking=accept-new
- `Test-Path Tests/SSHKnownHosts.Tests.ps1` is true
  </verify>
  <done>All UserKnownHostsFile=NUL instances replaced with lab-specific known_hosts path. Tests verify no NUL references remain and Clear-LabSSHKnownHosts works correctly.</done>
</task>

</tasks>

<verification>
- `grep -r 'UserKnownHostsFile=NUL' --include='*.ps1'` returns zero hits
- `grep -r 'StrictHostKeyChecking=accept-new' --include='*.ps1'` still shows all SSH locations (preserved)
- `grep -r 'lab_known_hosts' --include='*.ps1'` shows config and all SSH call sites
- Clear-LabSSHKnownHosts function exists and tests pass
</verification>

<success_criteria>
1. No file contains UserKnownHostsFile=NUL
2. All SSH/SCP operations use $GlobalLabConfig.SSH.KnownHostsPath
3. Clear-LabSSHKnownHosts helper exists for teardown
4. StrictHostKeyChecking=accept-new preserved everywhere
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-hardening/02-02-SUMMARY.md`
</output>
