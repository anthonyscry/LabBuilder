---
phase: 23-complex-networking
plan: 02
type: tdd
wave: 2
depends_on:
  - 23-01
files_modified:
  - Lab-Config.ps1
  - Private/Get-LabNetworkConfig.ps1
  - Public/Initialize-LabNetwork.ps1
  - Private/New-LabVMNetworkAdapter.ps1
  - Tests/ComplexNetworking-VMAssignment.Tests.ps1
autonomous: true
requirements:
  - NET-02
  - NET-03
  - NET-04

must_haves:
  truths:
    - "VMs reference switches by name in their config"
    - "VM network adapters can be assigned to specific named switches"
    - "VLAN IDs are assignable per VM adapter in configuration"
    - "Inter-subnet routing is configurable via gateway VM or host routing table"
    - "Initialize-LabNetwork configures VMs across multiple subnets"
  artifacts:
    - path: "Lab-Config.ps1"
      provides: "Per-VM switch assignment and VLAN ID in IPPlan entries"
      contains: "Switch"
    - path: "Private/Get-LabNetworkConfig.ps1"
      provides: "Returns per-VM switch and VLAN assignments"
      contains: "VlanId"
    - path: "Private/New-LabVMNetworkAdapter.ps1"
      provides: "Creates VM adapter connected to named switch with optional VLAN"
      contains: "VlanId"
    - path: "Public/Initialize-LabNetwork.ps1"
      provides: "Multi-subnet VM IP configuration and routing setup"
      contains: "Switches"
    - path: "Tests/ComplexNetworking-VMAssignment.Tests.ps1"
      provides: "Tests for VM-to-switch assignment, VLAN tagging, and routing"
      min_lines: 80
  key_links:
    - from: "Lab-Config.ps1"
      to: "Private/Get-LabNetworkConfig.ps1"
      via: "Per-VM switch and VLAN config consumed by Get-LabNetworkConfig"
      pattern: "Switch|VlanId"
    - from: "Private/New-LabVMNetworkAdapter.ps1"
      to: "Public/Initialize-LabNetwork.ps1"
      via: "Adapter creation called during network initialization"
      pattern: "New-LabVMNetworkAdapter"
    - from: "Private/Get-LabNetworkConfig.ps1"
      to: "Public/Initialize-LabNetwork.ps1"
      via: "Per-VM network config drives multi-subnet initialization"
      pattern: "Get-LabNetworkConfig"
---

<objective>
Add VM-to-switch assignment, VLAN tagging, and inter-subnet routing support so VMs can be placed on specific named switches with optional VLAN IDs and communicate across subnets.

Purpose: NET-02 requires VMs to reference switches by name. NET-04 requires VLAN IDs assignable per VM adapter. NET-03 requires inter-subnet routing (gateway VM or host routing). This plan extends the config, creates a VM adapter helper, and updates Initialize-LabNetwork for multi-subnet awareness.

Output: Per-VM switch and VLAN config in Lab-Config.ps1, New-LabVMNetworkAdapter helper, updated Initialize-LabNetwork, and comprehensive tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-complex-networking/23-01-SUMMARY.md
@Lab-Config.ps1
@Private/Get-LabNetworkConfig.ps1
@Public/Initialize-LabNetwork.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config for per-VM switch assignment, VLAN IDs, and routing</name>
  <files>Lab-Config.ps1, Private/Get-LabNetworkConfig.ps1, Tests/ComplexNetworking-VMAssignment.Tests.ps1</files>
  <action>
**Lab-Config.ps1:**
Extend the `$GlobalLabConfig.IPPlan` entries from flat IP strings to hashtables that include switch name and optional VLAN ID. Keep backward compatibility: if an entry is a plain string, it is treated as an IP on the default/first switch with no VLAN.

New format for IPPlan entries:
```powershell
IPPlan = @{
    DC1  = @{ IP = '10.0.10.10'; Switch = 'LabCorpNet' }
    SVR1 = @{ IP = '10.0.10.20'; Switch = 'LabCorpNet'; VlanId = 100 }
    WS1  = @{ IP = '10.0.20.30'; Switch = 'LabDMZ'; VlanId = 200 }
    DSC1 = '10.0.10.40'  # backward compat: plain string = default switch, no VLAN
    LIN1 = @{ IP = '10.0.10.110'; Switch = 'LabCorpNet' }
}
```

Add a `Routing` section inside `$GlobalLabConfig.Network`:
```powershell
Routing = @{
    # Mode: 'host' (add routes on Hyper-V host) or 'gateway' (use a gateway VM)
    Mode = 'host'
    # GatewayVM: VM name acting as router (only used when Mode = 'gateway')
    GatewayVM = ''
    # EnableForwarding: enable IP forwarding on gateway VM (only when Mode = 'gateway')
    EnableForwarding = $true
}
```

**Private/Get-LabNetworkConfig.ps1:**
Update the returned object to include:
- `VMAssignments`: A hashtable mapping VM name to `[PSCustomObject]@{ IP; Switch; VlanId; PrefixLength }`. Parse both the new hashtable format and plain string format (backward compat). For plain strings, use the first/default switch name and `$null` for VlanId.
- `Routing`: The routing config from `$GlobalLabConfig.Network.Routing` or a default `@{ Mode = 'host'; GatewayVM = ''; EnableForwarding = $true }`.

Preserve the existing `VMIPs` property (flat hashtable of name-to-IP) for backward compatibility by extracting just the IP from each VMAssignment entry.

**Tests (RED phase):**
Write tests in Tests/ComplexNetworking-VMAssignment.Tests.ps1:
- Test that VMAssignments returns correct Switch and VlanId for hashtable entries
- Test backward compat: plain string IPPlan entry maps to default switch with null VlanId
- Test Routing config returned with defaults when not specified
- Test that VMIPs property still works (flat name-to-IP mapping)
  </action>
  <verify>Run: `pwsh -Command "Invoke-Pester Tests/ComplexNetworking-VMAssignment.Tests.ps1 -Output Detailed"` -- expect RED first, then GREEN after implementation.</verify>
  <done>Per-VM switch assignment and VLAN config works in Lab-Config.ps1. Get-LabNetworkConfig returns VMAssignments with switch/VLAN data and Routing config. Backward compatibility preserved for plain string IPPlan entries. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create New-LabVMNetworkAdapter and update Initialize-LabNetwork for multi-subnet</name>
  <files>Private/New-LabVMNetworkAdapter.ps1, Public/Initialize-LabNetwork.ps1, Tests/ComplexNetworking-VMAssignment.Tests.ps1</files>
  <action>
**Private/New-LabVMNetworkAdapter.ps1 (new file):**
Create a helper function that connects a VM's network adapter to a specific named switch with optional VLAN tagging. Follows existing Private/ helper patterns: `[CmdletBinding()]`, returns `[PSCustomObject]`, throw on error with function-name prefix.

NOTE on registration: Lab-Common.ps1 uses `Get-LabScriptFiles` to dynamically discover and dot-source all files under `Private/` at startup (confirmed in lab-common.ps1 lines 14-22 and OpenCodeLab-App.ps1 lines 113-121). Dropping the new file into `Private/` is sufficient â€” no manual registration in any array is required.

```powershell
function New-LabVMNetworkAdapter {
    [CmdletBinding()]
    [OutputType([PSCustomObject])]
    param(
        [Parameter(Mandatory)]
        [string]$VMName,

        [Parameter(Mandatory)]
        [string]$SwitchName,

        [Parameter()]
        [int]$VlanId,

        [Parameter()]
        [switch]$Force
    )
    # ...
}
```

Logic:
1. Check if VM exists (Get-VM).
2. Get existing adapter. If adapter already connected to correct switch and VLAN matches, return OK (idempotent).
3. If adapter exists but on wrong switch: if -Force, disconnect and reconnect; else return failure.
4. Connect adapter to named switch via `Connect-VMNetworkAdapter -VMName $VMName -SwitchName $SwitchName`.
5. If VlanId is provided and > 0, set VLAN via `Set-VMNetworkAdapterVlan -VMName $VMName -Access -VlanId $VlanId`.
6. Return result object with VMName, SwitchName, VlanId, Status, Message.

**Public/Initialize-LabNetwork.ps1:**
Extend to handle multi-subnet scenarios:
1. Call `Get-LabNetworkConfig` to get `VMAssignments` and `Switches`.
2. For each VM in `-VMNames`:
   a. Look up the VM's assignment (IP, Switch, VlanId, PrefixLength).
   b. Call `New-LabVMNetworkAdapter` to connect the VM to the correct switch (if switch name is specified and different from current).
   c. Call existing `Set-VMStaticIP` with the VM's IP and PrefixLength.
   d. If VlanId is set, the adapter helper already handled it.
3. If `Routing.Mode` is `'host'`, add static routes on the Hyper-V host between subnets using `New-NetRoute` (for each pair of switches, add a route from one subnet to the other via the respective gateway). Wrap in try/catch with idempotent check.
4. If `Routing.Mode` is `'gateway'`, enable IP forwarding on the gateway VM via PowerShell Direct (`Set-NetIPInterface -Forwarding Enabled`).
5. Preserve backward compat: if VMAssignments shows no explicit switch assignments, use existing single-subnet behavior unchanged.

**Tests (continue RED-GREEN):**
Add to Tests/ComplexNetworking-VMAssignment.Tests.ps1:
- Test New-LabVMNetworkAdapter connects VM to named switch (mock Connect-VMNetworkAdapter, Get-VM)
- Test New-LabVMNetworkAdapter sets VLAN when VlanId > 0 (mock Set-VMNetworkAdapterVlan)
- Test idempotent: already-correct adapter returns OK without changes
- Test Initialize-LabNetwork with multi-subnet: each VM gets correct switch and IP
- Test host routing mode: New-NetRoute called for cross-subnet routes
- Test gateway routing mode: IP forwarding enabled on gateway VM
- Test backward compat: single-subnet config uses existing flow
  </action>
  <verify>
1. Run: `pwsh -Command "Invoke-Pester Tests/ComplexNetworking-VMAssignment.Tests.ps1 -Output Detailed"` -- all tests pass (GREEN).
2. Confirm dynamic discovery includes the new helper: `pwsh -Command ". ./Lab-Common.ps1; Get-Command New-LabVMNetworkAdapter -ErrorAction Stop; Write-Host 'OK'"` -- outputs `OK` (function loaded via Lab-Common.ps1 auto-discovery of Private/).
  </verify>
  <done>New-LabVMNetworkAdapter creates switch-connected adapters with VLAN tagging. Initialize-LabNetwork handles multi-subnet VM configuration and inter-subnet routing. Backward compatibility preserved. All tests pass. New-LabVMNetworkAdapter is discoverable at runtime via Lab-Common.ps1 dynamic loading (no manual registration needed).</done>
</task>

</tasks>

<verification>
1. `pwsh -Command "Invoke-Pester Tests/ComplexNetworking-VMAssignment.Tests.ps1 -Output Detailed"` -- all tests pass
2. Lab-Config.ps1 parses with enhanced IPPlan: `pwsh -Command ". ./Lab-Config.ps1; $GlobalLabConfig.IPPlan.SVR1.Switch"` returns switch name
3. Get-LabNetworkConfig returns VMAssignments: `pwsh -Command ". ./Lab-Common.ps1; (Get-LabNetworkConfig).VMAssignments.Keys.Count"` returns VM count
4. Backward compat: plain string IPPlan entries still resolve to IP correctly
</verification>

<success_criteria>
- VMs reference switches by name in IPPlan config (hashtable entries with Switch key)
- VLAN IDs assignable per VM adapter (VlanId key in IPPlan entries)
- New-LabVMNetworkAdapter connects VMs to named switches with optional VLAN
- Initialize-LabNetwork handles multi-subnet VM configuration
- Inter-subnet routing configurable via host routes or gateway VM
- Backward compatibility: plain string IPPlan entries and single-subnet config still work
- All Pester tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-complex-networking/23-02-SUMMARY.md`
</output>
