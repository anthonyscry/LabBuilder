---
phase: 02-preflight-validation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - SimpleLab/Public/Test-LabPrereqs.ps1
  - SimpleLab/Private/Test-DiskSpace.ps1
  - SimpleLab/SimpleLab.psm1
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Single command runs all pre-flight checks"
    - "Tool validates ISOs exist before build attempts"
    - "Tool checks available disk space"
    - "Tool validates Hyper-V is enabled"
    - "All checks return structured pass/fail results"
    - "User sees specific failure reason for each check"
  artifacts:
    - path: "SimpleLab/Public/Test-LabPrereqs.ps1"
      provides: "Orchestrates all pre-flight checks"
      min_lines: 60
      contains: "function Test-LabPrereqs"
    - path: "SimpleLab/Private/Test-DiskSpace.ps1"
      provides: "Disk space validation"
      min_lines: 30
      contains: "function Test-DiskSpace"
  key_links:
    - from: "SimpleLab/Public/Test-LabPrereqs.ps1"
      to: "SimpleLab/Private/Test-LabIso.ps1"
      via: "Function call"
      pattern: "Test-LabIso"
    - from: "SimpleLab/Public/Test-LabPrereqs.ps1"
      to: "SimpleLab/Private/Test-DiskSpace.ps1"
      via: "Function call"
      pattern: "Test-DiskSpace"
    - from: "SimpleLab/Public/Test-LabPrereqs.ps1"
      to: "SimpleLab/Public/Test-HyperVEnabled.ps1"
      via: "Function call"
      pattern: "Test-HyperVEnabled"
    - from: "SimpleLab/Public/Test-LabPrereqs.ps1"
      to: "SimpleLab/Private/Get-LabConfig.ps1"
      via: "Function call"
      pattern: "Get-LabConfig"
---

<objective>
Create pre-flight check orchestration that validates all prerequisites before lab operations.

Purpose: Prevent build failures by validating ISOs, disk space, and Hyper-V status before attempting any lab operations. Returns structured results that clearly indicate which checks passed/failed and why.

Output: Test-LabPrereqs orchestrator function with disk space validation helper.
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-preflight-validation/02-RESEARCH.md
@.planning/phases/01-project-foundation/01-02-SUMMARY.md
@.planning/phases/02-preflight-validation/02-01-PLAN.md
@SimpleLab/Public/Test-HyperVEnabled.ps1
@SimpleLab/Private/Test-LabIso.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test-DiskSpace function for disk validation</name>
  <files>SimpleLab/Private/Test-DiskSpace.ps1</files>
  <action>
Create SimpleLab/Private/Test-DiskSpace.ps1 with the following implementation:

1. Function name: Test-DiskSpace
2. Parameters:
   - Path (string, optional, default: "C:\"): Drive path to check
   - MinSpaceGB (int, optional, default: 100): Minimum required disk space in GB
3. Return: PSCustomObject with properties:
   - Path: Drive path checked
   - FreeSpaceGB: Available disk space in GB (calculated)
   - RequiredSpaceGB: Minimum space required
   - Status: "Pass" if FreeSpaceGB >= RequiredSpaceGB, else "Fail"
   - Message: Descriptive message ("X GB free, Y GB required")
4. Implementation:
   - Use Get-PSDrive with -Name (extract drive letter from Path)
   - Calculate Free space: $drive.Free / 1GB (convert bytes to GB)
   - Calculate Required: MinSpaceGB parameter
   - Compare: if ($freeSpace -ge $minSpace) then "Pass" else "Fail"
   - Format message: "$([math]::Round($freeSpace, 2)) GB free, $minSpace GB required"
   - Handle case where drive doesn't exist (Status: "Fail", Message: "Drive not found")
   - Include error handling for Get-PSDrive failures
5. Do NOT:
   - Do not write to console (return objects only)
   - Do not check multiple drives (single drive per call)
   - Do not create any files (read-only operation)

Follow the code style pattern from Test-HyperVEnabled.ps1 (try/catch, PSCustomObject return).
  </action>
  <verify>
Import SimpleLab module and run:
```powershell
Test-DiskSpace -Path "C:\" -MinSpaceGB 100
```
Verify output PSCustomObject has Path, FreeSpaceGB, RequiredSpaceGB, Status, Message properties with accurate values.
  </verify>
  <done>
Function returns PSCustomObject with accurate disk space check, Status is "Pass" when free space >= required.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Test-LabPrereqs orchestrator function</name>
  <files>SimpleLab/Public/Test-LabPrereqs.ps1</files>
  <action>
Create SimpleLab/Public/Test-LabPrereqs.ps1 with the following implementation:

1. Function name: Test-LabPrereqs
2. Parameters: None (uses config file for requirements)
3. Return: PSCustomObject with properties:
   - Timestamp: DateTime of check (ISO 8601 format)
   - OverallStatus: "Pass" if all checks pass, else "Fail"
   - Checks: Array of individual check result objects
   - FailedChecks: Array of check names that failed (for easy error reporting)
   - Duration: Total check duration in seconds
4. Implementation:
   - Initialize empty $checks array
   - Initialize $startTime = Get-Date
   - Start try/catch block

   **Check 1: Hyper-V**
   - Call Test-HyperVEnabled (from Phase 1)
   - Create result object: @{ Name = "HyperV"; Status = if ($result) "Pass" else "Fail"; Message = if ($result) "Hyper-V is enabled" else "Hyper-V is not enabled" }
   - Append to $checks array

   **Check 2: Configuration**
   - Call Get-LabConfig to load config
   - If config is $null: Create result with Status "Fail", Message "Configuration file not found. Run Initialize-LabConfig"
   - If config exists: Create result with Status "Pass", Message "Configuration loaded"
   - Append to $checks array
   - Store config for subsequent checks

   **Check 3: Disk Space**
   - If config loaded, call Test-DiskSpace -MinSpaceGB $config.Requirements.MinDiskSpaceGB
   - Create result object with Name = "DiskSpace", Status from Test-DiskSpace, Message from Test-DiskSpace
   - Append to $checks array

   **Check 4: ISOs**
   - For each ISO in config.IsoPaths:
     - Call Test-LabIso -IsoName $key -IsoPath $value
     - Create result object with Name = "ISO_$key", Status from Test-LabIso, Message with path
     - If Status is "Fail", also call Find-LabIso to search alternate paths
     - Append to $checks array

   **Final assembly:**
   - Calculate OverallStatus: if ($checks.Status -contains "Fail") then "Fail" else "Pass"
   - Extract FailedChecks: $checks | Where-Object { $_.Status -eq "Fail" } | Select-Object -ExpandProperty Name
   - Calculate Duration: (Get-Date - $startTime).TotalSeconds
   - Return PSCustomObject with all properties
   - Include error handling wrapper: if any check throws, catch and add error as failed check

5. Do NOT:
   - Do not write to console (return objects only, reporting is Plan 03's job)
   - Do not attempt to fix issues (validation only)
   - Do not skip checks (run all checks even if one fails)

Follow the code style pattern from Test-HyperVEnabled.ps1 and Write-RunArtifact.ps1.
  </action>
  <verify>
Import SimpleLab module and run:
```powershell
$results = Test-LabPrereqs
$results.OverallStatus
$results.Checks
$results.FailedChecks
```
Verify output has OverallStatus, Checks array (with 4+ checks), FailedChecks array, and Duration.
  </verify>
  <done>
Function executes all pre-flight checks, returns PSCustomObject with OverallStatus "Pass" only when all checks succeed, FailedChecks lists specific failures.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SimpleLab.psm1 to export Test-LabPrereqs</name>
  <files>SimpleLab/SimpleLab.psm1</files>
  <action>
Update SimpleLab/SimpleLab.psm1 to add Test-LabPrereqs to Export-ModuleMember:

1. Add 'Test-LabPrereqs' to the Export-ModuleMember -Function array
2. Maintain existing function exports (Test-HyperVEnabled, Write-RunArtifact, Test-LabIso)
3. Keep alphabetical or logical ordering

Follow the existing export pattern in the file.
  </action>
  <verify>
Import module and run:
```powershell
Get-Command -Module SimpleLab
```
Verify Test-LabPrereqs appears in output.
  </verify>
  <done>
Test-LabPrereqs is exported and available as module function.
  </done>
</task>

</tasks>

<verification>
1. Test-DiskSpace validates disk space accurately
2. Test-LabPrereqs runs all 4 checks: Hyper-V, Config, DiskSpace, ISOs
3. OverallStatus is "Pass" only when all checks pass
4. FailedChecks array lists specific check names that failed
5. Check results include Name, Status, and Message for each check
6. Duration is calculated and included in results
7. Function handles config not found gracefully
8. All checks run even if one fails (no early exit)
</verification>

<success_criteria>
1. Test-LabPrereqs executes all prerequisite checks
2. Each check returns structured result with Name, Status, Message
3. OverallStatus accurately reflects whether all checks passed
4. FailedChecks provides easy access to specific failures for error reporting
5. Disk space validation prevents builds with insufficient storage
</success_criteria>

<output>
After completion, create `.planning/phases/02-preflight-validation/02-02-SUMMARY.md`
</output>
