---
phase: 02-preflight-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - SimpleLab/SimpleLab.psm1
  - SimpleLab/Private/Test-LabIso.ps1
  - SimpleLab/Private/Find-LabIso.ps1
  - SimpleLab/Private/Get-LabConfig.ps1
  - SimpleLab/Private/Initialize-LabConfig.ps1
  - .planning/config.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tool can detect if a specific ISO file exists at a given path"
    - "Tool searches multiple directories for missing ISOs"
    - "Tool validates ISO file has .iso extension"
    - "Configuration file stores ISO paths for persistence"
    - "Default config is auto-created on first run"
    - "User can specify custom ISO locations"
  artifacts:
    - path: "SimpleLab/Private/Test-LabIso.ps1"
      provides: "Single ISO file validation"
      min_lines: 25
      contains: "function Test-LabIso"
    - path: "SimpleLab/Private/Find-LabIso.ps1"
      provides: "Multi-path ISO search"
      min_lines: 30
      contains: "function Find-LabIso"
    - path: "SimpleLab/Private/Get-LabConfig.ps1"
      provides: "Config file loading"
      min_lines: 20
      contains: "function Get-LabConfig"
    - path: "SimpleLab/Private/Initialize-LabConfig.ps1"
      provides: "Default config creation"
      min_lines: 35
      contains: "function Initialize-LabConfig"
    - path: ".planning/config.json"
      provides: "ISO path storage"
      contains: "IsoPaths"
  key_links:
    - from: "SimpleLab/Private/Test-LabIso.ps1"
      to: "SimpleLab/Private/Find-LabIso.ps1"
      via: "Function call for path fallback"
      pattern: "Find-LabIso"
    - from: "SimpleLab/Private/Get-LabConfig.ps1"
      to: ".planning/config.json"
      via: "ConvertFrom-Json"
      pattern: "Get-Content.*config.json.*ConvertFrom-Json"
    - from: "SimpleLab/Private/Initialize-LabConfig.ps1"
      to: ".planning/config.json"
      via: "ConvertTo-Json + Out-File"
      pattern: "ConvertTo-Json.*Out-File"
---

<objective>
Implement ISO detection and validation logic with configuration management.

Purpose: Enable the tool to validate ISO file existence before attempting lab operations, preventing build failures due to missing installation media. The configuration system allows users to customize ISO locations while providing sensible defaults.

Output: ISO validation functions, configuration file management, and default config template.
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-preflight-validation/02-RESEARCH.md
@SimpleLab/SimpleLab.psm1
@.planning/phases/01-project-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test-LabIso function for single ISO validation</name>
  <files>SimpleLab/Private/Test-LabIso.ps1</files>
  <action>
Create SimpleLab/Private/Test-LabIso.ps1 with the following implementation:

1. Function name: Test-LabIso
2. Parameters:
   - IsoName (string, mandatory): Name identifier (e.g., "Server2019", "Windows11")
   - IsoPath (string, mandatory): Full path to ISO file
3. Return: PSCustomObject with properties:
   - Name: The ISO name identifier
   - Path: Full path checked
   - Exists: Boolean (true if file exists)
   - IsValidIso: Boolean (true if .iso extension)
   - Status: "Pass", "Fail", or "Warning" (exists but not .iso)
4. Implementation:
   - Use Test-Path with -PathType Leaf for existence check
   - Use regex match '\.iso$' for extension validation
   - Use [PSCustomObject]@{...} for structured output
   - Include error handling with try/catch
5. Do NOT:
   - Do not search alternate paths (that's Find-LabIso's job)
   - Do not create files (only validate existing)
   - Do not write to console (return objects only)

Follow the code style pattern from Test-HyperVEnabled.ps1 (try/catch, structured return).
  </action>
  <verify>
Import SimpleLab module and run:
```powershell
Test-LabIso -IsoName "Server2019" -IsoPath "C:\ISOs\Server2019.iso"
```
Verify output is PSCustomObject with Name, Path, Exists, IsValidIso, Status properties.
  </verify>
  <done>
Function returns PSCustomObject with accurate existence and extension validation for any given file path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Find-LabIso function for multi-path ISO search</name>
  <files>SimpleLab/Private/Find-LabIso.ps1</files>
  <action>
Create SimpleLab/Private/Find-LabIso.ps1 with the following implementation:

1. Function name: Find-LabIso
2. Parameters:
   - IsoName (string, mandatory): Name identifier for logging
   - SearchPaths (string[], mandatory): Array of directory paths to search
   - Pattern (string, optional): Glob pattern for filename matching (default: "*Server*.iso", "*Windows*.iso")
3. Return: PSCustomObject with properties:
   - Name: ISO name identifier
   - FoundPath: Full path if found, null if not found
   - SearchedPaths: Array of paths that were searched
   - Found: Boolean indicating if any match was found
4. Implementation:
   - Iterate through SearchPaths array
   - For each path, use Get-ChildItem with -Filter and -Recurse (max depth 2 for performance)
   - Match against Pattern parameter
   - Return first match found (stop searching after first hit)
   - Use Join-Path for path construction (avoid hardcoded separators)
   - Include error handling for inaccessible directories
5. Do NOT:
   - Do not validate ISO (that's Test-LabIso's job)
   - Do not search deeper than 2 directory levels (performance)
   - Do not throw errors for missing directories (skip silently)

Follow the code style pattern from Test-HyperVEnabled.ps1.
  </action>
  <verify>
Import SimpleLab module and run:
```powershell
Find-LabIso -IsoName "Server2019" -SearchPaths @("C:\ISOs", "D:\ISOs") -Pattern "*Server*.iso"
```
Verify output is PSCustomObject with FoundPath if ISO exists in search locations.
  </verify>
  <done>
Function returns PSCustomObject with FoundPath set to first matching ISO location or null if not found in any search path.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Get-LabConfig and Initialize-LabConfig functions</name>
  <files>SimpleLab/Private/Get-LabConfig.ps1, SimpleLab/Private/Initialize-LabConfig.ps1, .planning/config.json</files>
  <action>
Create two configuration management functions and default config file:

**File 1: SimpleLab/Private/Get-LabConfig.ps1**
1. Function name: Get-LabConfig
2. Parameters: ConfigPath (string, optional, default: ".planning/config.json")
3. Return: PSCustomObject with config properties or null if not found
4. Implementation:
   - Use Test-Path to check if config exists
   - Use Get-Content + ConvertFrom-Json to load
   - Return $null if file doesn't exist (don't throw)
   - Resolve relative paths against module root using $PSScriptRoot
   - Include error handling for malformed JSON

**File 2: SimpleLab/Private/Initialize-LabConfig.ps1**
1. Function name: Initialize-LabConfig
2. Parameters:
   - ConfigPath (string, optional, default: ".planning/config.json")
   - Force (switch, optional): Overwrite existing config
3. Return: PSCustomObject with created config
4. Implementation:
   - Create .planning directory if it doesn't exist (New-Item -ItemType Directory)
   - If config exists and -Force not specified, return existing config
   - Create default config object with:
     - IsoPaths: @{ Server2019 = "C:\Lab\ISOs\Server2019.iso"; Windows11 = "C:\Lab\ISOs\Windows11.iso" }
     - IsoSearchPaths: @("C:\Lab\ISOs", "D:\ISOs", ".\ISOs")
     - Requirements: @{ MinDiskSpaceGB = 100; MinMemoryGB = 16 }
   - Use ConvertTo-Json -Depth 4 for serialization
   - Use Out-File to write (not Set-Content)
   - Return the created config object

**File 3: .planning/config.json**
Create default config file with the structure above (created by Initialize-LabConfig on first run, but include template in repo).

Follow the code style pattern from Write-RunArtifact.ps1 for JSON handling.
  </action>
  <verify>
Import SimpleLab module and run:
```powershell
$config = Initialize-LabConfig -Force
$config.IsoPaths.Server2019
```
Verify config is created at .planning/config.json with IsoPaths, IsoSearchPaths, and Requirements properties.
  </verify>
  <done>
Initialize-LabConfig creates .planning/config.json with default structure, Get-LabConfig loads and returns config as PSCustomObject.
  </done>
</task>

<task type="auto">
  <name>Task 4: Update SimpleLab.psm1 to export new functions</name>
  <files>SimpleLab/SimpleLab.psm1</files>
  <action>
Update SimpleLab/SimpleLab.psm1 to add Test-LabIso to Export-ModuleMember:

1. Add 'Test-LabIso' to the Export-ModuleMember -Function array
2. Do NOT export Find-LabIso, Get-LabConfig, or Initialize-LabConfig (they are internal helpers)
3. Maintain existing function exports (Test-HyperVEnabled, Write-RunArtifact)
4. Keep the dot-sourcing pattern for Private/ functions (automatic)

Follow the existing export pattern in the file.
  </action>
  <verify>
Import module and run:
```powershell
Get-Command -Module SimpleLab
```
Verify Test-LabIso appears in output but Find-LabIso does not.
  </verify>
  <done>
Test-LabIso is exported and available as module function, helper functions remain internal.
  </done>
</task>

</tasks>

<verification>
1. Import SimpleLab module successfully
2. Test-LabIso returns PSCustomObject for any file path with accurate existence/extension validation
3. Find-LabIso searches multiple paths and returns first matching ISO
4. Get-LabConfig loads .planning/config.json and returns PSCustomObject
5. Initialize-LabConfig creates default config file with proper structure
6. Module exports Test-LabIso but not helper functions
7. All functions use try/catch error handling pattern
8. All paths use Join-Path for cross-platform compatibility
</verification>

<success_criteria>
1. Test-LabIso function validates file existence and .iso extension
2. Find-LabIso function searches multiple directories for ISOs
3. Configuration system creates default .planning/config.json on first run
4. User can specify custom ISO paths via config file
5. All validation returns structured PSCustomObject results
</success_criteria>

<output>
After completion, create `.planning/phases/02-preflight-validation/02-01-SUMMARY.md`
</output>
