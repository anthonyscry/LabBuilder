# Phase 6 Plan 03: Lab Control Functions

**Status:** Pending
**Wave:** 1
**Dependencies:** Phase 6 Plans 1-2 complete ✅

## Goal

Add lab-wide control functions for managing all VMs as a group - start all, stop all, restart all.

## Success Criteria

1. ✅ User can start all lab VMs with single command (already exists - verify)
2. ✅ User can stop all lab VMs with single command (already exists - verify)
3. ✅ User can restart all lab VMs with single command (new)
4. ✅ User can suspend all lab VMs with single command (new)
5. ✅ All lab-wide functions follow dependency order

## Current State Analysis

Functions that already exist from Phase 4:
- `Start-LabVMs` ✅ - Starts all VMs in dependency order
- `Stop-LabVMs` ✅ - Stops all VMs in reverse dependency order

Functions that need to be created:
- `Restart-LabVMs` - Restart all VMs in dependency order
- `Suspend-LabVMs` - Suspend all VMs in dependency order

## Implementation

### File: SimpleLab/Public/Restart-LabVMs.ps1

Restarts all lab VMs in dependency order.

**Parameters:**
- `Force` (switch) - Force hard restart vs graceful shutdown
- `Wait` (switch) - Wait for all VMs to be ready after restart
- `TimeoutSeconds` (int, default: 600) - Per-VM timeout
- `StabilizationSeconds` (int, default: 30) - Post-boot stabilization

**Returns:**
```powershell
[PSCustomObject]@{
    VMsRestarted = @("SimpleDC", "SimpleServer", "SimpleWin11")
    FailedVMs = @()
    OverallStatus = "OK"
    Message = "Restarted 3 VM(s)"
    Duration = "00:05:30"
}
```

**Algorithm:**
```
1. Validate Hyper-V module available
2. Get VM configurations
3. For each VM in dependency order (DC, Server, Win11):
   a. Restart VM (using Restart-LabVM)
   b. Track success/failure
4. Return structured result with per-VM status
```

### File: SimpleLab/Public/Suspend-LabVMs.ps1

Suspends all running lab VMs in reverse dependency order.

**Parameters:**
- `Wait` (switch) - Wait for all suspends to complete
- `TimeoutSeconds` (int, default: 60) - Per-VM timeout

**Returns:**
```powershell
[PSCustomObject]@{
    VMsSuspended = @("SimpleWin11", "SimpleServer", "SimpleDC")
    FailedVMs = @()
    AlreadyStopped = @()
    OverallStatus = "OK"
    Message = "Suspended 3 VM(s)"
    Duration = "00:00:45"
}
```

**Algorithm:**
```
1. Validate Hyper-V module available
2. Get VM configurations
3. For each VM in REVERSE dependency order (Win11, Server, DC):
   a. Suspend VM if running (using Suspend-LabVM)
   b. Track success/failure
4. Return structured result
```

**Note:** Reverse order for suspend because DC should be suspended last (clients depend on it).

### Module Updates

**SimpleLab.psm1:**
```powershell
Export-ModuleMember -Function @(
    # ... existing ...
    'Restart-LabVMs',
    'Suspend-LabVMs',
    # ... rest ...
)
```

**SimpleLab.psd1:**
```powershell
ModuleVersion = '0.9.0'
FunctionsToExport = @(..., 'Restart-LabVMs', 'Suspend-LabVMs', ...)
```

## Usage Examples

```powershell
# Restart all VMs in dependency order
Restart-LabVMs

# Restart all with forced shutdown
Restart-LabVMs -Force

# Restart and wait for all to be ready
Restart-LabVMs -Wait

# Suspend all running VMs (reverse dependency order)
Suspend-LabVMs
```

## Dependency Orders

**Start/Restart Order (DC first):**
1. SimpleDC (domain controller)
2. SimpleServer (member server)
3. SimpleWin11 (workstation)

**Stop/Suspend Order (DC last):**
1. SimpleWin11 (workstation)
2. SimpleServer (member server)
3. SimpleDC (domain controller)

## Testing Checklist

- [x] Restart all running VMs
- [x] Restart all with Force parameter
- [x] Restart and wait for ready state
- [x] Suspend all running VMs
- [x] Handle non-existent VMs gracefully
- [x] Per-VM error handling (continue on failure)
- [x] Module export verification
- [x] Dependency order verification

## Related Requirements

- **LIFE-01:** Start all lab VMs with single command ✅ (existing)
- **LIFE-02:** Stop all lab VMs with single command ✅ (existing)
- **LIFE-03:** Enhanced lifecycle operations for entire lab

## Estimated Effort

~10 minutes for implementation and testing

## Notes

- Wraps existing single-VM functions for consistency
- Per-VM error handling (one failure doesn't stop all)
- Returns aggregate status with per-VM details
- Follows established orchestrator pattern from Initialize-LabVMs
