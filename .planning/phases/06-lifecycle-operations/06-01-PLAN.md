# Phase 6 Plan 01: Individual VM Restart

**Status:** Pending
**Wave:** 1
**Dependencies:** Phase 4 complete ✅

## Goal

Add ability to restart individual lab VMs by name with proper waiting and stabilization.

## Success Criteria

1. ✅ User can restart a single VM by name (e.g., `Restart-LabVM SimpleDC`)
2. ✅ Function supports graceful restart (default) and forced restart
3. ✅ Function waits for VM to fully start after restart
4. ✅ Function returns structured result with status and timing

## Implementation

### File: SimpleLab/Public/Restart-LabVM.ps1

**Parameters:**
- `VMName` (string, mandatory) - Name of VM to restart
- `Force` (switch) - Force hard restart vs graceful shutdown
- `Wait` (switch) - Wait for VM to be ready after restart
- `TimeoutSeconds` (int, default: 300) - Maximum wait time
- `StabilizationSeconds` (int, default: 30) - Post-boot stabilization

**Returns:**
```powershell
[PSCustomObject]@{
    VMName = "SimpleDC"
    PreviousState = "Running"
    CurrentState = "Running"
    OverallStatus = "OK"  # OK, Partial, Failed, NotFound, Timeout
    Message = "Restarted successfully"
    Duration = "00:01:45"
    StopDuration = "00:00:15"
    StartDuration = "00:01:30"
}
```

**Algorithm:**
```
1. Validate Hyper-V module available
2. Validate VM exists (Get-VM)
3. Record previous state
4. Stop VM (Stop-VM or TurnOff if Force)
5. Wait for Off state (with timeout)
6. Start VM (Start-VM)
7. If Wait:
   a. Wait for Running state
   b. Wait for Heartbeat OK
   c. Wait stabilization period
8. Return structured result
```

**State Handling:**
- VM Running → Stop → Off → Start → Running
- VM Off → Start (skip stop) → Running
- VM Saved → TurnOff → Off → Start → Running
- VM Paused → TurnOff → Off → Start → Running

**Timeout Behavior:**
- Stop timeout: 60 seconds (then force turn off)
- Start timeout: 300 seconds (from start command)
- Returns "Timeout" status if not ready within limit

### Module Updates

**SimpleLab.psm1:**
```powershell
Export-ModuleMember -Function @(
    # ... existing ...
    'Restart-LabVM',
    # ... rest ...
)
```

**SimpleLab.psd1:**
```powershell
ModuleVersion = '0.7.0'
FunctionsToExport = @(..., 'Restart-LabVM', ...)
```

## Usage Examples

```powershell
# Restart DC gracefully
Restart-LabVM -VMName SimpleDC

# Restart with forced shutdown
Restart-LabVM -VMName SimpleDC -Force

# Restart and wait for ready state
Restart-LabVM -VMName SimpleServer -Wait

# Custom timeout for slow VMs
Restart-LabVM -VMName SimpleDC -Wait -TimeoutSeconds 600 -StabilizationSeconds 60
```

## Testing Checklist

- [x] Restart running VM (graceful)
- [x] Restart running VM (forced)
- [x] Restart stopped VM (should just start)
- [x] Restart non-existent VM (returns NotFound)
- [x] Timeout handling on stop
- [x] Timeout handling on start
- [x] All three VM types (DC, Server, Win11)
- [x] Module export verification
- [x] Help documentation available

## Related Requirements

- **LIFE-03:** Individual VM restart capability
- **LIFE-04:** Status reporting (uses Get-LabStatus pattern)

## Estimated Effort

~15 minutes for implementation and testing

## Notes

- Follows established patterns from Start-LabVMs and Stop-LabVMs
- Stabilization wait is important for DC (AD services need time)
- Graceful shutdown preferred for data integrity
- Force option available for hung/frozen VMs
