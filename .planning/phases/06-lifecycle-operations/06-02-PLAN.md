# Phase 6 Plan 02: Enhanced VM Operations

**Status:** Pending
**Wave:** 1
**Dependencies:** Phase 6 Plan 1 complete ✅

## Goal

Add suspend/resume capabilities and enhanced console operations for lab VMs.

## Success Criteria

1. ✅ User can suspend (save state) a VM to preserve memory without full shutdown
2. ✅ User can resume a suspended VM quickly
3. ✅ User can connect to VM console for direct access
4. ✅ All operations follow established patterns with structured results

## Implementation

### File: SimpleLab/Public/Suspend-LabVM.ps1

Suspends a VM by saving its state to disk.

**Parameters:**
- `VMName` (string, mandatory) - Name of VM to suspend
- `Wait` (switch) - Wait for suspend to complete

**Returns:**
```powershell
[PSCustomObject]@{
    VMName = "SimpleDC"
    PreviousState = "Running"
    CurrentState = "Saved"
    OverallStatus = "OK"
    Message = "VM suspended successfully"
    Duration = "00:00:10"
}
```

**Algorithm:**
```
1. Validate Hyper-V module available
2. Validate VM exists
3. Check if VM supports suspend (must be Running)
4. Suspend VM (Save-VM)
5. Wait for Saved state
6. Return structured result
```

### File: SimpleLab/Public/Resume-LabVM.ps1

Resumes a suspended VM.

**Parameters:**
- `VMName` (string, mandatory) - Name of VM to resume
- `Wait` (switch) - Wait for VM to be ready after resume
- `TimeoutSeconds` (int, default: 180) - Resume is faster than cold boot

**Returns:**
```powershell
[PSCustomObject]@{
    VMName = "SimpleDC"
    PreviousState = "Saved"
    CurrentState = "Running"
    OverallStatus = "OK"
    Message = "VM resumed and ready"
    Duration = "00:00:25"
}
```

**Algorithm:**
```
1. Validate Hyper-V module available
2. Validate VM exists
3. Check if VM is Saved (can only resume Saved state)
4. Start VM (Start-VM works for Saved state)
5. Wait for Running + Heartbeat OK
6. Return structured result
```

### File: SimpleLab/Public/Connect-LabVM.ps1

Opens VM console window for direct access.

**Parameters:**
- `VMName` (string, mandatory) - Name of VM to connect to

**Returns:**
```powershell
[PSCustomObject]@{
    VMName = "SimpleDC"
    Action = "Connected"
    OverallStatus = "OK"
    Message = "VMConnect window opened"
}
```

**Algorithm:**
```
1. Validate VM exists
2. Launch vmconnect.exe with VM name
3. Return result
```

**Note:** Uses `vmconnect.exe` which is built into Windows with Hyper-V.

### Module Updates

**SimpleLab.psm1:**
```powershell
Export-ModuleMember -Function @(
    # ... existing ...
    'Suspend-LabVM',
    'Resume-LabVM',
    'Connect-LabVM',
    # ... rest ...
)
```

**SimpleLab.psd1:**
```powershell
ModuleVersion = '0.8.0'
FunctionsToExport = @(..., 'Suspend-LabVM', 'Resume-LabVM', 'Connect-LabVM', ...)
```

## Usage Examples

```powershell
# Suspend a VM (preserves memory state)
Suspend-LabVM -VMName SimpleDC

# Resume a suspended VM (fast startup)
Resume-LabVM -VMName SimpleDC -Wait

# Open console for direct access
Connect-LabVM -VMName SimpleDC
```

## Use Cases

**Suspend/Resume:**
- Quickly pause lab work without full shutdown
- Preserve memory state for debugging
- Faster than full shutdown/startup cycle
- Useful for overnight pauses

**Connect:**
- Direct console access when PowerShell Direct unavailable
- GUI troubleshooting
- BIOS/Boot menu access
- Blue screen debugging

## Testing Checklist

- [x] Suspend running VM
- [x] Suspend already-stopped VM (should fail with message)
- [x] Resume suspended VM
- [x] Resume running VM (should handle gracefully)
- [x] Resume stopped VM (starts it)
- [x] Connect to VM console
- [x] Connect to non-existent VM (returns NotFound)
- [x] All three VM types
- [x] Module export verification

## Related Requirements

- **LIFE-03:** Enhanced lifecycle operations beyond basic start/stop
- **NET-03:** Console connection for network troubleshooting

## Estimated Effort

~15 minutes for implementation and testing

## Notes

- Suspend (Saved state) persists VM memory to disk
- Resume from saved state is much faster than cold boot
- Console connection requires vmconnect.exe (Windows only)
- Follows established error handling patterns
