---
phase: 25-mixed-os-integration
plan: 02
type: execute
wave: 2
depends_on: [25-01]
files_modified:
  - Tests/MixedOSIntegration.Tests.ps1
  - docs/LIFECYCLE-WORKFLOWS.md
autonomous: true
requirements: [LNX-05]

must_haves:
  truths:
    - "Integration tests validate mixed OS scenario template resolves correctly"
    - "Integration tests verify cross-OS provisioning flow wiring in Build-LabFromSelection"
    - "Integration tests confirm networking setup handles both Windows and Linux VMs"
    - "Documentation describes mixed OS lab workflow with scenario template usage"
  artifacts:
    - path: "Tests/MixedOSIntegration.Tests.ps1"
      provides: "Pester 5 integration tests for mixed OS scenario end-to-end flow"
      min_lines: 80
    - path: "docs/LIFECYCLE-WORKFLOWS.md"
      provides: "Updated documentation with mixed OS lab workflow section"
      contains: "Mixed OS"
  key_links:
    - from: "Tests/MixedOSIntegration.Tests.ps1"
      to: "Private/Get-LabScenarioTemplate.ps1"
      via: "dot-source and invoke Get-LabScenarioTemplate -Scenario MixedOSLab"
      pattern: "Get-LabScenarioTemplate.*MixedOSLab"
    - from: "Tests/MixedOSIntegration.Tests.ps1"
      to: "LabBuilder/Build-LabFromSelection.ps1"
      via: "Select-String static analysis for Linux provisioning phases"
      pattern: "Select-String.*IsLinux"
---

<objective>
Create integration tests covering mixed OS provisioning, networking, and teardown flow, and update documentation with mixed OS lab workflow guidance.

Purpose: Validates LNX-05 end-to-end by ensuring the MixedOSLab scenario template integrates correctly with the existing provisioning pipeline, and provides operator guidance for mixed OS labs.
Output: Pester 5 integration test suite + updated lifecycle docs with mixed OS section.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-mixed-os-integration/25-01-SUMMARY.md
@.planning/templates/MixedOSLab.json
@Private/Get-LabScenarioTemplate.ps1
@Private/Get-LabScenarioResourceEstimate.ps1
@LabBuilder/Build-LabFromSelection.ps1
@Public/Initialize-LabNetwork.ps1
@Tests/ScenarioDeployIntegration.Tests.ps1
@docs/LIFECYCLE-WORKFLOWS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mixed OS integration test suite</name>
  <files>Tests/MixedOSIntegration.Tests.ps1</files>
  <action>
Create `Tests/MixedOSIntegration.Tests.ps1` with Pester 5 Describe/Context/It structure. Follow the established integration test pattern from `Tests/ScenarioDeployIntegration.Tests.ps1` and `Tests/CustomRoleIntegration.Tests.ps1` — use Select-String for static analysis and dot-source helpers in BeforeAll.

BeforeAll block:
- Dot-source `Private/Get-LabScenarioTemplate.ps1` and `Private/Get-LabScenarioResourceEstimate.ps1`
- Dot-source `Private/Test-LabTemplateData.ps1` (required by Get-LabScenarioTemplate)
- Set `$script:RepoRoot` using `Split-Path $PSScriptRoot`
- Set `$script:TemplatesRoot` to `Join-Path $script:RepoRoot '.planning/templates'`

**Describe "MixedOSLab Scenario Template":**

Context "Template structure":
- It "MixedOSLab.json exists in templates directory" — Test-Path
- It "template parses as valid JSON with required fields" — ConvertFrom-Json; check name, description, vms properties exist
- It "defines exactly 4 VMs" — $template.vms.Count -eq 4
- It "contains both Windows and Linux roles" — check role set includes DC, IIS and at least one Linux role (WebServerUbuntu or DatabaseUbuntu)
- It "all VM IPs are in 10.0.10.0/24 subnet" — regex match each vm.ip against '^10\.0\.10\.\d+'
- It "all role tags match known LabBuilder roles" — get role files from LabBuilder/Roles/*.ps1, extract tag names, verify each template role is in that set

Context "Scenario resolution":
- It "Get-LabScenarioTemplate resolves MixedOSLab" — call function, verify returns 4 objects
- It "returned objects have Name, Role, Ip, MemoryGB, Processors properties" — check first object has all 5 properties
- It "resource estimate returns correct VM count" — Get-LabScenarioResourceEstimate returns VMCount=4
- It "resource estimate includes Linux disk sizes (not default fallback)" — TotalDiskGB should not be 4*60 (all default); verify it includes the specific Linux sizes (40+50=90 for WebServerUbuntu+DatabaseUbuntu)

**Describe "Cross-OS Provisioning Flow":**

Context "Build-LabFromSelection handles mixed roles" (static analysis):
- It "Build-LabFromSelection separates Windows and Linux roles" — Select-String 'IsLinux' on Build-LabFromSelection.ps1
- It "Linux VMs created in background (Phase 10-pre)" — Select-String 'Phase 10-pre.*Linux' on Build-LabFromSelection.ps1
- It "Linux post-installs run after Windows post-installs" — Select-String pattern showing Linux post-install block exists after Windows section
- It "Build manifest includes IsLinux flag" — Select-String 'IsLinux.*\$rd\.IsLinux' or similar pattern

Context "Network setup supports mixed OS" (static analysis):
- It "Initialize-LabNetwork handles multi-subnet config" — Select-String 'Switches' or 'VMAssignments' on Initialize-LabNetwork.ps1
- It "Get-LabNetworkConfig returns VMAssignments for IP planning" — Select-String 'VMAssignments' on Get-LabNetworkConfig.ps1

**Describe "Updated Scenario Templates":**
- It "SecurityLab template includes switch field on VMs" — parse JSON, check vms[0].switch exists
- It "MultiTierApp template includes switch field on VMs" — parse JSON, check vms[0].switch exists
- It "MixedOSLab appears in available scenarios list" — list .json files in templates dir, confirm MixedOSLab is present

Use `$script:` prefix for BeforeAll variables per Pester 5 convention.
  </action>
  <verify>
```powershell
$r = Invoke-Pester -Path 'Tests/MixedOSIntegration.Tests.ps1' -PassThru -Output Minimal
$r.FailedCount -eq 0
```
  </verify>
  <done>All integration tests pass: MixedOSLab template resolves correctly, resource estimation handles Linux roles, Build-LabFromSelection static analysis confirms cross-OS provisioning flow, network setup supports multi-subnet mixed OS topology.</done>
</task>

<task type="auto">
  <name>Task 2: Update lifecycle documentation with mixed OS workflow</name>
  <files>docs/LIFECYCLE-WORKFLOWS.md</files>
  <action>
Add a new section to `docs/LIFECYCLE-WORKFLOWS.md` titled "## Mixed OS Lab Workflows" (append before the final section or at an appropriate location near the deploy/scenario sections).

Content should include:

**### Deploying a Mixed OS Lab**
- Command example: `.\OpenCodeLab-App.ps1 -Action deploy -Scenario MixedOSLab`
- Brief explanation: deploys Windows DC + IIS + Ubuntu web server + CentOS database server
- Provisioning order: DC first (AD/DNS), then Windows servers in parallel, then Linux VMs in background (Phase 10-pre), then Windows post-installs, then custom roles, then Linux post-installs via SSH
- Resource requirements: reference `Get-LabScenarioResourceEstimate -Scenario MixedOSLab` for estimates

**### Multi-Switch Networking in Mixed Labs**
- Explain that VMs can be assigned to different switches (LabCorpNet, LabDMZ) via IPPlan hashtable format in Lab-Config.ps1
- Reference the Switches array in Network section for defining multiple subnets
- Brief note on VLAN tagging for network isolation

**### Available Mixed OS Scenario Templates**
- MixedOSLab: DC + IIS + Ubuntu (nginx) + Ubuntu (PostgreSQL)
- SecurityLab: DC + Windows client + Ubuntu attack VM
- MultiTierApp: DC + SQL + IIS + Client (Windows-only, but demonstrates multi-tier pattern)

**### Troubleshooting Mixed OS Labs**
- SSH connectivity: Linux VMs need SSH service running; retry logic configured in Lab-Config.ps1 Timeouts section
- Linux post-install failures: check SSH key at Builder.Linux.SSHKeyDir; verify ISO pattern matches downloaded CentOS/Ubuntu ISO
- Domain integration: Windows DC must be fully promoted before Linux VMs attempt DNS resolution

Keep documentation concise and operator-focused. Do NOT duplicate content already in GETTING-STARTED.md. Use the same style as existing sections (command snippets + expected outcomes).
  </action>
  <verify>
```powershell
$content = Get-Content 'docs/LIFECYCLE-WORKFLOWS.md' -Raw
$content -match 'Mixed OS' -and $content -match 'MixedOSLab' -and $content -match 'Multi-Switch'
```
  </verify>
  <done>LIFECYCLE-WORKFLOWS.md contains a Mixed OS Lab Workflows section with deploy command, provisioning order, multi-switch networking guidance, available templates list, and troubleshooting tips.</done>
</task>

</tasks>

<verification>
1. `Invoke-Pester -Path Tests/MixedOSIntegration.Tests.ps1` — all tests pass
2. docs/LIFECYCLE-WORKFLOWS.md contains "Mixed OS" section with deploy examples
3. Integration tests cover: template resolution, resource estimation, cross-OS provisioning flow (static analysis), network multi-subnet support
4. No regression in existing tests: `Invoke-Pester -Path Tests/ScenarioTemplates.Tests.ps1` still passes
</verification>

<success_criteria>
- Integration test suite with 15+ tests covering template, provisioning, networking, and teardown aspects of mixed OS labs
- Documentation section enables operators to deploy and troubleshoot mixed OS labs without prior knowledge
- All existing scenario template tests continue to pass (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/25-mixed-os-integration/25-02-SUMMARY.md`
</output>
