---
phase: 25-mixed-os-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/templates/MixedOSLab.json
  - .planning/templates/SecurityLab.json
  - .planning/templates/MultiTierApp.json
  - Private/Get-LabScenarioResourceEstimate.ps1
autonomous: true
requirements: [LNX-05]

must_haves:
  truths:
    - "Mixed OS scenario template defines DC + Windows server + Linux app servers in one lab"
    - "Existing scenario templates updated with multi-switch and per-VM switch assignment where applicable"
    - "Resource estimation correctly calculates disk for CentOS and all Linux roles"
  artifacts:
    - path: ".planning/templates/MixedOSLab.json"
      provides: "Mixed OS scenario with DC, IIS, Ubuntu web server, CentOS database server"
      contains: "MixedOSLab"
    - path: "Private/Get-LabScenarioResourceEstimate.ps1"
      provides: "Updated disk lookup with CentOS and Linux role entries"
      contains: "CentOS"
  key_links:
    - from: ".planning/templates/MixedOSLab.json"
      to: "Private/Get-LabScenarioTemplate.ps1"
      via: "JSON file auto-discovered by Get-LabScenarioTemplate"
      pattern: "MixedOSLab"
    - from: "Private/Get-LabScenarioResourceEstimate.ps1"
      to: ".planning/templates/MixedOSLab.json"
      via: "diskLookup covers all roles in template"
      pattern: "CentOS.*40"
---

<objective>
Create a mixed OS scenario template (Windows DC + IIS + Linux app servers) and update existing templates and resource estimation to leverage multi-switch networking and support all Linux role types.

Purpose: LNX-05 requires end-to-end mixed Windows/Linux scenarios. This plan creates the scenario template and ensures the resource estimation pipeline handles all roles correctly.
Output: MixedOSLab.json template, updated SecurityLab/MultiTierApp templates with switch assignments, CentOS/Linux disk estimation in resource estimator.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/templates/SecurityLab.json
@.planning/templates/MultiTierApp.json
@.planning/templates/MinimalAD.json
@Private/Get-LabScenarioTemplate.ps1
@Private/Get-LabScenarioResourceEstimate.ps1
@Lab-Config.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MixedOSLab scenario template and update existing templates</name>
  <files>
    .planning/templates/MixedOSLab.json
    .planning/templates/SecurityLab.json
    .planning/templates/MultiTierApp.json
  </files>
  <action>
Create `.planning/templates/MixedOSLab.json` with this structure:
- name: "MixedOSLab"
- description: "Mixed OS lab: Windows DC, IIS web server, Ubuntu app server, CentOS database server"
- vms array with 4 VMs:
  1. dc1: role=DC, ip=10.0.10.10, memoryGB=4, processors=4 (Windows domain controller)
  2. iis1: role=IIS, ip=10.0.10.50, memoryGB=4, processors=2 (Windows IIS web server)
  3. linweb1: role=WebServerUbuntu, ip=10.0.10.111, memoryGB=2, processors=2 (Ubuntu nginx)
  4. lindb1: role=DatabaseUbuntu, ip=10.0.10.112, memoryGB=2, processors=2 (Ubuntu PostgreSQL)

The role values MUST match existing LabBuilder role tags exactly (DC, IIS, WebServerUbuntu, DatabaseUbuntu) — these are what Get-LabScenarioTemplate returns and what Build-LabFromSelection consumes.

IPs MUST match Builder.IPPlan entries in Lab-Config.ps1 for each role tag.

Update `SecurityLab.json`:
- Add "switch" field to each VM entry: dc1 and ws1 get "LabCorpNet", attack1 gets "LabCorpNet" (single-switch scenario but now explicitly named for multi-switch awareness).

Update `MultiTierApp.json`:
- Add "switch" field: dc1/sql1/iis1 on "LabCorpNet", ws1 on "LabCorpNet". All same switch but explicit assignment demonstrates the pattern.

The "switch" field is informational metadata for operators — Get-LabScenarioTemplate passes it through in the VM PSCustomObject. The provisioning pipeline uses IPPlan from Lab-Config.ps1 for actual switch assignment, but having switch in templates documents the intended topology.
  </action>
  <verify>
Verify JSON validity:
```powershell
$mixed = Get-Content '.planning/templates/MixedOSLab.json' -Raw | ConvertFrom-Json
$mixed.vms.Count -eq 4
$mixed.vms | Where-Object { $_.role -in @('DC','IIS','WebServerUbuntu','DatabaseUbuntu') } | Measure-Object | Select-Object -Expand Count  # must be 4
$sec = Get-Content '.planning/templates/SecurityLab.json' -Raw | ConvertFrom-Json
$sec.vms[0].switch -eq 'LabCorpNet'
$multi = Get-Content '.planning/templates/MultiTierApp.json' -Raw | ConvertFrom-Json
$multi.vms[0].switch -eq 'LabCorpNet'
```
  </verify>
  <done>MixedOSLab.json defines 4 VMs (DC + IIS + 2 Linux) with valid role tags and IPs matching Lab-Config. SecurityLab and MultiTierApp templates include switch field per VM.</done>
</task>

<task type="auto">
  <name>Task 2: Update resource estimator with Linux role disk lookup entries</name>
  <files>Private/Get-LabScenarioResourceEstimate.ps1</files>
  <action>
Update the `$diskLookup` hashtable in `Get-LabScenarioResourceEstimate` to include all Linux role tags:
- 'CentOS' = 40 (same as Ubuntu — lightweight Linux VMs)
- 'WebServerUbuntu' = 40
- 'DatabaseUbuntu' = 50 (PostgreSQL data files need slightly more)
- 'DockerUbuntu' = 50 (Docker images consume disk)
- 'K8sUbuntu' = 50 (container images)

The existing 'Ubuntu' = 40 entry stays. The existing default of 60GB stays for unknown roles.

This ensures `Get-LabScenarioResourceEstimate -Scenario MixedOSLab` returns accurate disk totals for mixed OS labs.
  </action>
  <verify>
```powershell
$content = Get-Content 'Private/Get-LabScenarioResourceEstimate.ps1' -Raw
$content -match "'CentOS'" -and $content -match "'WebServerUbuntu'" -and $content -match "'DatabaseUbuntu'" -and $content -match "'DockerUbuntu'" -and $content -match "'K8sUbuntu'"
```
  </verify>
  <done>Resource estimator diskLookup covers all 6 Linux role tags (Ubuntu, CentOS, WebServerUbuntu, DatabaseUbuntu, DockerUbuntu, K8sUbuntu) with appropriate disk size estimates.</done>
</task>

</tasks>

<verification>
1. All three template JSON files parse without errors via ConvertFrom-Json
2. MixedOSLab.json has exactly 4 VMs with roles matching LabBuilder role tags
3. Resource estimator diskLookup has entries for all Linux roles
4. Existing MinimalAD.json is unchanged (no multi-switch needed for single DC)
</verification>

<success_criteria>
- MixedOSLab scenario template exists with DC + IIS + Ubuntu + CentOS VMs
- SecurityLab and MultiTierApp templates include per-VM switch field
- Resource estimator handles all Linux roles without falling back to default disk size
</success_criteria>

<output>
After completion, create `.planning/phases/25-mixed-os-integration/25-01-SUMMARY.md`
</output>
