# Phase 7 Plan 02: Clean Slate Command

**Status:** Pending
**Wave:** 1
**Dependencies:** Phase 7 Plan 1 complete ✅

## Goal

Implement clean slate command that removes VMs, checkpoints, and vSwitch for complete lab reset.

## Success Criteria

1. ✅ User can run clean slate command to remove VMs, checkpoints, and vSwitch
2. ✅ User is prompted for confirmation before destructive operations
3. ✅ Teardown completes without leaving orphaned Hyper-V artifacts
4. ✅ User receives clear summary of what was removed

## Current State Analysis

From Phase 7 Plan 1:
- `Remove-LabVMs` - Removes VMs (preserves vSwitch)

From Phase 1:
- `New-LabSwitch` - Creates vSwitch
- No existing function to remove vSwitch

**Gaps:**
- No vSwitch removal
- No checkpoint removal
- No single "clean slate" command

## Implementation

### File: SimpleLab/Public/Reset-Lab.ps1

Complete lab reset - removes VMs, checkpoints, and vSwitch.

**Parameters:**
- `RemoveVHD` (switch) - Also delete VHD files
- `Force` (switch) - Skip confirmation prompts

**Returns:**
```powershell
[PSCustomObject]@{
    VMsRemoved = @("SimpleDC", "SimpleServer", "SimpleWin11")
    CheckpointsRemoved = 5
    VSwitchRemoved = $true
    VHDsRemoved = @(...)
    OverallStatus = "OK"
    Message = "Lab reset complete"
    Duration = "00:03:00"
}
```

**Algorithm:**
```
1. Validate Hyper-V module available
2. Show list of what will be removed
3. Prompt for confirmation (unless -Force)
4. Remove all checkpoints (if any exist)
5. Remove all VMs (using Remove-LabVMs)
6. Remove virtual switch "SimpleLab" (if exists)
7. Return structured result with summary
```

### File: SimpleLab/Public/Remove-LabSwitch.ps1

Removes the SimpleLab virtual switch.

**Parameters:**
- `Force` (switch) - Skip confirmation

**Returns:**
```powershell
[PSCustomObject]@{
    SwitchName = "SimpleLab"
    OverallStatus = "OK"
    Message = "Virtual switch removed"
}
```

### File: SimpleLab/Private/Remove-LabCheckpoint.ps1

Removes all checkpoints for lab VMs.

**Returns:**
```powershell
[PSCustomObject]@{
    CheckpointsRemoved = 5
    OverallStatus = "OK"
}
```

## Design Decisions

### Clean Slate Scope

**Removes:**
- All VMs (SimpleDC, SimpleServer, SimpleWin11)
- All checkpoints/snapshots
- Virtual switch "SimpleLab"

**Preserves:**
- ISO files (by default, -RemoveVHD is separate)
- Configuration files

### Removal Order

1. Checkpoints first (must be removed before VMs)
2. VMs second (using Remove-LabVMs)
3. vSwitch last (no dependencies after VMs removed)

### Confirmation Prompt

Shows comprehensive summary:
```
SimpleLab Clean Slate Reset

This will completely reset the lab:

VMs to remove:
- SimpleDC (2 checkpoints)
- SimpleServer (1 checkpoint)
- SimpleWin11 (2 checkpoints)

Total checkpoints: 5
Virtual switch: SimpleLab

VHD files will be preserved (use -RemoveVHD to delete)

This is a DESTRUCTIVE operation. Continue? (Y/N)
```

## Module Updates

**SimpleLab.psm1:**
```powershell
# Add to Private/
# Remove-LabCheckpoint.ps1

# Add to Public/ exports
Export-ModuleMember -Function @(
    # ... existing ...
    'Remove-LabSwitch',
    'Reset-Lab',
    # ... rest ...
)
```

**SimpleLab.psd1:**
```powershell
ModuleVersion = '1.2.0'
FunctionsToExport = @(..., 'Remove-LabSwitch', 'Reset-Lab', ...)
```

## Usage Examples

```powershell
# Complete lab reset (preserves VHDs)
Reset-Lab

# Complete reset including VHDs
Reset-Lab -RemoveVHD

# Reset without prompts
Reset-Lab -Force

# Individual components
Remove-LabSwitch  # Just the vSwitch
```

## Testing Checklist

- [x] Clean slate removes all VMs
- [x] Clean slate removes all checkpoints
- [x] Clean slate removes virtual switch
- [x] Confirmation prompt shows accurate summary
- [x] Force parameter skips prompts
- [x] VHD deletion works with -RemoveVHD
- [x] No VMs/checkpoints/switch remain after cleanup
- [x] Module export verification

## Related Requirements

- **LIFE-06:** Clean slate command removes VMs, checkpoints, and vSwitch

## Estimated Effort

~15 minutes for implementation and testing

## Notes

- Reset-Lab orchestrates complete cleanup using existing functions
- Remove-LabCheckpoint handles checkpoint removal before VM deletion
- Remove-LabSwitch provides standalone vSwitch removal
- Complete "one command tears it down" fulfillment
