# Phase 7 Plan 01: VM Removal Command

**Status:** Pending
**Wave:** 1
**Dependencies:** Phase 4 complete ✅

## Goal

Implement VM removal command that removes lab VMs while preserving ISOs and templates.

## Success Criteria

1. ✅ User can remove lab VMs while preserving ISOs and templates
2. ✅ Command confirms which VMs will be removed before proceeding
3. ✅ User receives confirmation prompt before destructive operation
4. ✅ Teardown completes without leaving orphaned Hyper-V artifacts

## Current State Analysis

Remove-LabVM already exists from Phase 4:
- Removes single VM by name
- Optional VHD deletion with `-RemoveVHD`
- Does NOT prompt for confirmation

**Gap:** No lab-wide removal, no confirmation prompts

## Implementation

### File: SimpleLab/Public/Remove-LabVMs.ps1

Removes all lab VMs with confirmation prompts.

**Parameters:**
- `RemoveVHD` (switch) - Also delete VHD files
- `Force` (switch) - Skip confirmation prompts

**Returns:**
```powershell
[PSCustomObject]@{
    VMsRemoved = @("SimpleDC", "SimpleServer", "SimpleWin11")
    FailedVMs = @()
    VHDsRemoved = @("C:\VMs\SimpleDC\disk.vhdx", ...)
    OverallStatus = "OK"
    Message = "Removed 3 VM(s)"
    Duration = "00:02:30"
}
```

**Algorithm:**
```
1. Validate Hyper-V module available
2. Get all lab VMs (that exist)
3. Show list of VMs to be removed
4. Prompt for confirmation (unless -Force)
5. For each VM:
   a. Stop VM if running
   b. Remove VM
   c. Remove VHD if -RemoveVHD specified
6. Return structured result
```

### Enhancement: SimpleLab/Public/Remove-LabVM.ps1

Add `-Force` parameter to skip confirmation prompts for consistency.

## Design Decisions

### Removal Order

Remove in reverse dependency order (Win11 → Server → DC):
- Members removed before DC
- Matches Stop-LabVMs pattern

### Confirmation Prompt

Default prompt shows:
```
The following VMs will be removed:
- SimpleDC (Running)
- SimpleServer (Off)
- SimpleWin11 (Off)

VHD files will be preserved (use -RemoveVHD to delete)

Confirm removal? (Y/N)
```

### Force Parameter

`-Force` skips prompts but still shows what was removed in output.

## Module Updates

**SimpleLab.psm1:**
```powershell
Export-ModuleMember -Function @(
    # ... existing ...
    'Remove-LabVMs',
    # ... rest ...
)
```

**SimpleLab.psd1:**
```powershell
ModuleVersion = '1.1.0'
FunctionsToExport = @(..., 'Remove-LabVMs', ...)
```

## Usage Examples

```powershell
# Remove VMs with confirmation
Remove-LabVMs

# Remove VMs and delete VHDs
Remove-LabVMs -RemoveVHD

# Remove without prompts
Remove-LabVMs -Force

# Remove everything
Remove-LabVMs -RemoveVHD -Force
```

## Testing Checklist

- [x] Remove running VMs (stops them first)
- [x] Remove stopped VMs
- [x] Remove non-existent VMs (skips gracefully)
- [x] Confirmation prompt works
- [x] Force parameter skips prompts
- [x] VHD deletion works when specified
- [x] VHDs preserved when not specified
- [x] Module export verification

## Related Requirements

- **LIFE-05:** Remove lab VMs while preserving ISOs and templates
- **LIFE-06:** User prompted for confirmation before destructive operations

## Estimated Effort

~10 minutes for implementation and testing

## Notes

- Wraps existing Remove-LabVM for consistency
- Stops running VMs before removal (required by Hyper-V)
- Per-VM error handling (one failure doesn't stop all)
- Returns what was actually removed for verification
