---
phase: 06-multi-host-coordination
plan: 05
type: execute
wave: 3
depends_on:
  - 06-01-PLAN
  - 06-02-PLAN
  - 06-03-PLAN
  - 06-04-PLAN
files_modified:
  - Tests/CoordinatorIntegration.Tests.ps1
autonomous: true
requirements:
  - MH-01
  - MH-02
  - MH-03
  - MH-04
  - MH-05

must_haves:
  truths:
    - "Integration test proves end-to-end: inventory load -> validation -> policy -> dispatch -> artifact write for enforced deploy with 2 hosts"
    - "Integration test proves end-to-end: inventory with invalid connection type is rejected before reaching policy"
    - "Integration test proves scoped confirmation token gates full teardown across multiple hosts"
    - "Integration test proves unreachable host in fleet probe produces PolicyBlocked with host-specific reason"
    - "Integration test proves canary dispatch writes exactly 1 succeeded and N-1 not_dispatched host outcomes"
    - "Integration test proves dispatch mode off produces not_dispatched with no execution"
    - "All existing CoordinatorIntegration.Tests.ps1 tests continue to pass"
    - "New tests validate the hardened paths introduced in plans 01-04"
  artifacts:
    - path: "Tests/CoordinatorIntegration.Tests.ps1"
      provides: "End-to-end integration tests proving all 5 requirements work together"
  key_links:
    - from: "Tests/CoordinatorIntegration.Tests.ps1"
      to: "OpenCodeLab-App.ps1"
      via: "Integration tests invoke the app script directly to test the full pipeline"
      pattern: "& $appPath"
---

<objective>
Add integration tests that prove the full coordinator pipeline works end-to-end after all hardening changes from plans 01-04, validating that all 5 MH requirements are satisfied together.

Purpose: Unit tests in plans 01-04 prove individual components work correctly, but integration tests are needed to prove the full pipeline handles the hardened validation, dispatch routing, safety gates, and failure handling correctly when all components are composed together through OpenCodeLab-App.ps1.

Output: Additional integration tests in CoordinatorIntegration.Tests.ps1 that exercise the full pipeline for hardened paths.
</objective>

<execution_context>
- CoordinatorIntegration.Tests.ps1 (701 lines) has 11 existing integration tests
- Tests invoke OpenCodeLab-App.ps1 directly with various inventory/probe/mode combinations
- Tests use OPENCODELAB_SKIP_RUNTIME_BOOTSTRAP and OPENCODELAB_RUNTIME_STATE_JSON for test isolation
- Tests use OPENCODELAB_TEST_ALLOW_SIMULATED_REMOTE_SUCCESS for dispatch simulation
- Existing tests cover: NoExecute policy, blocked probes, escalation, scoped confirmation, dispatch artifacts
</execution_context>

<changes>

## Change 1: Add inventory validation rejection integration test

**File:** `Tests/CoordinatorIntegration.Tests.ps1`

```powershell
It 'rejects inventory with invalid connection type before reaching policy' {
    $inventoryPath = Join-Path $TestDrive 'invalid-connection-inventory.json'
    @'
{
  "hosts": [
    { "name": "hv-a", "role": "primary", "connection": "telnet" }
  ]
}
'@ | Set-Content -Path $inventoryPath -Encoding UTF8

    {
        & $appPath -Action deploy -Mode quick -NoExecute -InventoryPath $inventoryPath -TargetHosts @('hv-a')
    } | Should -Throw "*connection value*telnet*not supported*"
}
```

## Change 2: Add duplicate host name rejection integration test

**File:** `Tests/CoordinatorIntegration.Tests.ps1`

```powershell
It 'rejects inventory with duplicate host names before reaching policy' {
    $inventoryPath = Join-Path $TestDrive 'dup-host-inventory.json'
    @'
{
  "hosts": [
    { "name": "hv-a", "role": "primary", "connection": "winrm" },
    { "name": "HV-A", "role": "secondary", "connection": "ssh" }
  ]
}
'@ | Set-Content -Path $inventoryPath -Encoding UTF8

    {
        & $appPath -Action deploy -Mode quick -NoExecute -InventoryPath $inventoryPath -TargetHosts @('hv-a')
    } | Should -Throw "*duplicate host name*"
}
```

## Change 3: Add full pipeline success integration test with artifact verification

**File:** `Tests/CoordinatorIntegration.Tests.ps1`

```powershell
It 'enforced deploy with 2 hosts writes complete artifacts with dispatch metadata' {
    $logRoot = Join-Path $TestDrive 'run-logs-integration-hardened'
    $env:OPENCODELAB_RUN_LOG_ROOT = $logRoot
    $env:OPENCODELAB_SKIP_RUNTIME_BOOTSTRAP = '1'
    $env:OPENCODELAB_TEST_ALLOW_SIMULATED_REMOTE_SUCCESS = '1'
    $markerPath = Join-Path $TestDrive 'dispatch-hardened-marker.log'
    $env:OPENCODELAB_TEST_DISPATCH_EXECUTION_MARKER = $markerPath
    $inventoryPath = Join-Path $TestDrive 'hardened-integration-inventory.json'
    @'
{
  "hosts": [
    { "name": "hv-a", "role": "primary", "connection": "psremoting" },
    { "name": "hv-b", "role": "secondary", "connection": "psremoting" }
  ]
}
'@ | Set-Content -Path $inventoryPath -Encoding UTF8

    $hostProbes = @(
        [pscustomobject]@{
            HostName = 'hv-a'
            Reachable = $true
            Probe = [pscustomobject]@{
                LabRegistered = $true
                MissingVMs = @()
                LabReadyAvailable = $true
                SwitchPresent = $true
                NatPresent = $true
            }
            Failure = $null
        },
        [pscustomobject]@{
            HostName = 'hv-b'
            Reachable = $true
            Probe = [pscustomobject]@{
                LabRegistered = $true
                MissingVMs = @()
                LabReadyAvailable = $true
                SwitchPresent = $true
                NatPresent = $true
            }
            Failure = $null
        }
    )
    $env:OPENCODELAB_RUNTIME_STATE_JSON = ($hostProbes | ConvertTo-Json -Depth 10 -Compress)

    & $appPath -Action deploy -Mode quick -NonInteractive -DispatchMode enforced -TargetHosts @('hv-a', 'hv-b') -InventoryPath $inventoryPath

    $report = Get-LatestRunReport -LogRoot $logRoot

    $report.dispatch_mode | Should -Be 'enforced'
    $report.execution_outcome | Should -Be 'succeeded'
    $report.success | Should -BeTrue
    @($report.host_outcomes).Count | Should -Be 2
    @($report.host_outcomes | ForEach-Object { [string]$_.HostName }) | Should -Be @('hv-a', 'hv-b')
    @($report.host_outcomes | ForEach-Object { [string]$_.DispatchStatus }) | Should -Be @('succeeded', 'succeeded')
    @($report.blast_radius).Count | Should -Be 2
}
```

## Change 4: Add off-mode no-execution integration test with artifact verification

**File:** `Tests/CoordinatorIntegration.Tests.ps1`

```powershell
It 'dispatch mode off produces not_dispatched and writes artifact with zero execution' {
    $logRoot = Join-Path $TestDrive 'run-logs-off-mode-artifact'
    $env:OPENCODELAB_RUN_LOG_ROOT = $logRoot
    $env:OPENCODELAB_SKIP_RUNTIME_BOOTSTRAP = '1'
    $inventoryPath = Join-Path $TestDrive 'off-mode-inventory.json'
    @'
{
  "hosts": [
    { "name": "hv-a", "role": "primary", "connection": "psremoting" }
  ]
}
'@ | Set-Content -Path $inventoryPath -Encoding UTF8

    $hostProbes = @(
        [pscustomobject]@{
            HostName = 'hv-a'
            Reachable = $true
            Probe = [pscustomobject]@{
                LabRegistered = $true
                MissingVMs = @()
                LabReadyAvailable = $true
                SwitchPresent = $true
                NatPresent = $true
            }
            Failure = $null
        }
    )
    $env:OPENCODELAB_RUNTIME_STATE_JSON = ($hostProbes | ConvertTo-Json -Depth 10 -Compress)

    $result = & $appPath -Action deploy -Mode quick -NoExecute -InventoryPath $inventoryPath -TargetHosts @('hv-a') -NoExecuteStateJson ($hostProbes | ConvertTo-Json -Depth 10 -Compress)

    $result.DispatchMode | Should -Be 'off'
    $result.ExecutionOutcome | Should -Be 'not_dispatched'
    $result.PolicyOutcome | Should -Be 'Approved'
}
```

</changes>

<validation>
- All 11 existing CoordinatorIntegration.Tests.ps1 tests continue to pass
- New inventory validation test proves invalid connection types are rejected at inventory layer
- New duplicate host test proves duplicates are caught before policy evaluation
- New enforced deploy test proves full pipeline writes complete artifacts with per-host dispatch status
- New off-mode test proves no-execution path returns correct dispatch metadata
- `pwsh -NoProfile -Command "Invoke-Pester Tests/CoordinatorIntegration.Tests.ps1 -Output Detailed"` passes all tests
</validation>
