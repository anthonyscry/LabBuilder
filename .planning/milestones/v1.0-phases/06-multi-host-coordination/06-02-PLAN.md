---
phase: 06-multi-host-coordination
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Invoke-LabCoordinatorDispatch.ps1
  - Private/Resolve-LabDispatchMode.ps1
  - Tests/CoordinatorDispatch.Tests.ps1
  - Tests/DispatchMode.Tests.ps1
autonomous: true
requirements:
  - MH-02
  - MH-03

must_haves:
  truths:
    - "Invoke-LabCoordinatorDispatch validates TargetHosts is non-empty and throws if empty array is provided"
    - "Invoke-LabCoordinatorDispatch includes HostName in every host outcome even when dispatch mode is off"
    - "Invoke-LabCoordinatorDispatch reports partial outcome correctly when some hosts succeed and some fail in enforced mode"
    - "Invoke-LabCoordinatorDispatch in canary mode dispatches exactly the first eligible host and marks all others not_dispatched"
    - "Invoke-LabCoordinatorDispatch in enforced mode dispatches all hosts in order"
    - "Invoke-LabCoordinatorDispatch in off mode short-circuits immediately with no runner invocation"
    - "Invoke-LabCoordinatorDispatch handles runner returning non-boolean truthy values correctly"
    - "Resolve-LabDispatchMode supports config hashtable as third precedence source (parameter > env > config > default)"
    - "All existing CoordinatorDispatch.Tests.ps1 and DispatchMode.Tests.ps1 tests continue to pass"
    - "New tests cover empty targets validation, config-based mode resolution, and runner edge cases"
  artifacts:
    - path: "Private/Invoke-LabCoordinatorDispatch.ps1"
      provides: "Hardened dispatcher with input validation and deterministic outcomes"
    - path: "Private/Resolve-LabDispatchMode.ps1"
      provides: "Config-sourced dispatch mode resolution"
    - path: "Tests/CoordinatorDispatch.Tests.ps1"
      provides: "Tests covering new validation and edge cases"
    - path: "Tests/DispatchMode.Tests.ps1"
      provides: "Tests covering config-based resolution"
  key_links:
    - from: "Private/Invoke-LabCoordinatorDispatch.ps1"
      to: "Private/Test-LabTransientTransportFailure.ps1"
      via: "Dispatcher calls transient failure classifier to decide retry eligibility"
      pattern: "Test-LabTransientTransportFailure -Message"
    - from: "Private/Resolve-LabDispatchMode.ps1"
      to: "OpenCodeLab-App.ps1"
      via: "App resolves dispatch mode at startup before routing"
      pattern: "Resolve-LabDispatchMode"
---

<objective>
Harden coordinator dispatch routing and dispatch mode resolution to handle edge cases, validate inputs, and support config-file-based mode selection.

Purpose: The dispatcher accepts empty target host arrays without error (producing a confusing not_dispatched outcome with zero host outcomes). The dispatch mode resolver only supports parameter and environment variable sources, but the project's config system (Lab-Config.ps1) should be a third source. These gaps make the system fragile for operators who rely on config-driven workflows.

Output: Updated Invoke-LabCoordinatorDispatch.ps1 with input validation. Updated Resolve-LabDispatchMode.ps1 with config hashtable support. Updated tests for both.
</objective>

<execution_context>
- Invoke-LabCoordinatorDispatch.ps1 (179 lines) handles off/canary/enforced dispatch with retry logic
- No validation on TargetHosts emptiness -- empty array silently returns not_dispatched with 0 host outcomes
- Resolve-LabDispatchMode.ps1 (34 lines) resolves from parameter > env > default
- No config hashtable source exists yet
- Existing tests: 5 dispatcher tests, 7 mode tests -- all pass
</execution_context>

<changes>

## Change 1: Validate TargetHosts is non-empty

**File:** `Private/Invoke-LabCoordinatorDispatch.ps1`
**Location:** At the top of the function body, after line 33 (`$executionStartedAt = Get-Date`)

Add validation:
```powershell
$resolvedTargets = @($TargetHosts | Where-Object { -not [string]::IsNullOrWhiteSpace($_) })
if ($resolvedTargets.Count -eq 0) {
    throw "TargetHosts must contain at least one non-empty host name."
}
```

Then use `$resolvedTargets` instead of `$TargetHosts` throughout the function (in the for loop and the off-mode loop).

## Change 2: Add config hashtable parameter to Resolve-LabDispatchMode

**File:** `Private/Resolve-LabDispatchMode.ps1`
**Location:** Add a new parameter and resolution step

Add parameter:
```powershell
[Parameter()]
[hashtable]$Config
```

Add config resolution between env var check and the final validation (after the elseif for env var):
```powershell
elseif ($null -ne $Config -and $Config.ContainsKey('DispatchMode') -and -not [string]::IsNullOrWhiteSpace([string]$Config['DispatchMode'])) {
    $resolvedMode = ([string]$Config['DispatchMode']).Trim().ToLowerInvariant()
    $source = 'config'
}
```

## Change 3: Add empty targets test

**File:** `Tests/CoordinatorDispatch.Tests.ps1`

Add test:
```powershell
It 'throws when target hosts array is empty' {
    {
        Invoke-LabCoordinatorDispatch -Action 'deploy' -EffectiveMode 'quick' -DispatchMode 'enforced' -TargetHosts @()
    } | Should -Throw "*at least one*"
}

It 'throws when target hosts contain only whitespace' {
    {
        Invoke-LabCoordinatorDispatch -Action 'deploy' -EffectiveMode 'quick' -DispatchMode 'enforced' -TargetHosts @('', '  ')
    } | Should -Throw "*at least one*"
}

It 'handles runner returning string truthy value' {
    $result = Invoke-LabCoordinatorDispatch -Action 'deploy' -EffectiveMode 'quick' -DispatchMode 'enforced' -TargetHosts @('host-a') -HostStepRunner {
        param($HostName, $Action, $EffectiveMode, $Attempt)
        return 'completed'
    }

    $result.HostOutcomes[0].DispatchStatus | Should -Be 'succeeded'
}
```

## Change 4: Add config-based dispatch mode tests

**File:** `Tests/DispatchMode.Tests.ps1`

Add tests:
```powershell
It 'uses config value when neither parameter nor env var is provided' {
    $config = @{ DispatchMode = 'canary' }
    $result = Resolve-LabDispatchMode -Config $config

    $result.Mode | Should -Be 'canary'
    $result.Source | Should -Be 'config'
    $result.ExecutionEnabled | Should -BeTrue
}

It 'parameter takes precedence over config' {
    $config = @{ DispatchMode = 'canary' }
    $result = Resolve-LabDispatchMode -Mode 'off' -Config $config

    $result.Mode | Should -Be 'off'
    $result.Source | Should -Be 'parameter'
}

It 'environment takes precedence over config' {
    $env:OPENCODELAB_DISPATCH_MODE = 'enforced'
    $config = @{ DispatchMode = 'canary' }
    $result = Resolve-LabDispatchMode -Config $config

    $result.Mode | Should -Be 'enforced'
    $result.Source | Should -Be 'environment'
}
```

</changes>

<validation>
- All 5 existing CoordinatorDispatch.Tests.ps1 tests continue to pass
- All 7 existing DispatchMode.Tests.ps1 tests continue to pass
- New empty targets test validates fail-fast on empty input
- New whitespace-only targets test validates trimming/filtering
- New runner truthy test validates non-boolean return handling
- New config-based mode tests validate precedence chain
- `pwsh -NoProfile -Command "Invoke-Pester Tests/CoordinatorDispatch.Tests.ps1,Tests/DispatchMode.Tests.ps1 -Output Detailed"` passes all tests
</validation>
