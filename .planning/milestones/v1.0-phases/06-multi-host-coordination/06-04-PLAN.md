---
phase: 06-multi-host-coordination
plan: 04
type: execute
wave: 2
depends_on:
  - 06-01-PLAN
  - 06-02-PLAN
files_modified:
  - Private/Invoke-LabCoordinatorDispatch.ps1
  - Private/Get-LabFleetStateProbe.ps1
  - Private/Test-LabTransientTransportFailure.ps1
  - Tests/CoordinatorDispatch.Tests.ps1
  - Tests/TransientTransportFailure.Tests.ps1
  - Tests/FleetStateProbe.Tests.ps1
autonomous: true
requirements:
  - MH-05

must_haves:
  truths:
    - "Invoke-LabCoordinatorDispatch host outcomes include the host name and failure details when a remote operation fails"
    - "Invoke-LabCoordinatorDispatch distinguishes transient from non-transient failures in LastFailureClass"
    - "Invoke-LabCoordinatorDispatch retries transient transport failures up to MaxRetryCount and succeeds if a retry works"
    - "Invoke-LabCoordinatorDispatch does NOT retry non-transient failures (auth, scope mismatch, access denied)"
    - "Test-LabTransientTransportFailure classifies SSH connection refused as transient"
    - "Test-LabTransientTransportFailure classifies SSH host unreachable as transient"
    - "Test-LabTransientTransportFailure classifies 'cannot connect to the destination' as transient"
    - "Get-LabFleetStateProbe returns structured per-host failure messages when remote probe fails"
    - "Get-LabFleetStateProbe returns Reachable=false with Failure message for unreachable hosts"
    - "All existing tests continue to pass"
    - "New tests cover SSH transient patterns, fleet probe failure messages, and retry exhaustion"
  artifacts:
    - path: "Private/Invoke-LabCoordinatorDispatch.ps1"
      provides: "Clear per-host failure messages with host name, failure class, and failure detail"
    - path: "Private/Get-LabFleetStateProbe.ps1"
      provides: "Structured failure reporting for fleet connectivity issues"
    - path: "Private/Test-LabTransientTransportFailure.ps1"
      provides: "SSH transport failure pattern recognition"
    - path: "Tests/CoordinatorDispatch.Tests.ps1"
      provides: "Tests for retry exhaustion and failure message clarity"
    - path: "Tests/TransientTransportFailure.Tests.ps1"
      provides: "Tests for SSH transient failure patterns"
    - path: "Tests/FleetStateProbe.Tests.ps1"
      provides: "Tests for per-host failure message structure"
  key_links:
    - from: "Private/Invoke-LabCoordinatorDispatch.ps1"
      to: "Private/Test-LabTransientTransportFailure.ps1"
      via: "Dispatcher calls classifier to determine retry eligibility"
      pattern: "Test-LabTransientTransportFailure -Message"
    - from: "Private/Get-LabFleetStateProbe.ps1"
      to: "Private/Invoke-LabRemoteProbe.ps1"
      via: "Fleet probe delegates per-host probing to remote probe"
      pattern: "Invoke-LabRemoteProbe -HostName"
---

<objective>
Harden remote operation failure handling to produce clear, actionable error messages that identify which host failed and why, and extend transient failure classification to cover SSH transport patterns.

Purpose: When a remote operation fails, operators need to know exactly which host failed, whether it was a transient connectivity issue or a permanent error, and what the specific failure message was. The existing dispatcher already captures this data but the transient classifier lacks SSH patterns, and the fleet probe's failure messages could be more specific. This plan closes those gaps so operators can diagnose multi-host failures without guesswork.

Output: Extended transient classifier with SSH patterns. Enhanced fleet probe failure messages. Additional tests for retry exhaustion and SSH failure classification.
</objective>

<execution_context>
- Test-LabTransientTransportFailure.ps1 (20 lines) classifies WinRM/WSMan patterns but has no SSH patterns
- Get-LabFleetStateProbe.ps1 (121 lines) wraps Invoke-LabRemoteProbe per host and captures Failure as exception message string
- Invoke-LabCoordinatorDispatch.ps1 already records LastFailureClass and LastFailureMessage per host
- Existing tests: 12 transient classifier tests, 5 dispatcher tests, fleet probe test file exists
- SSH connection patterns: "Connection refused", "No route to host", "Connection timed out", "Host is unreachable"
</execution_context>

<changes>

## Change 1: Add SSH transient patterns to Test-LabTransientTransportFailure

**File:** `Private/Test-LabTransientTransportFailure.ps1`
**Location:** The final return statement regex pattern (line 19)

Extend the transient pattern to include SSH connection failures:

```powershell
return ($normalizedMessage -match '(?i)(winrm|wsman|timed?\s*out|timeout|cannot\s+connect\s+to\s+the\s+destination|destination\s+is\s+not\s+reachable|temporar(?:y|ily)\s+unavailable|connection\s+refused|no\s+route\s+to\s+host|host\s+is\s+unreachable|network\s+is\s+unreachable|ssh.*connection.*(?:reset|closed|abort))')
```

## Change 2: Add SSH non-transient patterns to the exclusion regex

**File:** `Private/Test-LabTransientTransportFailure.ps1`
**Location:** The non-transient exclusion regex (line 15)

Add SSH-specific non-transient patterns:

```powershell
# Add to the existing exclusion pattern:
|host\s+key\s+verification\s+failed|permission\s+denied\s+\(publickey|too\s+many\s+authentication\s+failures
```

## Change 3: Add SSH transient and non-transient test cases

**File:** `Tests/TransientTransportFailure.Tests.ps1`

Add to the transient test cases array:
```powershell
@{ Message = 'ssh: connect to host 10.0.0.5 port 22: Connection refused' },
@{ Message = 'ssh: connect to host 10.0.0.5 port 22: No route to host' },
@{ Message = 'ssh: connect to host 10.0.0.5 port 22: Host is unreachable' },
@{ Message = 'ssh: connect to host 10.0.0.5 port 22: Network is unreachable' },
@{ Message = 'ssh: connect to host 10.0.0.5 port 22: Connection timed out' }
```

Add to the non-transient test cases array:
```powershell
@{ Message = 'Host key verification failed.' },
@{ Message = 'Permission denied (publickey).' },
@{ Message = 'Received disconnect from 10.0.0.5 port 22:2: Too many authentication failures' }
```

## Change 4: Add retry exhaustion test to CoordinatorDispatch.Tests.ps1

**File:** `Tests/CoordinatorDispatch.Tests.ps1`

```powershell
It 'exhausts retries on persistent transient failure and reports failed with attempt count' {
    $result = Invoke-LabCoordinatorDispatch -Action 'deploy' -EffectiveMode 'quick' -DispatchMode 'enforced' -TargetHosts @('host-a') -MaxRetryCount 2 -RetryDelayMilliseconds 0 -HostStepRunner {
        param($HostName, $Action, $EffectiveMode, $Attempt)
        throw 'ssh: connect to host 10.0.0.5 port 22: Connection refused'
    }

    $hostOutcome = $result.HostOutcomes[0]
    $hostOutcome.DispatchStatus | Should -Be 'failed'
    $hostOutcome.AttemptCount | Should -Be 3
    $hostOutcome.LastFailureClass | Should -Be 'transient'
    $hostOutcome.LastFailureMessage | Should -BeLike '*Connection refused*'
    $result.ExecutionOutcome | Should -Be 'failed'
}

It 'does not retry non-transient auth failure and reports single attempt' {
    $result = Invoke-LabCoordinatorDispatch -Action 'deploy' -EffectiveMode 'quick' -DispatchMode 'enforced' -TargetHosts @('host-a') -MaxRetryCount 2 -RetryDelayMilliseconds 0 -HostStepRunner {
        param($HostName, $Action, $EffectiveMode, $Attempt)
        throw 'Access is denied.'
    }

    $hostOutcome = $result.HostOutcomes[0]
    $hostOutcome.DispatchStatus | Should -Be 'failed'
    $hostOutcome.AttemptCount | Should -Be 1
    $hostOutcome.LastFailureClass | Should -Be 'non_transient'
    $hostOutcome.LastFailureMessage | Should -Be 'Access is denied.'
}

It 'includes host name in every outcome even when all hosts fail' {
    $result = Invoke-LabCoordinatorDispatch -Action 'deploy' -EffectiveMode 'full' -DispatchMode 'enforced' -TargetHosts @('host-a', 'host-b') -HostStepRunner {
        param($HostName, $Action, $EffectiveMode, $Attempt)
        throw "Failed on $HostName"
    }

    @($result.HostOutcomes).Count | Should -Be 2
    $result.HostOutcomes[0].HostName | Should -Be 'host-a'
    $result.HostOutcomes[0].LastFailureMessage | Should -Be 'Failed on host-a'
    $result.HostOutcomes[1].HostName | Should -Be 'host-b'
    $result.HostOutcomes[1].LastFailureMessage | Should -Be 'Failed on host-b'
    $result.ExecutionOutcome | Should -Be 'failed'
}
```

## Change 5: Add fleet probe failure message tests

**File:** `Tests/FleetStateProbe.Tests.ps1`

Add or update tests to verify structured failure output:

```powershell
It 'returns structured failure when remote probe throws' {
    Mock Invoke-LabRemoteProbe {
        throw "Remote probe failed for host 'hv-fail': WinRM cannot complete the operation."
    }

    $results = Get-LabFleetStateProbe -HostNames @('hv-fail')

    @($results).Count | Should -Be 1
    $results[0].HostName | Should -Be 'hv-fail'
    $results[0].Reachable | Should -BeFalse
    $results[0].Probe | Should -BeNullOrEmpty
    $results[0].Failure | Should -BeLike "*hv-fail*WinRM*"
}

It 'returns mixed results for fleet with one reachable and one unreachable host' {
    Mock Invoke-LabRemoteProbe {
        param($HostName, $ScriptBlock, $ArgumentList)
        if ($HostName -eq 'hv-ok') {
            return [pscustomobject]@{
                LabRegistered = $true
                MissingVMs = @()
                LabReadyAvailable = $true
                SwitchPresent = $true
                NatPresent = $true
            }
        }
        throw "Remote probe failed for host 'hv-down': Connection refused"
    }

    $results = Get-LabFleetStateProbe -HostNames @('hv-ok', 'hv-down')

    @($results).Count | Should -Be 2
    ($results | Where-Object { $_.HostName -eq 'hv-ok' }).Reachable | Should -BeTrue
    ($results | Where-Object { $_.HostName -eq 'hv-down' }).Reachable | Should -BeFalse
    ($results | Where-Object { $_.HostName -eq 'hv-down' }).Failure | Should -BeLike "*hv-down*Connection refused*"
}
```

</changes>

<validation>
- All existing TransientTransportFailure.Tests.ps1 tests continue to pass
- All existing CoordinatorDispatch.Tests.ps1 tests continue to pass
- New SSH transient tests confirm Connection refused, No route to host, Host is unreachable are classified as transient
- New SSH non-transient tests confirm host key verification failure and permission denied are not retried
- New retry exhaustion test proves 3 attempts are made and final state is failed with transient class
- New auth failure test proves single attempt with non_transient class
- New host name in outcome test proves every outcome carries the specific host name
- New fleet probe tests prove per-host structured failure messages
- `pwsh -NoProfile -Command "Invoke-Pester Tests/TransientTransportFailure.Tests.ps1,Tests/CoordinatorDispatch.Tests.ps1,Tests/FleetStateProbe.Tests.ps1 -Output Detailed"` passes all tests
</validation>
