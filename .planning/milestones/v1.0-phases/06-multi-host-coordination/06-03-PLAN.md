---
phase: 06-multi-host-coordination
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Test-LabScopedConfirmationToken.ps1
  - Private/New-LabScopedConfirmationToken.ps1
  - Tests/ScopedConfirmationToken.Tests.ps1
autonomous: true
requirements:
  - MH-04

must_haves:
  truths:
    - "Test-LabScopedConfirmationToken returns specific reason for each failure type: malformed_token, bad_signature, token_expired, run_scope_mismatch, host_scope_mismatch, operation_scope_mismatch"
    - "Test-LabScopedConfirmationToken validates that a token scoped to host-a,host-b rejects validation against host-a,host-b,host-c"
    - "Test-LabScopedConfirmationToken validates that a token scoped to 3 hosts rejects a subset of 2 hosts"
    - "New-LabScopedConfirmationToken normalizes host names to lowercase and sorts for deterministic comparison"
    - "Token validation uses constant-time comparison for signature bytes"
    - "Token with hosts in different order still validates (normalization handles ordering)"
    - "All existing ScopedConfirmationToken.Tests.ps1 tests continue to pass"
    - "New tests cover per-host subset/superset rejection, host ordering normalization, and zero-TTL edge case"
  artifacts:
    - path: "Private/Test-LabScopedConfirmationToken.ps1"
      provides: "Per-host scoped validation with clear rejection reasons"
    - path: "Private/New-LabScopedConfirmationToken.ps1"
      provides: "Deterministic token generation with normalized host sets"
    - path: "Tests/ScopedConfirmationToken.Tests.ps1"
      provides: "Tests covering per-host safety gate scenarios"
  key_links:
    - from: "Private/Test-LabScopedConfirmationToken.ps1"
      to: "Private/Resolve-LabCoordinatorPolicy.ps1"
      via: "Policy engine checks HasScopedConfirmation which is derived from token validation"
      pattern: "HasScopedConfirmation"
    - from: "Private/New-LabScopedConfirmationToken.ps1"
      to: "Scripts/New-ScopedConfirmationToken.ps1"
      via: "CLI script wraps the Private helper for operator use"
      pattern: "New-LabScopedConfirmationToken"
---

<objective>
Harden scoped confirmation token validation to ensure per-host safety gates reject tokens that do not exactly match the target host set, and add edge-case coverage.

Purpose: The existing token system correctly validates run scope, host scope, and operation scope, but the test suite does not verify that partial host matches (subset or superset) are properly rejected. Since tokens are the safety gate for destructive multi-host operations, thorough edge-case testing is critical. The existing code already handles this correctly (host normalization sorts and joins for comparison), but the test suite needs to prove it for each specific scenario.

Output: Additional tests for per-host scope boundary conditions. Minor documentation-quality improvements to existing validation code.
</objective>

<execution_context>
- New-LabScopedConfirmationToken.ps1 (76 lines) generates HMAC-SHA256 signed tokens with v1 format
- Test-LabScopedConfirmationToken.ps1 (168 lines) validates tokens with constant-time signature comparison
- Host normalization: lowercase, trim, sort, unique, join with comma for comparison
- Existing tests (5 tests): valid token, scope mismatches (run/hosts/operation), expired, malformed, bad signature
- Token format: v1.<base64url-payload>.<base64url-signature>
</execution_context>

<changes>

## Change 1: Add per-host subset and superset rejection tests

**File:** `Tests/ScopedConfirmationToken.Tests.ps1`

Add tests after the existing scope mismatch test:

```powershell
It 'rejects token when validation target has extra hosts (token is subset)' {
    $secret = 'test-secret-subset'
    $token = New-LabScopedConfirmationToken -RunId 'run-sub' -TargetHosts @('hv-01', 'hv-02') -OperationHash 'op-sub' -Secret $secret -TtlSeconds 300

    $result = Test-LabScopedConfirmationToken -Token $token -RunId 'run-sub' -TargetHosts @('hv-01', 'hv-02', 'hv-03') -OperationHash 'op-sub' -Secret $secret

    $result.Valid | Should -BeFalse
    $result.Reason | Should -Be 'host_scope_mismatch'
}

It 'rejects token when validation target is missing hosts (token is superset)' {
    $secret = 'test-secret-superset'
    $token = New-LabScopedConfirmationToken -RunId 'run-sup' -TargetHosts @('hv-01', 'hv-02', 'hv-03') -OperationHash 'op-sup' -Secret $secret -TtlSeconds 300

    $result = Test-LabScopedConfirmationToken -Token $token -RunId 'run-sup' -TargetHosts @('hv-01', 'hv-02') -OperationHash 'op-sup' -Secret $secret

    $result.Valid | Should -BeFalse
    $result.Reason | Should -Be 'host_scope_mismatch'
}
```

## Change 2: Add host ordering normalization test

**File:** `Tests/ScopedConfirmationToken.Tests.ps1`

```powershell
It 'validates successfully when hosts are provided in different order' {
    $secret = 'test-secret-order'
    $token = New-LabScopedConfirmationToken -RunId 'run-ord' -TargetHosts @('hv-03', 'hv-01', 'hv-02') -OperationHash 'op-ord' -Secret $secret -TtlSeconds 300

    $result = Test-LabScopedConfirmationToken -Token $token -RunId 'run-ord' -TargetHosts @('hv-02', 'hv-03', 'hv-01') -OperationHash 'op-ord' -Secret $secret

    $result.Valid | Should -BeTrue
    $result.Reason | Should -Be 'valid'
}
```

## Change 3: Add case-insensitive host matching test

**File:** `Tests/ScopedConfirmationToken.Tests.ps1`

```powershell
It 'validates successfully when hosts differ in casing' {
    $secret = 'test-secret-case'
    $token = New-LabScopedConfirmationToken -RunId 'run-case' -TargetHosts @('HV-01', 'HV-02') -OperationHash 'op-case' -Secret $secret -TtlSeconds 300

    $result = Test-LabScopedConfirmationToken -Token $token -RunId 'run-case' -TargetHosts @('hv-01', 'hv-02') -OperationHash 'op-case' -Secret $secret

    $result.Valid | Should -BeTrue
    $result.Reason | Should -Be 'valid'
}
```

## Change 4: Add single-host token test

**File:** `Tests/ScopedConfirmationToken.Tests.ps1`

```powershell
It 'validates a single-host token correctly' {
    $secret = 'test-secret-single'
    $token = New-LabScopedConfirmationToken -RunId 'run-single' -TargetHosts @('hv-01') -OperationHash 'op-single' -Secret $secret -TtlSeconds 300

    $result = Test-LabScopedConfirmationToken -Token $token -RunId 'run-single' -TargetHosts @('hv-01') -OperationHash 'op-single' -Secret $secret

    $result.Valid | Should -BeTrue
    $result.Reason | Should -Be 'valid'
}
```

## Change 5: Add tampered payload test

**File:** `Tests/ScopedConfirmationToken.Tests.ps1`

```powershell
It 'rejects token with tampered payload' {
    $secret = 'test-secret-tamper'
    $token = New-LabScopedConfirmationToken -RunId 'run-tamper' -TargetHosts @('hv-01') -OperationHash 'op-tamper' -Secret $secret -TtlSeconds 300

    # Flip a character in the payload portion
    $parts = $token -split '\.'
    $tamperedPayload = $parts[1].Substring(0, $parts[1].Length - 1) + 'X'
    $tamperedToken = '{0}.{1}.{2}' -f $parts[0], $tamperedPayload, $parts[2]

    $result = Test-LabScopedConfirmationToken -Token $tamperedToken -RunId 'run-tamper' -TargetHosts @('hv-01') -OperationHash 'op-tamper' -Secret $secret

    $result.Valid | Should -BeFalse
    $result.Reason | Should -Be 'bad_signature'
}
```

</changes>

<validation>
- All 5 existing ScopedConfirmationToken.Tests.ps1 tests continue to pass
- Subset rejection test proves token scoped to 2 hosts rejects validation against 3 hosts
- Superset rejection test proves token scoped to 3 hosts rejects validation against 2 hosts
- Ordering normalization test proves host order does not affect validation
- Case-insensitive test proves casing does not affect validation
- Single-host test proves simplest case works
- Tampered payload test proves signature verification catches modifications
- `pwsh -NoProfile -Command "Invoke-Pester Tests/ScopedConfirmationToken.Tests.ps1 -Output Detailed"` passes all tests
</validation>
