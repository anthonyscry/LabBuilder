---
phase: 06-multi-host-coordination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Get-LabHostInventory.ps1
  - Tests/HostInventory.Tests.ps1
autonomous: true
requirements:
  - MH-01

must_haves:
  truths:
    - "Get-LabHostInventory rejects duplicate host names within a single inventory file with a clear error citing the duplicate name and index"
    - "Get-LabHostInventory validates connection field against allowed values: local, winrm, ssh, psremoting"
    - "Get-LabHostInventory defaults connection to 'local' when field is empty or missing"
    - "Get-LabHostInventory defaults role to 'secondary' when field is empty or missing and at least one host already has role set"
    - "Get-LabHostInventory rejects inventory with empty hosts array with error 'hosts array is empty'"
    - "Get-LabHostInventory trims whitespace from name, role, and connection fields"
    - "Get-LabHostInventory rejects inventory where hosts property is not an array"
    - "All existing HostInventory.Tests.ps1 tests continue to pass"
    - "New validation tests cover duplicate names, connection validation, empty hosts, and defaults"
  artifacts:
    - path: "Private/Get-LabHostInventory.ps1"
      provides: "Hardened inventory loading with duplicate detection, field validation, and defensive defaults"
    - path: "Tests/HostInventory.Tests.ps1"
      provides: "Tests covering all new validation paths"
  key_links:
    - from: "Private/Get-LabHostInventory.ps1"
      to: "Private/Resolve-LabOperationIntent.ps1"
      via: "Resolve-LabOperationIntent calls Get-LabHostInventory to resolve the target host set"
      pattern: "Get-LabHostInventory -InventoryPath"
---

<objective>
Harden host inventory loading and validation to reject malformed, duplicate, or invalid host entries before they reach the coordinator pipeline.

Purpose: The existing Get-LabHostInventory loads and normalizes JSON inventory files but does not validate field values or detect duplicates. A typo in connection type or a copy-paste duplicate host name would silently pass through and cause confusing failures downstream in dispatch or remote probe. This plan adds fail-fast validation at the inventory layer so errors are caught early with clear messages.

Output: Updated Get-LabHostInventory.ps1 with validation logic. Updated HostInventory.Tests.ps1 with tests for all new validation paths.
</objective>

<execution_context>
- Private/Get-LabHostInventory.ps1 normalizes hosts from JSON at lines 78-96 but only validates name is non-empty
- Connection and role fields are accepted as-is without validation
- No duplicate name detection exists
- Empty hosts array passes silently (returns empty Hosts property)
- Existing tests (6 tests) cover happy path, filtering, and error handling for missing/malformed JSON
</execution_context>

<changes>

## Change 1: Add duplicate host name detection

**File:** `Private/Get-LabHostInventory.ps1`
**Location:** Inside the `for` loop at line 80, after validating name is non-empty (line 85)

Add a seen-names tracking set before the loop and a duplicate check inside:

Before the loop (after line 79):
```powershell
$seenNames = [System.Collections.Generic.HashSet[string]]::new([System.StringComparer]::OrdinalIgnoreCase)
```

Inside the loop, after the name trim (after line 85):
```powershell
$trimmedName = $name.Trim()
if (-not $seenNames.Add($trimmedName)) {
    throw "Invalid inventory JSON in '$InventoryPath': duplicate host name '$trimmedName' at hosts[$index]."
}
```

## Change 2: Add connection field validation with default

**File:** `Private/Get-LabHostInventory.ps1`
**Location:** Inside the `for` loop, after building the host object (around line 91)

Replace the simple connection assignment with validation:

```powershell
$allowedConnections = @('local', 'winrm', 'ssh', 'psremoting')
$rawConnection = ([string]$hostEntry.connection).Trim()
if ([string]::IsNullOrWhiteSpace($rawConnection)) {
    $rawConnection = 'local'
}
$connectionLower = $rawConnection.ToLowerInvariant()
if ($allowedConnections -notcontains $connectionLower) {
    throw "Invalid inventory JSON in '$InventoryPath': hosts[$index].connection value '$rawConnection' is not supported. Allowed: $($allowedConnections -join ', ')."
}
```

Then use `$connectionLower` as the Connection value in the host object.

## Change 3: Default role when empty

**File:** `Private/Get-LabHostInventory.ps1`
**Location:** Inside the `for` loop, role assignment

Replace the simple role assignment with:

```powershell
$rawRole = ([string]$hostEntry.role).Trim()
if ([string]::IsNullOrWhiteSpace($rawRole)) {
    $rawRole = if ($index -eq 0) { 'primary' } else { 'secondary' }
}
```

Then use `$rawRole` as the Role value in the host object.

## Change 4: Reject empty hosts array

**File:** `Private/Get-LabHostInventory.ps1`
**Location:** After line 79 (`$rawHosts = @($parsedInventory.hosts)`)

Add:
```powershell
if ($rawHosts.Count -eq 0) {
    throw "Invalid inventory JSON in '$InventoryPath': hosts array is empty."
}
```

## Change 5: Add validation tests

**File:** `Tests/HostInventory.Tests.ps1`

Add these test cases after the existing tests:

```powershell
It 'rejects duplicate host names' {
    $inventoryPath = Join-Path $TestDrive 'dup-inventory.json'
    @'
{
  "hosts": [
    { "name": "HV-01", "role": "primary", "connection": "winrm" },
    { "name": "hv-01", "role": "secondary", "connection": "ssh" }
  ]
}
'@ | Set-Content -LiteralPath $inventoryPath -Encoding UTF8

    {
        Get-LabHostInventory -InventoryPath $inventoryPath
    } | Should -Throw "*duplicate host name*HV-01*"
}

It 'rejects invalid connection type' {
    $inventoryPath = Join-Path $TestDrive 'bad-connection-inventory.json'
    @'
{
  "hosts": [
    { "name": "HV-01", "role": "primary", "connection": "telnet" }
  ]
}
'@ | Set-Content -LiteralPath $inventoryPath -Encoding UTF8

    {
        Get-LabHostInventory -InventoryPath $inventoryPath
    } | Should -Throw "*connection value*telnet*not supported*"
}

It 'defaults connection to local when missing' {
    $inventoryPath = Join-Path $TestDrive 'no-connection-inventory.json'
    @'
{
  "hosts": [
    { "name": "HV-01", "role": "primary" }
  ]
}
'@ | Set-Content -LiteralPath $inventoryPath -Encoding UTF8

    $result = Get-LabHostInventory -InventoryPath $inventoryPath

    $result.Hosts[0].Connection | Should -Be 'local'
}

It 'defaults role to primary for first host and secondary for subsequent' {
    $inventoryPath = Join-Path $TestDrive 'no-role-inventory.json'
    @'
{
  "hosts": [
    { "name": "HV-01", "connection": "winrm" },
    { "name": "HV-02", "connection": "ssh" }
  ]
}
'@ | Set-Content -LiteralPath $inventoryPath -Encoding UTF8

    $result = Get-LabHostInventory -InventoryPath $inventoryPath

    $result.Hosts[0].Role | Should -Be 'primary'
    $result.Hosts[1].Role | Should -Be 'secondary'
}

It 'rejects empty hosts array' {
    $inventoryPath = Join-Path $TestDrive 'empty-hosts-inventory.json'
    @'
{
  "hosts": []
}
'@ | Set-Content -LiteralPath $inventoryPath -Encoding UTF8

    {
        Get-LabHostInventory -InventoryPath $inventoryPath
    } | Should -Throw "*hosts array is empty*"
}

It 'normalizes connection type to lowercase' {
    $inventoryPath = Join-Path $TestDrive 'case-connection-inventory.json'
    @'
{
  "hosts": [
    { "name": "HV-01", "role": "primary", "connection": "WinRM" }
  ]
}
'@ | Set-Content -LiteralPath $inventoryPath -Encoding UTF8

    $result = Get-LabHostInventory -InventoryPath $inventoryPath

    $result.Hosts[0].Connection | Should -Be 'winrm'
}
```

</changes>

<validation>
- All 6 existing HostInventory.Tests.ps1 tests continue to pass unchanged
- New duplicate name test catches case-insensitive duplicates
- New connection validation test rejects unsupported connection types
- New default connection test verifies 'local' fallback
- New default role test verifies primary/secondary defaults
- New empty hosts test rejects empty array
- New normalization test confirms lowercase output
- `pwsh -NoProfile -Command "Invoke-Pester Tests/HostInventory.Tests.ps1 -Output Detailed"` passes all tests
</validation>
