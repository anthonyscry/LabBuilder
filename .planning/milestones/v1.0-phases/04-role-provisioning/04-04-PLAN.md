---
phase: 04-role-provisioning
plan: 04
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - LabBuilder/Roles/Ubuntu.ps1
  - LabBuilder/Roles/LinuxRoleBase.ps1
  - LabBuilder/Roles/WebServer.Ubuntu.ps1
  - LabBuilder/Roles/Database.Ubuntu.ps1
  - LabBuilder/Roles/Docker.Ubuntu.ps1
  - LabBuilder/Roles/K8s.Ubuntu.ps1
  - Tests/LabBuilderRoles.Tests.ps1
autonomous: true
requirements:
  - ROLE-11

must_haves:
  truths:
    - "Linux role scripts don't crash if called with missing config"
    - "LinuxRoleBase.ps1 has null-guard on config parameters"
    - "All 5 Linux role files parse without syntax errors"
    - "Linux role tests validate graceful handling of missing config"
  artifacts:
    - path: "LabBuilder/Roles/Ubuntu.ps1"
      provides: "Null-guard on config access"
    - path: "LabBuilder/Roles/LinuxRoleBase.ps1"
      provides: "Null-guards on LabConfig property access"
    - path: "Tests/LabBuilderRoles.Tests.ps1"
      provides: "Additional tests for Linux role null-safety"
  key_links:
    - from: "LabBuilder/Roles/LinuxRoleBase.ps1"
      to: "LabBuilder/Build-LabFromSelection.ps1"
      via: "CreateVM and PostInstall scriptblocks"
      pattern: "Invoke-LinuxRoleCreateVM"
---

<objective>
Add null-guards to Linux role scripts to prevent crashes if called with incomplete config. Add Linux role syntax tests.

Purpose: Per project decision, Linux VMs are deprioritized but the code should not crash if invoked. Currently, LinuxRoleBase.ps1 accesses `$LabConfig.Linux.User`, `$LabConfig.Linux.SSHPublicKey`, `$LabConfig.Timeouts.*` etc. without null checks. If these config sections don't exist, the scripts throw unclear errors.

Output: Defensive Linux role scripts that fail gracefully with clear messages.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-role-provisioning/04-RESEARCH.md
@LabBuilder/Roles/LinuxRoleBase.ps1
@LabBuilder/Roles/Ubuntu.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add null-guards to LinuxRoleBase.ps1 and all Linux role scripts</name>
  <files>
    LabBuilder/Roles/LinuxRoleBase.ps1
    LabBuilder/Roles/Ubuntu.ps1
    LabBuilder/Roles/WebServer.Ubuntu.ps1
    LabBuilder/Roles/Database.Ubuntu.ps1
    LabBuilder/Roles/Docker.Ubuntu.ps1
    LabBuilder/Roles/K8s.Ubuntu.ps1
  </files>
  <action>
**LinuxRoleBase.ps1 — Invoke-LinuxRoleCreateVM:** Add null-guards at function entry:
1. Check `$LabConfig.VMNames` contains key `$VMNameKey`: if not, Write-Warning "VM name key '$VMNameKey' not found in config VMNames. Skipping Linux VM creation." and return.
2. Check `$LabConfig.LabSourcesRoot` is not null: if null, Write-Warning "LabSourcesRoot not configured. Skipping Linux VM creation." and return.
3. Check `$LabConfig.Linux` section exists: if null, Write-Warning "Linux config section not found. Skipping Linux VM creation." and return.
4. Check `$LabConfig.Timeouts` section exists: if null, set defaults: `$waitMinutes = 10; $pollInterval = 15; $pollMax = 60` instead of throwing.

**LinuxRoleBase.ps1 — Invoke-LinuxRolePostInstall:** Add null-guards:
1. Check `$LabConfig.VMNames` contains `$VMNameKey`
2. Check `$LabConfig.Linux.User` is not null (if null, Write-Warning and return)
3. Check `$LabConfig.Linux.SSHPrivateKey` path validation already exists (line 113) — this is good, keep it
4. Wrap the entire try/catch body more tightly — the current catch on line 137 only catches the SSH execution, not the adapter lookup. Extend the try block to start at the adapter lookup.

**Ubuntu.ps1 and other Linux role files (WebServer.Ubuntu.ps1, Database.Ubuntu.ps1, Docker.Ubuntu.ps1, K8s.Ubuntu.ps1):** Each has a Get-LabRole_* function that accesses `$Config.VMNames.*`, `$Config.LinuxOS`, `$Config.LinuxVM.*`, `$Config.IPPlan.*`. Add a guard at the top of each function:
```powershell
if (-not $Config.ContainsKey('LinuxVM') -or -not $Config.LinuxVM) {
    Write-Warning "Linux VM configuration not found. Skipping role definition for $($Config.VMNames.Ubuntu // 'Ubuntu')."
    return @{ Tag = 'Ubuntu'; VMName = ''; SkipInstallLab = $true; IsLinux = $true; Roles = @(); PostInstall = $null; CreateVM = $null }
}
```
This returns a stub role definition that Build-LabFromSelection can safely skip rather than throwing.

Keep changes minimal — these are deprioritized. Focus on preventing crashes, not improving functionality.
  </action>
  <verify>Parse all 6 files with PowerShell parser. Verify no syntax errors.</verify>
  <done>All Linux role scripts handle missing config gracefully with Write-Warning instead of throwing. LinuxRoleBase functions validate config before accessing properties.</done>
</task>

<task type="auto">
  <name>Task 2: Add Linux role syntax and null-safety tests to existing test file</name>
  <files>Tests/LabBuilderRoles.Tests.ps1</files>
  <action>
Add a new Describe block to the existing `Tests/LabBuilderRoles.Tests.ps1` (created in plan 04-01):

**Linux role syntax tests:** Parse all 6 Linux role files (Ubuntu.ps1, WebServer.Ubuntu.ps1, Database.Ubuntu.ps1, Docker.Ubuntu.ps1, K8s.Ubuntu.ps1, LinuxRoleBase.ps1) with the PowerShell parser to confirm no syntax errors.

**Linux role null-safety tests:** For each Linux role function (Get-LabRole_Ubuntu, Get-LabRole_WebServerUbuntu, etc.):
1. Dot-source the file
2. Call the function with a minimal config missing the LinuxVM section
3. Verify it does NOT throw (Should -Not -Throw)
4. Verify the result has `SkipInstallLab = $true` (stub role)

**LinuxRoleBase null-safety tests:**
1. Dot-source LinuxRoleBase.ps1
2. Call Invoke-LinuxRoleCreateVM with a config missing VMNames key — verify Write-Warning was called (mock Write-Warning) and function returns without error
3. Call Invoke-LinuxRolePostInstall with a config missing Linux section — verify Write-Warning and early return

Mock all external commands: Get-ChildItem, Get-VMNetworkAdapter, Start-VM, Test-NetConnection, etc.
  </action>
  <verify>Run `pwsh -Command "Invoke-Pester Tests/LabBuilderRoles.Tests.ps1 -Output Detailed"` — all tests pass including new Linux tests.</verify>
  <done>Linux role scripts have syntax tests and null-safety tests confirming they don't crash with missing config.</done>
</task>

</tasks>

<verification>
1. All 6 Linux role files parse without syntax errors
2. Linux role functions return stub definitions when config is incomplete
3. LinuxRoleBase functions return early with warnings on missing config
4. No existing tests broken
5. All new tests pass
</verification>

<success_criteria>
- Linux role scripts don't crash when called with incomplete config
- LinuxRoleBase validates config before accessing properties
- Null-guards use Write-Warning (not throw) for graceful degradation
- Tests confirm null-safety behavior
- Changes are minimal — deprioritized per project decision
</success_criteria>

<output>
After completion, create `.planning/phases/04-role-provisioning/04-04-SUMMARY.md`
</output>
