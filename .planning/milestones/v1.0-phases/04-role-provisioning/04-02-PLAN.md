---
phase: 04-role-provisioning
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - LabBuilder/Roles/DC.ps1
  - LabBuilder/Roles/SQL.ps1
  - LabBuilder/Roles/IIS.ps1
  - LabBuilder/Roles/WSUS.ps1
  - LabBuilder/Roles/PrintServer.ps1
  - LabBuilder/Roles/Jumpbox.ps1
autonomous: true
requirements:
  - ROLE-01
  - ROLE-02
  - ROLE-03
  - ROLE-04
  - ROLE-07
  - ROLE-09
  - ROLE-11

must_haves:
  truths:
    - "DC PostInstall has try-catch with role-specific error context"
    - "SQL PostInstall verifies SQL Server service is running after install"
    - "IIS PostInstall verifies W3SVC service is running after install"
    - "WSUS PostInstall verifies WsusService is running after install"
    - "PrintServer PostInstall verifies Spooler service after install"
    - "Jumpbox PostInstall handles RSAT install failures gracefully"
    - "All six role scripts have top-level try-catch in PostInstall"
  artifacts:
    - path: "LabBuilder/Roles/DC.ps1"
      provides: "Error handling wrapper on PostInstall, DNS service verification"
    - path: "LabBuilder/Roles/SQL.ps1"
      provides: "Post-install service verification, config prerequisite check"
    - path: "LabBuilder/Roles/IIS.ps1"
      provides: "Post-install W3SVC verification"
    - path: "LabBuilder/Roles/WSUS.ps1"
      provides: "Post-install WsusService verification, config prerequisite check"
    - path: "LabBuilder/Roles/PrintServer.ps1"
      provides: "Post-install Spooler verification"
    - path: "LabBuilder/Roles/Jumpbox.ps1"
      provides: "Graceful RSAT failure handling with summary"
  key_links:
    - from: "LabBuilder/Roles/DC.ps1"
      to: "Build-LabFromSelection.ps1"
      via: "PostInstall scriptblock returning structured result"
      pattern: "try.*catch.*Write-Warning"
---

<objective>
Add try-catch error handling and post-install verification to DC, SQL, IIS, WSUS, PrintServer, and Jumpbox role scripts.

Purpose: Currently if a PostInstall scriptblock throws, the error propagates to Build-LabFromSelection.ps1 where it gets a generic "Post-install failed" message with no role-specific context. Each role should catch its own errors, provide role-specific diagnostics, and verify the installed service is actually running.

Output: Six hardened role scripts with consistent error handling and post-install verification patterns.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-role-provisioning/04-RESEARCH.md
@LabBuilder/Roles/DC.ps1
@LabBuilder/Roles/SQL.ps1
@LabBuilder/Roles/IIS.ps1
@LabBuilder/Roles/WSUS.ps1
@LabBuilder/Roles/PrintServer.ps1
@LabBuilder/Roles/Jumpbox.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error handling and verification to DC, SQL, and IIS roles</name>
  <files>
    LabBuilder/Roles/DC.ps1
    LabBuilder/Roles/SQL.ps1
    LabBuilder/Roles/IIS.ps1
  </files>
  <action>
**DC.ps1:** The PostInstall already has good verification (NTDS + ADWS check). Add:
1. Wrap the entire PostInstall body in try-catch. On catch, Write-Warning with role-specific context: "DC role post-install failed on $dcName`: $($_.Exception.Message). Check: AD DS features installed, VM has network connectivity, DNS server service started."
2. Add DNS service check alongside NTDS and ADWS: verify the DNS service is running (`Get-Service DNS`). If DNS is not running, Write-Warning specifically about DNS.
3. The existing Write-Warning for failed ADWS/NTDS is good — keep it but also add suggested troubleshooting: "Run on DC: Get-Service NTDS,ADWS,DNS | Format-Table Name,Status"

**SQL.ps1:** Add:
1. Wrap the entire PostInstall body in try-catch. On catch: "SQL role post-install failed on $($LabConfig.VMNames.SQL): $($_.Exception.Message). Check: SQL ISO mounted, installation media accessible, SA account configuration."
2. Add config prerequisite check at PostInstall start: verify `$LabConfig.SQL` exists. If missing, Write-Warning "SQL config section not found in config. SA password will not be configured." (don't return — SQL install via AutomatedLab role still works without PostInstall config, the PostInstall just configures SA).
3. After the SA password configuration (or skip), add service verification: Use Invoke-LabCommand to check that the SQL Server service is running. The service name depends on instance: default instance = 'MSSQLSERVER', named instance = 'MSSQL$InstanceName'. Write-Warning if service not running with troubleshooting hint.

**IIS.ps1:** Add:
1. Wrap the entire PostInstall body in try-catch. On catch: "IIS role post-install failed on $($LabConfig.VMNames.IIS): $($_.Exception.Message). Check: Web-Server feature available, VM has sufficient disk space."
2. After the existing Invoke-LabCommand, add a verification step: Use Invoke-LabCommand to check that `W3SVC` (World Wide Web Publishing Service) is running. If not running, Write-Warning with troubleshooting: "Run on IIS VM: Get-Service W3SVC | Format-Table Name,Status"

For all three: Use this consistent error handling pattern in PostInstall:
```powershell
PostInstall = {
    param([hashtable]$LabConfig)
    try {
        # ... existing code ...

        # Verification step
        $verifyResult = Invoke-LabCommand -ComputerName $vmName -ActivityName 'RoleName-Verify-Services' -PassThru -ScriptBlock {
            $svc = Get-Service ServiceName -ErrorAction SilentlyContinue
            @{ Running = ($null -ne $svc -and $svc.Status -eq 'Running') }
        }
        if (-not $verifyResult.Running) {
            Write-Warning "RoleName: ServiceName is not running after installation. Troubleshooting: ..."
        } else {
            Write-Host '    [OK] ServiceName verified running.' -ForegroundColor Green
        }
    }
    catch {
        Write-Warning "RoleName role post-install failed on $vmName: $($_.Exception.Message). Check: ..."
    }
}
```
  </action>
  <verify>Parse each file with PowerShell parser to confirm no syntax errors. Grep for 'try' and 'catch' in each file to confirm error handling exists.</verify>
  <done>DC, SQL, and IIS PostInstall scriptblocks have try-catch wrappers and post-install service verification. Error messages include role-specific context and troubleshooting hints.</done>
</task>

<task type="auto">
  <name>Task 2: Add error handling and verification to WSUS, PrintServer, and Jumpbox roles</name>
  <files>
    LabBuilder/Roles/WSUS.ps1
    LabBuilder/Roles/PrintServer.ps1
    LabBuilder/Roles/Jumpbox.ps1
  </files>
  <action>
**WSUS.ps1:** Add:
1. Wrap entire PostInstall body in try-catch. On catch: "WSUS role post-install failed on $($LabConfig.VMNames.WSUS): $($_.Exception.Message). Check: UpdateServices feature available, sufficient disk space for WSUS content directory."
2. Add config prerequisite check: verify `$LabConfig.WSUS` exists (but don't fail — use defaults as the script already does).
3. After the existing Invoke-LabCommand, add verification: Use Invoke-LabCommand to check WsusService is running. If not, Write-Warning with troubleshooting.

**PrintServer.ps1:** Add:
1. Wrap entire PostInstall body in try-catch. On catch: "PrintServer role post-install failed on $($LabConfig.VMNames.PrintServer): $($_.Exception.Message). Check: Print-Server feature available."
2. After the existing verification Invoke-LabCommand (which already checks Print-Server feature), add Spooler service check: Verify the Spooler service is running. The existing verification throws on feature not installed — this is good but should be wrapped in the outer try-catch.
3. Move the `Write-Host "    [OK] Print Server installed..."` inside the try block so it only prints on success.

**Jumpbox.ps1:** Add:
1. Wrap entire PostInstall body in try-catch. On catch: "Jumpbox role post-install failed on $($LabConfig.VMNames.Jumpbox): $($_.Exception.Message). Check: Windows capability service running, internet connectivity for RSAT download."
2. The existing per-capability try-catch inside the ScriptBlock is good (individual RSAT capabilities can fail without failing the whole role). Add a summary after the loop: count how many capabilities installed successfully vs failed, Write-Host the summary.
3. After the Invoke-LabCommand, add verification: Use Invoke-LabCommand to check RDP is accessible (verify the registry key was set correctly). Write the RDP status.

For all three, follow the same consistent pattern as Task 1.
  </action>
  <verify>Parse each file with PowerShell parser. Grep for try-catch pattern. Run existing Pester tests to confirm nothing broken: `pwsh -Command "Invoke-Pester Tests/ -Output Detailed"`</verify>
  <done>WSUS, PrintServer, and Jumpbox PostInstall scriptblocks have try-catch wrappers and post-install verification. Error messages include role-specific context and troubleshooting hints.</done>
</task>

</tasks>

<verification>
1. All 6 role files parse without syntax errors
2. Each PostInstall scriptblock contains a top-level try-catch
3. Each role has a post-install verification step checking the expected service/feature
4. Error messages include role name, VM name, and troubleshooting hints
5. Existing Pester tests still pass
</verification>

<success_criteria>
- All 6 role scripts have try-catch error handling on PostInstall
- DC verifies NTDS + ADWS + DNS services
- SQL verifies SQL Server service running
- IIS verifies W3SVC service running
- WSUS verifies WsusService running
- PrintServer verifies Spooler service running + Print-Server feature
- Jumpbox reports RSAT install summary and verifies RDP enabled
- All error messages include role-specific troubleshooting context
</success_criteria>

<output>
After completion, create `.planning/phases/04-role-provisioning/04-02-SUMMARY.md`
</output>
