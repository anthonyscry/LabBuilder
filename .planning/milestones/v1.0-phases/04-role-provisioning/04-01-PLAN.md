---
phase: 04-role-provisioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - LabBuilder/Roles/FileServer.ps1
  - LabBuilder/Roles/Client.ps1
  - LabBuilder/Roles/DHCP.ps1
  - LabBuilder/Roles/DSCPullServer.ps1
  - Tests/LabBuilderRoles.Tests.ps1
autonomous: true
requirements:
  - ROLE-06
  - ROLE-10
  - ROLE-05
  - ROLE-08
  - ROLE-11

must_haves:
  truths:
    - "FileServer.ps1 ScriptBlock param uses simple variable name, not dotted property"
    - "Client.ps1 ScriptBlock param uses simple variable names, not dotted properties"
    - "DHCP.ps1 validates config keys exist before using them in ArgumentList"
    - "DSCPullServer.ps1 validates config keys exist before using them"
    - "All four role scripts parse without PowerShell syntax errors"
  artifacts:
    - path: "LabBuilder/Roles/FileServer.ps1"
      provides: "Fixed param syntax in ScriptBlock"
      contains: "param($DomainName)"
    - path: "LabBuilder/Roles/Client.ps1"
      provides: "Fixed param syntax in ScriptBlock"
      contains: "param($DomainName, $FileServerName, $FileServerSelected)"
    - path: "LabBuilder/Roles/DHCP.ps1"
      provides: "Prerequisite validation for DHCP config keys"
    - path: "LabBuilder/Roles/DSCPullServer.ps1"
      provides: "Prerequisite validation for DSCPullServer config keys"
    - path: "Tests/LabBuilderRoles.Tests.ps1"
      provides: "Pester tests validating role script syntax and structure"
  key_links:
    - from: "LabBuilder/Roles/FileServer.ps1"
      to: "Build-LabFromSelection.ps1"
      via: "PostInstall scriptblock invoked with $Config"
      pattern: "ArgumentList.*DomainName"
    - from: "LabBuilder/Roles/Client.ps1"
      to: "Build-LabFromSelection.ps1"
      via: "PostInstall scriptblock invoked with $Config"
      pattern: "ArgumentList.*DomainName.*FileServer"
---

<objective>
Fix critical syntax bugs in FileServer.ps1 and Client.ps1, add prerequisite validation to DHCP.ps1 and DSCPullServer.ps1, and create comprehensive Pester tests for all role scripts.

Purpose: FileServer and Client roles have the same systemic `param($GlobalLabConfig.Lab.DomainName)` bug that Phase 03-03 fixed across 12 other files. These scripts will crash at runtime. DHCP and DSC roles will throw unclear NullReferenceExceptions if config sections are missing.

Output: Four fixed role scripts + Pester test file validating all role script structure.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-role-provisioning/04-RESEARCH.md
@LabBuilder/Roles/FileServer.ps1
@LabBuilder/Roles/Client.ps1
@LabBuilder/Roles/DHCP.ps1
@LabBuilder/Roles/DSCPullServer.ps1
@LabBuilder/Build-LabFromSelection.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix param syntax bugs in FileServer.ps1 and Client.ps1, add prerequisite validation to DHCP.ps1 and DSCPullServer.ps1</name>
  <files>
    LabBuilder/Roles/FileServer.ps1
    LabBuilder/Roles/Client.ps1
    LabBuilder/Roles/DHCP.ps1
    LabBuilder/Roles/DSCPullServer.ps1
  </files>
  <action>
**FileServer.ps1 (line 35):** The Invoke-LabCommand ScriptBlock has `param($GlobalLabConfig.Lab.DomainName)` which is invalid PowerShell param syntax. PowerShell interprets dotted properties as type constraints in param blocks. Fix:
- Change `param($GlobalLabConfig.Lab.DomainName)` to `param($DomainName)`
- The `-ArgumentList $LabConfig.DomainName` on line 82 already passes the value correctly — no change needed there
- Inside the scriptblock, replace `$GlobalLabConfig.Lab.DomainName` references with `$DomainName`
- Line 64: `$netbios = ($GlobalLabConfig.Lab.DomainName -split '\.')[0].ToUpper()` should become `$netbios = ($DomainName -split '\.')[0].ToUpper()`

**Client.ps1 (line 34):** Same bug pattern. The Invoke-LabCommand ScriptBlock has `param($GlobalLabConfig.Lab.DomainName, $FileServerName, $FileServerSelected)`. Fix:
- Change to `param($DomainName, $FileServerName, $FileServerSelected)` — the -ArgumentList on line 65 already passes `$LabConfig.DomainName` as the first argument

**DHCP.ps1:** Add prerequisite validation at the start of the PostInstall scriptblock (before Install-LabWindowsFeature):
- Check that `$LabConfig.DHCP` exists and is not null
- Check that required keys exist: ScopeId, Start, End, Mask
- If missing, Write-Warning with clear message listing which config keys are needed, then return early
- Also check `$LabConfig.Network.Gateway` and `$LabConfig.IPPlan.DC` before passing to ArgumentList

**DSCPullServer.ps1:** Add prerequisite validation at the start of the PostInstall scriptblock:
- Check that `$LabConfig.DSCPullServer` exists and is not null
- Check that required keys exist: PullPort, CompliancePort, RegistrationKeyDir, RegistrationKeyFile
- If missing, Write-Warning with clear message about which DSC config keys are needed, then return early

For both DHCP and DSC, use this pattern:
```powershell
$requiredKeys = @('KeyName1', 'KeyName2')
$missing = @($requiredKeys | Where-Object { -not $configSection.ContainsKey($_) -or [string]::IsNullOrWhiteSpace([string]$configSection[$_]) })
if ($missing.Count -gt 0) {
    Write-Warning "Role prereq check failed: Missing config keys in `$LabConfig.SectionName: $($missing -join ', '). Add these to Lab-Config.ps1."
    return
}
```
  </action>
  <verify>
Run `pwsh -Command "& { [System.Management.Automation.Language.Parser]::ParseFile('LabBuilder/Roles/FileServer.ps1', [ref]$null, [ref]$null) }"` for each of the 4 files to confirm they parse without errors. Also grep for `param($GlobalLabConfig` across all role files to confirm no remaining instances.
  </verify>
  <done>FileServer.ps1 and Client.ps1 use simple param variable names (not dotted properties). DHCP.ps1 and DSCPullServer.ps1 validate their config prerequisites before attempting installation. No role file contains `param($GlobalLabConfig` syntax.</done>
</task>

<task type="auto">
  <name>Task 2: Create Pester tests validating role script syntax and structure</name>
  <files>Tests/LabBuilderRoles.Tests.ps1</files>
  <action>
Create a new Pester 5 test file `Tests/LabBuilderRoles.Tests.ps1` that validates all 10 Windows role scripts. Follow the project's existing test patterns (dot-source in BeforeAll, mock in BeforeEach, Set-StrictMode -Version Latest).

**Test groups:**

1. **Syntax validation (all 10 Windows role files):** Use `[System.Management.Automation.Language.Parser]::ParseFile()` to confirm each role script parses without errors. Iterate over: DC.ps1, SQL.ps1, IIS.ps1, WSUS.ps1, DHCP.ps1, FileServer.ps1, PrintServer.ps1, DSCPullServer.ps1, Jumpbox.ps1, Client.ps1.

2. **No invalid param syntax (regression prevention):** Grep each role file for `param($GlobalLabConfig` or `param($\w+\.\w+` patterns inside ScriptBlock definitions. This prevents the Phase 03-03 systemic bug from recurring.

3. **Function structure validation:** For each role file, dot-source it and verify:
   - The expected function exists (Get-LabRole_DC, Get-LabRole_SQL, etc.)
   - The function has CmdletBinding attribute
   - The function has a mandatory $Config parameter of type [hashtable]

4. **Role definition structure:** Call each Get-LabRole_* function with a mock config hashtable and verify the returned hashtable contains required keys: Tag, VMName, OS, IP, Gateway, DnsServer1, Memory, PostInstall. Use a minimal mock config:
```powershell
$mockConfig = @{
    VMNames = @{ DC = 'DC1'; SQL = 'SQL1'; IIS = 'IIS1'; WSUS = 'WSUS1'; DHCP = 'DHCP1'; FileServer = 'FILE1'; PrintServer = 'PRN1'; DSC = 'DSC1'; Jumpbox = 'JUMP1'; Client = 'WIN10-01' }
    IPPlan = @{ DC = '10.0.10.10'; SQL = '10.0.10.20'; IIS = '10.0.10.30'; WSUS = '10.0.10.31'; DHCP = '10.0.10.32'; FileServer = '10.0.10.33'; PrintServer = '10.0.10.34'; DSC = '10.0.10.40'; Jumpbox = '10.0.10.50'; Client = '10.0.10.60' }
    Network = @{ Gateway = '10.0.10.1'; SwitchName = 'LabSwitch' }
    ServerOS = 'Windows Server 2022 Datacenter'
    ClientOS = 'Windows 11 Enterprise'
    ServerVM = @{ Memory = 2GB; MinMemory = 512MB; MaxMemory = 4GB; Processors = 2 }
    ClientVM = @{ Memory = 2GB; MinMemory = 512MB; MaxMemory = 4GB; Processors = 2 }
    DomainName = 'lab.local'
    CredentialUser = 'admin'
    SQL = @{ InstanceName = 'MSSQLSERVER'; Features = 'SQLENGINE'; SaPassword = 'Test123!' }
    DSCPullServer = @{ PullPort = 8080; CompliancePort = 9080; RegistrationKeyDir = 'C:\DscService'; RegistrationKeyFile = 'RegistrationKey.txt' }
}
```

5. **DHCP prerequisite validation test:** Call DHCP PostInstall with a config missing the DHCP section. Verify it writes a warning and returns without throwing. Mock `Install-LabWindowsFeature` and `Invoke-LabCommand` to prevent actual execution.

6. **DSC prerequisite validation test:** Call DSC PostInstall with a config missing the DSCPullServer section. Verify it writes a warning and returns without throwing. Mock `Invoke-LabCommand` to prevent actual execution.

Mock `Get-LabMachineRoleDefinition` for SQL role tests (it's an AutomatedLab cmdlet that won't be available in test environment).
  </action>
  <verify>Run `pwsh -Command "Invoke-Pester Tests/LabBuilderRoles.Tests.ps1 -Output Detailed"` — all tests pass.</verify>
  <done>Pester test file exists with passing tests for syntax validation, param regression prevention, function structure, role definition structure, and prerequisite validation for DHCP and DSC roles.</done>
</task>

</tasks>

<verification>
1. `pwsh -Command "[System.Management.Automation.Language.Parser]::ParseFile('LabBuilder/Roles/FileServer.ps1', [ref]$null, [ref]$null)"` — no errors
2. `pwsh -Command "[System.Management.Automation.Language.Parser]::ParseFile('LabBuilder/Roles/Client.ps1', [ref]$null, [ref]$null)"` — no errors
3. `grep -r 'param(\$GlobalLabConfig' LabBuilder/Roles/` — no matches
4. `pwsh -Command "Invoke-Pester Tests/LabBuilderRoles.Tests.ps1 -Output Detailed"` — all pass
</verification>

<success_criteria>
- FileServer.ps1 and Client.ps1 param syntax bugs fixed (same class as Phase 03-03)
- DHCP.ps1 and DSCPullServer.ps1 validate prerequisites before installation
- All 10 Windows role scripts parse without syntax errors
- No role script contains `param($GlobalLabConfig` pattern
- Pester tests prevent regression of these bugs
</success_criteria>

<output>
After completion, create `.planning/phases/04-role-provisioning/04-01-SUMMARY.md`
</output>
