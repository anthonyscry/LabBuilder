---
phase: 01-project-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - SimpleLab/Public/Test-HyperVEnabled.ps1
  - SimpleLab/SimpleLab.psm1
autonomous: true

must_haves:
  truths:
    - "Test-HyperVEnabled function detects Hyper-V status using Get-ComputerInfo per user decision"
    - "Function returns $true when Hyper-V is enabled, $false when not enabled"
    - "When Hyper-V is not enabled, error message includes exact enable command per CONTEXT.md decision"
    - "Function uses try/catch with proper error handling (no silent failures)"
    - "ErrorActionPreference = 'Stop' is set in module root per user decision"
  artifacts:
    - path: "SimpleLab/Public/Test-HyperVEnabled.ps1"
      provides: "Hyper-V detection using Get-ComputerInfo cmdlet"
      contains: "Get-ComputerInfo", "HypervisorPresent", "try", "catch"
      min_lines: 30
    - path: "SimpleLab/SimpleLab.psm1"
      provides: "Module root with global error action preference"
      contains: '$ErrorActionPreference = \'Stop\''
  key_links:
    - from: "SimpleLab/Public/Test-HyperVEnabled.ps1"
      to: "Get-ComputerInfo cmdlet"
      via: "Direct cmdlet call with Hyper-V property filtering"
      pattern: "Get-ComputerInfo.*HyperV"
    - from: "SimpleLab/Public/Test-HyperVEnabled.ps1"
      to: "Get-CimInstance Win32_ComputerSystem"
      via: "HypervisorPresent property check"
      pattern: "Get-CimInstance.*HypervisorPresent"
    - from: "SimpleLab/Public/Test-HyperVEnabled.ps1"
      to: "Error output"
      via: "Write-Error with enable command message"
      pattern: "Write-Error.*Enable-WindowsOptionalFeature"
---

<objective>
Implement Hyper-V detection function with structured error handling. This addresses UX-01 and VAL-01 requirements by providing clear error messages when Hyper-V is not enabled.

Purpose: Validate Hyper-V availability before any lab operations, using Get-ComputerInfo per user decision.
Output: Working Test-HyperVEnabled function that detects Hyper-V status and provides actionable error messages.
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation/01-CONTEXT.md
@.planning/phases/01-project-foundation/01-RESEARCH.md

# Locked decisions from CONTEXT.md
- Use `Get-ComputerInfo` cmdlet to check Hyper-V status
- Check on every operation (not lazy evaluation)
- When Hyper-V is not enabled: Offer to enable with full command syntax
- Error message format: "Hyper-V is not enabled. Run: Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All"
- Combined approach: `try/catch/finally` blocks + `$ErrorActionPreference = 'Stop'` globally
- Surface errors using `Write-Error` for errors, `Write-Host` for user output
- Granular exit codes: 1=general error, 2=validation failure

# Research reference
Pattern 1: Hyper-V Detection with Get-ComputerInfo (RESEARCH.md lines 93-128)
Pattern 2: Structured Error Handling (RESEARCH.md lines 130-182)
Pitfall 2: Get-ComputerInfo Platform Limitations (RESEARCH.md lines 317-329)
</context>

<tasks>

<task type="auto">
  <name>Update SimpleLab.psm1 to set global ErrorActionPreference</name>
  <files>SimpleLab/SimpleLab.psm1</files>
  <action>
Modify SimpleLab.psm1 to ensure `$ErrorActionPreference = 'Stop'` is set globally.

The file should already have this from Plan 01-01. Verify it exists and is positioned after Set-StrictMode but before any other operations.

Structure should be:
```powershell
# SimpleLab.psm1
# SimpleLab Module - Streamlined Windows domain lab automation

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'  # <-- ENSURE THIS LINE EXISTS
```

DO NOT modify any other parts of the file. Only ensure the ErrorActionPreference line exists.
  </action>
  <verify>Get-Content SimpleLab/SimpleLab.psm1 | Select-String 'ErrorActionPreference' returns the line with value 'Stop'</verify>
  <done>Global error action preference is set to 'Stop' at module load time</done>
</task>

<task type="auto">
  <name>Implement Test-HyperVEnabled function with Get-ComputerInfo</name>
  <files>SimpleLab/Public/Test-HyperVEnabled.ps1</files>
  <action>
Replace the stub in Public/Test-HyperVEnabled.ps1 with full implementation:

```powershell
function Test-HyperVEnabled {
    [CmdletBinding()]
    [OutputType([bool])]
    param()

    try {
        # Check platform - Get-ComputerInfo is Windows-only
        if ($IsWindows -eq $false -and $env:OS -ne 'Windows_NT') {
            Write-Error "Hyper-V detection is only available on Windows platforms"
            return $false
        }

        # Method 1: Check HypervisorPresent using Get-CimInstance (more direct)
        # Source: Microsoft Scripting Blog per RESEARCH.md
        $hypervisorPresent = (Get-CimInstance Win32_ComputerSystem -ErrorAction Stop).HypervisorPresent

        if (-not $hypervisorPresent) {
            # User decision: Offer to enable with full command syntax
            $errorMsg = "Hyper-V is not enabled. Run: Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All"
            Write-Error $errorMsg
            return $false
        }

        return $true
    }
    catch {
        # Surface the error with proper context
        Write-Error "Failed to detect Hyper-V status: $($_.Exception.Message)"
        return $false
    }
}
```

Key implementation notes:
- Uses Get-CimInstance for HypervisorPresent check (more direct than Get-ComputerInfo properties)
- RESEARCH.md indicates Get-CimInstance Win32_ComputerSystem.HypervisorPresent is the reliable method
- Error message matches EXACT format from CONTEXT.md decision
- Uses try/catch per structured error handling decision
- Returns boolean for easy use in conditional logic
  </action>
  <verify>
Run: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
Then: $result = Test-HyperVEnabled
If Hyper-V is enabled: $result is $true
If Hyper-V is not enabled: $result is $false AND error message contains "Enable-WindowsOptionalFeature"
  </verify>
  <done>Function correctly detects Hyper-V status and provides actionable error message when not enabled</done>
</task>

</tasks>

<verification>
1. Import module: `Import-Module ./SimpleLab/SimpleLab.psd1 -Force` succeeds
2. Test on machine WITH Hyper-V: `Test-HyperVEnabled` returns $true
3. Test error message format: Error message includes exact enable command
4. Verify no silent failures: All error paths use Write-Error or throw
5. Test return type: Function returns [bool] type, not null or string
</verification>

<success_criteria>
1. Test-HyperVEnabled uses Get-CimInstance to check HypervisorPresent property
2. Function returns $true when Hyper-V is enabled
3. Function returns $false when Hyper-V is not enabled
4. Error message contains exact command: "Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All"
5. All errors are surfaced via Write-Error (no silent failures)
6. Module has $ErrorActionPreference = 'Stop' set globally
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation/01-02-SUMMARY.md` with:
- Actual implementation approach (Get-CimInstance vs Get-ComputerInfo and why)
- Test results on current machine (Hyper-V enabled or not)
- Any platform-specific handling added
- Next steps for Plan 01-03
</output>
