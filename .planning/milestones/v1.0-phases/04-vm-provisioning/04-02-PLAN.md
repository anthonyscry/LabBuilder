---
phase: 04-vm-provisioning
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - SimpleLab/Public/New-LabVM.ps1
  - SimpleLab/Public/Remove-LabVM.ps1
  - SimpleLab/SimpleLab.psm1
  - SimpleLab/SimpleLab.psd1
autonomous: true

must_haves:
  truths:
    - Tool can create new VMs with specified hardware configuration
    - Tool attaches ISO files to VMs for bootable installation
    - Tool provides idempotent VM creation (checks for existing VMs)
    - Tool can remove VMs with cleanup of associated resources
    - VMs connect to existing "SimpleLab" vSwitch from Phase 3
  artifacts:
    - path: SimpleLab/Public/New-LabVM.ps1
      provides: Single VM creation with idempotent pattern
      min_lines: 60
      exports: [New-LabVM]
    - path: SimpleLab/Public/Remove-LabVM.ps1
      provides: VM removal with resource cleanup
      min_lines: 40
      exports: [Remove-LabVM]
  key_links:
    - from: New-LabVM.ps1
      to: Get-LabVMConfig.ps1 (from 04-01)
      via: Function call to get VM hardware specifications
      pattern: Get-LabVMConfig
    - from: New-LabVM.ps1
      to: Test-LabVM.ps1 (from 04-01)
      via: Function call to check if VM exists before creation
      pattern: Test-LabVM
    - from: New-LabVM.ps1
      to: New-VM (Hyper-V module)
      via: Native Hyper-V cmdlet for VM creation
      pattern: New-VM.*-Generation
    - from: New-LabVM.ps1
      to: "SimpleLab" vSwitch (from Phase 3)
      via: SwitchName parameter connecting to existing vSwitch
      pattern: -SwitchName.*SimpleLab
    - from: Remove-LabVM.ps1
      to: Remove-VM (Hyper-V module)
      via: Native Hyper-V cmdlet for VM removal
      pattern: Remove-VM.*-Force
---

<objective>
Create VM provisioning and removal functions

Purpose: Implement the core VM lifecycle operations for creating and removing Hyper-V VMs with proper hardware configuration, ISO attachment for bootable installations, and idempotent patterns that prevent duplicate VM creation.

Output: New-LabVM and Remove-LabVM functions for VM management
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vm-provisioning/04-RESEARCH.md
@.planning/phases/04-vm-provisioning/04-01-SUMMARY.md

# Pattern reference from prior phases
@SimpleLab/Public/New-LabSwitch.ps1
@SimpleLab/Private/Get-LabConfig.ps1

# VM configuration from Plan 04-01
@SimpleLab/Private/Get-LabVMConfig.ps1
@SimpleLab/Private/Test-LabVM.ps1

# Network infrastructure from Phase 3
@SimpleLab/Public/Test-LabNetwork.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create New-LabVM for single VM creation</name>
  <files>SimpleLab/Public/New-LabVM.ps1</files>
  <action>
    Create New-LabVM function in Public/ that:
    - Parameters:
      * VMName (string, mandatory)
      * MemoryGB (int, mandatory - converted to bytes internally)
      * VHDPath (string, mandatory - path for VHDX file)
      * SwitchName (string, default "SimpleLab")
      * IsoPath (string, optional - path to ISO file)
      * ProcessorCount (int, default 2)
      * Generation (int, default 2)
      * Force (switch, default false - recreate if exists)
    - Uses Test-LabVM to check if VM already exists
    - If VM exists and -Force not specified: returns PSCustomObject with Created=$false, Status="AlreadyExists", Message
    - If VM exists and -Force specified: removes existing VM, waits 2 seconds for cleanup
    - Creates VM using New-VM with parameters:
      * -Name $VMName
      * -MemoryStartupBytes ($MemoryGB * 1GB)
      * -NewVHDPath $VHDPath
      * -NewVHDSizeBytes 60GB
      * -Generation $Generation
      * -SwitchName $SwitchName
      * -ErrorAction 'Stop'
    - Configures processor: Set-VMProcessor -VMName $VMName -Count $ProcessorCount
    - Configures static memory: Set-VMMemory -VMName $VMName -StartupBytes ($MemoryGB * 1GB) -DynamicMemoryEnabled $false
    - Attaches ISO if provided and exists: Add-VMDvdDrive -VMName $VMName -Path $IsoPath
    - Returns PSCustomObject with: VMName, Created, Status, Message, VHDPath, MemoryGB, ProcessorCount
    - Status values: "OK" (created), "AlreadyExists" (VM exists, no -Force), "Failed" (error), "ISONotFound" (ISO path invalid)
    - Handles errors with try/catch, returns structured error results
    - Public function (exported)

    Pattern reference: Follow New-LabSwitch.ps1 idempotent pattern with -Force parameter
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
    Use New-TimeSpan for duration measurement if applicable
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: New-LabVM -VMName "TestVM" -MemoryGB 2 -VHDPath "C:\Lab\VMs\TestVM.vhdx" -SwitchName "SimpleLab"
    3. Verify output contains VMName, Created, Status, Message properties
    4. Verify Created=$false (Hyper-V not available in WSL, but structure should be correct)
  </verify>
  <done>
    New-LabVM function creates VMs with idempotent pattern, hardware configuration, and ISO attachment
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Remove-LabVM for VM removal</name>
  <files>SimpleLab/Public/Remove-LabVM.ps1</files>
  <action>
    Create Remove-LabVM function in Public/ that:
    - Parameters:
      * VMName (string, mandatory)
      * DeleteVHD (switch, default false - also delete VHD files)
    - Uses Test-LabVM to check if VM exists
    - If VM doesn't exist: returns PSCustomObject with Removed=$false, Status="NotFound", Message
    - Stops VM if running: if (Get-VM -Name $VMName).State -ne 'Off' { Stop-VM -Name $VMName -TurnOff -Force }
    - Removes VM: Remove-VM -Name $VMName -Force
    - If -DeleteVHD specified: removes VHD file at VHDPath using Remove-Item
    - Returns PSCustomObject with: VMName, Removed, Status, Message, VHDDeleted
    - Status values: "OK" (removed), "NotFound" (VM didn't exist), "Failed" (error)
    - VHDDeleted: $true if -DeleteVHD and VHD file removed, $false otherwise
    - Handles errors with try/catch, returns structured error results
    - Public function (exported)

    Pattern reference: Follow existing error handling patterns with try/catch
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Remove-LabVM -VMName "NonExistentVM"
    3. Verify output contains VMName, Removed, Status, Message, VHDDeleted properties
    4. Verify Status="NotFound" for non-existent VM
  </verify>
  <done>
    Remove-LabVM function removes VMs with optional VHD deletion and returns structured result
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SimpleLab module files to export new functions</name>
  <files>SimpleLab/SimpleLab.psm1, SimpleLab/SimpleLab.psd1</files>
  <action>
    Update both SimpleLab module files to export new functions:
    - SimpleLab.psm1: Add 'New-LabVM' and 'Remove-LabVM' to Export-ModuleMember array
    - SimpleLab.psd1: Add 'New-LabVM' and 'Remove-LabVM' to FunctionsToExport array

    Maintain alphabetical ordering in both export arrays
    This follows the pattern established in Phase 3 for proper module exports
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify New-LabVM appears in output
    4. Verify Remove-LabVM appears in output
  </verify>
  <done>
    New-LabVM and Remove-LabVM functions are exported from SimpleLab module and available for use
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. New-LabVM creates VMs with specified hardware configuration
2. New-LabVM checks for existing VMs before creation (idempotent)
3. New-LabVM attaches ISO files when provided
4. New-LabVM configures static memory and processor count
5. Remove-LabVM removes VMs with optional VHD deletion
6. Both functions are properly exported from the module
7. Both functions return structured PSCustomObject results
</verification>

<success_criteria>
1. User can create single VM with New-LabVM command
2. Tool prevents duplicate VM creation without -Force parameter
3. Tool creates VMs with correct RAM allocation (DC/Server: 2GB, Win11: 4GB)
4. Tool attaches ISO files for bootable Windows installation
5. User can remove VMs with Remove-LabVM command
6. VMs connect to existing "SimpleLab" vSwitch
</success_criteria>

<output>
After completion, create `.planning/phases/04-vm-provisioning/04-02-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Any deviations from plan
</output>
