---
phase: 04-vm-provisioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - SimpleLab/Private/Get-LabVMConfig.ps1
  - SimpleLab/Private/Test-LabVM.ps1
  - SimpleLab/SimpleLab.psm1
  - SimpleLab/SimpleLab.psd1
autonomous: true

must_haves:
  truths:
    - Tool provides centralized location for VM hardware specifications
    - Tool can detect if a specific VM already exists before creation
    - VM configuration includes memory, processor, disk, and generation settings
    - User can query VM config by name or get all VM configurations
  artifacts:
    - path: SimpleLab/Private/Get-LabVMConfig.ps1
      provides: VM hardware specifications (memory, processor, disk, generation)
      min_lines: 30
    - path: SimpleLab/Private/Test-LabVM.ps1
      provides: VM existence detection using Get-VM
      min_lines: 25
  key_links:
    - from: Get-LabVMConfig.ps1
      to: Get-LabConfig.ps1
      via: Function call to read VMConfiguration from config.json
      pattern: Get-LabConfig
    - from: Test-LabVM.ps1
      to: Hyper-V module
      via: Get-VM cmdlet for VM existence check
      pattern: Get-VM.*ErrorAction
---

<objective>
Create VM configuration and detection infrastructure

Purpose: Establish the foundational data structures and detection logic for VM provisioning, enabling idempotent VM creation by checking for existing VMs and providing centralized hardware specifications that align with lab requirements.

Output: VM configuration retrieval and VM existence detection functions
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vm-provisioning/04-RESEARCH.md

# Pattern reference from prior phases
@SimpleLab/Private/Get-LabNetworkConfig.ps1
@SimpleLab/Private/Get-LabConfig.ps1
@SimpleLab/Public/Test-LabNetwork.ps1

# Network infrastructure from Phase 3
@SimpleLab/Public/Test-LabNetwork.ps1
@SimpleLab/Public/New-LabSwitch.ps1
@SimpleLab/Private/Get-LabNetworkConfig.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Get-LabVMConfig for VM hardware specifications</name>
  <files>SimpleLab/Private/Get-LabVMConfig.ps1</files>
  <action>
    Create Get-LabVMConfig function in Private/ that:
    - Parameters: VMName (string, optional - if not specified, returns all VM configs)
    - Returns PSCustomObject with VM hardware specifications
    - Default VM configurations from requirements:
      * SimpleDC: MemoryGB=2, ProcessorCount=2, DiskSizeGB=60, Generation=2, ISO='Server2019'
      * SimpleServer: MemoryGB=2, ProcessorCount=2, DiskSizeGB=60, Generation=2, ISO='Server2019'
      * SimpleWin11: MemoryGB=4, ProcessorCount=2, DiskSizeGB=60, Generation=2, ISO='Windows11'
    - Uses Get-LabConfig to read VMConfiguration from config.json if available
    - Falls back to defaults if VMConfiguration section not present
    - If VMName specified, returns single VM config or null if not found
    - If VMName not specified, returns hashtable of all VM configs
    - Internal function only (not exported)

    Pattern reference: Follow Get-LabNetworkConfig.ps1 pattern for config retrieval with defaults
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Get-LabVMConfig -VMName "SimpleDC"
    3. Verify output contains MemoryGB, ProcessorCount, DiskSizeGB, Generation, ISO properties
    4. Verify SimpleDC has MemoryGB=2
    5. Run: Get-LabVMConfig (without VMName)
    6. Verify returns hashtable with all 3 VM configurations
  </verify>
  <done>
    Get-LabVMConfig function returns VM hardware specifications with default values and config.json override support
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Test-LabVM for VM existence detection</name>
  <files>SimpleLab/Private/Test-LabVM.ps1</files>
  <action>
    Create Test-LabVM function in Private/ that:
    - Parameters: VMName (string, mandatory)
    - Uses Get-VM -Name $VMName -ErrorAction SilentlyContinue to check if VM exists
    - Returns PSCustomObject with: VMName, Exists, Status, Message, State
    - Exists: $true if VM found, $false otherwise
    - State: VM state if exists (Running, Off, Saved, etc.), or null if not found
    - Status values: "OK" (exists), "NotFound" (doesn't exist), "Error" (exception)
    - Message provides details: "VM '{VMName}' exists (State: {State})", "VM '{VMName}' not found", or error details
    - Handles Hyper-V module not available gracefully
    - Internal function only (not exported)

    Pattern reference: Follow Test-LabNetwork.ps1 error handling pattern
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Test-LabVM -VMName "NonExistentVM"
    3. Verify output contains VMName, Exists, Status, Message, State properties
    4. Verify Exists=$false and Status="NotFound"
  </verify>
  <done>
    Test-LabVM function detects VM existence and returns structured result with VM state
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SimpleLab module files</name>
  <files>SimpleLab/SimpleLab.psm1, SimpleLab/SimpleLab.psd1</files>
  <action>
    Update both SimpleLab module files:
    - SimpleLab.psm1: No changes needed (internal functions, not exported)
    - SimpleLab.psd1: No changes needed (internal functions, not exported)

    Note: Get-LabVMConfig and Test-LabVM remain internal functions (Private/) and are not exported
    This follows the pattern established in Phase 2 and Phase 3 for internal helper functions
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Get-LabVMConfig does NOT appear in output (internal function)
    4. Verify Test-LabVM does NOT appear in output (internal function)
  </verify>
  <done>
    Module files verified - internal functions are not exported and available for internal use
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Get-LabVMConfig returns VM hardware specifications with proper defaults
2. Get-LabVMConfig supports config.json override for custom configurations
3. Test-LabVM correctly detects VM existence using Get-VM
4. Test-LabVM returns VM state when VM exists
5. Both functions remain internal (not exported) following established patterns
</verification>

<success_criteria>
1. User can query VM hardware specifications by name or get all configs
2. Tool can detect if a VM exists before attempting creation
3. VM configurations match requirements (DC/Server: 2GB, Win11: 4GB)
4. Infrastructure ready for VM creation tasks in subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/04-vm-provisioning/04-01-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Test results
- Any deviations from plan
</output>
