---
phase: 02-preflight-validation
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - SimpleLab/Private/Write-ValidationReport.ps1
  - SimpleLab/SimpleLab.ps1
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User sees color-coded pass/fail status for all checks"
    - "User receives specific error message listing missing ISOs"
    - "User can run validation before build attempt"
    - "Clear visual summary table shows overall status"
    - "Missing ISOs are listed with expected locations"
  artifacts:
    - path: "SimpleLab/Private/Write-ValidationReport.ps1"
      provides: "Formats and displays validation results"
      min_lines: 50
      contains: "function Write-ValidationReport"
    - path: "SimpleLab/SimpleLab.ps1"
      provides: "Entry point with validation operation"
      contains: "'Validate'"
  key_links:
    - from: "SimpleLab/SimpleLab.ps1"
      to: "SimpleLab/Public/Test-LabPrereqs.ps1"
      via: "Function call in Validate operation"
      pattern: "Test-LabPrereqs"
    - from: "SimpleLab/SimpleLab.ps1"
      to: "SimpleLab/Private/Write-ValidationReport.ps1"
      via: "Function call to display results"
      pattern: "Write-ValidationReport"
    - from: "SimpleLab/Private/Write-ValidationReport.ps1"
      to: "console"
      via: "Write-Host with -ForegroundColor"
      pattern: "Write-Host.*-ForegroundColor (Green|Red|Yellow)"
---

<objective>
Create user-facing validation error reporting with clear pass/fail visualization.

Purpose: Transform the structured validation results into clear, actionable feedback that helps users understand exactly what's missing or misconfigured before attempting lab builds. Color-coded output and specific error messages prevent confusion.

Output: Write-ValidationReport function and updated SimpleLab.ps1 with Validate operation.
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-preflight-validation/02-RESEARCH.md
@.planning/phases/01-project-foundation/01-03-SUMMARY.md
@.planning/phases/02-preflight-validation/02-02-SUMMARY.md
@SimpleLab/SimpleLab.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Write-ValidationReport function</name>
  <files>SimpleLab/Private/Write-ValidationReport.ps1</files>
  <action>
Create SimpleLab/Private/Write-ValidationReport.ps1 with the following implementation:

1. Function name: Write-ValidationReport
2. Parameters:
   - Results (PSCustomObject, mandatory): The Test-LabPrereqs result object
   - Quiet (switch, optional): Suppress console output (for automation)
3. Return: PSCustomObject with:
   - ExitCode: 0 if all passed, 2 if any failed (validation exit code)
   - OverallStatus: Passthrough of Results.OverallStatus
4. Implementation:
   - If -Quiet specified, return ExitCode without writing to console
   - Start with header: Write-Host "`n=== SimpleLab Pre-flight Validation ===" -ForegroundColor Cyan
   - Write timestamp: Write-Host "Checked at: $($results.Timestamp)" -ForegroundColor Gray
   - Write duration: Write-Host "Duration: $([math]::Round($results.Duration, 2)) seconds`n" -ForegroundColor Gray

   **Overall Status:**
   - If OverallStatus is "Pass": Write-Host "Overall Status: PASS" -ForegroundColor Green
   - If OverallStatus is "Fail": Write-Host "Overall Status: FAIL" -ForegroundColor Red

   **Check Results Table:**
   - Write-Host "`nCheck Results:" -ForegroundColor White
   - Iterate through $results.Checks
   - For each check:
     - If Status is "Pass": Write-Host "  [PASS] $($check.Name)" -ForegroundColor Green
     - If Status is "Fail": Write-Host "  [FAIL] $($check.Name)" -ForegroundColor Red
     - If check has Message: Write-Host "         $($check.Message)" -ForegroundColor Gray
     - For ISO failures specifically:
       - If check.Name starts with "ISO_" and Status is "Fail":
         - Write-Host "         Expected: $($check.Path)" -ForegroundColor Yellow
         - Write-Host "         To fix: Edit .planning/config.json with correct ISO path" -ForegroundColor Yellow

   **Failed Checks Summary:**
   - If $results.FailedChecks.Count -gt 0:
     - Write-Host "`nFailed Checks:" -ForegroundColor Red
     - Write-Host "  $($results.FailedChecks -join ', ')" -ForegroundColor Yellow
     - Write-Host "`nPlease resolve the issues above before attempting lab build.`n" -ForegroundColor Yellow
   - Else:
     - Write-Host "`nAll prerequisites met. Ready to build lab.`n" -ForegroundColor Green

   - Set ExitCode: if ($results.OverallStatus -eq "Pass") then 0 else 2
   - Return PSCustomObject with ExitCode and OverallStatus
   - Include error handling for null results

5. Do NOT:
   - Do not throw exceptions (use ExitCode for signaling)
   - Do not modify the Results object (read-only display)
   - Do not run checks (only display existing results)

Follow the PowerShell console output pattern from SimpleLab.ps1 (Write-Host with -ForegroundColor).
  </action>
  <verify>
Import SimpleLab module and run:
```powershell
$results = Test-LabPrereqs
Write-ValidationReport -Results $results
```
Verify console shows header, overall status with color, check results table, and failed checks summary.
  </verify>
  <done>
Function displays color-coded validation report to console, returns ExitCode 0 for pass and 2 for failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SimpleLab.ps1 with Validate operation</name>
  <files>SimpleLab/SimpleLab.ps1</files>
  <action>
Update SimpleLab/SimpleLab.ps1 to add Validate operation:

1. Add 'Validate' to ValidateSet attribute for Operation parameter:
   - Change ValidateSet line to: [ValidateSet('Test-HyperV', 'Test-Artifact', 'Validate')]

2. Update switch statement to handle 'Validate' operation:
   - Add 'Validate' case to switch block
   - Implementation:
     ```powershell
     'Validate' {
         Write-Host "Running pre-flight validation..." -ForegroundColor Cyan
         $validationResults = Test-LabPrereqs
         $reportResult = Write-ValidationReport -Results $validationResults

         # Set exit code based on validation result
         $exitCode = $reportResult.ExitCode
         $status = if ($exitCode -eq 0) { "Success" } else { "Failed" }

         # Include validation results in run artifact
         $vmNames = @()  # No VMs in validation
     }
     ```

3. Update the try block's Hyper-V check:
   - Keep existing Hyper-V check for 'Test-HyperV' and 'Test-Artifact' operations
   - Skip Hyper-V check for 'Validate' operation (Test-LabPrereqs includes it)
   - Wrap existing Hyper-V check in: if ($Operation -ne 'Validate') { ... }

4. Update Write-RunArtifact call in finally block:
   - Pass $validationResults for Validate operation (add to artifact if possible)
   - Keep existing artifact structure for other operations

5. Do NOT:
   - Do not remove existing operations (Test-HyperV, Test-Artifact)
   - Do not change exit code meanings (0=success, 2=validation failure)
   - Do not write validation output in try block (let Write-ValidationReport handle it)

Follow the existing SimpleLab.ps1 structure and error handling pattern.
  </action>
  <verify>
Run SimpleLab.ps1 with Validate operation:
```powershell
.\SimpleLab\SimpleLab.ps1 -Operation Validate
```
Verify tool runs pre-flight checks, displays validation report, and exits with appropriate code.
  </verify>
  <done>
SimpleLab.ps1 accepts Validate operation, runs Test-LabPrereqs, displays report via Write-ValidationReport, and returns appropriate exit code.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify validation UX works correctly</name>
  <what-built>Complete validation system with ISO detection, pre-flight checks, and user-facing error reporting</what-built>
  <how-to-verify>
1. Run validation operation:
   ```powershell
   .\SimpleLab\SimpleLab.ps1 -Operation Validate
   ```

2. Verify the following:
   - Console displays header with "SimpleLab Pre-flight Validation"
   - Overall Status shows PASS or FAIL with appropriate color (green/red)
   - Each check shows [PASS] or [FAIL] with color
   - Failed checks include descriptive messages
   - Missing ISOs show expected locations and fix instructions
   - Duration is displayed
   - Exit code is 0 for pass, 2 for failure (check with echo $LASTEXITCODE)

3. Test with missing ISOs (if applicable):
   - Temporarily rename an ISO file in config
   - Run validation again
   - Verify missing ISO is listed with expected path
   - Verify error message suggests editing config.json

4. Test with all prerequisites met:
   - Ensure Hyper-V is enabled
   - Ensure ISOs exist at configured paths
   - Ensure sufficient disk space
   - Run validation
   - Verify "All prerequisites met. Ready to build lab." message
  </how-to-verify>
  <resume-signal>Type "approved" if validation works correctly, or describe issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. Write-ValidationReport displays color-coded output (green=pass, red=fail, yellow=warning)
2. Overall status line shows correct color based on pass/fail
3. Each check shows [PASS] or [FAIL] indicator
4. Failed checks include descriptive message and fix instructions
5. Missing ISOs show expected path and config file edit suggestion
6. Duration and timestamp are displayed
7. SimpleLab.ps1 accepts -Operation Validate
8. Exit code is 0 for pass, 2 for validation failure
9. Run artifact is generated for validation operations
10. All Phase 2 success criteria are met
</verification>

<success_criteria>
1. User receives specific error message listing missing ISOs before build attempt
2. Tool validates Windows Server 2019 and Windows 11 ISOs exist in configured location
3. User sees clear pass/fail status for all pre-flight checks
4. Color-coded output makes status immediately visible
5. Failed checks include actionable fix instructions
6. Exit code enables automation integration
</success_criteria>

<output>
After completion, create `.planning/phases/02-preflight-validation/02-03-SUMMARY.md` and PHASE-2-COMPLETE.md
</output>
