---
phase: 03-core-lifecycle-integration
plan: 05
type: execute
wave: 3
depends_on:
  - 03-02
  - 03-03
  - 03-04
files_modified:
  - OpenCodeLab-App.ps1
  - Scripts/Start-LabDay.ps1
  - Tests/CLIActionRouting.Tests.ps1
autonomous: true
requirements:
  - LIFE-03
  - CLI-01
  - CLI-02
  - CLI-05
  - CLI-09

must_haves:
  truths:
    - "All 25+ actions in OpenCodeLab-App.ps1 ValidateSet route to handlers without unhandled errors"
    - "Quick mode deploy restores LabReady snapshot via auto-heal when snapshot exists"
    - "Menu system displays correct options and routes to correct handlers for every key"
    - "CLI action routing test covers every ValidateSet value"
  artifacts:
    - path: "OpenCodeLab-App.ps1"
      provides: "Clean CLI action routing with no dead code or legacy references"
      contains: "switch.*Action"
    - path: "Tests/CLIActionRouting.Tests.ps1"
      provides: "Tests that every ValidateSet action value has a handler"
      contains: "Describe.*Action.*Routing"
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Scripts/Start-LabDay.ps1"
      via: "Quick deploy calls Start-LabDay"
      pattern: "Invoke-RepoScript.*Start-LabDay"
---

<objective>
Verify and fix CLI action routing for all 25+ actions, clean up dead code in the orchestrator, and validate quick mode flow.

Purpose: The orchestrator has accumulated legacy code paths and dead variable references. Every action in the ValidateSet must route to a working handler. Quick mode must correctly restore LabReady snapshots and auto-heal infrastructure gaps.

Output: All CLI actions route correctly. No dead code in action handlers. Quick mode restore verified. Pester tests cover every action routing path.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-lifecycle-integration/03-RESEARCH.md
@.planning/phases/03-core-lifecycle-integration/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up orchestrator action routing and dead code</name>
  <files>OpenCodeLab-App.ps1</files>
  <action>
1. **Verify every ValidateSet action has a handler:**
   Cross-reference the ValidateSet values (lines 10-33) against the switch block (lines 1785-1878). Every action must have a case. Document any gaps.

   Current ValidateSet: menu, setup, one-button-setup, one-button-reset, preflight, bootstrap, deploy, add-lin1, lin1-config, ansible, health, start, status, asset-report, offline-bundle, terminal, new-project, push, test, save, stop, rollback, blow-away, teardown

   Current switch cases: menu, setup, one-button-setup, one-button-reset, preflight, bootstrap, deploy, teardown, add-lin1, lin1-config, ansible, health, start, status, asset-report, offline-bundle, terminal, new-project, push, test, save, stop, rollback, blow-away

2. **Clean up legacy variable references** in OpenCodeLab-App.ps1:
   - Check for any remaining `$LabName`, `$LabSwitch`, `$AdminPassword` bare variable references
   - Fix string interpolation bugs (`"$GlobalLabConfig.X.Y"` → `"$($GlobalLabConfig.X.Y)"`)
   - Remove dead code in Invoke-BulkAdditionalVMProvision that references `$Server_Memory`, `$Client_Memory`, `$Server_Processors`, `$Client_Processors` (lines 1024-1027) — should use $GlobalLabConfig

3. **Fix Invoke-BulkAdditionalVMProvision** (lines 1024-1027):
   Replace `$Server_Memory`, `$Client_Memory`, `$Server_Processors`, `$Client_Processors` with:
   ```powershell
   $serverMemoryGB = [int]([math]::Ceiling($GlobalLabConfig.VMSizing.Server.Memory / 1GB))
   $workstationMemoryGB = [int]([math]::Ceiling($GlobalLabConfig.VMSizing.Client.Memory / 1GB))
   $serverCpu = [int]$GlobalLabConfig.VMSizing.Server.Processors
   $workstationCpu = [int]$GlobalLabConfig.VMSizing.Client.Processors
   ```

4. **Verify quick mode flow:**
   - `Invoke-QuickDeploy` calls Start-LabDay → Lab-Status → Test-OpenCodeLabHealth
   - Auto-heal (Invoke-LabQuickModeHeal) runs before mode decision when quick mode requested
   - `Invoke-QuickTeardown` stops VMs and restores LabReady if available
   - Ensure all three functions handle errors gracefully
  </action>
  <verify>
- Every ValidateSet action value appears in the switch block
- No `$Server_Memory`, `$Client_Memory`, `$Server_Processors`, `$Client_Processors` references remain
- No bare `$LabName`, `$LabSwitch` references remain
  </verify>
  <done>All CLI actions route correctly. Dead code and legacy variable references cleaned up. Quick mode flow verified.</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI action routing tests</name>
  <files>Tests/CLIActionRouting.Tests.ps1</files>
  <action>
1. **Create Tests/CLIActionRouting.Tests.ps1** with Pester 5 tests:
   - Test: Parse ValidateSet values from OpenCodeLab-App.ps1 param block
   - Test: Parse switch case values from the action dispatch block
   - Test: Every ValidateSet value has a matching switch case
   - Test: No switch case exists without a ValidateSet value
   - Test: Invoke-BulkAdditionalVMProvision doesn't reference legacy variables ($Server_Memory, etc.)
   - Test: No bare $LabName, $LabSwitch, $AdminPassword in OpenCodeLab-App.ps1 (outside strings and comments)
   - Test: Quick mode functions (Invoke-QuickDeploy, Invoke-QuickTeardown) are defined
   - Use content parsing (AST or regex) — don't execute the script
  </action>
  <verify>
- `Test-Path Tests/CLIActionRouting.Tests.ps1` is true
- Pester tests pass: `Invoke-Pester Tests/CLIActionRouting.Tests.ps1 -PassThru`
  </verify>
  <done>CLI action routing tests validate every action has a handler and no legacy variable references remain.</done>
</task>

</tasks>

<verification>
- Every ValidateSet action in OpenCodeLab-App.ps1 has a switch case handler
- No legacy variable references ($Server_Memory, $Client_Memory, $LabName, $LabSwitch) in orchestrator
- Quick mode deploy/teardown functions handle errors gracefully
- Pester action routing tests pass
</verification>

<success_criteria>
1. All 25+ CLI actions route to handlers without unhandled errors
2. No dead code or legacy variable references in orchestrator
3. Quick mode restore and auto-heal flow is verified
4. Menu system routes every key to correct handler
5. Tests cover every action routing path
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-lifecycle-integration/03-05-SUMMARY.md`
</output>
