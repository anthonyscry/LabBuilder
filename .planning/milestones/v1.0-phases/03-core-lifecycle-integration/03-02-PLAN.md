---
phase: 03-core-lifecycle-integration
plan: 02
type: execute
wave: 1
depends_on:
  - 03-01
files_modified:
  - Deploy.ps1
  - OpenCodeLab-App.ps1
  - Tests/DeployErrorHandling.Tests.ps1
autonomous: true
requirements:
  - CLI-08
  - LIFE-01

must_haves:
  truths:
    - "Every critical section in Deploy.ps1 (DHCP, DNS forwarders, share creation, Git install, SSH config, RSAT, checkpoint) is wrapped in try-catch with context-aware error messages"
    - "Non-fatal failures (Git install, RSAT, SSH) log warnings and continue; fatal failures (Install-Lab, AD DS) throw with troubleshooting steps"
    - "LabReady checkpoint creation is validated — script verifies checkpoint exists on all VMs after Checkpoint-LabVM"
    - "Deploy.ps1 produces a structured deployment report with per-section timing and pass/fail status"
  artifacts:
    - path: "Deploy.ps1"
      provides: "Robust error handling on all critical deployment sections"
      contains: "catch.*context"
    - path: "Tests/DeployErrorHandling.Tests.ps1"
      provides: "Tests that verify error handling patterns exist in Deploy.ps1"
      contains: "Describe.*Error"
  key_links:
    - from: "Deploy.ps1"
      to: "OpenCodeLab-App.ps1"
      via: "Called via Invoke-RepoScript -BaseName Deploy"
      pattern: "Invoke-RepoScript.*Deploy"
---

<objective>
Add structured try-catch error handling to every critical section of Deploy.ps1 and validate LabReady checkpoint creation.

Purpose: Deploy.ps1 currently has a single outer try-catch that catches everything. When DHCP configuration fails, the error message is a raw PowerShell exception with no context about what was being attempted. Each section needs its own error handling with context-aware messages that tell the operator what failed and how to recover.

Output: Every Deploy.ps1 section has try-catch with section name, failure description, and troubleshooting steps. LabReady checkpoint is verified after creation. Deployment produces per-section timing summary.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-lifecycle-integration/03-RESEARCH.md
@.planning/phases/03-core-lifecycle-integration/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add try-catch to Deploy.ps1 critical sections</name>
  <files>Deploy.ps1</files>
  <action>
1. **Define error handling strategy:**
   - **Fatal sections** (Install-Lab, AD DS validation, vSwitch/NAT) → try-catch with throw (include troubleshooting steps)
   - **Non-fatal sections** (DHCP, DNS forwarders, Git, SSH, RSAT, share) → try-catch with Write-LabStatus WARN and continue
   - Each catch block includes: section name, what was being attempted, the error message, and remediation steps

2. **Wrap these sections in try-catch:**
   - DHCP role + scope installation (lines 640-670) — non-fatal, warn and continue
   - DNS forwarder configuration (already has try-catch but improve messaging)
   - DC1 share creation (lines 804-842) — non-fatal
   - DC1 Git installation (already has try-catch but improve messaging)
   - DC1 OpenSSH configuration (already has try-catch but improve messaging)
   - ws1 RSAT installation (already has try-catch but improve messaging)
   - ws1 Git installation (already has try-catch but improve messaging)
   - LIN1 creation and configuration (already has try-catch but improve messaging)

3. **Add per-section timing summary:**
   Create a `$sectionResults` list that tracks each section's name, duration, and status (OK/WARN/FAIL). Print a deployment summary table at the end.

4. **Validate LabReady checkpoint:**
   After `Checkpoint-LabVM -All -SnapshotName 'LabReady'` (line 1211), add validation:
   ```powershell
   foreach ($vmName in @($GlobalLabConfig.Lab.CoreVMNames)) {
       $snap = Get-VMSnapshot -VMName $vmName -Name 'LabReady' -ErrorAction SilentlyContinue
       if (-not $snap) {
           Write-LabStatus -Status WARN -Message "LabReady checkpoint missing for VM '$vmName'"
       }
   }
   ```

5. **Improve the AD DS recovery section** error messages to include specific troubleshooting commands the operator can run.
  </action>
  <verify>
- Each major section in Deploy.ps1 has its own try-catch
- Fatal sections re-throw with context; non-fatal sections warn and continue
- LabReady checkpoint validation exists after Checkpoint-LabVM
- Deployment summary table is printed at end
  </verify>
  <done>Deploy.ps1 has structured error handling on all critical sections with context-aware messages, per-section timing, and LabReady checkpoint validation.</done>
</task>

<task type="auto">
  <name>Task 2: Add error handling tests</name>
  <files>Tests/DeployErrorHandling.Tests.ps1</files>
  <action>
1. **Create Tests/DeployErrorHandling.Tests.ps1** with Pester 5 tests:
   - Test: Deploy.ps1 contains try-catch blocks for key sections (DHCP, DNS, Share, Git, SSH, RSAT, Checkpoint)
   - Test: Each catch block contains Write-LabStatus or throw
   - Test: LabReady checkpoint validation code exists
   - Test: Section timing tracking exists ($sectionResults or equivalent)
   - Use content-scanning approach (Get-Content + Select-String) rather than execution
  </action>
  <verify>
- `Test-Path Tests/DeployErrorHandling.Tests.ps1` is true
- Pester tests pass: `Invoke-Pester Tests/DeployErrorHandling.Tests.ps1 -PassThru`
  </verify>
  <done>Error handling tests validate that Deploy.ps1 has structured error handling on all critical sections.</done>
</task>

</tasks>

<verification>
- Deploy.ps1 has try-catch on every section listed in research (DHCP, DNS, share, Git, SSH, RSAT, checkpoint)
- Fatal errors include troubleshooting steps in the throw message
- Non-fatal errors log WARN status and continue
- LabReady checkpoint is verified after creation
- Pester tests pass
</verification>

<success_criteria>
1. Every critical Deploy.ps1 section has context-aware error handling
2. Fatal vs non-fatal failure distinction is clear and consistent
3. LabReady checkpoint creation is validated
4. Tests verify error handling patterns exist
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-lifecycle-integration/03-02-SUMMARY.md`
</output>
