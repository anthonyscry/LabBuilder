---
phase: 03-core-lifecycle-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Bootstrap.ps1
  - Deploy.ps1
  - Scripts/Test-OpenCodeLabPreflight.ps1
  - Scripts/Test-OpenCodeLabHealth.ps1
  - Tests/BootstrapDeployInterpolation.Tests.ps1
autonomous: true
requirements:
  - LIFE-01
  - CLI-04

must_haves:
  truths:
    - "All string interpolation of $GlobalLabConfig nested properties uses subexpression syntax: $($GlobalLabConfig.X.Y)"
    - "Deploy.ps1 param block has valid PowerShell parameter names (no dotted paths)"
    - "Bootstrap.ps1 does not reference $LabSwitch, $LabName, $LabSourcesRoot, or any legacy variables"
    - "Scripts/Test-OpenCodeLabPreflight.ps1 and Test-OpenCodeLabHealth.ps1 use $GlobalLabConfig exclusively"
  artifacts:
    - path: "Bootstrap.ps1"
      provides: "Fixed string interpolation and removed legacy variable references"
      contains: "\\$\\(\\$GlobalLabConfig"
    - path: "Deploy.ps1"
      provides: "Fixed param block and string interpolation"
      contains: "\\$\\(\\$GlobalLabConfig"
    - path: "Tests/BootstrapDeployInterpolation.Tests.ps1"
      provides: "Tests that verify no bare $GlobalLabConfig.X.Y in double-quoted strings"
      contains: "Describe.*Interpolation"
  key_links:
    - from: "Bootstrap.ps1"
      to: "Lab-Config.ps1"
      via: "Dot-sources config at startup"
      pattern: ". $ConfigPath"
---

<objective>
Fix all string interpolation bugs, parameter syntax errors, and legacy variable references in Bootstrap.ps1, Deploy.ps1, Test-OpenCodeLabPreflight.ps1, and Test-OpenCodeLabHealth.ps1.

Purpose: These scripts cannot run end-to-end because `"$GlobalLabConfig.Paths.LabSourcesRoot\ISOs"` does not interpolate the nested property correctly in PowerShell — it evaluates `$GlobalLabConfig` (a hashtable) and then appends the literal `.Paths.LabSourcesRoot\ISOs`. The Deploy.ps1 param block also has a dotted path as a parameter name which is a syntax error.

Output: All four scripts use correct `$($GlobalLabConfig.X.Y)` subexpression syntax. Legacy variable fallbacks removed. Pester test validates no bare dotted interpolation remains.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-lifecycle-integration/03-RESEARCH.md
@.planning/phases/03-core-lifecycle-integration/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix string interpolation and param syntax in Deploy.ps1</name>
  <files>Deploy.ps1</files>
  <action>
1. **Fix param block (line 15):** Change `[string]$GlobalLabConfig.Credentials.AdminPassword` to a valid parameter name like `[string]$AdminPassword`. Update line 46 to use the new param name:
   ```powershell
   $GlobalLabConfig.Credentials.AdminPassword = Resolve-LabPassword -Password $(if ($PSBoundParameters.ContainsKey('AdminPassword')) { $AdminPassword } else { $GlobalLabConfig.Credentials.AdminPassword })
   ```

2. **Fix all string interpolation throughout Deploy.ps1:** Search for patterns like `"$GlobalLabConfig.X.Y"` in double-quoted strings and replace with `"$($GlobalLabConfig.X.Y)"`. Key locations:
   - Line 48: `$IsoPath = "$GlobalLabConfig.Paths.LabSourcesRoot\ISOs"` → `$IsoPath = "$($GlobalLabConfig.Paths.LabSourcesRoot)\ISOs"`
   - Line 49: SSH key path
   - Line 99: `$logDir = "$GlobalLabConfig.Paths.LabSourcesRoot\Logs"` → `"$($GlobalLabConfig.Paths.LabSourcesRoot)\Logs"`
   - All Write-Host strings referencing $GlobalLabConfig nested properties
   - All Join-Path calls that use string interpolation with $GlobalLabConfig

   **Pattern to find:** `"[^"]*\$GlobalLabConfig\.[^(]` in double-quoted strings
   **Replace with:** Wrap each `$GlobalLabConfig.X.Y.Z` in `$()` subexpression

3. **Remove legacy variable fallbacks (lines 52-62):** Delete the `Get-Variable -Name Server1_Ip` checks and the `$WSUS_Memory` legacy aliases. These reference variables that no longer exist.

4. **Fix Git installer hardcoded values:** Replace hardcoded SHA256 hashes and URLs in Invoke-LabCommand calls (lines 972, 1146) with `$GlobalLabConfig.SoftwarePackages.Git.Sha256` and `$GlobalLabConfig.SoftwarePackages.Git.Url`.
  </action>
  <verify>
- `Select-String -Path Deploy.ps1 -Pattern '"[^"]*\$GlobalLabConfig\.\w+\.\w+[^)]'` returns no hits (all nested properties wrapped in subexpressions)
- `Select-String -Path Deploy.ps1 -Pattern 'Get-Variable -Name (Server1_Ip|Server_Memory|WSUS_)'` returns no hits
- Deploy.ps1 param block parses without error: `[scriptblock]::Create((Get-Content Deploy.ps1 -Raw))` succeeds
  </verify>
  <done>Deploy.ps1 param syntax fixed, all string interpolation corrected, legacy variable fallbacks removed, Git config values read from $GlobalLabConfig.</done>
</task>

<task type="auto">
  <name>Task 2: Fix Bootstrap.ps1, preflight, and health check scripts</name>
  <files>Bootstrap.ps1, Scripts/Test-OpenCodeLabPreflight.ps1, Scripts/Test-OpenCodeLabHealth.ps1, Tests/BootstrapDeployInterpolation.Tests.ps1</files>
  <action>
1. **Bootstrap.ps1:**
   - Remove all legacy variable fallback checks (lines 39-44): Delete `Get-Variable -Name LabName/LabSwitch/etc` blocks entirely
   - Fix line 43: `$NatName = "${LabSwitch}NAT"` → read from $GlobalLabConfig.Network.NatName
   - Fix all string interpolation: `"$GlobalLabConfig.Paths.LabSourcesRoot\ISOs"` → `"$($GlobalLabConfig.Paths.LabSourcesRoot)\ISOs"` etc.
   - Fix `$RequiredFolders` array (lines 49-57) to use subexpression syntax
   - Replace any remaining `$LabSwitch`, `$LabSourcesRoot`, `$GatewayIp`, `$NatName`, `$AddressSpace` bare variables with `$GlobalLabConfig` references

2. **Scripts/Test-OpenCodeLabPreflight.ps1:**
   - Remove legacy variable fallback checks (lines 21-25): Delete `Get-Variable -Name LabSourcesRoot/LabSwitch/etc` blocks
   - Fix `@($GlobalLabConfig.RequiredISOs) = @(...)` syntax — this is attempting to assign to a function call
   - Use `$GlobalLabConfig` properties directly instead of fallback variables

3. **Scripts/Test-OpenCodeLabHealth.ps1:**
   - Remove legacy variable fallback checks (lines 21-28): Delete `Get-Variable -Name LabName/LabVMs/etc` blocks
   - Fix `@($GlobalLabConfig.Lab.CoreVMNames) = @(...)` assignment syntax
   - Use `$GlobalLabConfig` properties directly

4. **Create Tests/BootstrapDeployInterpolation.Tests.ps1:**
   - Pester 5 test that scans Bootstrap.ps1 and Deploy.ps1 for bare `$GlobalLabConfig.X.Y` inside double-quoted strings (not wrapped in `$()`)
   - Test that Deploy.ps1 param block is valid PowerShell
   - Test that Bootstrap.ps1 doesn't reference legacy variable names ($LabSwitch, $LabName, etc.)
  </action>
  <verify>
- `Select-String -Path Bootstrap.ps1 -Pattern '\$LabSwitch|\$LabName|\$LabSourcesRoot|\$GatewayIp(?!\.)'` returns no hits
- `Select-String -Path Scripts/Test-OpenCodeLabPreflight.ps1 -Pattern 'Get-Variable -Name (LabSourcesRoot|LabSwitch|NatName)'` returns no hits
- `Select-String -Path Scripts/Test-OpenCodeLabHealth.ps1 -Pattern 'Get-Variable -Name (LabName|LabVMs|LinuxUser)'` returns no hits
- Pester tests pass: `Invoke-Pester Tests/BootstrapDeployInterpolation.Tests.ps1 -PassThru`
  </verify>
  <done>Bootstrap.ps1, preflight, and health scripts fixed. All legacy variable references removed. Interpolation test created.</done>
</task>

</tasks>

<verification>
- All four scripts parse without syntax errors
- No bare `$GlobalLabConfig.X.Y` in double-quoted strings (all wrapped in subexpressions)
- No legacy variable names ($LabSwitch, $LabName, $Server1_Ip, etc.) referenced outside Lab-Config.ps1
- Deploy.ps1 param block uses valid PowerShell parameter names
- Pester interpolation test passes
</verification>

<success_criteria>
1. Deploy.ps1 has valid param block and correct string interpolation
2. Bootstrap.ps1 uses $GlobalLabConfig exclusively with no legacy variable references
3. Preflight and health check scripts use $GlobalLabConfig exclusively
4. Test verifies no regression of bare dotted interpolation
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-lifecycle-integration/03-01-SUMMARY.md`
</output>
