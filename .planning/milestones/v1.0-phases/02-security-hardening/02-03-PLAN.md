---
phase: 02-security-hardening
plan: 03
type: execute
wave: 3
depends_on: []
files_modified:
  - Deploy.ps1
  - Private/Protect-LabLogString.ps1
  - Public/Write-RunArtifact.ps1
  - Tests/ProtectLabLogString.Tests.ps1
autonomous: true
requirements:
  - SEC-03
  - SEC-04

must_haves:
  truths:
    - "Git installer download requires checksum — the 'if ($ExpectedSha256)' conditional is removed, checksum validation always runs"
    - "Protect-LabLogString function exists and scrubs known credential patterns from strings"
    - "Write-RunArtifact passes CustomData values through Protect-LabLogString before serialization"
    - "GUI settings save does NOT persist password fields to disk (verified, not changed — already correct)"
  artifacts:
    - path: "Private/Protect-LabLogString.ps1"
      provides: "Credential scrubbing function for log/artifact output"
      contains: "function Protect-LabLogString"
    - path: "Tests/ProtectLabLogString.Tests.ps1"
      provides: "Tests for credential scrubbing"
      contains: "Describe.*Protect-LabLogString"
  key_links:
    - from: "Public/Write-RunArtifact.ps1"
      to: "Private/Protect-LabLogString.ps1"
      via: "Protect-LabLogString call on CustomData"
      pattern: "Protect-LabLogString"
---

<objective>
Make download checksum validation mandatory and create a credential scrubbing function for log output.

Purpose: Ensure external downloads always validate integrity (defense against MITM/corrupted downloads) and that credentials cannot leak into run artifacts, log files, or error messages — even if a developer accidentally passes sensitive data through CustomData or error contexts.

Output: Checksum validation is mandatory for Git download. Protect-LabLogString scrubs credentials from strings. Write-RunArtifact uses scrubber on CustomData. Tests cover both.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-hardening/02-RESEARCH.md
@.planning/phases/02-security-hardening/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make checksum validation mandatory and create Protect-LabLogString</name>
  <files>Deploy.ps1, Private/Protect-LabLogString.ps1</files>
  <action>
1. **Deploy.ps1** — Make checksum validation mandatory for Git download:
   In the `$gitInstallerScriptBlock` (around line 937), change:
   ```powershell
   if ($ExpectedSha256) {
   ```
   To:
   ```powershell
   if ([string]::IsNullOrWhiteSpace($ExpectedSha256)) {
       Remove-Item $gitInstaller -Force -ErrorAction SilentlyContinue
       $result.Message = "Git installer download rejected: no checksum provided. Set SoftwarePackages.Git.Sha256 in Lab-Config.ps1."
       return $result
   }
   ```
   Then keep the existing validation logic (Get-FileHash comparison).

   This means: if no checksum is configured, the download is rejected entirely. No silent bypass.

2. **Create Private/Protect-LabLogString.ps1**:
   ```powershell
   function Protect-LabLogString {
       <#
       .SYNOPSIS
           Scrubs known credential patterns from a string.
       .DESCRIPTION
           Replaces known default passwords, environment variable password values,
           and credential-like patterns with '***REDACTED***' to prevent credential
           leakage in logs, run artifacts, and error output.
       .PARAMETER InputString
           The string to scrub.
       .OUTPUTS
           [string] The scrubbed string.
       #>
       [CmdletBinding()]
       [OutputType([string])]
       param(
           [AllowEmptyString()][AllowNull()]
           [string]$InputString
       )

       if ([string]::IsNullOrEmpty($InputString)) { return $InputString }

       $result = $InputString

       # Scrub known default passwords
       $knownDefaults = @('SimpleLab123!', 'SimpleLabSqlSa123!')
       foreach ($pwd in $knownDefaults) {
           if ($result.Contains($pwd)) {
               $result = $result.Replace($pwd, '***REDACTED***')
           }
       }

       # Scrub password env var values if they are set
       $envVarNames = @('OPENCODELAB_ADMIN_PASSWORD', 'LAB_ADMIN_PASSWORD')
       foreach ($envName in $envVarNames) {
           $envValue = [System.Environment]::GetEnvironmentVariable($envName)
           if (-not [string]::IsNullOrEmpty($envValue) -and $result.Contains($envValue)) {
               $result = $result.Replace($envValue, '***REDACTED***')
           }
       }

       # Scrub GlobalLabConfig passwords if available
       if (Test-Path variable:GlobalLabConfig) {
           $configPasswords = @(
               $GlobalLabConfig.Credentials.AdminPassword,
               $GlobalLabConfig.Credentials.SqlSaPassword
           )
           foreach ($cp in $configPasswords) {
               if (-not [string]::IsNullOrEmpty($cp) -and $result.Contains($cp)) {
                   $result = $result.Replace($cp, '***REDACTED***')
               }
           }
       }

       return $result
   }
   ```

   Design notes:
   - Scrubs known defaults, env var values, and config values
   - Uses simple string replacement (fast, predictable)
   - Does NOT use regex (passwords contain special chars that would need escaping)
   - Returns input unchanged if no matches found
  </action>
  <verify>
- `grep 'if (\$ExpectedSha256)' Deploy.ps1` returns no hits (conditional removed)
- `grep 'no checksum provided' Deploy.ps1` shows the new rejection message
- `Test-Path Private/Protect-LabLogString.ps1` is true
- `grep 'REDACTED' Private/Protect-LabLogString.ps1` shows the scrubbing marker
  </verify>
  <done>Checksum validation made mandatory for Git download (rejects if no hash configured). Protect-LabLogString created with multi-layer credential scrubbing.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Protect-LabLogString into Write-RunArtifact and add tests</name>
  <files>Public/Write-RunArtifact.ps1, Tests/ProtectLabLogString.Tests.ps1</files>
  <action>
1. **Public/Write-RunArtifact.ps1** — Scrub CustomData before serialization:
   After the `if ($CustomData)` block (around line 110), add scrubbing:
   ```powershell
   if ($CustomData) {
       foreach ($key in $CustomData.Keys) {
           $val = $CustomData[$key]
           if ($val -is [string]) {
               $artifact[$key] = Protect-LabLogString -InputString $val
           } else {
               $artifact[$key] = $val
           }
       }
   }
   ```
   This scrubs string values in CustomData. Non-string values (numbers, arrays, nested objects) pass through unchanged.

   Also scrub the error message if present:
   After line 103 where `$artifact.Error.Message` is set:
   ```powershell
   if ($ErrorRecord) {
       $artifact.Error = [ordered]@{
           Message = Protect-LabLogString -InputString $ErrorRecord.Exception.Message
           Type = $ErrorRecord.Exception.GetType().FullName
           ScriptStackTrace = $ErrorRecord.ScriptStackTrace
       }
   }
   ```
   Note: ScriptStackTrace shows file paths and line numbers, not variable values — safe to leave unscrubbed.

2. **Create Tests/ProtectLabLogString.Tests.ps1**:
   - Test: Returns empty/null input unchanged
   - Test: Scrubs 'SimpleLab123!' from input string
   - Test: Scrubs 'SimpleLabSqlSa123!' from input string
   - Test: Scrubs environment variable values when set
   - Test: Scrubs $GlobalLabConfig password values when available
   - Test: Leaves non-matching strings unchanged
   - Test: Handles strings with multiple credential occurrences
   - Test: Replacement marker is '***REDACTED***'

   Follow existing test patterns: dot-source the helper in BeforeAll, set up mocks in BeforeEach.
   For env var tests, set `$env:OPENCODELAB_ADMIN_PASSWORD` in BeforeEach and clear in AfterEach.

3. **Verify GUI settings save** — Confirm (read-only check) that `GUI/Start-OpenCodeLabGUI.ps1` Save button handler does NOT serialize passwords to disk. Research confirms it only saves Theme and ISO paths. Document this in the summary as "verified correct."
  </action>
  <verify>
- `grep 'Protect-LabLogString' Public/Write-RunArtifact.ps1` shows the scrubbing calls
- `Test-Path Tests/ProtectLabLogString.Tests.ps1` is true
- Pester tests pass: `Invoke-Pester Tests/ProtectLabLogString.Tests.ps1 -PassThru`
- GUI settings save confirmed to NOT persist passwords (read-only verification)
  </verify>
  <done>Write-RunArtifact scrubs CustomData and error messages through Protect-LabLogString. Tests cover all scrubbing scenarios. GUI settings save verified password-safe.</done>
</task>

</tasks>

<verification>
- Git installer download rejects missing checksum (mandatory validation)
- Protect-LabLogString scrubs known defaults, env var values, and config passwords
- Write-RunArtifact CustomData and error messages pass through scrubber
- GUI settings file never contains password fields
- All tests pass
</verification>

<success_criteria>
1. Git download checksum validation is mandatory (not conditional)
2. Protect-LabLogString exists and scrubs credentials from strings
3. Write-RunArtifact uses scrubber on CustomData and error messages
4. GUI settings save confirmed NOT to persist passwords
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-hardening/02-03-SUMMARY.md`
</output>
