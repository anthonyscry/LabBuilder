---
phase: 02-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Resolve-LabPassword.ps1
  - Lab-Config.ps1
  - Public/Linux/New-LinuxGoldenVhdx.ps1
  - Public/Linux/Join-LinuxToDomain.ps1
  - Public/Initialize-LabVMs.ps1
  - Tests/ResolveLabPassword.Tests.ps1
autonomous: true
requirements:
  - SEC-01

must_haves:
  truths:
    - "Resolve-LabPassword implements full resolution chain: parameter > env var > config default (with loud warning) > interactive prompt"
    - "No Public/ function has a hardcoded 'SimpleLab123!' as a parameter default — all use $GlobalLabConfig lookup"
    - "Lab-Config.ps1 default password warning fires on every config load when default is in use"
    - "SQL SA password follows same resolution pattern via Resolve-LabSqlPassword or extended Resolve-LabPassword"
  artifacts:
    - path: "Private/Resolve-LabPassword.ps1"
      provides: "Enhanced password resolution with warning-on-default and interactive fallback"
      contains: "Write-Warning.*default"
    - path: "Tests/ResolveLabPassword.Tests.ps1"
      provides: "Tests for all resolution chain branches"
      contains: "Describe.*Resolve-LabPassword"
  key_links:
    - from: "Lab-Config.ps1"
      to: "Private/Resolve-LabPassword.ps1"
      via: "Resolve-LabPassword call after config load"
      pattern: "Resolve-LabPassword"
---

<objective>
Implement the full password resolution chain and eliminate hardcoded password fallbacks from Public/ functions.

Purpose: Ensure passwords are resolved through a consistent, auditable chain (parameter > env var > config default with warning > interactive prompt) so that no deployment silently uses a well-known default password without the operator being aware.

Output: Updated Resolve-LabPassword with warning-on-default and interactive fallback. Public/ functions use $GlobalLabConfig instead of hardcoded defaults. Tests cover all resolution branches.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-hardening/02-RESEARCH.md
@.planning/phases/02-security-hardening/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Resolve-LabPassword with warning-on-default and interactive fallback</name>
  <files>Private/Resolve-LabPassword.ps1, Lab-Config.ps1</files>
  <action>
1. Update `Private/Resolve-LabPassword.ps1` to implement the full resolution chain:
   ```
   Priority:
   1. Explicit non-empty $Password parameter -> return it (check if it matches default and warn if so)
   2. Environment variable ($EnvVarName, default 'OPENCODELAB_ADMIN_PASSWORD') -> return it
   3. Interactive prompt via Read-Host -AsSecureString (if running interactively)
   4. Throw error (non-interactive and no password available)
   ```

2. Add a `-DefaultPassword` parameter so the function knows what the "default" value is. When the resolved password equals the default, emit:
   ```powershell
   Write-Warning "[Security] Using default password. Set `$env:$EnvVarName or pass -AdminPassword for production use."
   ```

3. Add an `-EnvVarName` parameter (default: `'OPENCODELAB_ADMIN_PASSWORD'`) so callers can specify which env var to check. This allows SQL password to use a different env var.

4. Add a `-PasswordLabel` parameter (default: `'AdminPassword'`) for contextual warning messages.

5. The interactive prompt path:
   - Check `[Environment]::UserInteractive` to determine if prompting is possible
   - Use `Read-Host -Prompt "Enter $PasswordLabel" -AsSecureString`
   - Convert SecureString to plain text for return (same pattern as LabBuilder/Build-LabFromSelection.ps1:60-62)
   - If resulting string is empty, throw

6. In `Lab-Config.ps1`, the existing warning at line 441-442 should remain but become redundant — `Resolve-LabPassword` now handles this. Keep it as defense-in-depth.

7. Create `Private/Resolve-LabSqlPassword.ps1` as a thin wrapper:
   ```powershell
   function Resolve-LabSqlPassword {
       [CmdletBinding()][OutputType([string])]
       param([AllowEmptyString()][AllowNull()][string]$Password)
       Resolve-LabPassword -Password $Password `
           -EnvVarName $GlobalLabConfig.Credentials.BuilderPasswordEnvVar `
           -DefaultPassword 'SimpleLabSqlSa123!' `
           -PasswordLabel 'SqlSaPassword'
   }
   ```
   Note: Use the env var name from config (`LAB_ADMIN_PASSWORD` for builder, or add a dedicated SQL one).

8. Register `Resolve-LabSqlPassword` in `Lab-Common.ps1` helper sourcing if needed (check if Private/ files are auto-discovered or manually listed).
  </action>
  <verify>
- `Get-Content Private/Resolve-LabPassword.ps1` shows `-DefaultPassword`, `-EnvVarName`, `-PasswordLabel` parameters
- `Get-Content Private/Resolve-LabPassword.ps1` contains `Write-Warning` for default password detection
- `Get-Content Private/Resolve-LabPassword.ps1` contains `Read-Host.*AsSecureString` for interactive fallback
- `Test-Path Private/Resolve-LabSqlPassword.ps1` is true
  </verify>
  <done>Resolve-LabPassword enhanced with full resolution chain: explicit > env var > interactive prompt, with loud warning when default password detected. Resolve-LabSqlPassword wrapper created for SQL SA password.</done>
</task>

<task type="auto">
  <name>Task 2: Remove hardcoded password fallbacks from Public/ functions and add tests</name>
  <files>Public/Linux/New-LinuxGoldenVhdx.ps1, Public/Linux/Join-LinuxToDomain.ps1, Public/Initialize-LabVMs.ps1, Tests/ResolveLabPassword.Tests.ps1</files>
  <action>
1. **Public/Linux/New-LinuxGoldenVhdx.ps1** (line 32):
   Change:
   ```powershell
   [string]$Password = $(if ($GlobalLabConfig.Credentials.AdminPassword) { $GlobalLabConfig.Credentials.AdminPassword } else { 'SimpleLab123!' }),
   ```
   To:
   ```powershell
   [string]$Password = $(if (Test-Path variable:GlobalLabConfig) { $GlobalLabConfig.Credentials.AdminPassword } else { '' }),
   ```
   The empty string will cause Resolve-LabPassword (if called downstream) to check env var / prompt.

2. **Public/Linux/Join-LinuxToDomain.ps1** (line 17):
   Same pattern — replace `'SimpleLab123!'` fallback with empty string or `$GlobalLabConfig` lookup without hardcoded default.

3. **Public/Initialize-LabVMs.ps1** (line 109):
   Change:
   ```powershell
   $defaultPassword = if (Test-Path variable:GlobalLabConfig) { $GlobalLabConfig.Credentials.AdminPassword } else { 'SimpleLab123!' }
   ```
   To:
   ```powershell
   $defaultPassword = if (Test-Path variable:GlobalLabConfig) { $GlobalLabConfig.Credentials.AdminPassword } else { '' }
   ```

4. **Create Tests/ResolveLabPassword.Tests.ps1** with Pester 5 tests:
   - Test: Returns explicit non-empty password
   - Test: Returns env var when password is empty/null
   - Test: Warns when resolved password matches default
   - Test: Throws when non-interactive and no password available
   - Test: Resolve-LabSqlPassword delegates correctly
   - Mock `Read-Host` and `[Environment]::UserInteractive` as needed
   - Follow existing test patterns: dot-source in `BeforeAll`, mock in `BeforeEach`
  </action>
  <verify>
- `grep 'SimpleLab123!' Public/Linux/New-LinuxGoldenVhdx.ps1` returns no hits
- `grep 'SimpleLab123!' Public/Linux/Join-LinuxToDomain.ps1` returns no hits
- `grep 'SimpleLab123!' Public/Initialize-LabVMs.ps1` returns no hits
- `Test-Path Tests/ResolveLabPassword.Tests.ps1` is true
- Pester tests pass: `Invoke-Pester Tests/ResolveLabPassword.Tests.ps1 -PassThru`
  </verify>
  <done>Hardcoded 'SimpleLab123!' removed from all Public/ function parameter defaults. Tests created covering all resolution chain branches.</done>
</task>

</tasks>

<verification>
- `grep -r "SimpleLab123\!" --include="*.ps1" Public/` returns no hits (only Lab-Config.ps1 and test files should have it)
- `Resolve-LabPassword` has 4 resolution paths: explicit, env var, interactive, throw
- All existing tests still pass
- New tests cover warning-on-default behavior
</verification>

<success_criteria>
1. Resolve-LabPassword implements full resolution chain with warning on default password
2. No Public/ function has hardcoded 'SimpleLab123!' as parameter default
3. SQL SA password uses same resolution pattern
4. Tests cover all resolution branches including warning behavior
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-hardening/02-01-SUMMARY.md`
</output>
