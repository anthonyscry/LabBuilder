---
phase: 03-network-infrastructure
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - SimpleLab/Private/Set-VMStaticIP.ps1
  - SimpleLab/Private/Get-LabNetworkConfig.ps1
  - SimpleLab/Public/Initialize-LabNetwork.ps1
  - SimpleLab/SimpleLab.psm1
  - .planning/config.json
autonomous: true

must_haves:
  truths:
    - Tool assigns static IP addresses to VMs (DC: 10.0.0.1, Server: 10.0.0.2, Win11: 10.0.0.3)
    - Tool configures subnet mask 255.255.255.0 for all lab VMs
    - Tool stores IP configuration in config.json for persistence
    - Tool provides clear feedback about IP configuration status
  artifacts:
    - path: SimpleLab/Private/Set-VMStaticIP.ps1
      provides: In-VM IP configuration via PowerShell Direct
      min_lines: 40
    - path: SimpleLab/Private/Get-LabNetworkConfig.ps1
      provides: Network configuration retrieval from config.json
      min_lines: 20
    - path: SimpleLab/Public/Initialize-LabNetwork.ps1
      provides: Network initialization orchestrator
      min_lines: 50
      exports: [Initialize-LabNetwork]
  key_links:
    - from: Initialize-LabNetwork.ps1
      to: Get-LabNetworkConfig.ps1
      via: Internal function call
      pattern: Get-LabNetworkConfig
    - from: Initialize-LabNetwork.ps1
      to: Set-VMStaticIP.ps1
      via: Internal function call per VM
      pattern: Set-VMStaticIP.*-VMName
    - from: Set-VMStaticIP.ps1
      to: Target VM
      via: PowerShell Direct (Invoke-Command -VMName)
      pattern: Invoke-Command.*-VMName.*-ScriptBlock
    - from: Get-LabNetworkConfig.ps1
      to: .planning/config.json
      via: Get-LabConfig function
      pattern: Get-LabConfig
---

<objective>
Configure static IP addresses for lab VMs

Purpose: Assign predictable static IP addresses to all lab VMs (DC: 10.0.0.1, Server: 10.0.0.2, Win11: 10.0.0.3) to support domain configuration and reliable VM-to-VM communication.

Output: IP configuration system using PowerShell Direct for in-VM network setup
</objective>

<execution_context>
@/home/ajt/.claude/get-shit-done/workflows/execute-plan.md
@/home/ajt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern reference from prior phases
@SimpleLab/Public/Test-LabPrereqs.ps1
@SimpleLab/Private/Get-LabConfig.ps1
@.planning/phases/03-network-infrastructure/03-01-SUMMARY.md

# Network infrastructure from Plan 03-01
@SimpleLab/Public/Test-LabNetwork.ps1
@SimpleLab/Public/New-LabSwitch.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Get-LabNetworkConfig helper for network configuration</name>
  <files>SimpleLab/Private/Get-LabNetworkConfig.ps1</files>
  <action>
    Create Get-LabNetworkConfig function in Private/ that:
    - Accepts no parameters
    - Returns PSCustomObject with lab network configuration from config.json
    - Properties: Subnet (string, default "10.0.0.0/24"), PrefixLength (int, default 24), Gateway (string, empty for Internal switch), DNSServers (string array, empty initially)
    - VMIPs hashtable with VM names as keys and IP addresses as values:
      - "SimpleDC" = "10.0.0.1"
      - "SimpleServer" = "10.0.0.2"
      - "SimpleWin11" = "10.0.0.3"
    - Uses Get-LabConfig to read config.json, retrieves NetworkConfiguration section
    - Provides defaults if NetworkConfiguration not present in config
    - Internal function only (not exported)

    Pattern reference: Follow Get-LabConfig.ps1 pattern for config retrieval
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: $config = Get-LabNetworkConfig (from within module scope)
    3. Verify output contains Subnet, PrefixLength, Gateway, DNSServers, VMIPs properties
    4. Verify VMIPs hashtable has entries for SimpleDC, SimpleServer, SimpleWin11
  </verify>
  <done>
    Get-LabNetworkConfig function returns network configuration with IP assignments for all lab VMs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Set-VMStaticIP function for in-VM IP configuration</name>
  <files>SimpleLab/Private/Set-VMStaticIP.ps1</files>
  <action>
    Create Set-VMStaticIP function in Private/ that:
    - Parameters: VMName (string, mandatory), IPAddress (string, mandatory), PrefixLength (int, default 24), InterfaceAlias (string, default "Ethernet")
    - Uses PowerShell Direct (Invoke-Command -VMName $VMName) to execute inside VM
    - In-VM scriptblock:
      - Gets network adapter using Get-NetAdapter -Name $InterfaceAlias
      - Configures IP using: New-NetIPAddress -IPAddress $IPAddress -PrefixLength $PrefixLength -InterfaceAlias $InterfaceAlias
      - Removes any existing default gateway (Remove-NetRoute -DestinationPrefix 0.0.0.0/0 -Confirm:$false) for isolated network
      - Sets DNS servers to empty array (Set-DnsClientServerAddress -InterfaceAlias $InterfaceAlias -ResetServerAddresses)
    - Returns PSCustomObject with: VMName, IPAddress, Configured, Status, Message
    - Status values: "OK", "Failed", "VMNotFound"
    - Handles VM not running or not found errors gracefully
    - Internal function only (not exported)

    Pattern reference: Follow error handling pattern from Test-LabPrereqs.ps1
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. (Note: Verification requires a running VM with PowerShell Direct enabled)
    3. Function should return structured PSCustomObject with VMName, IPAddress, Configured, Status, Message
    4. Function handles non-existent VM with Status="VMNotFound"
  </verify>
  <done>
    Set-VMStaticIP function configures static IP address inside VM using PowerShell Direct and returns structured result
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Initialize-LabNetwork orchestrator and update config</name>
  <files>SimpleLab/Public/Initialize-LabNetwork.ps1</files>
  <action>
    Create Initialize-LabNetwork function in Public/ that:
    - Parameters: VMNames (string array, optional - if not provided, uses defaults: "SimpleDC", "SimpleServer", "SimpleWin11")
    - Orchestrates IP configuration for all VMs
    - Uses Get-LabNetworkConfig to get IP assignments
    - Iterates through VMNames, calling Set-VMStaticIP for each with configured IP
    - Returns PSCustomObject with: VMConfigured (hashtable), FailedVMs (array), OverallStatus, Duration
    - OverallStatus values: "OK" (all configured), "Partial" (some failed), "Failed" (all failed)
    - VMConfigured hashtable maps VMName to configuration result
    - Measures execution duration using New-TimeSpan
    - Provides summary Message with count of successful/failed configurations

    Pattern reference: Follow Test-LabPrereqs orchestrator pattern (structured result with overall status)
    Use [CmdletBinding()] and [OutputType([PSCustomObject])] attributes
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1
    2. Run: Initialize-LabNetwork (without running VMs, should handle gracefully)
    3. Verify output contains VMConfigured, FailedVMs, OverallStatus, Duration properties
    4. Verify OverallStatus reflects configuration attempts
  </verify>
  <done>
    Initialize-LabNetwork function orchestrates IP configuration for all lab VMs and returns structured result
  </done>
</task>

<task type="auto">
  <name>Task 4: Update config.json with NetworkConfiguration section</name>
  <files>.planning/config.json</files>
  <action>
    Update .planning/config.json to add NetworkConfiguration section:
    - Add at root level (sibling to IsoPaths, IsoSearchPaths, Requirements)
    - Structure:
      ```json
      "NetworkConfiguration": {
        "Subnet": "10.0.0.0/24",
        "PrefixLength": 24,
        "Gateway": "",
        "DNSServers": [],
        "VMIPs": {
          "SimpleDC": "10.0.0.1",
          "SimpleServer": "10.0.0.2",
          "SimpleWin11": "10.0.0.3"
        }
      }
      ```
    - Gateway empty string because Internal switch has no default gateway
    - DNSServers empty array initially (will be configured by DC in Phase 5)
    - Preserve existing IsoPaths, IsoSearchPaths, Requirements sections
  </action>
  <verify>
    1. Read .planning/config.json
    2. Verify NetworkConfiguration section exists with Subnet, PrefixLength, Gateway, DNSServers, VMIPs
    3. Verify VMIPs contains entries for SimpleDC, SimpleServer, SimpleWin11 with correct IPs
    4. Verify existing sections (IsoPaths, IsoSearchPaths, Requirements) are preserved
  </verify>
  <done>
    config.json contains NetworkConfiguration section with IP assignments for all lab VMs
  </done>
</task>

<task type="auto">
  <name>Task 5: Update SimpleLab.psm1 to export Initialize-LabNetwork</name>
  <files>SimpleLab/SimpleLab.psm1</files>
  <action>
    Update SimpleLab.psm1 Export-ModuleMember to include:
    - Add 'Initialize-LabNetwork' to exported function list

    Maintain existing alphabetical ordering in the Export-ModuleMember array
    Note: Get-LabNetworkConfig and Set-VMStaticIP remain internal (Private/)
  </action>
  <verify>
    1. Import SimpleLab module: Import-Module ./SimpleLab/SimpleLab.psd1 -Force
    2. Run: Get-Command -Module SimpleLab
    3. Verify Initialize-LabNetwork appears in output
    4. Verify Get-LabNetworkConfig and Set-VMStaticIP do NOT appear (internal functions)
  </verify>
  <done>
    Initialize-LabNetwork function is exported from SimpleLab module and available for use
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Get-LabNetworkConfig returns network configuration with VM IP assignments from config.json
2. Set-VMStaticIP handles non-existent VMs gracefully with Status="VMNotFound"
3. Initialize-LabNetwork orchestrates configuration for all VMs and returns structured result
4. config.json contains NetworkConfiguration section with correct IP assignments
5. Initialize-LabNetwork is exported from module, internal functions are not
</verification>

<success_criteria>
1. Tool configures static IP addresses: DC (10.0.0.1), Server (10.0.0.2), Win11 (10.0.0.3)
2. IP configuration is stored in config.json for persistence
3. Initialize-LabNetwork provides clear status feedback for each VM
4. Function handles VM not found errors gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-network-infrastructure/03-02-SUMMARY.md` with:
- Files created/modified
- Function signatures and return schemas
- Configuration schema for NetworkConfiguration
- Test results
- Any deviations from plan
</output>
