---
phase: 05-gui-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - GUI/Start-OpenCodeLabGUI.ps1
  - Tests/WpfGui.Tests.ps1
autonomous: true
requirements:
  - GUI-04
  - GUI-05
  - GUI-07

must_haves:
  truths:
    - "Log entries list has a configurable size cap (default 2000)"
    - "Add-LogEntry trims oldest entries when cap is exceeded"
    - "Render-LogEntries uses view-element FindResource instead of mainWindow FindResource"
    - "Settings Save handler persists network settings (switch name, subnet, gateway IP) to config.json"
    - "Settings Save handler persists admin username to config.json"
    - "Settings Save handler validates subnet format before saving"
    - "Get-GuiSettings returns empty hashtable on corrupt JSON without throwing"
    - "Save-GuiSettings handles write failures gracefully with a warning"
    - "Initialize-SettingsView loads admin username from gui-settings.json when GlobalLabConfig unavailable"
  artifacts:
    - path: "GUI/Start-OpenCodeLabGUI.ps1"
      provides: "Hardened log management, full settings persistence, robust JSON error handling"
    - path: "Tests/WpfGui.Tests.ps1"
      provides: "Tests for settings persistence paths and log cap behavior"
  key_links:
    - from: "GUI/Start-OpenCodeLabGUI.ps1"
      to: ".planning/gui-settings.json"
      via: "Get-GuiSettings / Save-GuiSettings functions"
      pattern: "gui-settings.json"
    - from: "GUI/Start-OpenCodeLabGUI.ps1"
      to: ".planning/config.json"
      via: "Settings Save handler writes network + credential settings"
      pattern: "config.json"
---

<objective>
Harden log management, complete settings persistence, and make JSON handling robust against corruption.

Purpose: The Logs view rendering calls `$mainWindow.FindResource()` which can fail after a theme switch because the resource dictionaries are on the Application, not the window. The in-memory log list grows without bound, eventually consuming all memory. The Settings Save handler only persists ISO paths, silently discarding network and credential changes the user made. Get-GuiSettings returns gracefully on missing files but the JSON could be truncated/corrupt. These are the remaining reliability gaps before feature parity is complete.

Output: Updated Start-OpenCodeLabGUI.ps1 with bounded log buffer, theme-safe color resolution, full settings persistence including network/credentials, and defensive JSON handling.
</objective>

<execution_context>
- Render-LogEntries at line 1311 uses `$mainWindow.FindResource($brushKey)` -- theme brushes live on Application.Current.Resources after Set-AppTheme
- $script:LogEntries is a List[PSCustomObject] with no size limit (line 1280)
- Add-LogEntry at line 1285 appends without trimming
- Settings Save handler at line 1480 only writes IsoPaths to config.json
- Get-GuiSettings at line 94 catches parse errors but returns @{} -- no backup/recovery
- Save-GuiSettings at line 124 does not catch write failures
- Initialize-SettingsView at line 1393 reads from GlobalLabConfig only, not from gui-settings.json
</execution_context>

<changes>

## Change 1: Add log entry size cap with FIFO trimming

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** Around line 1280, after `$script:LogEntries` declaration

Add a cap constant and enforce it in Add-LogEntry:

```powershell
$script:LogEntriesMaxCount = 2000
```

In Add-LogEntry, after `$script:LogEntries.Add($entry)`:

```powershell
while ($script:LogEntries.Count -gt $script:LogEntriesMaxCount) {
    $script:LogEntries.RemoveAt(0)
}
```

## Change 2: Fix Render-LogEntries to use Application-level resource lookup

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Render-LogEntries` function, around line 1337

Replace:
```powershell
$run.Foreground = $mainWindow.FindResource($brushKey)
```

With:
```powershell
$run.Foreground = [System.Windows.Application]::Current.FindResource($brushKey)
```

This ensures color-coded log entries resolve correctly after a theme switch since Set-AppTheme pushes dictionaries onto Application.Current.Resources, not the window.

## Change 3: Complete Settings Save handler to persist network and credentials

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Initialize-SettingsView`, the `$btnSaveSettings.Add_Click` handler around line 1480

After writing ISO paths to config.json, also write:

```powershell
# Persist network settings
$existingProps = @($configJson.PSObject.Properties | ForEach-Object { $_.Name })

$networkSettings = [PSCustomObject]@{
    SwitchName  = $txtSwitchName.Text.Trim()
    Subnet      = $txtSubnet.Text.Trim()
    GatewayIP   = $gwIP
}

if ($existingProps -contains 'Network') {
    $configJson.Network = $networkSettings
} else {
    $configJson | Add-Member -MemberType NoteProperty -Name 'Network' -Value $networkSettings
}

# Persist admin username (password stays in memory only -- never written to disk)
$adminUser = $txtAdminUsername.Text.Trim()
if (-not [string]::IsNullOrWhiteSpace($adminUser)) {
    if ($existingProps -contains 'AdminUsername') {
        $configJson.AdminUsername = $adminUser
    } else {
        $configJson | Add-Member -MemberType NoteProperty -Name 'AdminUsername' -Value $adminUser
    }
}
```

Also add subnet format validation before the existing gateway IP validation:

```powershell
$subnet = $txtSubnet.Text.Trim()
if ($subnet -and $subnet -notmatch '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/\d{1,2}$') {
    [System.Windows.MessageBox]::Show(
        "Invalid subnet format. Please enter CIDR notation (e.g. 10.0.10.0/24).",
        'Validation Error',
        [System.Windows.MessageBoxButton]::OK,
        [System.Windows.MessageBoxImage]::Warning
    ) | Out-Null
    return
}
```

## Change 4: Harden Save-GuiSettings with try/catch

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Save-GuiSettings` function, around line 124

Wrap the write operation:

```powershell
try {
    $Settings | ConvertTo-Json -Depth 10 | Set-Content -Path $script:GuiSettingsPath -Encoding UTF8
}
catch {
    Write-Warning "Failed to save GUI settings: $_"
}
```

## Change 5: Populate Settings view from config.json as fallback

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** `Initialize-SettingsView`, after the GlobalLabConfig population block around line 1419

Add a fallback that reads from config.json when GlobalLabConfig is not available:

```powershell
if (-not (Test-Path variable:GlobalLabConfig)) {
    # Fall back to config.json for network and credential settings
    if (Test-Path $configJsonPath) {
        try {
            $configJson = Get-Content -Path $configJsonPath -Raw | ConvertFrom-Json
            if ($configJson.Network) {
                $txtSwitchName.Text = if ($configJson.Network.SwitchName) { $configJson.Network.SwitchName } else { '' }
                $txtSubnet.Text     = if ($configJson.Network.Subnet) { $configJson.Network.Subnet } else { '' }
                $txtGatewayIP.Text  = if ($configJson.Network.GatewayIP) { $configJson.Network.GatewayIP } else { '' }
            }
            if ($configJson.AdminUsername) {
                $txtAdminUsername.Text = $configJson.AdminUsername
            }
        }
        catch { }
    }
}
```

## Change 6: Persist admin username and theme to gui-settings.json from Settings Save

**File:** `GUI/Start-OpenCodeLabGUI.ps1`
**Location:** Settings Save handler, after config.json write succeeds

```powershell
# Also persist admin username to gui-settings.json for cross-session recall
$guiSettings = Get-GuiSettings
$guiSettings['AdminUsername'] = $txtAdminUsername.Text.Trim()
Save-GuiSettings -Settings $guiSettings
```

</changes>

<validation>
- PowerShell parser validates Start-OpenCodeLabGUI.ps1 has no syntax errors
- Render-LogEntries uses Application.Current.FindResource, not mainWindow.FindResource
- Add-LogEntry trims oldest entries when exceeding 2000 cap
- Settings Save persists ISO paths, network settings, and admin username to config.json
- Save-GuiSettings does not throw on write failure
- Get-GuiSettings does not throw on corrupt JSON
</validation>
