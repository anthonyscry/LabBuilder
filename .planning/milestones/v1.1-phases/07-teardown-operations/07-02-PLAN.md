---
phase: 07-teardown-operations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/Test-DCPromotionPrereqs.ps1
  - Private/Set-VMStaticIP.ps1
  - Public/New-LabSSHKey.ps1
  - Tests/ReliabilityGaps.Tests.ps1
autonomous: true
requirements:
  - REL-01
  - REL-02
  - REL-03
  - REL-04

must_haves:
  truths:
    - "Test-DCPromotionPrereqs accumulates all check results and always runs the network check (check 5), even when earlier checks fail"
    - "Ensure-VMsReady uses return instead of exit 0 (already fixed — verified by test)"
    - "Set-VMStaticIP validates IP address format and PrefixLength range before attempting configuration"
    - "New-LabSSHKey uses $GlobalLabConfig.Linux.SSHKeyDir instead of hardcoded C:\\LabSources\\SSHKeys fallback"
  artifacts:
    - path: "Private/Test-DCPromotionPrereqs.ps1"
      provides: "Restructured prereq checks that accumulate results without early return"
    - path: "Private/Set-VMStaticIP.ps1"
      provides: "IP address and CIDR prefix validation"
    - path: "Public/New-LabSSHKey.ps1"
      provides: "Config-based SSH key directory resolution"
    - path: "Tests/ReliabilityGaps.Tests.ps1"
      provides: "Verification tests for all 4 reliability gaps"
  key_links:
    - from: "Private/Set-VMStaticIP.ps1"
      to: "ValidatePattern"
      via: "parameter validation attribute on IPAddress"
      pattern: "ValidatePattern.*\\d"
    - from: "Public/New-LabSSHKey.ps1"
      to: "$GlobalLabConfig.Linux.SSHKeyDir"
      via: "config-based path resolution"
      pattern: "GlobalLabConfig\\.Linux\\.SSHKeyDir"
---

<objective>
Close all 4 reliability production gaps (R1-R4) with code fixes and verification tests.

Purpose: Fix control flow in Test-DCPromotionPrereqs so network check always runs (R1), add IP/CIDR validation to Set-VMStaticIP (R3), replace hardcoded paths with config lookups in New-LabSSHKey (R4), and verify the already-fixed Ensure-VMsReady return (R2). New-LabNAT already has IP ValidatePattern, so R3 focus is on adding PrefixLength validation to New-LabNAT param and adding both validations to Set-VMStaticIP.

Output: Updated source files plus ReliabilityGaps.Tests.ps1 covering all 4 reliability requirements.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Private/Test-DCPromotionPrereqs.ps1
@Private/Ensure-VMsReady.ps1
@Private/Set-VMStaticIP.ps1
@Public/New-LabNAT.ps1
@Public/New-LabSSHKey.ps1
@Public/Initialize-LabVMs.ps1
@Lab-Config.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure Test-DCPromotionPrereqs to accumulate checks (R1) and add validation to Set-VMStaticIP and New-LabNAT (R3)</name>
  <files>
    Private/Test-DCPromotionPrereqs.ps1
    Private/Set-VMStaticIP.ps1
    Public/New-LabNAT.ps1
  </files>
  <action>
    **R1 — Test-DCPromotionPrereqs restructure:**

    Rewrite the check logic so that ALL checks run regardless of earlier failures. Instead of `return $result` after each failed check, accumulate failures and set `CanPromote = $false` at the end if ANY check failed. The function must:

    1. Run Check 1 (Hyper-V module) — if missing, still continue but mark fail
    2. Run Check 2 (VM exists and running) — if VM not found, skip in-VM checks (3-5) since they require the VM, but still add check results
    3. Run Check 3 (Heartbeat) — skip if VM not found, add result
    4. Run Check 4 (ADDSDeployment module) — skip if VM not running, add result
    5. Run Check 5 (Network connectivity) — ALWAYS attempt if VM is running, never skipped by earlier check failures

    Use a `$canProceedToVMChecks` flag. Set it to `$false` if Check 1 fails (no Hyper-V) or Check 2 fails (VM not found/not running). Checks 3-5 are skipped (with "Skipped" status) if `$canProceedToVMChecks` is false, but the function NEVER returns early.

    At the end: `$result.CanPromote = ($result.Checks | Where-Object Status -eq 'Fail').Count -eq 0`

    Keep the same output shape (VMName, CanPromote, Status, Message, Checks, Duration). Set Status to "Ready" if CanPromote, "Failed" if any Fail, "Warning" if only warnings.

    **R3 — Set-VMStaticIP validation:**

    Add parameter validation attributes to Set-VMStaticIP:
    - `[ValidatePattern('^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$')]` on `$IPAddress`
    - `[ValidateRange(1,32)]` on `$PrefixLength`

    **R3 — New-LabNAT PrefixLength validation:**

    The `$AddressSpace` param already has CIDR in it (e.g., "10.0.0.0/24"). The prefix is extracted on line 73-76 with a regex. Add a validation check after extraction:

    ```powershell
    if ($prefixLength -lt 1 -or $prefixLength -gt 32) {
        return [PSCustomObject]@{
            OverallStatus = 'Failed'
            Message = "Invalid CIDR prefix length '$prefixLength' in AddressSpace '$AddressSpace'. Must be 1-32."
            SwitchCreated = $false
            GatewayConfigured = $false
            NATCreated = $false
        }
    }
    ```

    Do NOT change the GatewayIP ValidatePattern that already exists on New-LabNAT.
  </action>
  <verify>
    1. Read the updated Test-DCPromotionPrereqs.ps1 and confirm no `return $result` inside check blocks (only at the very end)
    2. Read Set-VMStaticIP.ps1 and confirm ValidatePattern and ValidateRange attributes are present
    3. Read New-LabNAT.ps1 and confirm prefix length validation exists
  </verify>
  <done>
    Test-DCPromotionPrereqs accumulates all checks without early return. Set-VMStaticIP validates IP format and prefix range. New-LabNAT validates CIDR prefix length.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix hardcoded paths in New-LabSSHKey (R4) and create ReliabilityGaps.Tests.ps1</name>
  <files>
    Public/New-LabSSHKey.ps1
    Tests/ReliabilityGaps.Tests.ps1
  </files>
  <action>
    **R4 — New-LabSSHKey config path:**

    Replace the hardcoded fallback logic (lines 30-40) with `$GlobalLabConfig`-based resolution:

    ```powershell
    $sshKeyDir = if ($OutputPath) {
        $OutputPath
    } elseif ((Test-Path variable:GlobalLabConfig) -and $GlobalLabConfig.Linux.SSHKeyDir) {
        $GlobalLabConfig.Linux.SSHKeyDir
    } else {
        Write-Warning "No SSH key directory configured. Set `$GlobalLabConfig.Linux.SSHKeyDir in Lab-Config.ps1. Falling back to C:\LabSources\SSHKeys."
        'C:\LabSources\SSHKeys'
    }
    ```

    This uses `$GlobalLabConfig.Linux.SSHKeyDir` (which exists in Lab-Config.ps1 line 366) instead of the old `Get-LabConfig` / `$labConfig.LabSettings.SSHKeyDir` lookup. The hardcoded fallback is kept as last resort with a warning.

    Also remove the `$labConfig = Get-LabConfig` call at line 29 since it's no longer needed.

    Note: Initialize-LabVMs.ps1 (R4 for VHDBasePath) already uses `$GlobalLabConfig.Paths.LabRoot` with a fallback (line 51). The fallback to `C:\Lab\VMs` is acceptable as a last-resort default, but add a Write-Warning when the fallback is used. Edit line 51 to:

    Actually, Initialize-LabVMs already properly checks `$GlobalLabConfig` first (line 51). The hardcoded path is only a last-resort fallback when config is unavailable. This is acceptable. Focus on New-LabSSHKey which uses the old `Get-LabConfig` pattern instead of `$GlobalLabConfig`.

    **ReliabilityGaps.Tests.ps1:**

    Create Pester 5.x test file with 4 Describe blocks:

    **R1 — Test-DCPromotionPrereqs always runs network check:**
    - Use `Select-String` to scan the function file for early `return $result` INSIDE the try block before Check 5. The pattern `return \$result` should NOT appear between "Check 1" and "Check 5" comments (only at the very end).
    - Alternative: count occurrences of `return $result` — should be exactly 2 (one at end of try, one in outer catch).

    **R2 — Ensure-VMsReady uses return not exit:**
    - Use `Select-String` on `Private/Ensure-VMsReady.ps1` for `exit` — should find 0 matches
    - Verify `return` exists in the file

    **R3 — IP and CIDR validation:**
    - Use `Select-String` on `Private/Set-VMStaticIP.ps1` for `ValidatePattern` — should match
    - Use `Select-String` on `Private/Set-VMStaticIP.ps1` for `ValidateRange` — should match
    - Use `Select-String` on `Public/New-LabNAT.ps1` for `ValidatePattern` on GatewayIP — should match
    - Use `Select-String` on `Public/New-LabNAT.ps1` for prefix validation — should match

    **R4 — Config paths instead of hardcoded:**
    - Use `Select-String` on `Public/New-LabSSHKey.ps1` for `GlobalLabConfig.Linux.SSHKeyDir` — should match
    - Use `Select-String` on `Public/Initialize-LabVMs.ps1` for `GlobalLabConfig.Paths.LabRoot` — should match

    Use `Set-StrictMode -Version Latest` in BeforeAll. Follow project test patterns.
  </action>
  <verify>
    Run the test file:
    ```powershell
    Invoke-Pester Tests/ReliabilityGaps.Tests.ps1 -Output Detailed
    ```
    All tests pass.
  </verify>
  <done>
    New-LabSSHKey uses $GlobalLabConfig.Linux.SSHKeyDir. ReliabilityGaps.Tests.ps1 exists with tests for R1-R4. All tests pass. No regressions.
  </done>
</task>

</tasks>

<verification>
1. `Invoke-Pester Tests/ReliabilityGaps.Tests.ps1 -Output Detailed` — all tests pass
2. `Select-String -Path Private/Test-DCPromotionPrereqs.ps1 -Pattern 'return \$result'` — only at function end and outer catch
3. `Select-String -Path Private/Set-VMStaticIP.ps1 -Pattern 'ValidatePattern'` — matches
4. `Select-String -Path Public/New-LabSSHKey.ps1 -Pattern 'GlobalLabConfig'` — matches
5. Full test suite: `Invoke-Pester Tests/ -Output Detailed` — no regressions
</verification>

<success_criteria>
- Test-DCPromotionPrereqs accumulates all checks, network check always runs (R1 closed)
- Ensure-VMsReady confirmed using return not exit (R2 verified)
- Set-VMStaticIP and New-LabNAT validate IP addresses and CIDR prefix (R3 closed)
- New-LabSSHKey uses $GlobalLabConfig paths (R4 closed)
- ReliabilityGaps.Tests.ps1 verifies all 4 reliability gaps with passing tests
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-teardown-operations/07-02-SUMMARY.md`
</output>
