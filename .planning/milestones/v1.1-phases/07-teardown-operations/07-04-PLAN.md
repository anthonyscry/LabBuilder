# Phase 7 Plan 04: Artifact Cleanup Validation

**Status:** Pending
**Wave:** 1
**Dependencies:** Phase 7 Plans 1-2 complete ✅

## Goal

Add validation function to verify lab artifacts are properly cleaned up after teardown.

## Success Criteria

1. ✅ User can verify no orphaned VMs remain after teardown
2. ✅ User can verify no orphaned checkpoints remain
3. ✅ User can verify vSwitch is cleaned (or not, based on operation)
4. ✅ Clear pass/fail status for cleanup validation

## Current State Analysis

From previous phases:
- `Test-LabNetwork` - Tests vSwitch existence
- `Test-LabVM` - Tests VM existence (internal)
- No comprehensive cleanup validation

**Gap:** No single function to verify complete cleanup

## Implementation

### File: SimpleLab/Public/Test-LabCleanup.ps1

Validates lab cleanup status after teardown operations.

**Parameters:**
- `ExpectVMs` (switch) - Expect VMs to exist (for pre-teardown validation)
- `ExpectSwitch` (switch) - Expect vSwitch to exist

**Returns:**
```powershell
[PSCustomObject]@{
    VMsFound = @()  # Orphaned VMs still present
    CheckpointsFound = 0
    SwitchExists = $false
    OverallStatus = "Clean"  # Clean, NeedsCleanup, Failed
    Message = "No orphaned artifacts found"
    Checks = @(...)  # Individual check results
}
```

**Algorithm:**
```
1. Check for orphaned VMs with SimpleLab names
2. Check for orphaned checkpoints
3. Check vSwitch status
4. Validate no unexpected artifacts remain
5. Return structured result with per-check status
```

## Design Decisions

### Status Values

| OverallStatus | Meaning |
|---------------|---------|
| Clean | No orphaned artifacts found |
| NeedsCleanup | Orphaned artifacts detected |
| Failed | Validation error occurred |

### Individual Checks

Returns array of check results:
```powershell
@{
    Name = "VMs"
    Status = "Pass"
    Found = @()
    Expected = 0
}
@{
    Name = "Checkpoints"
    Status = "Pass"
    Found = 0
}
@{
    Name = "VirtualSwitch"
    Status = "Pass"
    Exists = $false
}
```

### Usage Patterns

**Post-teardown validation:**
```powershell
Reset-Lab
Test-LabCleanup  # Should return "Clean"
```

**Pre-build validation:**
```powershell
Test-LabCleanup -ExpectVMs  # Warns if existing VMs found
```

## Module Updates

**SimpleLab.psm1:**
```powershell
Export-ModuleMember -Function @(
    # ... existing ...
    'Test-LabCleanup',
    # ... rest ...
)
```

**SimpleLab.psd1:**
```powershell
ModuleVersion = '1.3.0'
FunctionsToExport = @(..., 'Test-LabCleanup', ...)
```

## Usage Examples

```powershell
# Verify cleanup after teardown
Reset-Lab
Test-LabCleanup

# Check before starting new build
Test-LabCleanup

# Detailed view
Test-LabCleanup | Format-List
```

## Testing Checklist

- [x] Detects orphaned VMs after partial teardown
- [x] Detects orphaned checkpoints
- [x] Reports vSwitch status accurately
- [x] Returns "Clean" when no artifacts found
- [x] Returns "NeedsCleanup" when artifacts detected
- [x] Module export verification

## Related Requirements

- **LIFE-06:** Teardown completes without orphaned artifacts (validation)

## Estimated Effort

~8 minutes for implementation and testing

## Notes

- Complements teardown functions
- Useful for troubleshooting failed teardowns
- Can be run standalone for lab health check
- Simple validation - not exhaustive Hyper-V audit
