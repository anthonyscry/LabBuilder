---
phase: 07-teardown-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Private/New-LabUnattendXml.ps1
  - Tests/SecurityGaps.Tests.ps1
autonomous: true
requirements:
  - SEC-01
  - SEC-02
  - SEC-03
  - SEC-04

must_haves:
  truths:
    - "New-LabUnattendXml emits Write-Warning about plaintext password storage when generating unattend.xml"
    - "Initialize-LabVMs uses $GlobalLabConfig.Credentials.AdminPassword (no hardcoded default password)"
    - "All SSH calls use StrictHostKeyChecking=accept-new (no StrictHostKeyChecking=no anywhere)"
    - "Deploy.ps1 validates SHA256 checksum for Git installer downloads"
  artifacts:
    - path: "Private/New-LabUnattendXml.ps1"
      provides: "Plaintext password warning on unattend.xml generation"
      contains: "Write-Warning"
    - path: "Tests/SecurityGaps.Tests.ps1"
      provides: "Verification tests for all 4 security gaps"
  key_links:
    - from: "Private/New-LabUnattendXml.ps1"
      to: "Write-Warning"
      via: "emits warning when generating XML with plaintext password"
      pattern: "Write-Warning.*plaintext"
---

<objective>
Close all 4 security production gaps (S1-S4) and verify with Pester tests.

Purpose: Three of four security gaps (S1, S2, S3) were already fixed in v1.0. This plan implements the remaining fix (S4: plaintext password warning in New-LabUnattendXml) and creates comprehensive Pester tests that verify all four gaps are closed — serving as regression guards.

Output: Updated New-LabUnattendXml.ps1 with Write-Warning, plus SecurityGaps.Tests.ps1 covering all 4 security requirements.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Private/New-LabUnattendXml.ps1
@Public/Initialize-LabVMs.ps1
@Scripts/Open-LabTerminal.ps1
@Deploy.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add plaintext password warning to New-LabUnattendXml (S4)</name>
  <files>Private/New-LabUnattendXml.ps1</files>
  <action>
    Add a Write-Warning call at the beginning of the function body (after param block, before XML generation) that warns the user about plaintext password storage:

    ```powershell
    Write-Warning "Unattend.xml stores the administrator password in plaintext. This is inherent to Windows unattended installs. The generated file will be deleted from the VM after first logon."
    ```

    This warning is by design — Windows unattended installs require plaintext passwords in unattend.xml. The existing FirstLogonCommands already delete the unattend.xml files after setup (lines 104-114 in current file), so the warning is informational.

    Do NOT change any other behavior. The function must still return the same XML string output.
  </action>
  <verify>
    Dot-source the function and call it — verify Write-Warning output appears:
    ```powershell
    . Private/New-LabUnattendXml.ps1
    $xml = New-LabUnattendXml -ComputerName "test" -AdministratorPassword "P@ss" -OSType "Server2019" -WarningVariable w -WarningAction SilentlyContinue
    $w | Should -Not -BeNullOrEmpty
    ```
  </verify>
  <done>New-LabUnattendXml emits a Write-Warning about plaintext password storage. XML output is unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Create SecurityGaps.Tests.ps1 verifying all 4 security gaps are closed</name>
  <files>Tests/SecurityGaps.Tests.ps1</files>
  <action>
    Create a Pester 5.x test file with 4 Describe blocks — one per security gap:

    **S1 - No hardcoded default password in Initialize-LabVMs:**
    - Use `Select-String` to scan `Public/Initialize-LabVMs.ps1` for the old pattern `$defaultPassword = 'SimpleLab123!'` (should NOT match)
    - Verify line 109 pattern uses `$GlobalLabConfig.Credentials.AdminPassword` (SHOULD match)
    - Verify the else fallback is `''` (empty string), not a hardcoded password

    **S2 - StrictHostKeyChecking=accept-new everywhere:**
    - Use `Select-String` to scan all `.ps1` files for `StrictHostKeyChecking=no` (should find 0 matches)
    - Use `Select-String` to scan for `StrictHostKeyChecking=accept-new` (should find multiple matches)
    - Exclude Tests/ directory from the scan

    **S3 - Git installer SHA256 validation in Deploy.ps1:**
    - Use `Select-String` to scan `Deploy.ps1` for `Get-FileHash` (should match)
    - Verify the checksum rejection pattern exists: `no checksum provided`
    - Verify `SoftwarePackages.Git.Sha256` reference exists

    **S4 - Plaintext password warning in New-LabUnattendXml:**
    - Dot-source `Private/New-LabUnattendXml.ps1` in BeforeAll
    - Call `New-LabUnattendXml` with `-WarningVariable w -WarningAction SilentlyContinue`
    - Assert `$w` is not empty and contains "plaintext"
    - Assert the returned XML is still valid (contains `<unattend`)

    Use `Set-StrictMode -Version Latest` in BeforeAll. Follow project test patterns: dot-source in BeforeAll, assertions with descriptive `-Because` messages.
  </action>
  <verify>
    Run the test file:
    ```powershell
    Invoke-Pester Tests/SecurityGaps.Tests.ps1 -Output Detailed
    ```
    All tests pass.
  </verify>
  <done>SecurityGaps.Tests.ps1 exists with tests for S1, S2, S3, S4. All tests pass. No regressions in existing test suite.</done>
</task>

</tasks>

<verification>
1. `Invoke-Pester Tests/SecurityGaps.Tests.ps1 -Output Detailed` — all tests pass
2. `Select-String -Path Private/New-LabUnattendXml.ps1 -Pattern 'Write-Warning'` — matches
3. `Select-String -Path "*.ps1" -Pattern 'StrictHostKeyChecking=no' -Recurse` — zero matches (excluding Tests/)
4. Full test suite: `Invoke-Pester Tests/ -Output Detailed` — no regressions
</verification>

<success_criteria>
- New-LabUnattendXml emits Write-Warning about plaintext password (S4 closed)
- SecurityGaps.Tests.ps1 verifies all 4 security gaps with passing tests
- No changes to observable behavior of any function
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-teardown-operations/07-01-SUMMARY.md`
</output>
