---
phase: 08-orchestrator-extraction
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - OpenCodeLab-App.ps1
  - Private/Resolve-LabNoExecuteStateOverride.ps1
  - Private/Resolve-LabRuntimeStateOverride.ps1
  - Private/Test-LabReadySnapshot.ps1
  - Private/Stop-LabVMsSafe.ps1
  - Private/Write-LabRunArtifacts.ps1
  - Private/Invoke-LabBlowAway.ps1
  - Private/Invoke-LabQuickDeploy.ps1
  - Private/Invoke-LabQuickTeardown.ps1
  - Tests/OrchestratorExtraction-Batch2.Tests.ps1
autonomous: true
requirements:
  - EXT-01
  - EXT-03
  - EXT-04

must_haves:
  truths:
    - "8 state resolution and lab operation functions extracted with explicit parameters"
    - "Write-RunArtifacts converted to Write-LabRunArtifacts with a report-data parameter object instead of 20+ script-scope var reads"
    - "Invoke-BlowAway converted to Invoke-LabBlowAway with explicit $LabConfig, $SwitchName, $RunEvents params"
    - "All existing Pester tests pass after extraction"
  artifacts:
    - path: "Private/Write-LabRunArtifacts.ps1"
      provides: "Run artifact writer with explicit ReportData parameter"
    - path: "Private/Invoke-LabBlowAway.ps1"
      provides: "Lab teardown with explicit config parameters"
    - path: "Tests/OrchestratorExtraction-Batch2.Tests.ps1"
      provides: "Unit tests for all 8 extracted functions"
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Write-LabRunArtifacts.ps1"
      via: "passes report data hashtable to Write-LabRunArtifacts"
      pattern: "Write-LabRunArtifacts"
---

<objective>
Extract 8 state resolution and lab operation functions from OpenCodeLab-App.ps1 (Batch 2 of 4).

Purpose: These functions handle state overrides, snapshot checks, VM lifecycle, run artifacts, and the blow-away teardown sequence. They have moderate script-scope dependencies that must be converted to explicit parameters.

Output: 8 new Private/*.ps1 files, updated App.ps1, unit tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-orchestrator-extraction/08-RESEARCH.md
@OpenCodeLab-App.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Resolve-NoExecuteStateOverride -> Resolve-LabNoExecuteStateOverride</name>
  <files>Private/Resolve-LabNoExecuteStateOverride.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Resolve-LabNoExecuteStateOverride.ps1` with function `Resolve-LabNoExecuteStateOverride`:
    - `[CmdletBinding()]`
    - Parameters: `[switch]$NoExecute`, `[string]$NoExecuteStateJson`, `[string]$NoExecuteStatePath`
    - Body: same logic but uses parameters instead of script-scope vars
    - Early return if -not $NoExecute

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 435-482)
    - Replace call: `Resolve-NoExecuteStateOverride` -> `Resolve-LabNoExecuteStateOverride -NoExecute:$NoExecute -NoExecuteStateJson $NoExecuteStateJson -NoExecuteStatePath $NoExecuteStatePath`
  </action>
  <verify>Call with test JSON, verify parsed state returned.</verify>
  <done>Resolve-LabNoExecuteStateOverride.ps1 exists with explicit params.</done>
</task>

<task type="auto">
  <name>Task 2: Extract Resolve-RuntimeStateOverride -> Resolve-LabRuntimeStateOverride</name>
  <files>Private/Resolve-LabRuntimeStateOverride.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Resolve-LabRuntimeStateOverride.ps1` with function `Resolve-LabRuntimeStateOverride`:
    - `[CmdletBinding()]`
    - Parameters: `[switch]$SkipRuntimeBootstrap`
    - Body: same logic -- reads $env:OPENCODELAB_RUNTIME_STATE_JSON (env vars are global, acceptable)
    - $SkipRuntimeBootstrap replaces the script-scope var check

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 484-530)
    - Replace call: `Resolve-RuntimeStateOverride` -> `Resolve-LabRuntimeStateOverride -SkipRuntimeBootstrap:$SkipRuntimeBootstrap`
  </action>
  <verify>Set env var with test JSON, call function, verify parsed state.</verify>
  <done>Resolve-LabRuntimeStateOverride.ps1 exists with explicit param.</done>
</task>

<task type="auto">
  <name>Task 3: Extract Test-LabReadySnapshot (already Lab-prefixed)</name>
  <files>Private/Test-LabReadySnapshot.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Test-LabReadySnapshot.ps1` with function `Test-LabReadySnapshot`:
    - `[CmdletBinding()]`
    - Parameters: `[string[]]$VMNames`, `[Parameter(Mandatory)][string]$LabName`, `[string[]]$CoreVMNames`
    - Body: calls `Import-LabModule -LabName $LabName` instead of Ensure-LabImported
    - Uses $CoreVMNames param instead of $GlobalLabConfig.Lab.CoreVMNames for fallback
    - Calls `Get-LabExpectedVMs` with appropriate config or uses $VMNames/$CoreVMNames directly

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 262-286)
    - Update calls to pass LabName and CoreVMNames
  </action>
  <verify>Mock Get-VMSnapshot, verify returns $true when snapshot exists, $false when missing.</verify>
  <done>Test-LabReadySnapshot.ps1 extracted with explicit params.</done>
</task>

<task type="auto">
  <name>Task 4: Extract Stop-LabVMsSafe</name>
  <files>Private/Stop-LabVMsSafe.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Stop-LabVMsSafe.ps1` with function `Stop-LabVMsSafe`:
    - `[CmdletBinding()]`
    - Parameters: `[Parameter(Mandatory)][string]$LabName`, `[Parameter(Mandatory)][string[]]$CoreVMNames`
    - Body: calls `Import-LabModule -LabName $LabName` instead of Ensure-LabImported
    - Uses $CoreVMNames param instead of $GlobalLabConfig.Lab.CoreVMNames

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 556-565)
    - Update calls: `Stop-LabVMsSafe` -> `Stop-LabVMsSafe -LabName $GlobalLabConfig.Lab.Name -CoreVMNames @($GlobalLabConfig.Lab.CoreVMNames)`
  </action>
  <verify>Mock Stop-LabVM and Get-VM, verify graceful fallback behavior.</verify>
  <done>Stop-LabVMsSafe.ps1 extracted with explicit params.</done>
</task>

<task type="auto">
  <name>Task 5: Extract Write-RunArtifacts -> Write-LabRunArtifacts</name>
  <files>Private/Write-LabRunArtifacts.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Write-LabRunArtifacts.ps1` with function `Write-LabRunArtifacts`:
    - `[CmdletBinding()]`
    - Parameters: Use a `[Parameter(Mandatory)][hashtable]$ReportData` parameter containing all the values that were previously script-scope variables, plus `[Parameter(Mandatory)][bool]$Success`, `[string]$ErrorMessage = ''`
    - The $ReportData hashtable keys: RunId, Action, ResolvedDispatchMode, ExecutionOutcome, ExecutionStartedAt, ExecutionCompletedAt, RequestedMode, EffectiveMode, FallbackReason, ProfileSource, NonInteractive, CoreOnly, Force, RemoveNetwork, DryRun, AutoHeal (healResult), DefaultsFile, RunStart, RunLogRoot, PolicyOutcome, PolicyReason, HostOutcomes, BlastRadius, RunEvents
    - Body: same JSON/TXT writing logic but reads from $ReportData hashtable

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 167-250)
    - In finally block, build $reportData hashtable from current vars, then call:
      `Write-LabRunArtifacts -ReportData $reportData -Success:$runSuccess -ErrorMessage $runError`
  </action>
  <verify>Call with test report data, verify JSON and TXT files created with correct content.</verify>
  <done>Write-LabRunArtifacts.ps1 exists with ReportData hashtable param. No script-scope deps.</done>
</task>

<task type="auto">
  <name>Task 6: Extract Invoke-BlowAway -> Invoke-LabBlowAway</name>
  <files>Private/Invoke-LabBlowAway.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabBlowAway.ps1` with function `Invoke-LabBlowAway`:
    - `[CmdletBinding()]`
    - Parameters: `[switch]$BypassPrompt`, `[switch]$DropNetwork`, `[switch]$Simulate`, `[Parameter(Mandatory)][hashtable]$LabConfig`, `[Parameter(Mandatory)][string]$SwitchName`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: same logic but uses params:
      - $LabConfig instead of $GlobalLabConfig
      - $SwitchName as explicit param
      - Calls `Add-LabRunEvent` with -RunEvents
      - Calls `Stop-LabVMsSafe` with -LabName/-CoreVMNames
    - Replace hardcoded LIN1 reference with: `@(@($LabConfig.Lab.CoreVMNames)) + @('LIN1')`

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 567-699)
    - Update calls: `Invoke-BlowAway -BypassPrompt:X -DropNetwork:Y -Simulate:Z` -> `Invoke-LabBlowAway -BypassPrompt:X -DropNetwork:Y -Simulate:Z -LabConfig $GlobalLabConfig -SwitchName $SwitchName -RunEvents $RunEvents`
  </action>
  <verify>Call in simulate mode, verify dry-run output. Mock VM commands for non-simulate path.</verify>
  <done>Invoke-LabBlowAway.ps1 extracted with explicit LabConfig/SwitchName/RunEvents params.</done>
</task>

<task type="auto">
  <name>Task 7: Extract Invoke-QuickDeploy and Invoke-QuickTeardown</name>
  <files>Private/Invoke-LabQuickDeploy.ps1, Private/Invoke-LabQuickTeardown.ps1, OpenCodeLab-App.ps1</files>
  <action>
    **Private/Invoke-LabQuickDeploy.ps1** - `Invoke-LabQuickDeploy`:
    - `[CmdletBinding()]`
    - Parameters: `[switch]$DryRun`, `[Parameter(Mandatory)][string]$ScriptDir`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: calls Invoke-LabRepoScript with params, calls Get-LabHealthArgs

    **Private/Invoke-LabQuickTeardown.ps1** - `Invoke-LabQuickTeardown`:
    - `[CmdletBinding()]`
    - Parameters: `[switch]$DryRun`, `[Parameter(Mandatory)][string]$LabName`, `[Parameter(Mandatory)][string[]]$CoreVMNames`, `[Parameter(Mandatory)][hashtable]$LabConfig`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: calls Stop-LabVMsSafe, Import-LabModule, Test-LabReadySnapshot, Get-LabExpectedVMs with params

    In OpenCodeLab-App.ps1:
    - Remove both inline definitions
    - Update all call sites with explicit params
  </action>
  <verify>Call in dry-run mode, verify output messages. Mock lab commands for real path.</verify>
  <done>Both quick deploy/teardown functions extracted with explicit params.</done>
</task>

<task type="auto">
  <name>Task 8: Create unit tests for all 8 extracted functions</name>
  <files>Tests/OrchestratorExtraction-Batch2.Tests.ps1</files>
  <action>
    Create Pester 5.x test file with Describe blocks for each function:

    1. **Resolve-LabNoExecuteStateOverride**: Test JSON parsing, file path loading, null when not NoExecute
    2. **Resolve-LabRuntimeStateOverride**: Test env var parsing, null when not skipped
    3. **Test-LabReadySnapshot**: Mock Get-VMSnapshot, test found/not-found scenarios
    4. **Stop-LabVMsSafe**: Mock Stop-LabVM, test graceful fallback to Get-VM/Stop-VM
    5. **Write-LabRunArtifacts**: Test JSON/TXT creation with temp directory
    6. **Invoke-LabBlowAway**: Test simulate mode output, mock VM removal
    7. **Invoke-LabQuickDeploy**: Test dry-run mode, mock Invoke-LabRepoScript
    8. **Invoke-LabQuickTeardown**: Test dry-run mode, mock lab commands

    Use Set-StrictMode, dot-source in BeforeAll, mock in BeforeEach.
  </action>
  <verify>Run tests -- all pass.</verify>
  <done>Unit tests for all 8 functions. All pass. No regressions.</done>
</task>

<task type="auto">
  <name>Task 9: Run full test suite to verify no regressions</name>
  <files>(none)</files>
  <action>
    Run `Invoke-Pester Tests/ -Output Detailed` -- all tests must pass. Fix any failures.
  </action>
  <verify>Full test suite passes.</verify>
  <done>All existing tests pass after Batch 2 extraction.</done>
</task>

</tasks>

<verification>
1. All 8 Private/*.ps1 files exist with [CmdletBinding()] and explicit parameters
2. OpenCodeLab-App.ps1 no longer contains the 8 inline definitions
3. Write-LabRunArtifacts uses ReportData hashtable (no script-scope reads)
4. `Invoke-Pester Tests/OrchestratorExtraction-Batch2.Tests.ps1` -- all pass
5. `Invoke-Pester Tests/` -- full suite passes
</verification>

<success_criteria>
- 8 functions extracted to Private/ with explicit parameters
- Write-RunArtifacts refactored from 20+ script-scope reads to single ReportData hashtable
- Invoke-BlowAway has no closure dependencies
- Full test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-orchestrator-extraction/08-02-SUMMARY.md`
</output>
