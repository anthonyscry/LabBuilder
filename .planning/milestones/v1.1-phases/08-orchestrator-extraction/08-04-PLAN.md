---
phase: 08-orchestrator-extraction
plan: 04
type: execute
wave: 4
depends_on: [08-03]
files_modified:
  - OpenCodeLab-App.ps1
  - Private/Read-LabMenuCount.ps1
  - Private/Show-LabMenu.ps1
  - Private/Invoke-LabMenuCommand.ps1
  - Private/Get-LabMenuVmSelection.ps1
  - Private/Invoke-LabConfigureRoleMenu.ps1
  - Private/Invoke-LabAddVMWizard.ps1
  - Private/Invoke-LabAddVMMenu.ps1
  - Private/Invoke-LabInteractiveMenu.ps1
  - Private/Suspend-LabMenuPrompt.ps1
  - Tests/OrchestratorExtraction-Batch4.Tests.ps1
autonomous: true
requirements:
  - EXT-01
  - EXT-02
  - EXT-03
  - EXT-04

must_haves:
  truths:
    - "9 interactive menu functions extracted to Private/ with [CmdletBinding()] and explicit parameters"
    - "OpenCodeLab-App.ps1 reduced to thin orchestrator: param block, config load, dispatch loop, main try/catch/finally"
    - "All 34 inline functions now extracted (11 + 8 + 6 + 9 = 34)"
    - "All existing Pester tests pass after extraction"
    - "ROADMAP.md updated with plan entries for Phase 8"
  artifacts:
    - path: "Private/Invoke-LabInteractiveMenu.ps1"
      provides: "Main interactive menu loop with explicit config/state params"
    - path: "Private/Show-LabMenu.ps1"
      provides: "Menu display function"
    - path: "Tests/OrchestratorExtraction-Batch4.Tests.ps1"
      provides: "Unit tests for all 9 extracted menu functions"
  key_links:
    - from: "OpenCodeLab-App.ps1"
      to: "Private/Invoke-LabInteractiveMenu.ps1"
      via: "calls Invoke-LabInteractiveMenu from 'menu' action case"
      pattern: "Invoke-LabInteractiveMenu"
---

<objective>
Extract 9 interactive menu functions from OpenCodeLab-App.ps1 (Batch 4 of 4, final batch).

Purpose: Complete the orchestrator extraction by moving all remaining inline functions -- the interactive menu system -- to Private/ helpers. After this plan, OpenCodeLab-App.ps1 is a thin orchestrator containing only: param block, config/common loading, state variable initialization, the main try/catch/finally block with dispatch logic. Update ROADMAP.md with the 4 plan entries.

Output: 9 new Private/*.ps1 files, minimal App.ps1, unit tests, updated ROADMAP.md.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-orchestrator-extraction/08-RESEARCH.md
@OpenCodeLab-App.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Pause-Menu -> Suspend-LabMenuPrompt</name>
  <files>Private/Suspend-LabMenuPrompt.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Suspend-LabMenuPrompt.ps1` with function `Suspend-LabMenuPrompt`:
    - `[CmdletBinding()]`
    - No parameters (Read-Host is the only interaction)
    - Body: `Read-Host "`n  Press Enter to continue" | Out-Null`

    In OpenCodeLab-App.ps1:
    - Remove inline `function Pause-Menu { ... }` (lines 823-825)
    - Replace all calls: `Pause-Menu` -> `Suspend-LabMenuPrompt`
  </action>
  <verify>Function exists with [CmdletBinding()].</verify>
  <done>Suspend-LabMenuPrompt.ps1 extracted.</done>
</task>

<task type="auto">
  <name>Task 2: Extract Invoke-MenuCommand -> Invoke-LabMenuCommand</name>
  <files>Private/Invoke-LabMenuCommand.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabMenuCommand.ps1` with function `Invoke-LabMenuCommand`:
    - `[CmdletBinding()]`
    - Parameters: `[Parameter(Mandatory)][string]$Name`, `[Parameter(Mandatory)][scriptblock]$Command`, `[switch]$NoPause`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: calls Add-LabRunEvent with -RunEvents, calls Suspend-LabMenuPrompt

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 827-846)
    - Replace calls: `Invoke-MenuCommand` -> `Invoke-LabMenuCommand` with -RunEvents
  </action>
  <verify>Mock scriptblock, verify event logged and pause called.</verify>
  <done>Invoke-LabMenuCommand.ps1 extracted with RunEvents param.</done>
</task>

<task type="auto">
  <name>Task 3: Extract Read-MenuCount -> Read-LabMenuCount</name>
  <files>Private/Read-LabMenuCount.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Read-LabMenuCount.ps1` with function `Read-LabMenuCount`:
    - `[CmdletBinding()]`
    - Parameters: `[Parameter(Mandatory)][string]$Prompt`, `[int]$DefaultValue = 0`
    - Body: same logic (Read-Host, TryParse, return)

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 1057-1075)
    - Replace calls: `Read-MenuCount` -> `Read-LabMenuCount`
  </action>
  <verify>Mock Read-Host to return '5', verify returns 5. Mock empty, verify returns default.</verify>
  <done>Read-LabMenuCount.ps1 extracted.</done>
</task>

<task type="auto">
  <name>Task 4: Extract Get-MenuVmSelection -> Get-LabMenuVmSelection</name>
  <files>Private/Get-LabMenuVmSelection.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Get-LabMenuVmSelection.ps1` with function `Get-LabMenuVmSelection`:
    - `[CmdletBinding()]`
    - Parameters: `[string]$SuggestedVM = ''`, `[string[]]$CoreVMNames`
    - Body: same logic but uses $CoreVMNames param instead of $GlobalLabConfig.Lab.CoreVMNames in the catch fallback

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 848-892)
    - Replace calls with -CoreVMNames param
  </action>
  <verify>Mock Get-VM and Read-Host, verify correct VM returned.</verify>
  <done>Get-LabMenuVmSelection.ps1 extracted with explicit CoreVMNames param.</done>
</task>

<task type="auto">
  <name>Task 5: Extract Show-Menu -> Show-LabMenu</name>
  <files>Private/Show-LabMenu.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Show-LabMenu.ps1` with function `Show-LabMenu`:
    - `[CmdletBinding()]`
    - No parameters (pure display function)
    - Body: same Write-Host calls for menu display

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 1183-1211)
    - Replace call: `Show-Menu` -> `Show-LabMenu`
  </action>
  <verify>Call function, verify no errors (output goes to host).</verify>
  <done>Show-LabMenu.ps1 extracted.</done>
</task>

<task type="auto">
  <name>Task 6: Extract Invoke-ConfigureRoleMenu -> Invoke-LabConfigureRoleMenu</name>
  <files>Private/Invoke-LabConfigureRoleMenu.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabConfigureRoleMenu.ps1` with function `Invoke-LabConfigureRoleMenu`:
    - `[CmdletBinding()]`
    - Parameters: `[Parameter(Mandatory)][string]$ScriptDir`, `[Parameter(Mandatory)][string[]]$CoreVMNames`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: calls Get-LabMenuVmSelection with -CoreVMNames, calls Add-LabRunEvent with -RunEvents
    - Uses $ScriptDir param for LabBuilder path

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 894-961)
    - Update call site
  </action>
  <verify>Mock Read-Host for role selection, verify role plan captured in events.</verify>
  <done>Invoke-LabConfigureRoleMenu.ps1 extracted with explicit params.</done>
</task>

<task type="auto">
  <name>Task 7: Extract Invoke-AddVMWizard and Invoke-AddVMMenu</name>
  <files>Private/Invoke-LabAddVMWizard.ps1, Private/Invoke-LabAddVMMenu.ps1, OpenCodeLab-App.ps1</files>
  <action>
    **Private/Invoke-LabAddVMWizard.ps1** - `Invoke-LabAddVMWizard`:
    - `[CmdletBinding()]`
    - Parameters: `[Parameter(Mandatory)][ValidateSet('Server', 'Workstation')][string]$VMType`, `[Parameter(Mandatory)][hashtable]$LabConfig`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: uses $LabConfig for paths and network config, calls Add-LabRunEvent

    **Private/Invoke-LabAddVMMenu.ps1** - `Invoke-LabAddVMMenu`:
    - `[CmdletBinding()]`
    - Parameters: `[Parameter(Mandatory)][hashtable]$LabConfig`, `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
    - Body: calls Invoke-LabAddVMWizard with params

    In OpenCodeLab-App.ps1:
    - Remove both inline definitions
    - Update call sites
  </action>
  <verify>Mock Read-Host and New-LabVM. Verify VM creation flow.</verify>
  <done>Both VM wizard/menu functions extracted.</done>
</task>

<task type="auto">
  <name>Task 8: Extract Invoke-InteractiveMenu -> Invoke-LabInteractiveMenu</name>
  <files>Private/Invoke-LabInteractiveMenu.ps1, OpenCodeLab-App.ps1</files>
  <action>
    Create `Private/Invoke-LabInteractiveMenu.ps1` with function `Invoke-LabInteractiveMenu`:
    - `[CmdletBinding()]`
    - Parameters:
      - `[Parameter(Mandatory)][hashtable]$LabConfig`
      - `[Parameter(Mandatory)][string]$ScriptDir`
      - `[Parameter(Mandatory)][string]$SwitchName`
      - `[Parameter(Mandatory)][string]$LabName`
      - `[Parameter(Mandatory)][ValidateSet('quick', 'full')][string]$EffectiveMode`
      - `[Parameter(Mandatory)][System.Collections.Generic.List[object]]$RunEvents`
      - `[switch]$NonInteractive`
      - `[switch]$AutoFixSubnetConflict`
    - Body: the do { Show-LabMenu; switch } while loop
    - All internal calls use Lab-prefixed extracted functions with explicit params:
      - `Invoke-LabMenuCommand` with -RunEvents
      - `Invoke-LabSetupMenu` with all params
      - `Invoke-LabOneButtonReset` with all params
      - `Invoke-LabRepoScript` with -ScriptDir -RunEvents
      - `Import-LabModule` with -LabName
      - `Test-LabReadySnapshot` with params
      - `Stop-LabVMsSafe` with params
      - `Get-LabHealthArgs`
      - `Invoke-LabConfigureRoleMenu` with params
      - `Invoke-LabAddVMMenu` with params

    In OpenCodeLab-App.ps1:
    - Remove inline definition (lines 1213-1265)
    - Replace call: `Invoke-InteractiveMenu` -> `Invoke-LabInteractiveMenu -LabConfig $GlobalLabConfig -ScriptDir $ScriptDir -SwitchName $SwitchName -LabName $GlobalLabConfig.Lab.Name -EffectiveMode $EffectiveMode -RunEvents $RunEvents -NonInteractive:$NonInteractive -AutoFixSubnetConflict:$AutoFixSubnetConflict`
  </action>
  <verify>Mock Read-Host to return 'X' immediately. Verify menu exits cleanly.</verify>
  <done>Invoke-LabInteractiveMenu.ps1 extracted. OpenCodeLab-App.ps1 is now a thin orchestrator.</done>
</task>

<task type="auto">
  <name>Task 9: Create unit tests for all 9 extracted functions</name>
  <files>Tests/OrchestratorExtraction-Batch4.Tests.ps1</files>
  <action>
    Create Pester 5.x test file with Describe blocks:

    1. **Suspend-LabMenuPrompt**: Mock Read-Host, verify called
    2. **Invoke-LabMenuCommand**: Mock scriptblock, verify event logged and command executed
    3. **Read-LabMenuCount**: Mock Read-Host with valid/invalid/empty input
    4. **Get-LabMenuVmSelection**: Mock Get-VM and Read-Host, test selection scenarios
    5. **Show-LabMenu**: Verify no errors on call (output is host-only)
    6. **Invoke-LabConfigureRoleMenu**: Mock Read-Host for role selection, verify event
    7. **Invoke-LabAddVMWizard**: Mock Read-Host and New-LabVM, verify VM creation
    8. **Invoke-LabAddVMMenu**: Mock Read-Host, verify dispatch to wizard
    9. **Invoke-LabInteractiveMenu**: Mock Read-Host to return 'X', verify clean exit

    Follow project patterns. Set-StrictMode, dot-source, mock.
  </action>
  <verify>All tests pass.</verify>
  <done>Unit tests for all 9 menu functions. All pass.</done>
</task>

<task type="auto">
  <name>Task 10: Update ROADMAP.md with Phase 8 plan entries</name>
  <files>.planning/ROADMAP.md</files>
  <action>
    In ROADMAP.md, replace the Phase 8 "Plans: TBD" section with:

    ```
    Plans:
    - [ ] 08-01-PLAN.md -- Extract 11 pure utility functions (arg builders, script resolver, run events, log retention)
    - [ ] 08-02-PLAN.md -- Extract 8 state/operation functions (state overrides, snapshots, VM stop, artifacts, blow-away, quick ops)
    - [ ] 08-03-PLAN.md -- Extract 6 lifecycle orchestration functions (action core, one-button setup/reset, setup, bulk VM)
    - [ ] 08-04-PLAN.md -- Extract 9 interactive menu functions (menu display, commands, role config, VM wizard)
    ```

    Update the Progress table:
    - Phase 8 row: Plans = 0/4, Status = In Progress

    Update **Plans**: TBD -> 4 plans
  </action>
  <verify>ROADMAP.md shows 4 plan entries for Phase 8.</verify>
  <done>ROADMAP.md updated with Phase 8 plan entries and progress.</done>
</task>

<task type="auto">
  <name>Task 11: Verify App.ps1 is thin orchestrator + full regression test</name>
  <files>OpenCodeLab-App.ps1</files>
  <action>
    Verify that OpenCodeLab-App.ps1 now contains ONLY:
    1. Param block (~55 lines)
    2. Config/Common loading (~30 lines)
    3. State variable initialization (~20 lines)
    4. DefaultsFile loading (~15 lines)
    5. Dispatch mode resolution (~15 lines)
    6. Main try/catch/finally block with:
       - Action routing (resolve dispatch plan, resolve intent)
       - Policy evaluation
       - Auto-heal
       - Mode decision
       - Coordinator dispatch
       - Action switch statement (now calling extracted Lab-prefixed functions)
       - Run artifact writing and log retention in finally
    7. No inline function definitions remain

    Run `Invoke-Pester Tests/ -Output Detailed` for final regression check.

    Expected: OpenCodeLab-App.ps1 reduced from ~2,012 lines to ~750-900 lines (only orchestration logic remains).
  </action>
  <verify>
    - `Select-String -Path OpenCodeLab-App.ps1 -Pattern '^function '` returns 0 matches
    - Full test suite passes
  </verify>
  <done>OpenCodeLab-App.ps1 is a thin orchestrator with zero inline functions. All 566+ tests pass.</done>
</task>

</tasks>

<verification>
1. All 9 Private/*.ps1 files exist with [CmdletBinding()] and explicit parameters
2. `Select-String -Path OpenCodeLab-App.ps1 -Pattern '^function '` returns 0 matches
3. OpenCodeLab-App.ps1 is ~750-900 lines (down from 2,012)
4. Total extracted: 34 functions across 4 plans (11 + 8 + 6 + 9)
5. `Invoke-Pester Tests/OrchestratorExtraction-Batch4.Tests.ps1` -- all pass
6. `Invoke-Pester Tests/` -- full suite passes
7. ROADMAP.md updated with plan entries
</verification>

<success_criteria>
- All 34 inline functions extracted to Private/ (EXT-01 complete)
- Lab-Common.ps1 auto-loads all extracted helpers (EXT-02 complete)
- All extracted helpers have [CmdletBinding()] and explicit parameters (EXT-03 complete)
- All existing Pester tests pass (EXT-04 complete)
- OpenCodeLab-App.ps1 is a thin orchestrator with no inline function definitions
- ROADMAP.md reflects Phase 8 plan structure
</success_criteria>

<output>
After completion, create `.planning/phases/08-orchestrator-extraction/08-04-SUMMARY.md`

Then update:
- `.planning/STATE.md` -- Phase 8 complete, ready for Phase 9
- `.planning/ROADMAP.md` -- Phase 8 plans marked complete, progress table updated
</output>
