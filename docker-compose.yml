services:
  test:
    build: .
    tmpfs:
      - /app/.planning/runs
    volumes:
      - .:/app:ro
      - ./Tests/results:/app/Tests/results
    command: >
      pwsh -NoProfile -Command
      "New-Item -Path ./Tests/results -ItemType Directory -Force | Out-Null;
       $$c = New-PesterConfiguration;
       $$c.Run.Path = './Tests';
       $$c.TestResult.Enabled = $$true;
       $$c.TestResult.OutputPath = './Tests/results/testResults.xml';
       $$c.TestResult.OutputFormat = 'JUnitXml';
       $$c.Output.Verbosity = 'Detailed';
       Invoke-Pester -Configuration $$c;
       exit $$LASTEXITCODE"

  validate:
    build: .
    volumes:
      - .:/app:ro
    command: >
      pwsh -NoProfile -File ./Scripts/Test-LabPreDeploy.ps1
